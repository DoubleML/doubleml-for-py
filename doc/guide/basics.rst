.. _basics:

The basics of double/debiased machine learning
----------------------------------------------

In the following we provide a brief summary of and motivation to double machine learning methods and show how the
corresponding methods provided by the :ref:`DoubleML <doubleml_package>` package can be applied.
For details we refer to Chernozhukov et al. (2018).

.. Add references to the vignette here when it is ready.

Data generating process
+++++++++++++++++++++++

We consider the following partially linear model

.. math::

        d_i = m_0(x_i) + v_i, & &v_i \sim \mathcal{N}(0,1),

        y_i = \theta d_i + g_0(x_i) + \zeta_i, & &\zeta_i \sim \mathcal{N}(0,1),


with covariates :math:`x_i \sim \mathcal{N}(0, \Sigma)`, where  :math:`\Sigma` is a matrix with entries
:math:`\Sigma_{kj} = 0.7^{|j-k|}`.
The true parameter :math:`\theta` is set to :math:`0.5`.

The nuisance functions are given by

.. math::

    m_0(x_i) &= \frac{1}{4} x_{i,1} + \frac{\exp(x_{i,3})}{1+\exp(x_{i,3})},

    g_0(X) &= \frac{\exp(x_{i,1})}{1+\exp(x_{i,1})} + \frac{1}{4} x_{i,3}.


.. note::
    - In Python the data can be generated with :py:func:`doubleml.datasets.make_plr_CCDDHNR2018`.
    - In R the data can be generated with `DoubleML::make_plr_CCDDHNR2018()`.

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        from doubleml.datasets import make_plr_CCDDHNR2018

        np.random.seed(1234)
        n_rep = 1000
        n_obs = 200
        n_vars = 150
        alpha = 0.5

        data = list()

        for i_rep in range(n_rep):
            (x, y, d) = make_plr_CCDDHNR2018(alpha=alpha, n_obs=n_obs, dim_x=n_vars, return_type='array')
            data.append((x, y, d))

.. tabbed:: R

    .. jupyter-execute::

        library(DoubleML)
        set.seed(1234)
        n_rep = 1000
        n_obs = 200
        n_vars = 150
        alpha = 0.5

        data = list()
        for (i_rep in seq_len(n_rep)) {
            data[[i_rep]] = make_plr_CCDDHNR2018(alpha=alpha, n_obs=n_obs, dim_x=n_vars,
                                                  return_type="data.frame")
        }


OLS estimation
++++++++++++++

A naive OLS regression of :math:`Y` on :math:`D` produces a significant bias.

.. tabbed:: Python

    .. The following block makes sure that the seaborn graphics are rendered appropriately but does not need to be shown

    .. ipython:: python
        :suppress:

        import seaborn as sns
        sns.set()

    .. ipython:: python

        from sklearn.linear_model import LinearRegression
        import matplotlib.pyplot as plt
        import seaborn as sns
        colors = sns.color_palette()

        def est_ols(y, X):
            ols = LinearRegression(fit_intercept=True)
            results = ols.fit(X, y)
            theta = results.coef_[0]
            return theta

        # to speed up the illustration we hard-code the simulation results
        theta_ols = np.array([0.53474489, 0.49321301, 0.48938474, 0.49113348, 0.47249586, 0.5002854 , 0.54329356, 0.49102594, 0.5122862 , 0.60483322, 0.50529179, 0.53756289, 0.53973136, 0.39572044, 0.48551521, 0.49308509, 0.52267272, 0.4739062 , 0.52061361, 0.49173419, 0.46886516, 0.44620177, 0.48511717, 0.52962376, 0.48755895, 0.43818864, 0.52179583, 0.46562877, 0.4800013 , 0.52071133, 0.49715162, 0.584374  , 0.41527432, 0.42062481, 0.49689983, 0.47557549, 0.47519286, 0.55330276, 0.50076464, 0.50110138, 0.44096759, 0.46251581, 0.49484472, 0.41750748, 0.51593157, 0.50057749, 0.51954889, 0.509907  , 0.50827057, 0.55922668, 0.47165547, 0.46419179, 0.53983825, 0.54715187, 0.56191988, 0.42893567, 0.52380663, 0.53270167, 0.4479071 , 0.48105327, 0.53353764, 0.54124996, 0.54548295, 0.51094094, 0.56332714, 0.43157765, 0.46556516, 0.48167184, 0.56591972, 0.5402868 , 0.45071603, 0.480492  , 0.4832924 , 0.51180645, 0.50391732, 0.55593077, 0.52081439, 0.49764327, 0.49323343, 0.50710186, 0.48558193, 0.49369803, 0.49289557, 0.45678834, 0.44466524, 0.5276184 , 0.50574872, 0.50873315, 0.5093345 , 0.5358176 , 0.41679893, 0.47270082, 0.54418933, 0.49517824, 0.52979261, 0.48433163, 0.48359337, 0.51812487, 0.59181156, 0.53699232, 0.46552581, 0.55333476, 0.48623123, 0.51144752, 0.46236854, 0.57886483, 0.51789811, 0.50735307, 0.4211589 , 0.48855078, 0.4243681 , 0.47640944, 0.45491436, 0.43403199, 0.48560822, 0.47612736, 0.48238253, 0.47310284, 0.4687885 , 0.47317536, 0.49469609, 0.56567542, 0.51730801, 0.49993896, 0.43936152, 0.56527377, 0.46761745, 0.47789828, 0.46624183, 0.43593246, 0.53883015, 0.4434861 , 0.52922966, 0.46343688, 0.48016923, 0.54198326, 0.53640534, 0.5486066 , 0.42170194, 0.47966118, 0.46205922, 0.44124758, 0.55045419, 0.53159584, 0.59094911, 0.42068926, 0.40552518, 0.53774806, 0.45015142, 0.52390304, 0.55731778, 0.49946863, 0.4673236 , 0.43911031, 0.5290068 , 0.62502696, 0.45862903, 0.49461714, 0.46826537, 0.6051445 , 0.49431491, 0.47420313, 0.51407318, 0.54771606, 0.49161362, 0.44876688, 0.55423873, 0.52165142, 0.54497392, 0.50958543, 0.52191335, 0.46170832, 0.48759109, 0.4665105 , 0.51398279, 0.49982105, 0.53468427, 0.57252245, 0.50871602, 0.49004664, 0.44862674, 0.54257961, 0.51952797, 0.43977019, 0.42614987, 0.4720368 , 0.4259677 , 0.46686015, 0.55086186, 0.51424663, 0.45194414, 0.46101624, 0.48000879, 0.40106034, 0.48569319, 0.49920413, 0.46055315, 0.53534816, 0.47341027, 0.44843531, 0.50454913, 0.57366355, 0.4925387 , 0.49228086, 0.4716174 , 0.45750129, 0.49507212, 0.4917077 , 0.56592525, 0.54639371, 0.4567486 , 0.60379587, 0.43035842, 0.38947502, 0.44171603, 0.54995707, 0.46330771, 0.54304814, 0.53987895, 0.53023513, 0.54072239, 0.50089411, 0.50459866, 0.53817506, 0.47298026, 0.55963564, 0.50326527, 0.50355272, 0.60127213, 0.49417754, 0.54759414, 0.56598608, 0.63706283, 0.49713338, 0.52999039, 0.60079361, 0.51643385, 0.44295755, 0.5963949 , 0.54125622, 0.50391499, 0.55067411, 0.47376548, 0.53941362, 0.46516167, 0.46151392, 0.53755663, 0.45469142, 0.43863601, 0.41087728, 0.47003843, 0.51079895, 0.52527368, 0.52637816, 0.50092493, 0.44371885, 0.49035799, 0.48642697, 0.58636112, 0.45844304, 0.46310898, 0.42365187, 0.49340386, 0.49373416, 0.47127632, 0.52443002, 0.48453076, 0.53557534, 0.54587319, 0.44557909, 0.44707145, 0.4539416 , 0.39477708, 0.57836687, 0.54884059, 0.55032192, 0.53475578, 0.50112881, 0.48718628, 0.50788462, 0.54118569, 0.48301988, 0.5794996 , 0.46683584, 0.50240451, 0.51780353, 0.59311556, 0.48079214, 0.56902342, 0.41570907, 0.51884787, 0.52249686, 0.50962174, 0.47330233, 0.4726149 , 0.48647001, 0.61941465, 0.43823152, 0.53603477, 0.44087591, 0.52902047, 0.58196358, 0.52784005, 0.5011582 , 0.45911991, 0.49441593, 0.53494157, 0.44535554, 0.5414655 , 0.49733792, 0.49475779, 0.43915872, 0.49568767, 0.56616213, 0.41704942, 0.48640589, 0.38543642, 0.50647226, 0.51371925, 0.52275473, 0.61616474, 0.4457942 , 0.53518279, 0.54067626, 0.53808711, 0.46492893, 0.50588601, 0.47287885, 0.45846615, 0.47665859, 0.47544855, 0.57764142, 0.4591314 , 0.45698   , 0.49991277, 0.45565277, 0.61295733, 0.39221989, 0.56562479, 0.49472817, 0.50932473, 0.42825645, 0.55559475, 0.43789049, 0.44167833, 0.57057639, 0.51820855, 0.52564698, 0.50620186, 0.43815581, 0.4810203 , 0.51335185, 0.5406191 , 0.48605583, 0.56855526, 0.54627503, 0.54415214, 0.43370327, 0.45239461, 0.46801712, 0.51715154, 0.47194603, 0.53931567, 0.5177749 , 0.53794166, 0.55616002, 0.51282155, 0.53608601, 0.55132172, 0.4980859 , 0.45259939, 0.47296707, 0.45061339, 0.4656037 , 0.43601839, 0.47838829, 0.56652835, 0.47912519, 0.47854479, 0.42877945, 0.54045897, 0.50203415, 0.51853431, 0.48332299, 0.51886349, 0.4922721 , 0.51415983, 0.50206898, 0.45802994, 0.48818453, 0.49376163, 0.49887163, 0.52478963, 0.52212671, 0.43240737, 0.41568593, 0.47251163, 0.51264271, 0.466146  , 0.48933761, 0.48328596, 0.47176266, 0.46670011, 0.53623029, 0.46025685, 0.47451923, 0.46879133, 0.50285378, 0.51401867, 0.47154368, 0.48150155, 0.42599135, 0.42931466, 0.38318738, 0.48729486, 0.50933095, 0.55217102, 0.46280048, 0.43381374, 0.50524411, 0.46498898, 0.49124544, 0.50201223, 0.46115799, 0.56409345, 0.49510631, 0.54108662, 0.44732406, 0.55340783, 0.53348839, 0.58847206, 0.42240913, 0.53597536, 0.45452201, 0.46062658, 0.509018  , 0.56280922, 0.54645935, 0.49926289, 0.47578281, 0.57868343, 0.53177585, 0.52901166, 0.49277313, 0.48939172, 0.43784499, 0.51884934, 0.50864266, 0.47256198, 0.50127337, 0.4865633 , 0.43823874, 0.50186063, 0.45279471, 0.45886552, 0.52525697, 0.53479534, 0.49155475, 0.41529628, 0.51256312, 0.51154064, 0.47848512, 0.53132404, 0.40414784, 0.48513958, 0.46941835, 0.506359  , 0.51026723, 0.42966184, 0.49305197, 0.46517452, 0.47567673, 0.53031564, 0.45419569, 0.48672741, 0.49795157, 0.48743661, 0.45806165, 0.49365887, 0.49653507, 0.48774482, 0.46732982, 0.58459275, 0.49083937, 0.48334247, 0.39941987, 0.5403948 , 0.53823986, 0.57201352, 0.52602583, 0.50339863, 0.4615549 , 0.44344451, 0.49285971, 0.45480388, 0.56558225, 0.60131966, 0.5053107 , 0.43050647, 0.50708966, 0.46837389, 0.54209162, 0.51197757, 0.44571481, 0.53555083, 0.42096495, 0.41615568, 0.53194506, 0.53527908, 0.51869224, 0.48849469, 0.4618124 , 0.5028268 , 0.56673464, 0.55341871, 0.5145758 , 0.45543321, 0.53295514, 0.4848744 , 0.44652998, 0.49586723, 0.46408788, 0.52653831, 0.45675493, 0.48064854, 0.54894375, 0.51060434, 0.53444835, 0.52246305, 0.43932644, 0.58277465, 0.49863121, 0.55056164, 0.49953239, 0.46288279, 0.46965027, 0.5697236 , 0.53503966, 0.4965715 , 0.4674949 , 0.5263088 , 0.50678119, 0.46258979, 0.4384881 , 0.46117142, 0.44299651, 0.54077493, 0.53312685, 0.48808191, 0.51242034, 0.50558988, 0.51457369, 0.56547915, 0.56384583, 0.48725927, 0.57817448, 0.50696463, 0.51031497, 0.48304431, 0.43884653, 0.41845616, 0.55504791, 0.46636769, 0.54222221, 0.47889168, 0.48675801, 0.5656616 , 0.49355164, 0.59875287, 0.54860168, 0.41522733, 0.48733809, 0.45435601, 0.48421146, 0.53625036, 0.52039774, 0.46557329, 0.44124397, 0.45918866, 0.59905709, 0.45946443, 0.58272019, 0.56888478, 0.51512697, 0.49093757, 0.42787907, 0.36219117, 0.45381723, 0.52093829, 0.40546958, 0.4660952 , 0.48313102, 0.44781083, 0.57084453, 0.46142245, 0.47217102, 0.52012389, 0.48153086, 0.53011145, 0.51914472, 0.50200375, 0.53883905, 0.54166622, 0.48516097, 0.51547332, 0.52541931, 0.47094642, 0.53695563, 0.49049476, 0.52160056, 0.51067811, 0.54168207, 0.54234601, 0.44459535, 0.48857404, 0.47027832, 0.50366589, 0.57688593, 0.47950764, 0.53180427, 0.53870999, 0.53445408, 0.5105142 , 0.51371376, 0.42762207, 0.51726115, 0.45286408, 0.5109974 , 0.49780359, 0.54788922, 0.50479127, 0.64452317, 0.48756741, 0.47778028, 0.50247063, 0.5683386 , 0.47424521, 0.52908729, 0.48216914, 0.4775991 , 0.45400233, 0.60397105, 0.49374285, 0.52471122, 0.57952876, 0.43364184, 0.53986198, 0.4539684 , 0.52752411, 0.47134024, 0.51161519, 0.54641137, 0.41413646, 0.48030456, 0.50183466, 0.50047268, 0.47452658, 0.55366858, 0.43086586, 0.56226793, 0.48369335, 0.53388527, 0.52281165, 0.47390147, 0.44183718, 0.53477263, 0.48494785, 0.51406698, 0.4364245 , 0.4743458 , 0.53747715, 0.52402966, 0.5517987 , 0.462502  , 0.53312726, 0.45864507, 0.4963592 , 0.45126227, 0.3865317 , 0.52282475, 0.5811465 , 0.48913972, 0.47794925, 0.53048497, 0.47688648, 0.59828497, 0.47491287, 0.48384638, 0.50358656, 0.47974641, 0.52118523, 0.52047044, 0.57841763, 0.44414197, 0.49448264, 0.48941372, 0.56717217, 0.49568387, 0.46514785, 0.48829665, 0.48496805, 0.53573793, 0.44725976, 0.52156074, 0.48637891, 0.47565922, 0.52188966, 0.52385771, 0.48305139, 0.50539809, 0.42186232, 0.5310401 , 0.5259056 , 0.49774519, 0.52779038, 0.50357969, 0.44497218, 0.55608139, 0.5305365 , 0.44169658, 0.46459225, 0.49803248, 0.50077158, 0.51459487, 0.5578276 , 0.44990819, 0.47057602, 0.4935438 , 0.50186926, 0.55992217, 0.49552788, 0.56180316, 0.50581783, 0.55138616, 0.53310174, 0.51467114, 0.46727048, 0.49602158, 0.54968695, 0.49183205, 0.53702454, 0.48045015, 0.60745461, 0.47877859, 0.52268702, 0.44059445, 0.52658321, 0.51342425, 0.48777418, 0.45409294, 0.50199068, 0.58796237, 0.51459613, 0.52727472, 0.51778247, 0.58508896, 0.42353076, 0.5589943 , 0.5452906 , 0.46497285, 0.4721525 , 0.51872793, 0.50737646, 0.53598476, 0.51487334, 0.51025047, 0.45997346, 0.52569714, 0.59271492, 0.47565387, 0.4253818 , 0.51048574, 0.45883372, 0.46833953, 0.49072685, 0.40760359, 0.50887312, 0.51979943, 0.4819792 , 0.5011791 , 0.48768716, 0.42263539, 0.42955879, 0.43264743, 0.56108565, 0.46934004, 0.49473812, 0.49870407, 0.50209089, 0.5257926 , 0.58951831, 0.47646809, 0.44359847, 0.51646926, 0.48335204, 0.6095419 , 0.43684926, 0.46532125, 0.57085336, 0.45246229, 0.45500884, 0.43820721, 0.48883694, 0.49923171, 0.49454512, 0.46757216, 0.50392497, 0.45690719, 0.52115087, 0.49426604, 0.5682218 , 0.56663046, 0.48588061, 0.50559017, 0.55418244, 0.46094655, 0.4875857 , 0.49152018, 0.51592583, 0.45254013, 0.52578698, 0.48037731, 0.5888076 , 0.41591601, 0.57084497, 0.54238712, 0.46058968, 0.49596231, 0.44058778, 0.46605588, 0.43884962, 0.50133128, 0.56691439, 0.51067353, 0.50922709, 0.59197217, 0.51544076, 0.46496894, 0.44652142, 0.38269509, 0.48060243, 0.57067647, 0.52669513, 0.54722451, 0.59266688, 0.5027297 , 0.52517902, 0.50655131, 0.48671682, 0.46502047, 0.36989293, 0.57694682, 0.47269473, 0.49795472, 0.45216404, 0.58739343, 0.46508828, 0.55824265, 0.47456072, 0.51541848, 0.55838359, 0.51605357, 0.54614737, 0.41025221, 0.51133316, 0.5643638 , 0.47493961, 0.50785406, 0.53192483, 0.52820181, 0.45081073, 0.5402259 , 0.52844925, 0.48895705, 0.45544954, 0.46532192, 0.46329957, 0.53848375, 0.49837064, 0.56305592, 0.52683051, 0.48461581, 0.53912628, 0.47429614, 0.55116519, 0.41253095, 0.55496383, 0.49483699, 0.48079289, 0.40545022, 0.55754818, 0.49453036, 0.45718172, 0.54040348, 0.44332797, 0.53741497, 0.52103591, 0.40783533, 0.53037164, 0.56506329, 0.42884113, 0.4905965 , 0.46556432, 0.46612422, 0.49108396, 0.43627095, 0.53392408, 0.40424801, 0.53241135, 0.54615187, 0.48652899, 0.526703  , 0.47725838, 0.44261845, 0.57641265, 0.51916159, 0.51944697, 0.4668915 , 0.46111359, 0.55932904, 0.59413201, 0.50788586, 0.48124233, 0.44335864, 0.54505944, 0.47534189, 0.48856266, 0.54285278, 0.46202711, 0.53536273, 0.46786836, 0.46270178, 0.59477902, 0.54031046, 0.53264006, 0.56325303, 0.54716242, 0.50410641, 0.45729931, 0.49915554, 0.49975055, 0.56362584, 0.55207975, 0.43898493, 0.47108249, 0.43693969, 0.49183465, 0.42706892, 0.47105807, 0.48851287, 0.6038248 , 0.47808143, 0.47665868, 0.52669046, 0.42548465, 0.51011812, 0.48982998, 0.46345572, 0.50397137, 0.485495  , 0.50939626, 0.4710299 , 0.50338374, 0.42873138, 0.5485134 , 0.53108115, 0.49835547, 0.47022046, 0.53646885, 0.4645972 , 0.52719066, 0.47153956, 0.43017155, 0.49774166, 0.4094798 , 0.47422792, 0.5230961 , 0.47733581, 0.45446963, 0.49697803, 0.48056422, 0.54790097, 0.48669133, 0.51637556, 0.46626523, 0.48151959, 0.62070997, 0.56278102, 0.5733016 , 0.50237631, 0.49459564, 0.48035173, 0.40878425, 0.5860298 , 0.53697496, 0.50528379, 0.54038233, 0.50800976, 0.45271877, 0.5263313 ])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            this_theta = est_ols(y, np.column_stack((d, x)))
            # we show that the loaded result matches the just computed
            print(np.abs(theta_ols[i_rep] - this_theta))
            theta_ols[i_rep] = this_theta

        ax = sns.kdeplot(theta_ols, shade=True, color=colors[0])
        @savefig ols.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        library(ggplot2)

        est_ols = function(df) {
            ols = stats::lm(y ~ 1 +., df)
            theta = coef(ols)["d"]
            return(theta)
        }

        # to speed up the illustration we hard-code the simulation results
        theta_ols = c(0.6076970468,  0.5170300995,  0.5896526432,  0.4726354351,  0.6642408585,  0.4932108056,  0.5392813703,  0.3140456483,  0.6101903047,  0.3812736489,  0.4496136570,  0.5914102960,  0.4754180670,  0.4532252810,  0.6269753602,  0.1338819316,  0.6884028841,  0.5842727441,  0.4009953898,  0.5080115455,  0.6521632319,  0.4502464412,  0.4813712970,  0.3879250029,  0.3393197436,  0.4552115052,  0.3931089712,  0.5080443651,  0.5700436320,  0.5041384567,  0.6499953723,  0.5731817909,  0.4502041678,  0.5801559287,  0.5591247555,  0.3191664832,  0.6196052426,  0.5599893983,  0.4975941524,  0.5164621868,  0.2619606631,  0.2042809030,  0.6690166441,  0.2500558662,  0.6470170061,  0.7003569318,  0.4788808811,  0.4909024261,  0.5766942001,  0.4977991783,  0.6546114303,  0.7610038138,  0.5271171729,  0.5761494009,  0.2682168403,  0.4274974716,  0.5582841927,  0.4652853510,  0.3673695350,  0.3589508407,  0.3533174156,  0.5511216826,  0.4760835293,  0.3490864679,  0.5560198291,  0.2427731801,  0.4626729518,  0.6618025699,  0.6529357868,  0.4767832618,  0.5501974215,  0.6059532099,  0.6982176475,  0.5161451470,  0.4745462039,  0.5927961750,  0.5959526257,  0.4997198712,  0.4709201659,  0.6358823918,  0.5160796258,  0.4523976587,  0.7141906497,  0.2152552728,  0.3473790100,  0.5834710477,  0.5248199571,  0.6089117059,  0.4237631663,  0.2911086892,  0.6078379727,  0.5415383784,  0.6323186392,  0.5288200377,  0.6199827790,  0.5706961851,  0.2459746689,  0.4118286186,  0.5953504255,  0.5478210410,  0.7266343491,  0.3950921552,  0.4706827765,  0.2468213702,  0.5705680085,  0.4518898237,  0.8313867061,  0.4741807833,  0.6851161612,  0.6156674390,  0.4127686471,  0.4204619558,  0.2684915333,  0.4315165374,  0.3526017422,  0.5922533664,  0.3684168306,  0.3742130364,  0.4906696956,  0.3744237070,  0.7699017505,  0.5130441628,  0.4398846656,  0.5609220081,  0.6299814601,  0.3219267670,  0.3982179088,  0.4448168725,  0.3213651310,  0.2728333801,  0.0930689760,  0.4452144845,  0.2982795653,  0.7483862010,  0.1547772795,  0.6171616096,  0.3186683517,  0.6542977699,  0.3257576803,  0.3430333842,  0.6434526588,  0.4296710125,  0.4350139549,  0.5076840081,  0.4773992816,  0.5963094638,  0.7855482875,  0.7271602788,  0.3270095317,  0.3206659841,  0.2407900798,  0.5173405920,  0.4290969392,  0.3581220168,  0.4460449939,  0.5816081976,  0.3901010130,  0.5004372968,  0.5940031370,  0.4754769340,  0.5259951165,  0.6316891175,  0.7071195478,  0.4625924072,  0.5427512018,  0.3901473154,  0.5111287831,  0.4157216163,  0.4935320133,  0.5087524378,  0.2805809128,  0.6339772023,  0.4569877058,  0.2634290851,  0.4273468221,  0.6319883422,  0.5294040223,  0.3566137316,  0.5440552193,  0.4863781919,  0.5772500666,  0.3083497835,  0.4341985914,  0.7598329757,  0.8267576927,  0.5892556960,  0.3722149089,  0.6342198834,  0.7201080636,  0.5568547139,  0.5500572246,  0.2759680198,  0.5778758935,  0.3846505789,  0.6420321609,  0.4702989111,  0.4959133540,  0.5539106506,  0.5176808677,  0.4381448903,  0.3256491658,  0.7421723099,  0.5132623356,  0.3726711388,  0.7153751525,  0.4550771132,  0.6530432841,  0.4918091784,  0.3284268649,  0.4637856389,  0.3399554209,  0.6306782630,  0.5330097195,  0.4810019031,  0.5297058741,  0.5437914936,  0.4965345768,  0.1926473467,  0.1450751021,  0.6322691485,  0.3388288815,  0.4439174619,  0.2957983561,  0.3235628985,  0.5257032434,  0.4774459015,  0.5503580893,  0.4686447948,  0.4140039640,  0.4644008215,  0.1800065841,  0.2678298940,  0.5378418905,  0.5734995951,  0.4010856920,  0.5905161353,  0.5755804753,  0.2658726437,  0.5276545505,  0.6383589987,  0.5455910425,  0.4029387921,  0.3766297181,  0.2490598339,  0.6392956338,  0.5332552301,  0.7720538775,  0.5563041768,  0.4636269614,  0.5813612325,  0.6206371491,  0.3334506591,  0.5824669006,  0.4218184389,  0.3960121654,  0.3846973139,  0.4534165556,  0.3667789743,  0.3403755497,  0.2675813119,  0.6708493911,  0.7277702653,  0.7727494818,  0.4388925885,  0.4744948382,  0.3706205261,  0.4592669693,  0.7473799214,  0.6090764624,  0.7388914750,  0.3534884574,  0.5453348799,  0.4487785777,  0.7035133174,  0.4723042542,  0.3157579514,  0.4836540872,  0.4547791198,  0.7060799144,  0.6708263311,  0.4163801015,  0.6040911970,  0.3292629435,  0.7200384193,  0.2377825515,  0.4965012231,  0.4310670522,  0.4280694448,  0.3703042541,  0.4804376276,  0.5292646200,  0.4955867915,  0.5921542559,  0.6690265548,  0.3253486665,  0.5277717968,  0.5320253413,  0.4387697885,  0.5518985434,  0.4639784662,  0.6002953004,  0.5312127908,  0.5128540791,  0.6274009050,  0.5195083226,  0.4581668078,  0.4395923317,  0.5162453910,  0.5663040937,  0.5925011710,  0.5582437070,  0.2685600205,  0.5653983389,  0.6187145510,  0.5088381953,  0.6603818987,  0.4454735561,  0.4353125431,  0.5123012913,  0.2573739816,  0.5423773622,  0.4275383064,  0.5731455874,  0.4589647941,  0.5986566750,  0.6812454725,  0.6184327409,  0.3798110573,  0.7949114528,  0.3312470616,  0.4715480750,  0.5004387014,  0.4642236592,  0.5048873346,  0.4909511989,  0.7510132966,  0.5275853674,  0.5517708731,  0.3645024458,  0.5694708798,  0.4735405601,  0.8231520963,  0.4689918450,  0.4575945437,  0.5139341633,  0.5195423857,  0.6226979486,  0.6082377991,  0.4200122529,  0.5599721241,  0.4051238913,  0.4450305863,  0.5368574512,  0.4331097164,  0.7659272797,  0.7511279491,  0.3689749146,  0.5672333089,  0.6260276304,  0.3868100858,  0.5247743018,  0.4421670536,  0.4502109590,  0.7136088850,  0.4625509320,  0.6599553002,  0.6894134830,  0.3822595904,  0.5808214338,  0.2826009736,  0.2424402639,  0.3866911184,  0.5056930342,  0.1526118564,  0.3983853255,  0.4733449335,  0.1918979659,  0.3166952600,  0.6297845154,  0.2740518778,  0.6558703457,  0.5357904885,  0.5480509524,  0.6323552631,  0.3041936023,  0.6053640882,  0.3139587603,  0.6144449919,  0.3118860637,  0.3973543275,  0.3483049835,  0.6928219962,  0.5482047867,  0.4663752936,  0.3842601622,  0.5988347760,  0.1316518272,  0.7754340601,  0.5077453823,  0.4951828582,  0.6241673911,  0.4213784166,  0.6360804020,  0.3960199321,  0.4506408803,  0.4446560381,  0.4196003128,  0.5317781868,  0.7646776169,  0.3599891030,  0.4402728384,  0.4205305154,  0.7015446032,  0.5829213870,  0.7118039577,  0.6448882114,  0.4052924715,  0.7109752365,  0.5409561330,  0.4039598103,  0.4874183244,  0.4614112104,  0.2062625504,  0.5553883260,  0.6247851358,  0.6149714167,  0.3030402243,  0.3691553441,  0.5987491375,  0.6137694130,  0.6241808077,  0.7432595608,  0.6237899186,  0.4950584888,  0.7576783436,  0.5457227848,  0.2711559102,  0.4706250562,  0.3147168110,  0.3921302816,  0.6168514043,  0.4809063332,  0.4655386744,  0.7864894022,  0.5080335888,  0.3806258560,  0.5070876695,  0.4572530006,  0.4138431436,  0.3074553474,  0.6575277990,  0.6016190082,  0.3547914293,  0.3971596349,  0.5477258751,  0.5916470210,  0.3715930528,  0.3128162486,  0.2951593594,  0.6136578067,  0.6673181959,  0.5730410192,  0.6272124761,  0.5949186989,  0.5229515742,  0.5789967551,  0.4113238339,  0.6964560060,  0.9025239934,  0.5048877433,  0.3888662785,  0.5420399889,  0.6412563805,  0.0678137137,  0.4536497509,  0.5533968582,  0.4855067012,  0.4392715614,  0.7837731202,  0.6553902050,  0.2840320053,  0.3943593279,  0.5677342249,  0.4112658736,  0.5128265341,  0.6676677371,  0.4943484574,  0.7545888722,  0.5243581073,  0.3718148618,  0.6098100278,  0.3986562324,  0.4275430643,  0.4122787784,  0.4666122478,  0.5087813210,  0.5941683621,  0.7639064390,  0.4357923279,  0.6273186041,  0.4012828264,  0.5643226357,  0.7430295097,  0.6453151855,  0.4342840783,  0.5425365016,  0.6867590871,  0.5461090414,  0.3114341022,  0.6636124701,  0.3251285587,  0.6657290882,  0.4057424123,  0.4263442637,  0.5302884527,  0.3405918638,  0.4422798499,  0.3288835280,  0.3816193674,  0.6176447392,  0.6986436154,  0.6305618871,  0.5196977735,  0.5841297272,  0.3616215179,  0.4389478330,  0.5507040927,  0.6196288115,  0.4634663455,  0.4458471142,  0.6029185234,  0.5472220056,  0.3234896190,  0.4072489631,  0.6007441227,  0.4237881180,  0.5390684021,  0.4541491760,  0.5911556227,  0.4033892738,  0.5018263999,  0.4808401974,  0.9026315858,  0.6079085261,  0.4365509975,  0.5546118885,  0.3639783534,  0.5864639670,  0.5890865630,  0.5949924992,  0.4197133424,  0.5540341521,  0.4840675350,  0.5132415287,  0.4379506844,  0.3414737821,  0.6561542380,  0.4528294624,  0.6279822612,  0.6830783896,  0.3473661878,  0.2741865556,  0.4280516830,  0.5646897527,  0.6078915225,  0.5906250767,  0.4965706254,  0.2593490204,  0.4666935514,  0.3790447351,  0.7808812701,  0.2777992058,  0.4108918641,  0.5065261830,  0.4148743467,  0.4247450821,  0.2878744298,  0.6860998730,  0.4048643604,  0.5828632364,  0.6989955000,  0.6988103393,  0.2541432174,  0.5005649977,  0.5119128855,  0.6419538148,  0.3846482435,  0.6705052024,  0.7911920436,  0.6612189950,  0.6623186429,  0.4910237840,  0.5275516132,  0.3753987773,  0.4939630732,  0.5651451549,  0.6439671156,  0.5849205587,  0.5114137861,  0.4637432296,  0.6132227414,  0.8060547313,  0.1962590281,  0.5927502821,  0.5931560499,  0.5147652656,  0.5558689441,  0.6269214495,  0.8507522141,  0.2259964909,  0.5956728046,  0.4257167352,  0.5733663191,  0.4722607755,  0.4218119956,  0.6153635445,  0.5785201249,  0.5696048792,  0.6724851208,  0.5701995002,  0.7258396090,  0.3935117023,  0.4586407150,  0.4310385577,  0.5079977324,  0.4371618132,  0.6291977894,  0.4841508907,  0.6531287566,  0.6564799295,  0.4640740309,  0.3308935598,  0.3743820362,  0.3749729556,  0.6861143440,  0.4487690499,  0.1805414017,  0.2640035409,  0.4798727895,  0.6817166167,  0.5109377795,  0.5998688997,  0.3066504697,  0.5565783250,  0.2871613891,  0.5040486997,  0.5786954737,  0.7138225103,  0.2378066612,  0.7419362243,  0.4657306916,  0.6186973570,  0.5087934087,  0.4984674874,  0.5245897002,  0.6003410142,  0.4389079250,  0.3535417638,  0.6241079442,  0.4742876569,  0.6716848900,  0.4985446975,  0.5847787754,  0.4925463137,  0.5369431770,  0.5183328652,  0.6109006529,  0.5587068823,  0.3250137476,  0.4846560186,  0.6055780120,  0.6512212226,  0.5869871067,  0.6299635520,  0.7943254554,  0.2960118739,  0.3707173073,  0.1345308954,  0.7366617780,  0.6063499082,  0.4376598232,  0.4754983994,  0.4701898424,  0.7137386506,  0.6220602024,  0.5055674724,  0.3265512052,  0.7370558544,  0.8046149936,  0.4396730413,  0.5121881371,  0.5250620069,  0.7493366520,  0.3176801458,  0.4151210459,  0.3638219360,  0.3129369743,  0.2276490078,  0.4587645457,  0.5807752686,  0.3465675064,  0.5024502645,  0.5424324079,  0.2999073278,  0.4029679306,  0.5177261083,  0.5362318234,  0.6556881286,  0.4156654351,  0.5236619330,  0.6870961076,  0.4972401091,  0.6382394163,  0.5751587408,  0.6255655617,  0.5463885281,  0.2464810062,  0.4580495287,  0.3713163212,  0.6043568958,  0.4764683564,  0.5108779063,  0.6095900875,  0.4181724019,  0.3013205554,  0.7561916055,  0.5139305052,  0.5137330762,  0.7155613960,  0.3071099714,  0.5600914785,  0.4172473261,  0.4596543843,  0.5695091722,  0.6083419584,  0.3393380653,  0.6383896643,  0.8373064674,  0.6406235400,  0.4175578074,  0.4122180476,  0.6210775627,  0.3821789150,  0.6567473981,  0.6283657855,  0.4116112214,  0.4518565302,  0.4522743013,  0.7604519515,  0.4182491189,  0.4810422212,  0.6320157397,  0.5921241513,  0.5766938495,  0.3247115737,  0.2703896827,  0.4185879263,  0.7592021572,  0.5332725283,  0.6542020920,  0.6328260609,  0.4924104186,  0.4036824886,  0.5118722903,  0.3665288504,  0.3426986470,  0.4015860810,  0.5457729851,  0.5617826399,  0.2457019273,  0.6232354343,  0.6198344522,  0.3336892970,  0.1571112376,  0.5302578543,  0.5896195835,  0.5045548852,  0.1038594426,  0.4827105478,  0.4625021003,  0.6622099645,  0.3906701212,  0.7855141344,  0.4739854013,  0.5974381160,  0.4956047962,  0.3884149227,  0.4735520726,  0.5569370070,  0.3885771241,  0.6921680637,  0.5307979053,  0.4478790041,  0.2521418794,  0.3653833498,  0.4644757108,  0.4920318549,  0.4954566442,  0.5570176214,  0.6502358567,  0.4753184434,  0.4594743395,  0.5482583307,  0.6277798133,  0.6981686206,  0.6187655987,  0.5965462283,  0.5297084261,  0.4279360901,  0.1817626048,  0.2111365738,  0.3798967352,  0.3077189146,  0.5074858352,  0.3020465101,  0.5585563587,  0.4669719417,  0.6258874623,  0.4788181254,  0.6031830563,  0.4192175248,  0.8315681795,  0.7514063990,  0.5105236249,  0.3613152818,  0.6270093033,  0.3523742755,  0.6425440918,  0.3457825041,  0.5677974519,  0.4554885768,  0.3853195932,  0.6944759319,  0.7279363416,  0.6307611619,  0.7266577792,  0.4691833321,  0.4364350803,  0.2740016735,  0.3683804337,  0.3656010469,  0.4847634576,  0.2635796128,  0.4708807769,  0.4251331735,  0.5961937080,  0.7359779525,  0.3960925525,  0.7544216824,  0.4553743674,  0.6277900183,  0.5604000678,  0.4123944519,  0.6697466795,  0.4542655060,  0.6726582582,  0.5178095934,  0.5336656003,  0.7294123494,  0.5737851442,  0.4375373221,  0.5169854604,  0.5647916007,  0.5281703047,  0.4947867579,  0.6033878160,  0.4348261019,  0.6622941134,  0.5181854618,  0.4387885592,  0.5840565870,  0.7078765595,  0.4293114362,  0.5289573078,  0.6357464673,  0.4019810076,  0.4917680291,  0.5141892462,  0.5742675024,  0.6187602570,  0.4924936579,  0.4631088728,  0.2970657923,  0.6183528546,  0.5926991307,  0.3422548365,  0.4630764069,  0.3745998673,  0.5779962672,  0.5943075376,  0.4863586326,  0.5702442510,  0.8110391970,  0.4637084427,  0.7044627148,  0.5141194878,  0.4610210390,  0.4283283243,  0.2124464880,  0.3241674624,  0.8986303116,  0.6650904154,  0.4358467530,  0.3623206466,  0.3086154653,  0.4073734322,  0.3954349869,  0.7140152024,  0.5475629076,  0.3772126235,  0.6549230244,  0.7222120900,  0.6293562288,  0.7074974891,  0.3862122773,  0.5190522868,  0.5086677172,  0.4566653024,  0.6198970108,  0.5534357746,  0.6403650132,  0.4776773409,  0.7993807655,  0.3316596983,  0.5347903151, -0.0073145945,  0.7505758880,  0.7721696602,  0.4786098286,  0.7733355763,  0.4292071198,  0.5524794380,  0.4738381907,  0.4532365578,  0.3864576996,  0.3154620027,  0.4125880055,  0.7336049906,  0.7191266612,  0.4174040603,  0.3966765475,  0.4200732061,  0.5158521385,  0.5179938216,  0.6002159767,  0.6655745967,  0.3359239334,  0.2815784591,  0.3850891300,  0.7365577578,  0.3621555499,  0.6444221888,  0.5666878213,  0.5194972086,  0.7835955228,  0.8471366245,  0.6936365628,  0.2793957788,  0.5781979405,  0.3851868684,  0.5080473573,  0.5638570327,  0.2292095223,  0.5795689538,  0.4331280258,  0.4737607122,  0.5558744047,  0.6336470554,  0.5559408316,  0.4499369967,  0.6496618608,  0.6065969525,  0.3587967152,  0.6153089390,  0.5826552712,  0.6817230843,  0.4902681535,  0.4304772497,  0.3568752494,  0.4414055507,  0.5421596269,  0.6616140050,  0.5645489367,  0.4600724670,  0.5220926673,  0.2790394247,  0.7390774505,  0.3820212110,  0.5281986424,  0.6567182815,  0.4522734618,  0.3908002136,  0.7182619596,  0.6261977128,  0.2436503360,  0.3906712092,  0.4287648988,  0.5611551354,  0.7583334768,  0.3711041209 )
        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
          df = data[[i_rep]]
          this_theta = est_ols(df)
          print(abs(theta_ols[i_rep] - this_theta))
          theta_ols[i_rep] = this_theta
        }

        g_ols = ggplot(data.frame(theta_ols), aes(x = theta_ols)) +
                    geom_density(fill = "dark blue", alpha = 0.3, color = "dark blue") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_ols


Regularization bias in simple ML-approaches
+++++++++++++++++++++++++++++++++++++++++++

A simple ML approach is given by randomly splitting the sample into two parts.
On the auxiliary sample indexed by :math:`i \in I^C` the nuisance function :math:`g_0(X)` is estimated with an ML method.
Given the estimate :math:`\hat{g}_0(X)`, the final estimate of :math:`\theta` is obtained as (:math:`n=N/2`) using the
other half of observations indexed with :math:`i \in I`


.. math::

    \hat{\theta} = \left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i (Y_i - \hat{g}_0(X_i)).

.. tabbed:: Python

    .. ipython:: python

        def non_orth_score(y, d, g_hat, m_hat, smpls):
            u_hat = y - g_hat
            psi_a = -np.multiply(d, d)
            psi_b = np.multiply(d, u_hat)
            return psi_a, psi_b

    .. ipython:: python

        from doubleml import DoubleMLData
        from doubleml import DoubleMLPLR
        from sklearn.ensemble import RandomForestRegressor
        from sklearn.base import clone
        import numpy as np
        np.random.seed(1111)

        learner = RandomForestRegressor(n_estimators=100, max_features=n_vars, max_depth=5, min_samples_leaf=2)
        ml_m = clone(learner)
        ml_g = clone(learner)

        # to speed up the illustration we hard-code the simulation results
        theta_nonorth = np.array([0.29319684, 0.31840615, 0.31223144, 0.21330107, 0.25659459, 0.24835001, 0.34180878, 0.2434044 , 0.39574817, 0.41771943, 0.26560856, 0.28342785, 0.3251033 , 0.21955147, 0.326546  , 0.3666444 , 0.35565926, 0.20386695, 0.27908492, 0.3676557 , 0.23653232, 0.24380573, 0.24229452, 0.21983314, 0.20134483, 0.17584869, 0.35675313, 0.31079762, 0.29343276, 0.39521953, 0.31544726, 0.35182732, 0.19266858, 0.27993025, 0.2625552 , 0.28292512, 0.2504227 , 0.25184899, 0.32404356, 0.25360991, 0.20085518, 0.24903073, 0.32223034, 0.22999957, 0.36521065, 0.29230698, 0.21207339, 0.3155053 , 0.2565405 , 0.28042589, 0.27927371, 0.24020442, 0.31689617, 0.30543755, 0.33658461, 0.24789342, 0.35596227, 0.21703709, 0.28244194, 0.25493631, 0.33369396, 0.33491105, 0.31333223, 0.30679768, 0.33111346, 0.25416343, 0.28499504, 0.27214359, 0.28477609, 0.11725465, 0.30035971, 0.36260626, 0.30574892, 0.29619337, 0.47072922, 0.32151207, 0.35074774, 0.21117695, 0.33625854, 0.35161057, 0.25353144, 0.24231556, 0.17925759, 0.29530721, 0.14742435, 0.17959333, 0.28699551, 0.32394097, 0.27759004, 0.24004821, 0.22557524, 0.27228742, 0.26156933, 0.3225659 , 0.31609126, 0.28303064, 0.22460877, 0.26487577, 0.31546301, 0.29192795, 0.23488023, 0.40330001, 0.25796419, 0.35024425, 0.29272965, 0.20371538, 0.31188784, 0.30727171, 0.30207012, 0.37011565, 0.27569244, 0.24342733, 0.35242927, 0.33346499, 0.2835006 , 0.23589216, 0.32692853, 0.25555251, 0.21043037, 0.23278246, 0.40567014, 0.29273458, 0.32095532, 0.25429688, 0.20978686, 0.37868848, 0.22678583, 0.27186399, 0.37387355, 0.24947016, 0.26737071, 0.29613413, 0.29554816, 0.25821904, 0.17825272, 0.37491785, 0.19583833, 0.36591379, 0.2549919 , 0.36753639, 0.15887216, 0.27815385, 0.2855657 , 0.34708299, 0.23808476, 0.29864112, 0.23332502, 0.37003327, 0.29792418, 0.32318961, 0.3207421 , 0.26794835, 0.2547224 , 0.33712819, 0.12832034, 0.33788336, 0.20525795, 0.21347059, 0.34635817, 0.29988315, 0.30323361, 0.23957384, 0.26197808, 0.17971546, 0.34330474, 0.13339347, 0.37059148, 0.31371407, 0.28624461, 0.27985534, 0.30185459, 0.35130287, 0.33901941, 0.25795781, 0.31584885, 0.30775679, 0.36706445, 0.27068611, 0.2891883 , 0.38371762, 0.25517989, 0.33023073, 0.29958366, 0.28026265, 0.2503629 , 0.26475935, 0.21049856, 0.1423197 , 0.35287324, 0.30344198, 0.15053151, 0.324559  , 0.27280448, 0.16433175, 0.25466775, 0.2745836 , 0.32328078, 0.25970638, 0.17766038, 0.2098045 , 0.28357777, 0.21605416, 0.27122119, 0.27571804, 0.2936043 , 0.19794982, 0.17866909, 0.21235336, 0.29199468, 0.23830312, 0.23033383, 0.35933588, 0.1620826 , 0.17186896, 0.18416139, 0.30637393, 0.26472774, 0.27727687, 0.44740879, 0.28375374, 0.3066991 , 0.29732014, 0.33021236, 0.27559895, 0.34884626, 0.32356646, 0.16272322, 0.33545231, 0.25534704, 0.29852845, 0.37720084, 0.30664904, 0.44687089, 0.26946585, 0.31865206, 0.35660557, 0.17476756, 0.20519534, 0.35203209, 0.27581518, 0.27925961, 0.39696984, 0.34167771, 0.24138579, 0.37792603, 0.2308852 , 0.41492775, 0.26002311, 0.32188474, 0.22756602, 0.30044557, 0.2143263 , 0.24005907, 0.35667131, 0.22619088, 0.25794655, 0.27608715, 0.32097895, 0.33727697, 0.20818261, 0.24644071, 0.30466575, 0.26298512, 0.25662702, 0.24483208, 0.43047575, 0.33397762, 0.35399593, 0.18956857, 0.31086464, 0.14275596, 0.35707408, 0.17847349, 0.45623743, 0.25790341, 0.32341659, 0.26190591, 0.14788621, 0.28693403, 0.29365714, 0.39700133, 0.27012914, 0.3252729 , 0.32146871, 0.3345289 , 0.29520698, 0.38879868, 0.33701645, 0.38698306, 0.21135743, 0.28989781, 0.23002162, 0.18095605, 0.24977852, 0.27216133, 0.22074684, 0.32612241, 0.23451498, 0.23155274, 0.25115124, 0.22946209, 0.37080465, 0.26271139, 0.2331574 , 0.24477204, 0.31580129, 0.37118545, 0.21998636, 0.32829081, 0.28601368, 0.31922825, 0.17514537, 0.37554706, 0.26155049, 0.12972149, 0.41703229, 0.20742184, 0.35163323, 0.17901207, 0.37205129, 0.31401936, 0.25664183, 0.32165039, 0.34636682, 0.26836103, 0.35899911, 0.25426319, 0.40731718, 0.24251142, 0.33523925, 0.24649361, 0.38725382, 0.19132417, 0.2338103 , 0.20397743, 0.24174912, 0.27969103, 0.24087839, 0.28480819, 0.2392837 , 0.42328871, 0.2405941 , 0.316421  , 0.26945591, 0.21905906, 0.3393181 , 0.31728025, 0.29444184, 0.31527138, 0.2289431 , 0.3771293 , 0.28432793, 0.36679193, 0.26713554, 0.36532493, 0.30502709, 0.27736823, 0.20196746, 0.29207574, 0.21556587, 0.32772197, 0.20262584, 0.32476781, 0.25873466, 0.34620529, 0.29935617, 0.16642763, 0.34663595, 0.27357198, 0.2982772 , 0.2314988 , 0.25063713, 0.31574765, 0.28674426, 0.25510278, 0.29910046, 0.3013401 , 0.24221426, 0.3978542 , 0.19700109, 0.33796558, 0.31580919, 0.23913296, 0.32639272, 0.31939073, 0.24759191, 0.30181017, 0.30404123, 0.2199586 , 0.31506155, 0.32422915, 0.29305382, 0.25247297, 0.21021239, 0.26032998, 0.27315551, 0.25212632, 0.31220125, 0.21501468, 0.42037517, 0.21377253, 0.32713257, 0.31418021, 0.2795437 , 0.27236052, 0.28665366, 0.27599028, 0.36403201, 0.37400683, 0.24246052, 0.25156382, 0.25034515, 0.22781666, 0.16727949, 0.20829453, 0.26574614, 0.32446194, 0.18586769, 0.15760543, 0.19925664, 0.19235239, 0.26086358, 0.30401212, 0.22782145, 0.34334088, 0.14627948, 0.3062442 , 0.29297942, 0.33304006, 0.38315349, 0.46590377, 0.2961071 , 0.27611792, 0.33925651, 0.23486769, 0.27318809, 0.23299323, 0.18690162, 0.26601188, 0.33316654, 0.41506294, 0.23462502, 0.31792679, 0.25699156, 0.3876131 , 0.26230957, 0.16928191, 0.25158579, 0.2070323 , 0.18600558, 0.32185997, 0.17230405, 0.23305841, 0.22027967, 0.23728688, 0.34456774, 0.36797653, 0.15093248, 0.29702243, 0.20975122, 0.26149668, 0.31582985, 0.27934859, 0.39253709, 0.30071506, 0.24750077, 0.28515173, 0.25959705, 0.18610014, 0.27691788, 0.30597765, 0.30857929, 0.29784484, 0.27233281, 0.31245188, 0.21266821, 0.24001271, 0.25243079, 0.28468564, 0.32814629, 0.32008091, 0.30770589, 0.4007951 , 0.38673759, 0.29577242, 0.36105942, 0.22222496, 0.32465443, 0.34077791, 0.27961799, 0.26581298, 0.17582005, 0.25421134, 0.20055969, 0.23679547, 0.37920991, 0.27687498, 0.33009316, 0.21521212, 0.37229198, 0.24640521, 0.37133471, 0.33087701, 0.25700688, 0.28865486, 0.20395873, 0.20134789, 0.41165877, 0.36403856, 0.34082548, 0.1911489 , 0.2458969 , 0.24399398, 0.40612449, 0.40687366, 0.28284873, 0.25900919, 0.26050391, 0.19316106, 0.21614061, 0.31498673, 0.26115004, 0.28625721, 0.23141924, 0.23526172, 0.29346302, 0.37407703, 0.29807147, 0.36158063, 0.18973578, 0.4925426 , 0.31404028, 0.34714361, 0.34828088, 0.29817134, 0.22289707, 0.3507302 , 0.37813269, 0.23393946, 0.25365312, 0.37061011, 0.34198828, 0.30826333, 0.25759974, 0.27215007, 0.31859742, 0.30971266, 0.33893234, 0.32067849, 0.31533274, 0.14171065, 0.22870236, 0.24468148, 0.37954881, 0.28879696, 0.32565767, 0.24073966, 0.24477197, 0.38713123, 0.28208479, 0.28028966, 0.35180517, 0.13896571, 0.27460199, 0.34498357, 0.35840354, 0.26501797, 0.24719994, 0.38345119, 0.26542125, 0.26892174, 0.25980829, 0.21219918, 0.29915366, 0.33709222, 0.26477143, 0.30082016, 0.22205185, 0.24135321, 0.25896329, 0.27433097, 0.31751965, 0.23741986, 0.34162057, 0.31637418, 0.24616973, 0.20866684, 0.29308645, 0.26946817, 0.18029697, 0.23213092, 0.3272268 , 0.30925319, 0.34352314, 0.24100002, 0.2935282 , 0.21217536, 0.30401715, 0.26930965, 0.26283796, 0.41262901, 0.41025537, 0.22624398, 0.22155853, 0.27518809, 0.22958604, 0.30585373, 0.24801936, 0.23922312, 0.38973797, 0.32953543, 0.31376603, 0.28214616, 0.22996967, 0.29459341, 0.32026782, 0.28212886, 0.3141234 , 0.25450605, 0.2281625 , 0.25325933, 0.35504011, 0.23994727, 0.26219842, 0.35210459, 0.34979984, 0.27873991, 0.31598357, 0.28785034, 0.32573893, 0.36294896, 0.35413158, 0.27939219, 0.27436846, 0.34141719, 0.2510968 , 0.28478198, 0.48027739, 0.21290708, 0.3448923 , 0.24738578, 0.26994387, 0.29477065, 0.22314961, 0.30959474, 0.26492522, 0.38316418, 0.25156742, 0.34927883, 0.20908885, 0.26999617, 0.35343235, 0.30228772, 0.33787966, 0.22634276, 0.33010634, 0.26729395, 0.32410384, 0.16898097, 0.39029219, 0.27314103, 0.32954321, 0.40718884, 0.34020381, 0.23845998, 0.30376588, 0.32920799, 0.36046021, 0.2139594 , 0.27729576, 0.2627463 , 0.21606684, 0.21692553, 0.27241316, 0.35847809, 0.27756088, 0.3112457 , 0.22817825, 0.24076747, 0.3485126 , 0.38160213, 0.29835211, 0.26714476, 0.12172368, 0.34813552, 0.40019165, 0.35481774, 0.18447926, 0.26753618, 0.31162233, 0.18207261, 0.36366675, 0.18792699, 0.17845665, 0.26822811, 0.32174025, 0.33915387, 0.36974784, 0.25623063, 0.3505247 , 0.29268366, 0.29502533, 0.23791722, 0.22480179, 0.20797668, 0.22843705, 0.26060172, 0.34559641, 0.33075109, 0.29154998, 0.17506779, 0.40922365, 0.32391234, 0.31525306, 0.24737843, 0.31168529, 0.18289927, 0.32788822, 0.27563492, 0.23207472, 0.25275258, 0.26766764, 0.24839109, 0.27624132, 0.34317465, 0.28597101, 0.31796601, 0.26668254, 0.34324541, 0.28340665, 0.31155751, 0.26450331, 0.23816392, 0.27773972, 0.36095836, 0.33361369, 0.38941858, 0.1934152 , 0.31910934, 0.35391103, 0.24717574, 0.29170106, 0.13608657, 0.34946051, 0.32978011, 0.28974828, 0.40412635, 0.25718237, 0.20917514, 0.29336392, 0.31834754, 0.39534384, 0.377525  , 0.27984207, 0.2611942 , 0.45504852, 0.26819527, 0.29593522, 0.30072384, 0.27772612, 0.20591858, 0.24460663, 0.33253005, 0.31414112, 0.25752077, 0.30515717, 0.2958151 , 0.29908035, 0.34519822, 0.21390263, 0.255619  , 0.19645229, 0.26358932, 0.21695193, 0.32616397, 0.26568104, 0.37924359, 0.40788188, 0.30958615, 0.27918601, 0.28233053, 0.24696353, 0.25926154, 0.22315697, 0.29290969, 0.37519665, 0.13700712, 0.28288805, 0.27115335, 0.34500685, 0.30067907, 0.22967867, 0.20945214, 0.33677418, 0.29349561, 0.27971383, 0.21687752, 0.21439806, 0.3040365 , 0.19724053, 0.19431075, 0.29937213, 0.13991248, 0.35703645, 0.25022749, 0.27888559, 0.25257467, 0.15812217, 0.32429678, 0.31307669, 0.31110078, 0.23503492, 0.27567851, 0.34933315, 0.26637685, 0.27437971, 0.29887281, 0.25437893, 0.32804333, 0.25517129, 0.32624261, 0.30818378, 0.33665691, 0.25485245, 0.34054008, 0.28722171, 0.16125703, 0.31100509, 0.20788044, 0.26865956, 0.28267972, 0.17606888, 0.2464257 , 0.29432742, 0.29093306, 0.34917428, 0.3131915 , 0.28269665, 0.27450994, 0.34060333, 0.1611629 , 0.2583948 , 0.29976931, 0.1690698 , 0.27318073, 0.23783928, 0.3472381 , 0.30807657, 0.27193936, 0.36001817, 0.29930924, 0.32817252, 0.31023429, 0.32385623, 0.26935814, 0.32371182, 0.23675695, 0.36532003, 0.21114686, 0.40356034, 0.27415229, 0.34925102, 0.34139483, 0.22968727, 0.22189511, 0.38603935, 0.38341789, 0.27129872, 0.2050083 , 0.29786157, 0.28388557, 0.25213282, 0.24934106, 0.28368466, 0.19737474, 0.17556709, 0.34283217, 0.34575408, 0.25779986, 0.39944258, 0.25762786, 0.35609135, 0.39902364, 0.24469687, 0.16505124, 0.37074506, 0.29948662, 0.25388669, 0.18420502, 0.36455915, 0.31538916, 0.32632153, 0.26363196, 0.26300757, 0.24221963, 0.2455832 , 0.26117476, 0.11555666, 0.27081887, 0.39253464, 0.31743827, 0.33979268, 0.20979431, 0.22644027, 0.1944916 , 0.17493588, 0.27738256, 0.20720776, 0.22320087, 0.37081578, 0.25118571, 0.15345798, 0.32626107, 0.28168503, 0.27939485, 0.14938423, 0.26394828, 0.2635838 , 0.2313757 , 0.3523135 , 0.3599672 , 0.29293004, 0.25985955, 0.31377221, 0.34501481, 0.20813081, 0.22527715, 0.40425807, 0.23440039, 0.260185  , 0.31564136, 0.21534504, 0.20893064, 0.30806966, 0.29505211, 0.31448366, 0.29072767, 0.28258194, 0.28801394, 0.23111009, 0.22035274, 0.29706831, 0.27670521, 0.20682787, 0.15758223, 0.23297569, 0.33843577, 0.33158128, 0.19926417, 0.32296074, 0.24813818, 0.21652956, 0.24979186, 0.24950038, 0.22569088, 0.37113768, 0.30798443, 0.23541823, 0.25514065, 0.27408747, 0.23496553, 0.21193389, 0.27317648, 0.30666689, 0.30886513, 0.33145074, 0.30266963, 0.25960121, 0.33044062, 0.33390467, 0.39959554, 0.3063657 , 0.27558343, 0.31338648, 0.22957856, 0.32061607, 0.20468418, 0.30246092, 0.26548053, 0.25675625, 0.38064923, 0.19447888, 0.20874608, 0.35848563, 0.27297357, 0.26689161, 0.29202662, 0.2490595 , 0.23875537, 0.39059001, 0.2318199 , 0.34861821, 0.21427262, 0.32231824, 0.2935788 , 0.3069678 , 0.32836187, 0.32886618, 0.31457978, 0.25469999])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr_nonorth = DoubleMLPLR(obj_dml_data,
                                              ml_m, ml_g,
                                              n_folds=2,
                                              apply_cross_fitting=False,
                                              score=non_orth_score)
            obj_dml_plr_nonorth.fit()
            this_theta = obj_dml_plr_nonorth.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_nonorth[i_rep] - this_theta))
            theta_nonorth[i_rep] = this_theta

        ax = sns.kdeplot(theta_nonorth, shade=True, color=colors[1])
        @savefig nonorth.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        non_orth_score = function(y, d, g_hat, m_hat, smpls) {
         u_hat = y - g_hat
         psi_a = -1*d*d
         psi_b = d*u_hat
         psis = list(psi_a = psi_a, psi_b = psi_b)
         return(psis)
        }


    .. jupyter-execute::

        library(mlr3)
        library(mlr3learners)
        library(data.table)
        lgr::get_logger("mlr3")$set_threshold("warn")
        set.seed(1111)

        learner = lrn("regr.ranger", num.trees=100, mtry=n_vars, min.node.size=2, max.depth=5)
        ml_m = learner$clone()
        ml_g = learner$clone()

        # to speed up the illustration we hard-code the simulation results
        theta_nonorth = c(0.335140973, 0.419119658, 0.543364882, 0.465531595, 0.489423796, 0.580690927, 0.446899757, 0.272292296, 0.240826014, 0.365608710, 0.268312379, 0.354473099, 0.385506555, 0.615247222, 0.463371670, 0.410046844, 0.544959995, 0.489229912, 0.457527626, 0.614892818, 0.338072758, 0.394127768, 0.276357084, 0.433449188, 0.249084049, 0.528947106, 0.451120107, 0.327303152, 0.546307385, 0.395934562, 0.301388718, 0.239982004, 0.530202292, 0.169856178, 0.322835980, 0.065608845, 0.154554350, 0.430897491, 0.424487779, 0.324143676, 0.389261597, 0.272135966, 0.351868551, 0.256792473, 0.504886282, 0.474738538, 0.384538245, 0.483251852, 0.363105174, 0.216916587, 0.294053708, 0.479088598, 0.269570359, 0.377226775, 0.437593329, 0.225371600, 0.470220118, 0.580390685, 0.304737611, 0.305733674, 0.354465325, 0.436580536, 0.445360886, 0.368723539, 0.157181386, 0.155664995, 0.464140152, 0.480734551, 0.362887864, 0.337695182, 0.642324202, 0.310090948, 0.349702691, 0.305153800, 0.316219058, 0.381051853, 0.320910647, 0.469491087, 0.424923136, 0.429822780, 0.275509449, 0.323183059, 0.555469839, 0.191757655, 0.236563643, 0.431688361, 0.428128667, 0.352089478, 0.099148330, 0.444152504, 0.394307625, 0.255398535, 0.438946752, 0.253313216, 0.112699448, 0.477861515, 0.458580858, 0.583866474, 0.340893368, 0.591232974, 0.346205252, 0.543514451, 0.460809329, 0.231994475, 0.284534860, 0.328665723, 0.316603063, 0.364736497, 0.326819423, 0.360088787, 0.437105307, 0.340068129, 0.437790456, 0.293644690, 0.256570227, 0.391332290, 0.379705449, 0.345781442, 0.192708760, 0.495761272, 0.357445752, 0.289328987, 0.271279462, 0.246514418, 0.321481385, 0.547511147, 0.323289625, 0.421790101, 0.361704227, 0.183561036, 0.240601590, 0.373376260, 0.418223589, 0.234931680, 0.298725451, 0.334964767, 0.445040143, 0.411404746, 0.296765746, 0.342425930, 0.439660376, 0.449429060, 0.350347796, 0.501114430, 0.141751964, 0.460308677, 0.308125041, 0.412797756, 0.348937055, 0.320860597, 0.501787986, 0.402516515, 0.307775795, 0.265250174, 0.249370199, 0.237803476, 0.490491083, 0.392297291, 0.476605166, 0.596921313, 0.329334145, 0.168666169, 0.514855555, 0.361304938, 0.458823659, 0.218943774, 0.190659814, 0.399702615, 0.496828233, 0.364189324, 0.355013117, 0.347135933, 0.303363453, 0.388743993, 0.351564875, 0.461375525, 0.304952081, 0.305842312, 0.371825913, 0.529941260, 0.369612156, 0.227549238, 0.476589099, 0.409674606, 0.648042086, 0.454762542, 0.325161264, 0.474848225, 0.238840882, 0.246974012, 0.281007912, 0.485805697, 0.349186121, 0.240147788, 0.400154659, 0.350860610, 0.321397152, 0.329311833, 0.412791960, 0.416868304, 0.365255439, 0.224506192, 0.627734333, 0.315886799, 0.187565232, 0.321475886, 0.277727795, 0.298443734, 0.490262959, 0.260242409, 0.312206710, 0.352033429, 0.330884704, 0.258199280, 0.430870900, 0.325387453, 0.366884342, 0.388394987, 0.332531847, 0.456149765, 0.480522342, 0.198383637, 0.200533915, 0.269881924, 0.339918216, 0.453854936, 0.473168756, 0.460025119, 0.284768638, 0.360963578, 0.210442939, 0.299954368, 0.389141673, 0.361433498, 0.443818155, 0.380874367, 0.315574954, 0.514698977, 0.369786833, 0.342736404, 0.496349510, 0.539101645, 0.301455561, 0.273359613, 0.470802282, 0.435284567, 0.515617885, 0.284359396, 0.311403925, 0.324005567, 0.421392063, 0.256040305, 0.362017892, 0.108460158, 0.417848346, 0.345052901, 0.353888756, 0.741506986, 0.161336896, 0.293882645, 0.476037398, 0.266737080, 0.367479836, 0.327191264, 0.425098060, 0.359771576, 0.333680127, 0.508258363, 0.438388046, 0.447304806, 0.345523609, 0.354589932, 0.233374756, 0.265137181, 0.471825879, 0.441535845, 0.478299974, 0.261401313, 0.253694077, 0.389227934, 0.151084071, 0.216476808, 0.434783644, 0.383682580, 0.369379689, 0.395303966, 0.477838459, 0.477345702, 0.236623921, 0.446704627, 0.487379232, 0.486646465, 0.374339318, 0.403405009, 0.428196936, 0.503129243, 0.261579463, 0.311989682, 0.399559119, 0.336342308, 0.331440153, 0.311817569, 0.339955801, 0.438178493, 0.303263754, 0.311021038, 0.322706001, 0.350160553, 0.404341702, 0.462992184, 0.484585397, 0.322914772, 0.380903082, 0.372895224, 0.494503321, 0.376222458, 0.263453702, 0.212001186, 0.206101464, 0.402869130, 0.307022824, 0.245072507, 0.341579181, 0.340076578, 0.323873052, 0.350493163, 0.374368353, 0.345401596, 0.484073763, 0.467629075, 0.370743983, 0.307891115, 0.355864551, 0.349524997, 0.501745160, 0.373259961, 0.279370083, 0.404280389, 0.336302484, 0.290459812, 0.369968539, 0.386063016, 0.291498533, 0.472107093, 0.511800910, 0.296789379, 0.354125519, 0.397164911, 0.284529256, 0.266605833, 0.468921615, 0.306733555, 0.450476901, 0.429390637, 0.457733702, 0.328539326, 0.464024308, 0.319834497, 0.291051384, 0.187504646, 0.320121836, 0.373484884, 0.377095582, 0.300383363, 0.356479139, 0.518074771, 0.204405049, 0.256728209, 0.277996528, 0.355067317, 0.347816105, 0.509663585, 0.359005309, 0.515155727, 0.414259172, 0.322550472, 0.431219627, 0.497130001, 0.306405854, 0.389096941, 0.294762528, 0.409165634, 0.526968478, 0.498261463, 0.386643164, 0.353553613, 0.289264782, 0.451660768, 0.354498899, 0.346401761, 0.362479556, 0.490482003, 0.300499925, 0.365950487, 0.463450420, 0.409386840, 0.437135825, 0.477276728, 0.374835113, 0.471459955, 0.317641644, 0.377487222, 0.409667390, 0.365647394, 0.683162610, 0.303956062, 0.350092979, 0.388688672, 0.425086766, 0.192703569, 0.314456859, 0.358980806, 0.540660147, 0.557628591, 0.399092559, 0.385539080, 0.428395125, 0.313604117, 0.435173473, 0.356767828, 0.317945303, 0.333478406, 0.476416061, 0.460356934, 0.351449073, 0.453482456, 0.438485812, 0.310906017, 0.425545726, 0.325719525, 0.291101464, 0.427739312, 0.478049200, 0.366784116, 0.566479803, 0.350997656, 0.422443725, 0.246050759, 0.327444477, 0.361307319, 0.242988027, 0.377053194, 0.275613021, 0.415468868, 0.422776793, 0.359050276, 0.528717053, 0.313634999, 0.356947595, 0.200907078, 0.399720937, 0.327297663, 0.380470971, 0.303243450, 0.500775951, 0.423237635, 0.455580744, 0.379470024, 0.402841811, 0.301316543, 0.358466596, 0.273453625, 0.211050240, 0.434917719, 0.274622589, 0.449705393, 0.339627456, 0.472216715, 0.380793513, 0.384042691, 0.366380049, 0.454601828, 0.415306052, 0.513485538, 0.413571153, 0.386022194, 0.396414864, 0.363385855, 0.539084724, 0.401781638, 0.376258335, 0.346800862, 0.384002303, 0.326469334, 0.434814724, 0.400579017, 0.460159315, 0.353903194, 0.499363765, 0.232547763, 0.232564916, 0.266990117, 0.414387525, 0.594481017, 0.490436714, 0.257643830, 0.282652268, 0.499380590, 0.209764607, 0.452525097, 0.401005504, 0.241387376, 0.514194424, 0.309129314, 0.192709257, 0.460768752, 0.307039760, 0.479250881, 0.248454217, 0.377990206, 0.474953138, 0.368718681, 0.367159917, 0.487032194, 0.370486581, 0.132188936, 0.474676072, 0.339631945, 0.371568718, 0.346894293, 0.343915725, 0.408455880, 0.327992936, 0.573465772, 0.105733748, 0.456422400, 0.378515264, 0.224312940, 0.236924394, 0.338491432, 0.273814255, 0.399651979, 0.412017716, 0.339779593, 0.417965495, 0.396977134, 0.521484459, 0.189024390, 0.347512488, 0.423387014, 0.326135924, 0.501089002, 0.326132998, 0.363300144, 0.394970152, 0.338453130, 0.280115693, 0.437511874, 0.412136434, 0.241792635, 0.295666218, 0.438673780, 0.361559612, 0.496279292, 0.453798513, 0.245295668, 0.428392321, 0.126031399, 0.510682481, 0.390449407, 0.228420596, 0.286048111, 0.379206238, 0.394883570, 0.491426439, 0.193032422, 0.305096156, 0.354194364, 0.579224984, 0.342043732, 0.390492050, 0.277006110, 0.469745573, 0.379774110, 0.309866153, 0.453854505, 0.345495657, 0.447641691, 0.303964288, 0.265606346, 0.466886820, 0.347185498, 0.325633159, 0.481563940, 0.377888927, 0.458034044, 0.334010356, 0.492107866, 0.368891103, 0.374029506, 0.404582659, 0.344048436, 0.396998064, 0.423475820, 0.393839980, 0.350385859, 0.419196586, 0.479369640, 0.406476723, 0.493885804, 0.493830576, 0.430547609, 0.245253355, 0.295811700, 0.370462972, 0.497123923, 0.321285055, 0.238457679, 0.485029248, 0.332094918, 0.252361578, 0.335483683, 0.312229195, 0.111410838, 0.326746105, 0.267873416, 0.276625154, 0.486442383, 0.215542851, 0.357352136, 0.477885889, 0.390483119, 0.187146035, 0.323648334, 0.398040684, 0.463534208, 0.422516715, 0.349567706, 0.190730003, 0.374008497, 0.211617207, 0.539066120, 0.492327357, 0.484193727, 0.396276179, 0.222275099, 0.223295994, 0.383016116, 0.430018144, 0.405205576, 0.369757431, 0.325261981, 0.332207771, 0.279902575, 0.440659393, 0.458007408, 0.307655431, 0.351093956, 0.240580133, 0.157912429, 0.148631500, 0.388270077, 0.428377296, 0.464658277, 0.547458196, 0.343747548, 0.464763618, 0.442402608, 0.298135575, 0.366879649, 0.403171234, 0.408571518, 0.371649742, 0.412264789, 0.544746757, 0.199998170, 0.345996131, 0.156902042, 0.373194969, 0.490788064, 0.268865466, 0.442148841, 0.392444262, 0.462180076, 0.481726746, 0.575920973, 0.364584350, 0.414224161, 0.359697880, 0.419804955, 0.375292175, 0.308715779, 0.419298124, 0.433660436, 0.483664021, 0.321657282, 0.186040713, 0.412721970, 0.497239807, 0.338048993, 0.172343263, 0.275620489, 0.435058348, 0.216433071, 0.214581385, 0.257363811, 0.284767601, 0.315271565, 0.367446703, 0.378256919, 0.507091716, 0.432197509, 0.189776354, 0.263273411, 0.173107806, 0.386394819, 0.471893999, 0.416010835, 0.206716349, 0.562301528, 0.418366630, 0.397968577, 0.328290443, 0.302770598, 0.447752908, 0.328169170, 0.279351598, 0.350158028, 0.586152494, 0.345625386, 0.293558999, 0.282989334, 0.505090054, 0.347839648, 0.388295622, 0.374452600, 0.360014750, 0.345468555, 0.453368488, 0.339163738, 0.342396266, 0.323552646, 0.416536941, 0.476901662, 0.413115606, 0.432054897, 0.234474818, 0.410548306, 0.465261717, 0.307511182, 0.369528328, 0.269677954, 0.427906665, 0.445906859, 0.385045155, 0.368498033, 0.459465967, 0.345708130, 0.379837337, 0.394960482, 0.502255777, 0.478909263, 0.323189120, 0.374278793, 0.270686466, 0.277117398, 0.417217659, 0.426015414, 0.456790541, 0.322189137, 0.544548505, 0.253578860, 0.322975900, 0.362919840, 0.307711447, 0.364220168, 0.359471201, 0.373375671, 0.243844850, 0.290917892, 0.597136684, 0.254036144, 0.234842559, 0.455002949, 0.415709324, 0.443531265, 0.299394678, 0.273685693, 0.339751460, 0.290479625, 0.418674294, 0.367702267, 0.361132947, 0.447685742, 0.498754389, 0.270269135, 0.295705938, 0.484246007, 0.311986189, 0.304280505, 0.406538045, 0.370420053, 0.456776894, 0.457377674, 0.296940275, 0.377566228, 0.367587126, 0.427966186, 0.324805655, 0.420154277, 0.385518258, 0.434303736, 0.484742044, 0.420268053, 0.543945352, 0.614640782, 0.181089220, 0.538398740, 0.172360743, 0.401025849, 0.399125170, 0.301969996, 0.458273275, 0.352292564, 0.428755908, 0.281922745, 0.166868747, 0.383126737, 0.461700376, 0.321581217, 0.294979582, 0.645734516, 0.480530595, 0.369117806, 0.447472411, 0.367004384, 0.325281361, 0.372054625, 0.559420414, 0.420927754, 0.441013621, 0.268351322, 0.471931821, 0.377414999, 0.398822036, 0.586611520, 0.398019082, 0.332722226, 0.404158484, 0.335375695, 0.613275439, 0.442884130, 0.153235309, 0.331616205, 0.391264091, 0.357352172, 0.413816771, 0.408433901, 0.419759530, 0.228831898, 0.242195246, 0.325805978, 0.177510323, 0.287290644, 0.423608328, 0.346624498, 0.398904327, 0.312968780, 0.385049936, 0.355245850, 0.353788611, 0.622340341, 0.347298462, 0.487055228, 0.347159344, 0.642501454, 0.286065916, 0.272343803, 0.341502439, 0.502706623, 0.423043196, 0.392224835, 0.305042008, 0.413321735, 0.283283665, 0.335373677, 0.411467352, 0.016942860, 0.370115682, 0.556011768, 0.392865030, 0.301642465, 0.284051455, 0.493041813, 0.422299781, 0.283624328, 0.323970631, 0.360579274, 0.648236531, 0.492726100, 0.341422713, 0.506488260, 0.536233398, 0.399949932, 0.427973590, 0.427325204, 0.309583227, 0.320272411, 0.344996672, 0.406182681, 0.467704420, 0.443549638, 0.246331343, 0.255539278, 0.321713488, 0.241197032, 0.356909474, 0.403565810, 0.424665343, 0.449729106, 0.507606334, 0.463193632, 0.333415140, 0.447615303, 0.384183785, 0.414546057, 0.400747334, 0.537751757, 0.475605296, 0.238143678, 0.536313754, 0.421732910, 0.218056684, 0.202829815, 0.283549436, 0.275632531, 0.424492510, 0.404217234, 0.201301262, 0.424716609, 0.281339577, 0.514103586, 0.355023207, 0.140366294, 0.444906239, 0.367123147, 0.310100700, 0.457209742, 0.432594605, 0.583239047, 0.439187967, 0.411749513, 0.276365926, 0.282221109, 0.440751034, 0.607766309, 0.490552742, 0.170092443, 0.514622764, 0.387188302, 0.388399891, 0.500914171, 0.496650245, 0.589290271, 0.736033060, 0.397034165, 0.317624864, 0.298077378, 0.457904806, 0.183291084, 0.167276433, 0.458485644, 0.073808155, 0.344174108, 0.516475697, 0.422334218, 0.165966943, 0.457473721, 0.250581393, 0.481856213, 0.451418497, 0.407934704, 0.448765138, 0.343626739, 0.319897801, 0.387265723, 0.381855560, 0.314778127, 0.353790288, 0.535941667, 0.341841593, 0.407951513, 0.442824003, 0.262223904, 0.326596401, 0.321151280, 0.433902619, 0.465935076, 0.442801441, 0.310250453, 0.356294623, 0.240147508, 0.506087974, 0.367953065, 0.308278430, 0.352030300, 0.226553727, 0.398012138, 0.339787484, 0.320898727 )
        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr_nonorth = DoubleMLPLR$new(obj_dml_data,
                                                  ml_g, ml_m,
                                                  n_folds=2,
                                                  score=non_orth_score,
                                                  apply_cross_fitting=FALSE)
            obj_dml_plr_nonorth$fit()
            this_theta = obj_dml_plr_nonorth$coef
            print(abs(theta_nonorth[i_rep] - this_theta))
            theta_nonorth[i_rep] = this_theta
        }

        g_nonorth = ggplot(data.frame(theta_nonorth), aes(x = theta_nonorth)) +
                        geom_density(fill = "dark orange", alpha = 0.3, color = "dark orange") +
                        geom_vline(aes(xintercept = alpha), col = "black") +
                        xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_nonorth


The regularization bias in the simple ML-approach is caused by the slow convergence of :math:`\hat{\theta}`

.. math::

    |\sqrt{n} (\hat{\theta} - \theta) | \rightarrow_{P} \infty

i.e. slower than :math:`1/\sqrt{n}`.
The driving factor is the bias in learning :math:`g`.
A Heuristic illustration is given by

.. math::

    \sqrt{n}(\hat{\theta} - \theta) = \underbrace{\left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i U_i}_{=:a}
    +  \underbrace{\left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i (g_0(X_i) - \hat{g}_0(X_i))}_{=:b}.

:math:`a` is approximately Gaussian under mild conditions.
However, :math:`b` (the regularization bias) diverges in general.

.. _bias_non_orth:

Overcoming regularization bias by orthogonalization
+++++++++++++++++++++++++++++++++++++++++++++++++++

To overcome the regularization bias we are directly partialling out the effect of :math:`X` from :math:`D` to obtain the
orthogonalized regressor :math:`V = D - m(X)`. We then use the final estimate

.. math::

    \check{\theta} = \left(\frac{1}{n} \sum_{i\in I} \hat{V}_i D_i\right)^{-1} \frac{1}{n} \sum_{i\in I} \hat{V}_i (Y_i - \hat{g}_0(X_i)).

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        np.random.seed(2222)

        # to speed up the illustration we hard-code the simulation results
        theta_orth_nosplit = np.array([0.40001928, 0.37391323, 0.36308174, 0.36397944, 0.38541354, 0.3647171 , 0.40384992, 0.35925774, 0.40405829, 0.45272764, 0.40589423, 0.39377149, 0.41607069, 0.30492928, 0.36393528, 0.35385938, 0.38820243, 0.32989575, 0.3950756 , 0.37300714, 0.36545957, 0.33376852, 0.35256856, 0.36745957, 0.37102312, 0.34407758, 0.38984721, 0.36315858, 0.34772464, 0.39907514, 0.39374186, 0.43632286, 0.30719141, 0.32357411, 0.36874534, 0.34185308, 0.3631246 , 0.42268676, 0.38962016, 0.36641865, 0.34184314, 0.35062047, 0.36312652, 0.29401635, 0.40708813, 0.37791416, 0.3791789 , 0.37336375, 0.38507954, 0.44364113, 0.37275674, 0.37871017, 0.40828118, 0.39711773, 0.42601953, 0.33105222, 0.39585972, 0.43057969, 0.34452166, 0.36048483, 0.37794291, 0.40790173, 0.42418859, 0.38581412, 0.43188922, 0.33496595, 0.34463871, 0.3740169 , 0.42040489, 0.4057572 , 0.35336546, 0.36826517, 0.35224745, 0.39656492, 0.38819845, 0.39556661, 0.39492787, 0.39160303, 0.37582737, 0.40836546, 0.37592515, 0.36888467, 0.36023196, 0.35917169, 0.31524108, 0.39645808, 0.38930541, 0.37679351, 0.42913451, 0.39257438, 0.31370033, 0.33008828, 0.4284092 , 0.37201739, 0.38960731, 0.36442073, 0.38552077, 0.37666163, 0.48631475, 0.4088208 , 0.34498681, 0.43395948, 0.35941184, 0.40336225, 0.35556994, 0.43595662, 0.37842213, 0.40400933, 0.32198722, 0.36822364, 0.31142137, 0.35557807, 0.31839808, 0.33508737, 0.35310067, 0.38252933, 0.37534813, 0.37612325, 0.36934383, 0.35994186, 0.35715418, 0.44296029, 0.36743584, 0.36233167, 0.3015209 , 0.43576511, 0.33934909, 0.35533359, 0.35842759, 0.32351336, 0.41555779, 0.33858524, 0.37568617, 0.35843984, 0.36415919, 0.42145838, 0.41801671, 0.41663198, 0.31566444, 0.36326722, 0.35382034, 0.33178367, 0.44348583, 0.37095711, 0.42932865, 0.32469571, 0.32093132, 0.40160851, 0.35380148, 0.40504826, 0.3974217 , 0.38126728, 0.34374086, 0.36263591, 0.37124129, 0.46183988, 0.34940501, 0.37324977, 0.3188404 , 0.45117178, 0.3625096 , 0.36526825, 0.40936905, 0.41393585, 0.37869091, 0.35503858, 0.42627007, 0.36684799, 0.37608838, 0.3889056 , 0.40241684, 0.36906768, 0.37472092, 0.3531769 , 0.37551279, 0.37727005, 0.38937792, 0.46217379, 0.37782073, 0.35427822, 0.35297377, 0.40282625, 0.38365911, 0.3128854 , 0.30541763, 0.33503233, 0.3131235 , 0.3570351 , 0.40264212, 0.39558471, 0.33638786, 0.34186089, 0.3706435 , 0.29921387, 0.34671158, 0.37515507, 0.35998719, 0.40269215, 0.36606708, 0.34727916, 0.3964172 , 0.4308127 , 0.37397258, 0.37908462, 0.35550212, 0.33847138, 0.37118469, 0.35680909, 0.41848221, 0.40910494, 0.32729232, 0.46065445, 0.34459009, 0.29925887, 0.3227665 , 0.40430184, 0.35947231, 0.42583399, 0.39264917, 0.38338045, 0.43812287, 0.38281252, 0.37412672, 0.41700389, 0.38997648, 0.41027076, 0.39887435, 0.39220661, 0.44667408, 0.35197091, 0.40839143, 0.45209609, 0.4854438 , 0.35984437, 0.39423685, 0.43863703, 0.39093657, 0.35288801, 0.4397813 , 0.3871005 , 0.37778353, 0.40302877, 0.36125463, 0.41313949, 0.36067965, 0.33348316, 0.39962313, 0.36046663, 0.30451561, 0.31436114, 0.35565845, 0.37132819, 0.40666967, 0.39291165, 0.40295233, 0.30137892, 0.37572141, 0.38910604, 0.45560371, 0.36628338, 0.34611358, 0.31946706, 0.36373672, 0.36290657, 0.32529586, 0.39611899, 0.35310936, 0.42265876, 0.39885886, 0.32070258, 0.33339491, 0.34807571, 0.3008017 , 0.43347475, 0.40705414, 0.41674307, 0.40116894, 0.34334819, 0.3652796 , 0.38690629, 0.39948237, 0.35624796, 0.44379513, 0.36134902, 0.39043792, 0.40062084, 0.42713632, 0.38826038, 0.4267711 , 0.32855835, 0.3934872 , 0.40711174, 0.36893045, 0.34430599, 0.35327016, 0.38025061, 0.4990183 , 0.32497223, 0.42042386, 0.31622936, 0.3845819 , 0.44199202, 0.40472012, 0.35178447, 0.34843387, 0.38243416, 0.37708262, 0.32599582, 0.41200995, 0.37592255, 0.37834844, 0.32644963, 0.36207232, 0.42825537, 0.31530526, 0.35193491, 0.25959322, 0.39757105, 0.37261522, 0.38220709, 0.45142696, 0.33491789, 0.40776485, 0.39904373, 0.40776978, 0.35872097, 0.38864564, 0.36338925, 0.36164464, 0.34967735, 0.36396066, 0.43237291, 0.34351456, 0.35134618, 0.36176665, 0.3578046 , 0.45026987, 0.29329639, 0.41276502, 0.37373708, 0.37778935, 0.33909472, 0.3825095 , 0.34375536, 0.32434162, 0.43193363, 0.38970205, 0.40210207, 0.38724759, 0.34272059, 0.37373754, 0.35249926, 0.41151054, 0.35227197, 0.44718949, 0.42365257, 0.3739113 , 0.34358956, 0.33013519, 0.35346691, 0.38489312, 0.35225214, 0.41610397, 0.38223922, 0.39665339, 0.41339714, 0.36907582, 0.42374678, 0.38524038, 0.36085989, 0.31655061, 0.37696926, 0.36065944, 0.36892628, 0.32763272, 0.34931115, 0.4260696 , 0.36570993, 0.35202871, 0.33243539, 0.41358266, 0.36117919, 0.40821946, 0.35451097, 0.39068749, 0.34932853, 0.40351363, 0.37338521, 0.33198775, 0.34546106, 0.38870774, 0.37487984, 0.41485181, 0.37819235, 0.3444466 , 0.31210797, 0.36536734, 0.3585581 , 0.37276796, 0.39038369, 0.35372052, 0.35770557, 0.34884474, 0.41060923, 0.35855565, 0.3754773 , 0.37705445, 0.36425304, 0.36813507, 0.35759128, 0.39519617, 0.31883331, 0.33481559, 0.30294863, 0.3417548 , 0.36674413, 0.42152389, 0.36753216, 0.32171057, 0.34289769, 0.3560997 , 0.38603148, 0.37512908, 0.36306193, 0.41412217, 0.39053237, 0.40267606, 0.36691473, 0.38739647, 0.4171407 , 0.44489486, 0.31748   , 0.41482869, 0.35578538, 0.34258253, 0.37325434, 0.39639158, 0.38074552, 0.38273402, 0.35443547, 0.43075305, 0.4041138 , 0.40898089, 0.38242225, 0.3691925 , 0.34541086, 0.385363  , 0.37520769, 0.39151627, 0.38908748, 0.37646241, 0.34469022, 0.40290612, 0.36785716, 0.34992955, 0.36480184, 0.42123525, 0.36785073, 0.33123989, 0.40012545, 0.40659565, 0.36670067, 0.36191338, 0.29588814, 0.37312647, 0.34450584, 0.41318293, 0.36830677, 0.33650682, 0.39740905, 0.34176039, 0.36255794, 0.39656271, 0.34226146, 0.33676304, 0.39863481, 0.37353873, 0.35562713, 0.34678962, 0.35397938, 0.37667251, 0.34768794, 0.44232947, 0.37778086, 0.36194223, 0.31841387, 0.41601059, 0.45841643, 0.41726768, 0.38971096, 0.3615244 , 0.34464587, 0.32016425, 0.35866142, 0.34102194, 0.43715451, 0.42918335, 0.40681994, 0.31614225, 0.38457513, 0.32693288, 0.39855689, 0.39965807, 0.33575816, 0.40958387, 0.31303368, 0.30116879, 0.40875235, 0.42010187, 0.3670462 , 0.37005269, 0.34600724, 0.38423086, 0.45565091, 0.4075572 , 0.38656348, 0.34823337, 0.40672543, 0.34702377, 0.33763111, 0.36848661, 0.34351093, 0.40765753, 0.35455126, 0.36658001, 0.43232251, 0.38002381, 0.39626922, 0.37470471, 0.33188491, 0.45238551, 0.35766247, 0.40136229, 0.40085299, 0.34099208, 0.35867416, 0.44196904, 0.39799583, 0.39557137, 0.33924171, 0.40664603, 0.38649806, 0.33890776, 0.33571103, 0.36178626, 0.32561263, 0.38989618, 0.41930585, 0.35879548, 0.38260298, 0.37959771, 0.38320536, 0.40644429, 0.46036703, 0.35928164, 0.40456807, 0.3703464 , 0.36396502, 0.36222125, 0.32160536, 0.32060248, 0.41835681, 0.36036523, 0.37223746, 0.37364487, 0.38060943, 0.4087947 , 0.38203536, 0.44316304, 0.40369167, 0.31823117, 0.37607956, 0.30894414, 0.36593423, 0.39484666, 0.38495636, 0.37091047, 0.344995  , 0.34522012, 0.45476102, 0.32879695, 0.46335482, 0.41390145, 0.38299544, 0.3478091 , 0.30508563, 0.25788365, 0.34417653, 0.37548332, 0.31559959, 0.35250302, 0.37518343, 0.34191062, 0.41173967, 0.33789068, 0.36083339, 0.37212116, 0.34153455, 0.39955205, 0.38214725, 0.37826086, 0.40799408, 0.40414415, 0.35654331, 0.38867323, 0.39627225, 0.37085042, 0.41217105, 0.35672309, 0.39028068, 0.39691158, 0.41215798, 0.41185912, 0.31927866, 0.33923031, 0.34686718, 0.39160909, 0.39914311, 0.37219483, 0.38711755, 0.41833532, 0.4075456 , 0.37910866, 0.39925244, 0.31736814, 0.35622151, 0.30780188, 0.38266598, 0.39246002, 0.42789418, 0.37768803, 0.49802608, 0.37222247, 0.36255244, 0.37235673, 0.441084  , 0.34552991, 0.41865159, 0.35272684, 0.36665575, 0.34459399, 0.45355361, 0.36238447, 0.3940214 , 0.41563089, 0.30784041, 0.40532945, 0.35047921, 0.40777292, 0.33807763, 0.41170668, 0.41847632, 0.3229755 , 0.34919152, 0.37602639, 0.35764439, 0.37919626, 0.42789052, 0.32479458, 0.40656109, 0.35942197, 0.42795907, 0.42178479, 0.37430742, 0.3594821 , 0.41440698, 0.35120302, 0.37670767, 0.34015444, 0.35686015, 0.42889141, 0.36608222, 0.40993091, 0.34429054, 0.3950648 , 0.34619943, 0.3602255 , 0.35568094, 0.31484337, 0.40194631, 0.43142201, 0.35767893, 0.3838824 , 0.4071251 , 0.37998851, 0.46975559, 0.3423469 , 0.36946962, 0.38608829, 0.38124941, 0.4012503 , 0.39802026, 0.46122726, 0.33159043, 0.39760405, 0.36865209, 0.42865276, 0.39717176, 0.33976851, 0.35605032, 0.33303654, 0.41360348, 0.32096278, 0.38594815, 0.34268407, 0.35379911, 0.4281709 , 0.38618201, 0.36661045, 0.38085064, 0.31483165, 0.40219091, 0.38286771, 0.37351899, 0.36708458, 0.38886385, 0.31246683, 0.43668857, 0.39498873, 0.31789358, 0.35644839, 0.39724234, 0.39324696, 0.40169982, 0.39143351, 0.32184708, 0.35742505, 0.3553842 , 0.38381159, 0.4252446 , 0.36776472, 0.39457504, 0.39134822, 0.41879626, 0.39985936, 0.3598499 , 0.33797701, 0.39034027, 0.41110237, 0.38722897, 0.39546593, 0.35475288, 0.46662869, 0.38648158, 0.41740426, 0.35272521, 0.41189599, 0.39212775, 0.37394017, 0.34465552, 0.37506786, 0.45274256, 0.39040896, 0.38499868, 0.41025248, 0.45289013, 0.33040533, 0.4206823 , 0.41810672, 0.34234731, 0.36635969, 0.39868398, 0.40740216, 0.3487334 , 0.3684021 , 0.39842957, 0.33778305, 0.40680549, 0.44988675, 0.38084697, 0.32520345, 0.37972098, 0.34855965, 0.3335882 , 0.35493294, 0.30038498, 0.37995591, 0.38329241, 0.3713927 , 0.37405192, 0.36780832, 0.31504347, 0.33406286, 0.33658461, 0.43945234, 0.34716015, 0.36633356, 0.36133551, 0.35967686, 0.41488804, 0.43615878, 0.36982913, 0.35167351, 0.40145525, 0.37297699, 0.45283849, 0.33275454, 0.37397552, 0.41599255, 0.36625249, 0.34064723, 0.35701413, 0.36229925, 0.35441231, 0.37409266, 0.36191122, 0.37258104, 0.36389199, 0.40936828, 0.35942624, 0.42557527, 0.44162361, 0.35905005, 0.35521254, 0.43260028, 0.34506343, 0.37593818, 0.36634496, 0.3791138 , 0.37239845, 0.39537278, 0.37742375, 0.42449894, 0.34116406, 0.42180961, 0.3930474 , 0.33319946, 0.37302795, 0.33566649, 0.33855726, 0.35796936, 0.38957767, 0.422651  , 0.39985559, 0.37471674, 0.46037463, 0.37215373, 0.3568127 , 0.35044192, 0.30720257, 0.34597545, 0.37958671, 0.40859707, 0.40356913, 0.4519151 , 0.35556564, 0.39574165, 0.37859138, 0.3677757 , 0.34430123, 0.27408725, 0.42790453, 0.35137221, 0.36628569, 0.34516025, 0.42150124, 0.34079594, 0.41236038, 0.36351485, 0.37356844, 0.40794707, 0.40046451, 0.42245609, 0.30739235, 0.40548092, 0.40480409, 0.37983063, 0.38360541, 0.40449139, 0.40043292, 0.33300848, 0.40949876, 0.38578454, 0.34847574, 0.31840413, 0.31554551, 0.37761179, 0.40156503, 0.3814114 , 0.43932064, 0.37264881, 0.38376388, 0.39972841, 0.37333311, 0.42005324, 0.32283845, 0.40612175, 0.3738961 , 0.35382731, 0.31703621, 0.419838  , 0.36337648, 0.35585304, 0.43294994, 0.33380524, 0.40448412, 0.38686772, 0.32781478, 0.3883739 , 0.42930206, 0.33721595, 0.36460544, 0.35110877, 0.35457233, 0.38980433, 0.32714994, 0.40629809, 0.3001643 , 0.4005793 , 0.42266842, 0.37730864, 0.36729098, 0.33792152, 0.32971545, 0.43005192, 0.36994985, 0.40517234, 0.36060753, 0.34352767, 0.39749167, 0.44900376, 0.39123799, 0.3707553 , 0.34466515, 0.41541919, 0.37094542, 0.36066029, 0.4030567 , 0.33306289, 0.4251346 , 0.35943752, 0.33270913, 0.44412164, 0.417759  , 0.3887691 , 0.42244357, 0.40871404, 0.38964918, 0.35687496, 0.37631172, 0.36547202, 0.4326922 , 0.38354621, 0.34163407, 0.36605822, 0.32700064, 0.36247681, 0.32461241, 0.357158  , 0.38543326, 0.46429449, 0.38894153, 0.36282777, 0.41773433, 0.31510457, 0.38434146, 0.37526389, 0.33252803, 0.3815958 , 0.3566598 , 0.41237545, 0.37128323, 0.37616103, 0.30245403, 0.42499999, 0.39983854, 0.3680776 , 0.35406263, 0.40911188, 0.32070078, 0.38785558, 0.36099076, 0.32987217, 0.36092565, 0.30339202, 0.36388319, 0.39233829, 0.353423  , 0.35282661, 0.38403738, 0.36623352, 0.40644562, 0.3726407 , 0.39589529, 0.35380977, 0.37687277, 0.43741286, 0.424962  , 0.44086745, 0.40033519, 0.3743433 , 0.37034677, 0.2780654 , 0.41968544, 0.40875204, 0.36862512, 0.39604901, 0.38384861, 0.37429416, 0.42576152])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr_orth_nosplit = DoubleMLPLR(obj_dml_data,
                                                   ml_g, ml_m,
                                                   n_folds=1,
                                                   score='IV-type',
                                                   apply_cross_fitting=False)
            obj_dml_plr_orth_nosplit.fit()
            this_theta = obj_dml_plr_orth_nosplit.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_orth_nosplit[i_rep] - this_theta))
            theta_orth_nosplit[i_rep] = this_theta

        ax = sns.kdeplot(theta_orth_nosplit, shade=True, color=colors[2])
        @savefig orth_nosplit.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        library(data.table)
        lgr::get_logger("mlr3")$set_threshold("warn")
        set.seed(2222)

        # to speed up the illustration we hard-code the simulation results
        theta_orth_nosplit = c(0.24404981, 0.24200765, 0.27908831, 0.25502043, 0.32824182, 0.26923132, 0.24104406, 0.20969115, 0.32043631, 0.19615339, 0.26752732, 0.28054535, 0.20565819, 0.23094579, 0.30052261, 0.22506210, 0.30899243, 0.33166896, 0.29901923, 0.21645924, 0.19363222, 0.25194347, 0.20642525, 0.24555231, 0.22453258, 0.30131307, 0.23932457, 0.24134974, 0.32292519, 0.24820202, 0.29051209, 0.19341549, 0.25560635, 0.24635088, 0.25058896, 0.19513198, 0.23325175, 0.25732967, 0.25630722, 0.23618513, 0.17672957, 0.21211532, 0.26970909, 0.23979100, 0.24278216, 0.31524081, 0.21496712, 0.23975950, 0.22430487, 0.25032633, 0.31171158, 0.28673753, 0.23617691, 0.30279132, 0.25171843, 0.21937215, 0.24240521, 0.23905356, 0.18858651, 0.20627836, 0.18322578, 0.25066665, 0.27527609, 0.27380098, 0.16270080, 0.22131889, 0.22989677, 0.25631445, 0.30572004, 0.28186739, 0.28453591, 0.31102750, 0.28063015, 0.25876131, 0.29582343, 0.24814810, 0.35109199, 0.25108377, 0.22487320, 0.30794975, 0.23894645, 0.26638033, 0.23674057, 0.20538273, 0.19608607, 0.33079935, 0.19395816, 0.21966814, 0.18736528, 0.21029872, 0.29902640, 0.26053716, 0.25603558, 0.21075900, 0.20782755, 0.28236968, 0.25193825, 0.28224143, 0.23540541, 0.26424208, 0.29290447, 0.24258066, 0.27822969, 0.20114274, 0.23819599, 0.25825846, 0.30886038, 0.21687679, 0.26809187, 0.29897851, 0.28606557, 0.25426056, 0.17297763, 0.22302356, 0.24706098, 0.24361315, 0.20613373, 0.20395747, 0.26581544, 0.27803372, 0.28981682, 0.28375231, 0.26902671, 0.22007559, 0.21972414, 0.22691012, 0.23230200, 0.19660759, 0.22971657, 0.24840646, 0.27392351, 0.23431585, 0.23109943, 0.22423472, 0.17548714, 0.27187182, 0.23154822, 0.23570134, 0.20276194, 0.20357300, 0.29668416, 0.23894281, 0.29103412, 0.26916173, 0.20825452, 0.27174241, 0.28702397, 0.26323370, 0.20993333, 0.22861364, 0.28225493, 0.25282767, 0.25466747, 0.20584595, 0.25209117, 0.26527392, 0.24857230, 0.30070528, 0.29237504, 0.28291041, 0.26424070, 0.20749123, 0.33763761, 0.17805976, 0.23412056, 0.31256005, 0.24081702, 0.24795085, 0.29925883, 0.25657520, 0.17849887, 0.27372626, 0.23904392, 0.22488373, 0.24942245, 0.29803576, 0.23674057, 0.27779304, 0.25638963, 0.22914358, 0.22338097, 0.23024613, 0.22301133, 0.29410433, 0.30106813, 0.27284832, 0.24042849, 0.24791942, 0.25071209, 0.25156142, 0.23516980, 0.24695011, 0.25794186, 0.27033305, 0.27898959, 0.22825721, 0.26305627, 0.28653743, 0.24861610, 0.29348304, 0.22902869, 0.30333429, 0.26935249, 0.19811759, 0.27767260, 0.19347321, 0.33130437, 0.25953422, 0.26075776, 0.17054191, 0.22197221, 0.26321300, 0.27792267, 0.20024470, 0.31713220, 0.23528659, 0.28108999, 0.21161821, 0.18928942, 0.25071159, 0.32293010, 0.18651541, 0.20749911, 0.22686192, 0.30217232, 0.27595429, 0.26376699, 0.28513188, 0.29005017, 0.22022413, 0.18666795, 0.18394129, 0.22996187, 0.29361925, 0.24450357, 0.29357722, 0.22286200, 0.28265768, 0.22675825, 0.27649261, 0.28951131, 0.28271866, 0.17806041, 0.21163621, 0.30509409, 0.26342174, 0.32677576, 0.24797358, 0.23200651, 0.27904545, 0.26504825, 0.19402431, 0.26306555, 0.31078689, 0.24485790, 0.26520010, 0.21393591, 0.25235737, 0.23623305, 0.21269470, 0.36499369, 0.21848834, 0.28736613, 0.25397938, 0.25896726, 0.14757031, 0.15458744, 0.25966165, 0.29306232, 0.29959702, 0.34040452, 0.24615155, 0.16853516, 0.28525494, 0.23482806, 0.23951146, 0.26795442, 0.26138905, 0.28521849, 0.30644821, 0.22308750, 0.20662353, 0.26295613, 0.23490771, 0.20767176, 0.25672486, 0.23762899, 0.24988185, 0.21882009, 0.32730028, 0.31310884, 0.25821877, 0.23069627, 0.22345636, 0.19806570, 0.29756479, 0.21450103, 0.27358563, 0.24101731, 0.23376150, 0.22875492, 0.30380284, 0.27886358, 0.25644140, 0.27983788, 0.29336975, 0.20603135, 0.23124943, 0.25156872, 0.30053623, 0.27771452, 0.19847193, 0.25991230, 0.25088226, 0.25607595, 0.29055568, 0.20725805, 0.20844012, 0.26323932, 0.26251734, 0.29311885, 0.29691861, 0.28589456, 0.28678294, 0.23915972, 0.26246128, 0.24366650, 0.25425399, 0.31767331, 0.25261640, 0.21726079, 0.30237963, 0.22177598, 0.19588260, 0.23795208, 0.26311371, 0.28360425, 0.21153313, 0.17872878, 0.23587613, 0.25150900, 0.25867927, 0.26743636, 0.19428422, 0.24070189, 0.26749686, 0.21719999, 0.26282296, 0.23008293, 0.28084342, 0.22708225, 0.26011481, 0.25512443, 0.24929613, 0.26494690, 0.32442653, 0.24635223, 0.23136118, 0.29793829, 0.22573153, 0.20318348, 0.26693828, 0.24952603, 0.27215040, 0.26322105, 0.22329061, 0.27891631, 0.27127217, 0.27125980, 0.27248351, 0.22775018, 0.25404143, 0.25163026, 0.30982078, 0.20748986, 0.27073473, 0.23114844, 0.20224835, 0.30671944, 0.19242940, 0.24885178, 0.22356225, 0.29483575, 0.25740248, 0.18617692, 0.24523393, 0.25576838, 0.35176784, 0.25000509, 0.29496086, 0.18229425, 0.31624955, 0.21398406, 0.31201873, 0.27873516, 0.29288879, 0.21909350, 0.33838391, 0.28401419, 0.28814919, 0.25356693, 0.28313276, 0.29096662, 0.24443356, 0.27196073, 0.22707857, 0.23169359, 0.23623725, 0.29841002, 0.19643420, 0.22633211, 0.28084501, 0.26918329, 0.36923637, 0.21106338, 0.27083820, 0.23144420, 0.31389920, 0.22205859, 0.22125093, 0.26983642, 0.26984812, 0.27143384, 0.22440664, 0.24382201, 0.29489124, 0.27572998, 0.23011901, 0.21742103, 0.24521077, 0.24721123, 0.29630124, 0.29493903, 0.28724526, 0.27999346, 0.24368907, 0.22984274, 0.17392723, 0.27441598, 0.25581560, 0.22590773, 0.28188015, 0.22709537, 0.31067150, 0.32512125, 0.23057776, 0.30177850, 0.23242622, 0.28326166, 0.29190056, 0.25107901, 0.23130449, 0.24929647, 0.19796943, 0.26118980, 0.28361317, 0.28984450, 0.24239718, 0.23415392, 0.27891457, 0.31708859, 0.25101173, 0.24828103, 0.26219254, 0.26629355, 0.30090049, 0.21231956, 0.28541164, 0.31735485, 0.23788811, 0.21526438, 0.22865108, 0.26906438, 0.21838840, 0.26907421, 0.26570784, 0.20624892, 0.30029962, 0.34755127, 0.31459386, 0.28203083, 0.26903597, 0.29458419, 0.23009954, 0.24293185, 0.29547741, 0.22776509, 0.25928743, 0.27324063, 0.19938081, 0.34164972, 0.27462158, 0.22935702, 0.32378804, 0.25564062, 0.23829308, 0.17257210, 0.27254683, 0.20348844, 0.31883511, 0.30223972, 0.28047451, 0.25603642, 0.27022816, 0.28062654, 0.25154276, 0.25218666, 0.26535623, 0.21176103, 0.21301494, 0.26220526, 0.27431630, 0.27729789, 0.24779401, 0.24868582, 0.18360005, 0.26786428, 0.24958852, 0.22578138, 0.27438830, 0.32905933, 0.31888969, 0.24873045, 0.28213371, 0.20563072, 0.24977431, 0.30339369, 0.24085435, 0.17003776, 0.25333376, 0.28797501, 0.30977813, 0.25259406, 0.30296617, 0.26677033, 0.22128846, 0.30456640, 0.24690890, 0.30914977, 0.33190582, 0.26943920, 0.32514576, 0.25079613, 0.28332654, 0.22076585, 0.27260810, 0.21275210, 0.32582630, 0.28814724, 0.22820021, 0.23679701, 0.26929291, 0.20674902, 0.21578408, 0.23102393, 0.19422745, 0.26693484, 0.24910152, 0.25459030, 0.28373457, 0.23307690, 0.22377395, 0.22574906, 0.29702891, 0.25427968, 0.21206913, 0.24253494, 0.23148299, 0.28956044, 0.27245119, 0.27969498, 0.21298051, 0.27298282, 0.26791011, 0.23978439, 0.26989927, 0.20125381, 0.26407324, 0.30557669, 0.22319726, 0.31493078, 0.22910660, 0.21667511, 0.23672426, 0.25941675, 0.29885728, 0.21517201, 0.28029613, 0.32394264, 0.27670934, 0.34767623, 0.25234206, 0.28996521, 0.27791141, 0.25572864, 0.24964783, 0.21480398, 0.28467806, 0.28029405, 0.19916957, 0.30238731, 0.25757664, 0.21437019, 0.22555528, 0.28787462, 0.30702164, 0.23218925, 0.23998290, 0.24108701, 0.19807579, 0.27532625, 0.29797673, 0.33230228, 0.24863314, 0.26096881, 0.31315212, 0.24171227, 0.25872465, 0.22154767, 0.27599649, 0.26455210, 0.23163402, 0.27558069, 0.27989725, 0.27851760, 0.21170799, 0.28618903, 0.19861032, 0.22324798, 0.30309738, 0.17963283, 0.26532334, 0.24133140, 0.26011628, 0.31859660, 0.22378082, 0.26713240, 0.27861435, 0.21975233, 0.32211484, 0.28379428, 0.24634791, 0.21500082, 0.24459111, 0.22421237, 0.25253544, 0.23511794, 0.30314989, 0.17381773, 0.25880032, 0.21234982, 0.23865437, 0.25171010, 0.30581337, 0.28307510, 0.28132029, 0.25098349, 0.24429769, 0.32528412, 0.24508261, 0.27625946, 0.26367128, 0.30872965, 0.24758068, 0.31172295, 0.24418416, 0.20467152, 0.23338737, 0.24866117, 0.27964005, 0.27014072, 0.30935446, 0.25824221, 0.27114065, 0.24802035, 0.22854418, 0.22945380, 0.21464254, 0.25982662, 0.30725683, 0.22635262, 0.24299934, 0.24783000, 0.31402718, 0.23889412, 0.29329641, 0.24323276, 0.25997723, 0.29938332, 0.21108355, 0.17714399, 0.23398678, 0.31824499, 0.22832691, 0.23374580, 0.23741578, 0.19794363, 0.19985305, 0.25941090, 0.33144872, 0.27671553, 0.23529043, 0.25156616, 0.21581062, 0.14069085, 0.28701229, 0.28376436, 0.25324103, 0.24521140, 0.26348733, 0.31471963, 0.27928279, 0.23140739, 0.24005349, 0.27719299, 0.22549446, 0.17181816, 0.26914335, 0.26147563, 0.23488390, 0.20516042, 0.23104556, 0.33939887, 0.22747521, 0.26699641, 0.26940843, 0.24175948, 0.27359773, 0.26232683, 0.27280967, 0.28311917, 0.24809043, 0.23792607, 0.29930390, 0.28970429, 0.20569726, 0.25444149, 0.33283531, 0.32671300, 0.25556005, 0.21977557, 0.21200236, 0.24466482, 0.21267102, 0.28793926, 0.21491347, 0.27112680, 0.27976902, 0.28284870, 0.25920649, 0.27500549, 0.28002343, 0.30423065, 0.32924577, 0.17173157, 0.18553040, 0.23845241, 0.22745331, 0.32056756, 0.22080223, 0.29517097, 0.30737837, 0.25486917, 0.23718771, 0.28089043, 0.31238705, 0.25876756, 0.24292196, 0.22375197, 0.24283881, 0.35410498, 0.23368806, 0.19522686, 0.25769016, 0.25454050, 0.31319123, 0.17947042, 0.19190434, 0.30265186, 0.19946304, 0.30086939, 0.20109633, 0.25334314, 0.20911893, 0.28693220, 0.22298880, 0.27593279, 0.30214048, 0.26325374, 0.21294424, 0.27791242, 0.26954320, 0.29819193, 0.17927875, 0.23121506, 0.26231314, 0.25083801, 0.28033401, 0.26820107, 0.27022253, 0.22792994, 0.21512806, 0.30392373, 0.37016435, 0.31230905, 0.29721586, 0.27724949, 0.25459834, 0.15951586, 0.19782845, 0.21939142, 0.23747047, 0.24440075, 0.28495355, 0.29067143, 0.22289957, 0.19727838, 0.26182810, 0.26700056, 0.20850858, 0.22248073, 0.30294435, 0.28396686, 0.25325660, 0.28110754, 0.30402911, 0.25165942, 0.28631568, 0.21262876, 0.26504292, 0.23227707, 0.20243507, 0.24853321, 0.19272924, 0.26087873, 0.32408585, 0.21510694, 0.27491827, 0.25804386, 0.22382809, 0.30728360, 0.27347877, 0.24220788, 0.19617423, 0.24985472, 0.29069347, 0.32784967, 0.23223983, 0.28298148, 0.24628940, 0.30607884, 0.23767203, 0.20429131, 0.26093432, 0.22608648, 0.22543390, 0.23870808, 0.22717988, 0.30429532, 0.21939188, 0.24270492, 0.32245359, 0.30286073, 0.22104531, 0.22910319, 0.32607062, 0.21411771, 0.25257003, 0.24598362, 0.23180878, 0.27113287, 0.25057170, 0.19189994, 0.23257955, 0.27667730, 0.22466231, 0.25881201, 0.23175854, 0.24960139, 0.32826814, 0.28951057, 0.21486691, 0.17778950, 0.26021780, 0.27643750, 0.17872446, 0.28002911, 0.21805482, 0.38678121, 0.25471786, 0.21297770, 0.32726096, 0.28189860, 0.22361958, 0.28245412, 0.26690088, 0.30962131, 0.25677141, 0.23710782, 0.23152883, 0.27632201, 0.27235424, 0.21711356, 0.21794149, 0.20043823, 0.20760472, 0.20909603, 0.31225668, 0.27529778, 0.19133858, 0.24952837, 0.32137579, 0.25944996, 0.31970595, 0.24870416, 0.26509979, 0.26355110, 0.29517943, 0.34637904, 0.24146828, 0.28212012, 0.23472525, 0.24156734, 0.23788934, 0.24383514, 0.14396294, 0.33060120, 0.29607903, 0.20853050, 0.28021850, 0.23598870, 0.25251283, 0.26717264, 0.20898575, 0.24692804, 0.28417276, 0.21140865, 0.31535353, 0.25921238, 0.27417029, 0.26054656, 0.29587580, 0.20549704, 0.27341285, 0.29240708, 0.32059263, 0.23118675, 0.17993850, 0.26216515, 0.28442858, 0.23133134, 0.26663198, 0.33022619, 0.31993129, 0.30955249, 0.33249114, 0.29334380, 0.19866766, 0.30970885, 0.21414314, 0.18668980, 0.20812096, 0.27479207, 0.25533000, 0.24358777, 0.26188038, 0.25086771, 0.25654017, 0.22080933, 0.19350181, 0.25724694, 0.26805649, 0.13882816, 0.26080592, 0.27079933, 0.24554024, 0.23415862, 0.25285817, 0.27472101, 0.24890736, 0.35753835, 0.26952921, 0.22867552, 0.21595742, 0.25398338, 0.26967079, 0.27074357, 0.21771453, 0.28066849, 0.18347077, 0.24902906, 0.23107295, 0.35380816, 0.26439250, 0.23904248, 0.26452052, 0.28343627, 0.24538294, 0.25790816, 0.21900178  )
        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)){
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr_orth_nosplit = DoubleMLPLR$new(obj_dml_data,
                                                   ml_g, ml_m,
                                                   n_folds=1,
                                                   score='IV-type',
                                                   apply_cross_fitting=FALSE)
            obj_dml_plr_orth_nosplit$fit()
            this_theta = obj_dml_plr_orth_nosplit$coef
            print(abs(theta_orth_nosplit[i_rep] - this_theta))
            theta_orth_nosplit[i_rep] = this_theta
        }

        g_nosplit = ggplot(data.frame(theta_orth_nosplit), aes(x = theta_orth_nosplit)) +
                    geom_density(fill = "dark green", alpha = 0.3, color = "dark green") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_nosplit


If the nuisance models :math:`\hat{g}_0()` and :math:`\hat{m}()` are estimate on the whole dataset which is also used for obtaining
the final estimate :math:`\check{\theta}` another bias can be observed.

.. _bias_overfitting:

Sample splitting to remove bias induced by overfitting
++++++++++++++++++++++++++++++++++++++++++++++++++++++

Using sample splitting, i.e., estimate the nuisance models :math:`\hat{g}_0()` and :math:`\hat{m}()` on one part of the
data (training data) and estimate :math:`\check{\theta}` on the other part of the data (test data) overcomes the bias
induced by overfitting. Cross-fitting performs well empirically.

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        np.random.seed(3333)

        # to speed up the illustration we hard-code the simulation results
        theta_dml = np.array([0.54288123, 0.55371181, 0.46339388, 0.49385475, 0.49213487, 0.5050111 , 0.58988897, 0.48236908, 0.59217066, 0.68522203, 0.54380239, 0.52029499, 0.57284115, 0.4452564 , 0.50441597, 0.47650409, 0.54015765, 0.4494413 , 0.51149339, 0.50135583, 0.45471109, 0.43816486, 0.49635474, 0.53906716, 0.44338049, 0.47216099, 0.53343896, 0.53398806, 0.45514509, 0.53182394, 0.5303002 , 0.59774184, 0.42232608, 0.41028   , 0.48106874, 0.45175907, 0.51987224, 0.5646365 , 0.52328251, 0.60129572, 0.45353462, 0.50068965, 0.51352137, 0.40257158, 0.56185356, 0.51313695, 0.47868459, 0.48287266, 0.53839614, 0.56937954, 0.48854769, 0.52246533, 0.53382   , 0.49055279, 0.57694377, 0.45368641, 0.54769772, 0.57136253, 0.48699937, 0.44713082, 0.53278924, 0.61622837, 0.58404215, 0.47695354, 0.57401785, 0.45826163, 0.45183085, 0.50876734, 0.55230931, 0.5525642 , 0.51221464, 0.47471202, 0.43182669, 0.48680894, 0.52992376, 0.51947981, 0.53100123, 0.50903748, 0.47147659, 0.55365849, 0.46354071, 0.49771178, 0.49184555, 0.49907314, 0.45997543, 0.48476604, 0.57464762, 0.51354284, 0.54057693, 0.51580169, 0.44953565, 0.49137078, 0.59612721, 0.52669037, 0.58384796, 0.5223915 , 0.5890493 , 0.54512917, 0.59141874, 0.56064394, 0.47962013, 0.59676291, 0.47192364, 0.49610932, 0.55024611, 0.56388654, 0.53474486, 0.50483367, 0.42511813, 0.51894994, 0.46555202, 0.47976104, 0.49473788, 0.48674666, 0.51802349, 0.49883541, 0.48041863, 0.48991678, 0.50315856, 0.45638511, 0.50304149, 0.57999991, 0.50017858, 0.48184566, 0.41348744, 0.59922079, 0.46788614, 0.53816671, 0.47716643, 0.41114365, 0.54517718, 0.46920287, 0.5513536 , 0.4812061 , 0.49303468, 0.56928813, 0.56281834, 0.56134251, 0.47101611, 0.51214381, 0.4449861 , 0.46967615, 0.66494507, 0.52411009, 0.5627987 , 0.46889612, 0.43322021, 0.54225098, 0.47493747, 0.55515923, 0.59001373, 0.55045017, 0.46257442, 0.57645122, 0.5125088 , 0.64325479, 0.49696001, 0.52841445, 0.48363358, 0.57992595, 0.50376609, 0.49412297, 0.53749749, 0.55120499, 0.49548393, 0.44926652, 0.61120697, 0.57560467, 0.5326141 , 0.45642576, 0.55800428, 0.51337626, 0.47870204, 0.47898159, 0.49427373, 0.54115408, 0.50890063, 0.57227194, 0.54011276, 0.48522659, 0.48264631, 0.59157632, 0.52172118, 0.46068703, 0.44879916, 0.49233865, 0.44551616, 0.48969064, 0.58951441, 0.53296876, 0.46373658, 0.49411278, 0.49759449, 0.38396783, 0.52089373, 0.52621081, 0.4838764 , 0.60379733, 0.47195369, 0.47158175, 0.51786732, 0.54475883, 0.50852276, 0.53318138, 0.47926804, 0.45619227, 0.50260623, 0.54202818, 0.4985257 , 0.58083738, 0.49965165, 0.61791868, 0.41490793, 0.40957736, 0.45771652, 0.5276147 , 0.44166667, 0.56142333, 0.5396268 , 0.54399625, 0.5603477 , 0.50688066, 0.47792653, 0.54546745, 0.49763558, 0.60469747, 0.50601012, 0.50086284, 0.61122109, 0.43873687, 0.56353642, 0.63164213, 0.6655241 , 0.52014402, 0.49188033, 0.59537227, 0.51097082, 0.45484618, 0.59893759, 0.51668152, 0.48513793, 0.53441438, 0.46361776, 0.52071106, 0.49173985, 0.46711264, 0.56188561, 0.47680123, 0.46876735, 0.41519849, 0.48184913, 0.49327555, 0.50168819, 0.50622028, 0.49621954, 0.40299829, 0.48457349, 0.54311977, 0.61214234, 0.49524956, 0.51907762, 0.45570902, 0.5141557 , 0.4907405 , 0.46856077, 0.54663006, 0.50657429, 0.50710349, 0.52861611, 0.45056299, 0.46437207, 0.48729905, 0.41781897, 0.60918909, 0.57086807, 0.55678849, 0.57762845, 0.42506485, 0.52038609, 0.55889078, 0.52330059, 0.51058693, 0.55722153, 0.47343708, 0.49456868, 0.52850052, 0.60359548, 0.48583537, 0.60985179, 0.42306727, 0.55830886, 0.56450183, 0.5023707 , 0.53918371, 0.48830692, 0.52639965, 0.65310452, 0.41605668, 0.60650297, 0.40384292, 0.5540774 , 0.60327977, 0.50982093, 0.46057863, 0.42980553, 0.48275956, 0.54745587, 0.42612266, 0.51881336, 0.55630213, 0.52818715, 0.448852  , 0.49142825, 0.5408009 , 0.43427999, 0.48774935, 0.37876327, 0.54186573, 0.5349062 , 0.54993939, 0.67252298, 0.45452935, 0.58202535, 0.54358087, 0.51920907, 0.52043039, 0.48373032, 0.50878891, 0.4403581 , 0.51515119, 0.4804859 , 0.55334542, 0.43517394, 0.44945722, 0.52748988, 0.48059059, 0.63433224, 0.38657828, 0.54196978, 0.50538468, 0.47964171, 0.46324595, 0.51417836, 0.44501977, 0.48243664, 0.541168  , 0.51142664, 0.54107284, 0.55089771, 0.4889118 , 0.47989282, 0.47446686, 0.58407023, 0.50681244, 0.62763976, 0.59114501, 0.54602667, 0.49708495, 0.47690188, 0.47033221, 0.55975611, 0.46505781, 0.55328171, 0.54508166, 0.6053623 , 0.53304524, 0.51387898, 0.55728172, 0.5309572 , 0.50511962, 0.45684557, 0.49275603, 0.47789289, 0.48390916, 0.46768712, 0.4680081 , 0.55672889, 0.45635084, 0.4895981 , 0.40400326, 0.55612157, 0.50309062, 0.53872531, 0.52818503, 0.56509319, 0.45802902, 0.55746355, 0.53745026, 0.43922291, 0.47271576, 0.50979356, 0.51405123, 0.50596611, 0.48391823, 0.42509758, 0.41495324, 0.49400391, 0.50834419, 0.50270474, 0.53361532, 0.47550126, 0.4379097 , 0.49619306, 0.59187293, 0.49083569, 0.53105003, 0.46823576, 0.48224406, 0.53703992, 0.51623097, 0.50182542, 0.44415112, 0.42868143, 0.40507765, 0.50786408, 0.47974999, 0.53334098, 0.48899422, 0.41220893, 0.48448626, 0.52558846, 0.50606804, 0.49527948, 0.51170001, 0.55484841, 0.5080514 , 0.54684739, 0.4672308 , 0.52501485, 0.57952153, 0.55416348, 0.44838364, 0.55772562, 0.47629212, 0.47861361, 0.51545903, 0.59180565, 0.52759925, 0.52150478, 0.48280741, 0.54607199, 0.56641874, 0.57572268, 0.50245113, 0.48998946, 0.43407436, 0.55008705, 0.50068967, 0.54284476, 0.55825218, 0.5301717 , 0.43552436, 0.57160797, 0.49540104, 0.50659788, 0.54352645, 0.56329468, 0.48614516, 0.45815761, 0.54469478, 0.53058589, 0.48369298, 0.54072482, 0.43254562, 0.47888438, 0.46790166, 0.56443991, 0.52367178, 0.4860834 , 0.53665246, 0.47242828, 0.48634781, 0.56650099, 0.45879876, 0.45823984, 0.56632343, 0.51110318, 0.48258134, 0.51983996, 0.52339937, 0.48171847, 0.48478394, 0.62268801, 0.4756197 , 0.5022304 , 0.45939683, 0.55872411, 0.59955496, 0.61981263, 0.58407476, 0.45784569, 0.45454045, 0.48236482, 0.50875611, 0.47021639, 0.56335066, 0.58578129, 0.54189485, 0.43979271, 0.53246033, 0.49300375, 0.55107142, 0.55327048, 0.41151374, 0.5782344 , 0.4559725 , 0.39182657, 0.55674415, 0.62358707, 0.5140278 , 0.48536104, 0.48678686, 0.54773984, 0.60755871, 0.57080837, 0.47628834, 0.45078021, 0.5824967 , 0.46131088, 0.4891095 , 0.51689449, 0.46752986, 0.55227843, 0.44353426, 0.5017675 , 0.54559348, 0.52851101, 0.55026317, 0.45830156, 0.45772046, 0.6086443 , 0.49685519, 0.52751136, 0.51693728, 0.4484294 , 0.47660812, 0.58280905, 0.56772909, 0.52309964, 0.52428475, 0.57452075, 0.50973168, 0.47994609, 0.47923962, 0.45873824, 0.42570426, 0.48709328, 0.57413965, 0.5010925 , 0.55390541, 0.5593062 , 0.53844322, 0.55278223, 0.58870101, 0.51296611, 0.53402263, 0.52677827, 0.48695852, 0.5189925 , 0.42698966, 0.43450457, 0.60177386, 0.43788479, 0.55378877, 0.50138574, 0.45779969, 0.65772781, 0.49861358, 0.62596601, 0.57850869, 0.43050011, 0.49863034, 0.50523083, 0.49873493, 0.54422498, 0.54082604, 0.45050052, 0.47435829, 0.51097711, 0.60423771, 0.42562366, 0.63754131, 0.68396765, 0.46219551, 0.48702357, 0.43979438, 0.3685082 , 0.54834188, 0.55257998, 0.4443959 , 0.47900246, 0.45853638, 0.47023051, 0.57502053, 0.42216264, 0.48205311, 0.51736319, 0.52870329, 0.55425165, 0.54517921, 0.53670905, 0.55902853, 0.55993381, 0.43934017, 0.5430404 , 0.52401268, 0.45896712, 0.51809886, 0.45799006, 0.50187884, 0.5282877 , 0.58286187, 0.54218412, 0.4740787 , 0.54697446, 0.46129549, 0.53013919, 0.58395247, 0.51412211, 0.54379608, 0.57321777, 0.52975203, 0.51495748, 0.5467124 , 0.45404561, 0.48794829, 0.48734902, 0.567259  , 0.52374715, 0.639907  , 0.51235897, 0.69537551, 0.50771561, 0.52800241, 0.52819641, 0.60988158, 0.50655609, 0.54311974, 0.43545178, 0.48855101, 0.42757789, 0.64668596, 0.5135953 , 0.58217787, 0.58968197, 0.45775186, 0.58696989, 0.46007659, 0.57055176, 0.47679118, 0.50239227, 0.58181557, 0.40036324, 0.50038656, 0.48532153, 0.50611492, 0.51150958, 0.5366197 , 0.49252948, 0.55489687, 0.49758722, 0.58760888, 0.5632469 , 0.49489314, 0.49340345, 0.53955843, 0.44620908, 0.50076492, 0.45903207, 0.48582541, 0.57206606, 0.52236893, 0.56820001, 0.488824  , 0.59306406, 0.43605472, 0.48696051, 0.45298925, 0.39318081, 0.52131276, 0.5762088 , 0.48928729, 0.51129619, 0.56414142, 0.47669731, 0.63322221, 0.48599872, 0.50768554, 0.51273497, 0.53815394, 0.48362047, 0.56871147, 0.57371601, 0.46781439, 0.51894111, 0.55982441, 0.56836997, 0.55620777, 0.44896588, 0.49390795, 0.46122141, 0.5816414 , 0.50393289, 0.54457592, 0.44544417, 0.45760621, 0.5619857 , 0.5452888 , 0.50945522, 0.49124629, 0.47099338, 0.55211594, 0.50838207, 0.56501643, 0.55517873, 0.49045651, 0.40052446, 0.54423852, 0.6128542 , 0.44779434, 0.48657489, 0.5345633 , 0.51695592, 0.53434974, 0.52631928, 0.47704191, 0.46972198, 0.49172569, 0.54121094, 0.57445396, 0.51172669, 0.52637434, 0.52231926, 0.55580816, 0.51005062, 0.49158488, 0.46784938, 0.55121887, 0.61267839, 0.52871497, 0.53510678, 0.50852953, 0.61108235, 0.51697885, 0.53838749, 0.43386249, 0.48953085, 0.52407627, 0.46122995, 0.43647296, 0.52533791, 0.59640842, 0.48702877, 0.51564086, 0.50747108, 0.60527912, 0.42804851, 0.61809225, 0.57765345, 0.48651207, 0.4719782 , 0.56534957, 0.54008846, 0.48257632, 0.51142981, 0.54265858, 0.47225596, 0.56737839, 0.57305763, 0.46305606, 0.44839578, 0.5630844 , 0.47854302, 0.45146904, 0.50651709, 0.43292156, 0.50190796, 0.55304236, 0.5048284 , 0.50935487, 0.49152674, 0.41626669, 0.3969901 , 0.43283057, 0.60609904, 0.49024351, 0.47260228, 0.52034277, 0.47434266, 0.52362985, 0.63715217, 0.4649629 , 0.45748183, 0.54876253, 0.54048754, 0.66209149, 0.46648912, 0.50648451, 0.62963293, 0.46002751, 0.45168543, 0.48558652, 0.5388721 , 0.48292948, 0.49692646, 0.50144901, 0.5311668 , 0.4433951 , 0.5994168 , 0.53507823, 0.5897199 , 0.55392028, 0.4898946 , 0.52498239, 0.57091353, 0.52483223, 0.57629511, 0.52226816, 0.50367003, 0.50431973, 0.55528828, 0.45148067, 0.61352869, 0.4192982 , 0.61325168, 0.56546158, 0.41165108, 0.51160897, 0.45947673, 0.45603623, 0.50188999, 0.50650618, 0.50802022, 0.50795509, 0.47430019, 0.66732014, 0.49536729, 0.51603985, 0.5356992 , 0.42138356, 0.47243618, 0.56172251, 0.60485133, 0.57270442, 0.61730567, 0.50098006, 0.53091275, 0.4667603 , 0.47463872, 0.46995092, 0.39080554, 0.61192293, 0.50051007, 0.51423798, 0.52463494, 0.61575622, 0.52122775, 0.61039663, 0.45444551, 0.5401122 , 0.51205537, 0.49522669, 0.54929165, 0.41392431, 0.51435354, 0.5102911 , 0.44584664, 0.49165231, 0.48092642, 0.53309011, 0.4464865 , 0.56956229, 0.49715136, 0.50024868, 0.4309782 , 0.4688883 , 0.52904395, 0.59702491, 0.48048275, 0.61836839, 0.52187141, 0.53837696, 0.53425391, 0.52303295, 0.56348063, 0.44350304, 0.61558571, 0.53451139, 0.47780918, 0.42430238, 0.59087015, 0.47117401, 0.46995392, 0.56108674, 0.39646194, 0.53758368, 0.54887843, 0.44117517, 0.55502218, 0.63049554, 0.50074495, 0.47175411, 0.44655077, 0.4659113 , 0.52578297, 0.44756423, 0.55430589, 0.38678048, 0.55950509, 0.5903938 , 0.46580053, 0.50412846, 0.50256973, 0.44921474, 0.54562771, 0.5283449 , 0.53478664, 0.51393261, 0.45211007, 0.53410651, 0.67965399, 0.52733183, 0.59288505, 0.42833549, 0.53187216, 0.48986914, 0.47154567, 0.560534  , 0.47802934, 0.5169961 , 0.51271924, 0.44755838, 0.57637584, 0.59043142, 0.551828  , 0.52766878, 0.53500404, 0.50245993, 0.48553613, 0.49231206, 0.52748163, 0.57156535, 0.55340669, 0.4464268 , 0.53106926, 0.46675916, 0.5288402 , 0.42895956, 0.47848931, 0.55288537, 0.62971468, 0.49971099, 0.48699172, 0.57282032, 0.42364484, 0.4919252 , 0.51970401, 0.48053561, 0.58069438, 0.49787367, 0.5132585 , 0.50927198, 0.48982636, 0.43971438, 0.5531551 , 0.55420679, 0.48878611, 0.50664052, 0.54780657, 0.43992251, 0.55003118, 0.47555086, 0.44184514, 0.51220845, 0.44591446, 0.49200604, 0.51930475, 0.49684299, 0.47302858, 0.53907741, 0.5597189 , 0.50058171, 0.45030896, 0.47991928, 0.49398814, 0.48686849, 0.58547764, 0.5431777 , 0.55883729, 0.51228697, 0.52702564, 0.48845903, 0.45192874, 0.5939419 , 0.51038814, 0.46999408, 0.60098515, 0.51694077, 0.47429053, 0.61261457])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr = DoubleMLPLR(obj_dml_data,
                                      ml_g, ml_m,
                                      n_folds=2,
                                      score='IV-type')
            obj_dml_plr.fit()
            this_theta = obj_dml_plr.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_dml[i_rep] - this_theta))
            theta_dml[i_rep] = this_theta

        ax = sns.kdeplot(theta_dml, shade=True, color=colors[3])
        @savefig orth.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        set.seed(3333)

        # to speed up the illustration we hard-code the simulation results
        theta_dml = c(0.42913806, 0.43316824, 0.61369310, 0.47420288, 0.56612731, 0.48624066, 0.48266824, 0.42687167, 0.57932496, 0.35014429, 0.45364242, 0.50362907, 0.35426940, 0.50631755, 0.69905326, 0.44184129, 0.68664042, 0.65077473, 0.54085236, 0.53393103, 0.41080641, 0.55493858, 0.38648321, 0.50326788, 0.47792825, 0.52250731, 0.45095439, 0.51617920, 0.72629732, 0.44585236, 0.57614603, 0.40003120, 0.56031886, 0.51314163, 0.51161077, 0.42458006, 0.45470411, 0.62995282, 0.52821749, 0.52106290, 0.41796137, 0.49244195, 0.44735716, 0.47464688, 0.43278999, 0.57738025, 0.46497964, 0.51932182, 0.41720577, 0.43764400, 0.67841266, 0.55408659, 0.51307914, 0.68270399, 0.59202605, 0.56587065, 0.54677982, 0.53995167, 0.40541990, 0.43919669, 0.41382584, 0.60354425, 0.47532433, 0.57520404, 0.34593387, 0.44649214, 0.47314742, 0.65742616, 0.57004944, 0.58934731, 0.57040034, 0.64863370, 0.55508407, 0.56819856, 0.52013619, 0.46425486, 0.62237868, 0.51925107, 0.52501949, 0.62183034, 0.51362139, 0.50258909, 0.53324487, 0.37252394, 0.50511082, 0.56329268, 0.46591064, 0.46891112, 0.36117298, 0.40960975, 0.56476302, 0.60346171, 0.55011963, 0.43666665, 0.43957066, 0.59957770, 0.49008623, 0.67188050, 0.57097026, 0.60687472, 0.60862364, 0.50827286, 0.50359364, 0.30725406, 0.40085167, 0.50973296, 0.55199812, 0.49537286, 0.45188790, 0.56682157, 0.60075966, 0.55716112, 0.36188043, 0.42720108, 0.48913582, 0.49905466, 0.30636339, 0.37399033, 0.47361759, 0.55287262, 0.67421189, 0.65452966, 0.70761480, 0.41981470, 0.48624085, 0.46167888, 0.45667825, 0.47723405, 0.45471222, 0.47466022, 0.52806844, 0.55456203, 0.35834979, 0.48054982, 0.40626663, 0.53222057, 0.50406679, 0.61914153, 0.45274682, 0.38146984, 0.55040314, 0.51683918, 0.62819509, 0.56447129, 0.40844310, 0.56361326, 0.59545085, 0.54341239, 0.38600811, 0.48514795, 0.61624648, 0.52223771, 0.50694287, 0.40784649, 0.43925088, 0.56120925, 0.53709777, 0.53361594, 0.60162763, 0.55301727, 0.57168732, 0.40383638, 0.61029386, 0.32967098, 0.44418344, 0.59388784, 0.48403921, 0.43563524, 0.57586206, 0.54438640, 0.39391988, 0.54026644, 0.50304476, 0.45330140, 0.51772101, 0.57072679, 0.47129530, 0.52952563, 0.51118177, 0.43792613, 0.50708501, 0.55402204, 0.56300018, 0.64710173, 0.61068413, 0.50885259, 0.46867644, 0.51529826, 0.54432131, 0.44366517, 0.47907430, 0.48360119, 0.46415220, 0.62803625, 0.51681093, 0.44861562, 0.46878897, 0.57754910, 0.53934414, 0.55514825, 0.64211494, 0.58543153, 0.56421745, 0.41812980, 0.61842351, 0.39951353, 0.65326039, 0.59645961, 0.49958845, 0.39999194, 0.48458269, 0.57670828, 0.48991088, 0.46882587, 0.56076353, 0.45412254, 0.57411999, 0.44973420, 0.38673987, 0.49782242, 0.60652263, 0.32827752, 0.40505171, 0.52913411, 0.58860288, 0.54656647, 0.59747115, 0.50592872, 0.60282387, 0.34342820, 0.38265266, 0.37658983, 0.46327940, 0.45987841, 0.47207120, 0.62249832, 0.49486043, 0.48560421, 0.42329878, 0.43797319, 0.53221423, 0.49708016, 0.39947860, 0.37220067, 0.62247380, 0.51071511, 0.73578123, 0.49977786, 0.47002894, 0.55606379, 0.60036521, 0.37144821, 0.56061871, 0.58470561, 0.52377130, 0.47195886, 0.46082198, 0.54618085, 0.51661456, 0.40254820, 0.79526518, 0.47619727, 0.64471049, 0.48303118, 0.50388135, 0.34803997, 0.35489409, 0.48573732, 0.56607696, 0.55677069, 0.66452679, 0.47796660, 0.36815952, 0.49030185, 0.46802058, 0.49364717, 0.53806177, 0.63226813, 0.41949031, 0.61031602, 0.52203176, 0.45365217, 0.52340408, 0.38941021, 0.41657998, 0.46790560, 0.51640168, 0.52023209, 0.41658159, 0.62603226, 0.64976888, 0.55140079, 0.40168700, 0.48450186, 0.37489314, 0.57126164, 0.42998898, 0.46747086, 0.46207941, 0.42358173, 0.40508553, 0.60585155, 0.55732323, 0.49555698, 0.52873767, 0.66544607, 0.42496742, 0.47372355, 0.45987312, 0.56542595, 0.55594871, 0.39854807, 0.47535006, 0.47627848, 0.50834030, 0.53412860, 0.35496264, 0.38224096, 0.53455446, 0.53345455, 0.51537376, 0.56669332, 0.61729402, 0.56773772, 0.51540255, 0.46143092, 0.46263424, 0.47306752, 0.71764595, 0.44831611, 0.44472624, 0.54153129, 0.45992811, 0.41468665, 0.50693472, 0.53712667, 0.50115649, 0.41561605, 0.39845802, 0.57098662, 0.47668312, 0.53814574, 0.54558775, 0.36989976, 0.57058142, 0.59245627, 0.39453265, 0.55638448, 0.41792649, 0.50174815, 0.42716142, 0.57053877, 0.50450045, 0.50719061, 0.40791363, 0.60117304, 0.50726098, 0.41313999, 0.62713006, 0.52927468, 0.43919127, 0.51939909, 0.53216099, 0.61426638, 0.55517891, 0.52550725, 0.48726381, 0.52282488, 0.53412265, 0.57112127, 0.44915620, 0.48624981, 0.45434757, 0.54594964, 0.45144261, 0.58943593, 0.44173928, 0.39137041, 0.56532290, 0.52862947, 0.59335260, 0.47949536, 0.59270141, 0.60803178, 0.44201101, 0.50200628, 0.57736589, 0.67365436, 0.47965685, 0.53265149, 0.29539617, 0.63942053, 0.36842280, 0.60947176, 0.52338164, 0.59342733, 0.49698428, 0.69892615, 0.63637029, 0.47600661, 0.50267946, 0.52290767, 0.51826972, 0.53976759, 0.49725101, 0.51986060, 0.55680582, 0.53644020, 0.56394591, 0.41015781, 0.56109820, 0.54985548, 0.48015589, 0.70643971, 0.50029105, 0.57595621, 0.51223989, 0.62096412, 0.44081326, 0.39901139, 0.55241395, 0.51862525, 0.57115813, 0.44345708, 0.54100182, 0.51750750, 0.51221937, 0.44313306, 0.46866454, 0.54853286, 0.45596388, 0.60353598, 0.59485756, 0.51394737, 0.52571069, 0.51710424, 0.45414012, 0.37452561, 0.48179420, 0.48400926, 0.54266013, 0.62673309, 0.51523876, 0.70196700, 0.70896770, 0.46851214, 0.59934315, 0.50147654, 0.49531880, 0.50256030, 0.63738873, 0.44100607, 0.50199621, 0.50267163, 0.57522836, 0.54297195, 0.59369577, 0.47387198, 0.46236344, 0.55472654, 0.64741476, 0.56064831, 0.48637194, 0.48030544, 0.55182318, 0.59873158, 0.38704244, 0.49207536, 0.61636373, 0.49309616, 0.43057533, 0.42656903, 0.57737717, 0.47652448, 0.44508640, 0.55721658, 0.42001502, 0.53203807, 0.67786061, 0.56307312, 0.59090498, 0.46763688, 0.60226755, 0.51045486, 0.58261018, 0.51335751, 0.51489954, 0.49543312, 0.54261570, 0.37144113, 0.56424704, 0.52789051, 0.62629321, 0.56680133, 0.58094908, 0.56792576, 0.38076462, 0.51025326, 0.41766390, 0.67992174, 0.57048006, 0.55394699, 0.57142484, 0.50051587, 0.53052551, 0.59685925, 0.57857539, 0.66474049, 0.40036740, 0.45197943, 0.48545635, 0.58707913, 0.52364072, 0.53642783, 0.50616922, 0.38669512, 0.53221757, 0.44462522, 0.56490506, 0.52281451, 0.61329588, 0.53618070, 0.54026911, 0.57958907, 0.44172998, 0.54616971, 0.49559402, 0.46337158, 0.40539251, 0.48660211, 0.52950782, 0.67319498, 0.50960922, 0.55025810, 0.48466318, 0.48733741, 0.57079932, 0.52210722, 0.59483531, 0.57823919, 0.56681829, 0.67063110, 0.55044265, 0.49411047, 0.49592631, 0.53839330, 0.50303196, 0.57088299, 0.53512485, 0.45772366, 0.52151506, 0.58684530, 0.41629452, 0.48724706, 0.49347072, 0.44468953, 0.62079071, 0.45174209, 0.50964193, 0.57956285, 0.46846437, 0.45610451, 0.46687298, 0.56776141, 0.50069025, 0.47016823, 0.52769089, 0.48033467, 0.47567157, 0.51580042, 0.54601488, 0.44649238, 0.52159010, 0.58909856, 0.44350571, 0.47345207, 0.47027266, 0.52040233, 0.56983877, 0.47086448, 0.53872263, 0.44996677, 0.47074500, 0.42960621, 0.52333355, 0.58375512, 0.46329712, 0.49498312, 0.59458654, 0.50953637, 0.63728315, 0.50204231, 0.59437553, 0.52019228, 0.47574961, 0.43201755, 0.44222095, 0.53067411, 0.55695602, 0.40546530, 0.51287913, 0.52125397, 0.42011085, 0.44796920, 0.66000531, 0.55670752, 0.47266941, 0.49879186, 0.57275709, 0.46730920, 0.61246393, 0.56723568, 0.61656772, 0.53631019, 0.57331834, 0.57269018, 0.46993462, 0.49854259, 0.39883510, 0.57493417, 0.51821134, 0.43730615, 0.54825472, 0.64819963, 0.48815339, 0.47117569, 0.58801247, 0.38179558, 0.49153756, 0.53372616, 0.39952425, 0.54495609, 0.56425681, 0.60914698, 0.67661682, 0.43440964, 0.47919319, 0.50718258, 0.51064880, 0.73991197, 0.58496491, 0.59005490, 0.46279519, 0.58139833, 0.48246194, 0.47157441, 0.51921259, 0.59101700, 0.40841472, 0.57875099, 0.40205734, 0.52224831, 0.51818062, 0.53313627, 0.61172011, 0.49113850, 0.43693161, 0.46919091, 0.63009573, 0.55165641, 0.64606963, 0.55488746, 0.54408366, 0.38395325, 0.55924915, 0.51209453, 0.39222947, 0.44400452, 0.45858189, 0.50094515, 0.54827255, 0.61142796, 0.50540355, 0.50289919, 0.52269712, 0.44278828, 0.54354751, 0.40389553, 0.48896288, 0.51261510, 0.59240684, 0.57118052, 0.51133825, 0.70668058, 0.55364559, 0.56129073, 0.42279244, 0.51104222, 0.50439600, 0.40569372, 0.47728061, 0.43199642, 0.70508883, 0.41362643, 0.54311643, 0.44714492, 0.42709630, 0.37506699, 0.47275717, 0.65199031, 0.55824739, 0.47710929, 0.52287265, 0.46701169, 0.34957259, 0.57366553, 0.61544005, 0.57923248, 0.48491284, 0.67073890, 0.59296263, 0.52960127, 0.48830529, 0.42371237, 0.53493779, 0.46803035, 0.35813584, 0.63742714, 0.53100854, 0.48004508, 0.38527609, 0.45555077, 0.61923367, 0.45278751, 0.55398663, 0.54611470, 0.47799756, 0.62941151, 0.53417734, 0.48169190, 0.57393957, 0.56965073, 0.48438376, 0.59291956, 0.58419322, 0.40210205, 0.40705906, 0.60354322, 0.66776203, 0.47749758, 0.51099112, 0.41384870, 0.50893890, 0.44254692, 0.52634243, 0.48099904, 0.58424289, 0.59455376, 0.69857315, 0.52939985, 0.51870330, 0.52861707, 0.56935708, 0.65242725, 0.33287675, 0.36760792, 0.44377420, 0.56422963, 0.60120575, 0.41819252, 0.56997243, 0.60729652, 0.53456727, 0.49915985, 0.49840749, 0.54267287, 0.54345681, 0.51760500, 0.36975586, 0.53025333, 0.66200912, 0.50074647, 0.40370975, 0.50420793, 0.44299858, 0.58169330, 0.37495283, 0.35753936, 0.61401972, 0.38445478, 0.66316660, 0.39712808, 0.60481713, 0.43205297, 0.60673487, 0.36795722, 0.58504703, 0.59312592, 0.50726682, 0.43250603, 0.59993261, 0.50850652, 0.55197866, 0.42100227, 0.41197278, 0.48603494, 0.48233252, 0.52166479, 0.48123320, 0.57925253, 0.45858549, 0.44852927, 0.63552822, 0.67505307, 0.64072903, 0.58062243, 0.53493671, 0.57334320, 0.41484093, 0.50335731, 0.47572475, 0.62807268, 0.51276249, 0.48341935, 0.57002321, 0.42448958, 0.46463977, 0.50158529, 0.50336207, 0.38493723, 0.49877225, 0.70920972, 0.52804881, 0.55241536, 0.51123088, 0.56935502, 0.46794885, 0.62160760, 0.47682064, 0.55061002, 0.45601717, 0.32226202, 0.50512015, 0.39238552, 0.51890464, 0.56729508, 0.48812630, 0.52579096, 0.49552910, 0.45541965, 0.57388623, 0.55532925, 0.42905776, 0.42528833, 0.50058720, 0.57588967, 0.58886503, 0.45381248, 0.50284578, 0.44971131, 0.55089234, 0.50441897, 0.46913765, 0.49684019, 0.48161077, 0.55911804, 0.50199758, 0.47945146, 0.66388549, 0.39635503, 0.53354409, 0.64561425, 0.66166898, 0.47160421, 0.50143847, 0.64010436, 0.46946532, 0.52131207, 0.53527948, 0.47010874, 0.51834605, 0.54124221, 0.40402007, 0.50168993, 0.50234726, 0.40501895, 0.47435409, 0.39967228, 0.58627553, 0.63872443, 0.51361588, 0.47086834, 0.44200927, 0.54694174, 0.53323022, 0.34121376, 0.46739575, 0.42969545, 0.70104546, 0.46003349, 0.51258474, 0.72598733, 0.50390373, 0.50638444, 0.50122981, 0.51856086, 0.58824995, 0.56395614, 0.58458643, 0.48689805, 0.54648130, 0.46113281, 0.42569036, 0.51534597, 0.42647065, 0.36155963, 0.39515078, 0.59939998, 0.49517795, 0.43462746, 0.47664938, 0.56940909, 0.57171369, 0.60772723, 0.48845162, 0.64587916, 0.51106531, 0.56538809, 0.61896522, 0.45928391, 0.55184185, 0.59693194, 0.59348120, 0.43120609, 0.54165183, 0.31393692, 0.74020994, 0.58668672, 0.44618824, 0.58408901, 0.50309948, 0.50841443, 0.51478630, 0.48087840, 0.51480573, 0.50754975, 0.46715053, 0.58687497, 0.57562903, 0.56412152, 0.49320614, 0.48217559, 0.45551353, 0.50503672, 0.44996034, 0.63371039, 0.51740116, 0.41814389, 0.47413265, 0.55776780, 0.45872666, 0.59620842, 0.65898842, 0.65894305, 0.56710870, 0.60647653, 0.54772268, 0.42489299, 0.58600208, 0.33854023, 0.35980618, 0.43478661, 0.56196962, 0.60073501, 0.43790578, 0.39961190, 0.50526949, 0.49429539, 0.42253674, 0.42425078, 0.62641974, 0.43744788, 0.28745392, 0.49301899, 0.54976290, 0.51968761, 0.51677942, 0.52912944, 0.47229849, 0.47875525, 0.62221667, 0.58038527, 0.45193207, 0.47508698, 0.43425117, 0.45337453, 0.50681186, 0.45026174, 0.55684403, 0.39043084, 0.45808880, 0.39807946, 0.67317732, 0.48568494, 0.50180223, 0.61079194, 0.58155068, 0.55683503, 0.53079425, 0.44263915 )

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr = DoubleMLPLR$new(obj_dml_data,
                                      ml_g, ml_m,
                                      n_folds=2,
                                      score='IV-type')
            obj_dml_plr$fit()
            this_theta = obj_dml_plr$coef
            print(abs(theta_dml[i_rep] - this_theta))
            theta_dml[i_rep] = this_theta
        }

        g_dml = ggplot(data.frame(theta_dml), aes(x = theta_dml)) +
                    geom_density(fill = "dark red", alpha = 0.3, color = "dark red") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_dml


Double/debiased machine learning
++++++++++++++++++++++++++++++++

To illustrate the benefits of the auxiliary prediction step (the DML) we write the error as

.. math::

    \sqrt{n}(\check{\theta} - \theta) = a^* + b^* + c^*

Chernozhukov et al. (2018) argues that:

The first term

.. math::

    a^* := (EV^2)^{-1} \frac{1}{\sqrt{n}} \sum_{i\in I} V_i U_i

will be asymptotically normally distributed.

The second term

.. math::

    b^* := (EV^2)^{-1} \frac{1}{\sqrt{n}} \sum_{i\in I} (\hat{m}(X_i) - m(X_i)) (\hat{g}_0(X_i) - g_0(X_i))

vanishes asymptotically for many data generating processes.

The third term :math:`c^*` vanishes in probability if sample splitting is applied.

.. tabbed:: Python

    .. ipython:: python

        ax = sns.kdeplot(theta_ols, shade=True)
        sns.kdeplot(theta_nonorth, shade=True, ax=ax);
        sns.kdeplot(theta_orth_nosplit, shade=True);
        sns.kdeplot(theta_dml, shade=True);
        labels = ['True $\\theta$', 'OLS', 'Non-orthogonal ML', 'Double ML (no sample splitting)', 'Double ML with cross-fitting']
        ax.axvline(0.5, color='k', label='True theta');
        @savefig comparison.png width=5in
        ax.legend(labels);

.. tabbed:: R

    .. jupyter-execute::

        g_all = ggplot(data.frame(theta_ols, theta_nonorth, theta_orth_nosplit, theta_dml)) +
                    geom_density(aes(x = theta_ols), fill = "dark blue", alpha = 0.3, color = "dark blue") +
                    geom_density(aes(x = theta_nonorth), fill = "dark orange", alpha = 0.3, color = "dark orange") +
                    geom_density(aes(x = theta_orth_nosplit), fill = "dark green", alpha = 0.3, color = "dark green") +
                    geom_density(aes(x = theta_dml), fill = "dark red", alpha = 0.3, color = "dark red") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_all


References
++++++++++

Chernozhukov, V., Chetverikov, D., Demirer, M., Duflo, E., Hansen, C., Newey, W. and Robins, J. (2018), Double/debiased machine learning for treatment and structural parameters. The Econometrics Journal, 21: C1-C68. doi:`10.1111/ectj.12097 <https://doi.org/10.1111/ectj.12097>`_.