.. _basics:

The basics of double/debiased machine learning
----------------------------------------------

In the following we provide a brief summary of and motivation to double machine learning methods and show how the
corresponding methods provided by the :ref:`DoubleML <doubleml_package>` package can be applied.
For details we refer to Chernozhukov et al. (2018).

.. Add references to the vignette here when it is ready.

Data generating process
+++++++++++++++++++++++

We consider the following partially linear model

.. math::

        d_i = m_0(x_i) + v_i, & &v_i \sim \mathcal{N}(0,1),

        y_i = \theta d_i + g_0(x_i) + \zeta_i, & &\zeta_i \sim \mathcal{N}(0,1),


with covariates :math:`x_i \sim \mathcal{N}(0, \Sigma)`, where  :math:`\Sigma` is a matrix with entries
:math:`\Sigma_{kj} = 0.7^{|j-k|}`.
The true parameter :math:`\theta` is set to :math:`0.5`.

The nuisance functions are given by

.. math::

    m_0(x_i) &= \frac{1}{4} x_{i,1} + \frac{\exp(x_{i,3})}{1+\exp(x_{i,3})},

    g_0(X) &= \frac{\exp(x_{i,1})}{1+\exp(x_{i,1})} + \frac{1}{4} x_{i,3}.


.. note::
    - In Python the data can be generated with :py:func:`doubleml.datasets.make_plr_CCDDHNR2018`.
    - In R the data can be generated with `DoubleML::make_plr_CCDDHNR2018()`.

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        from doubleml.datasets import make_plr_CCDDHNR2018

        np.random.seed(1234)
        n_rep = 1000
        n_obs = 500
        n_vars = 20
        alpha = 0.5

        data = list()

        for i_rep in range(n_rep):
            (x, y, d) = make_plr_CCDDHNR2018(alpha=alpha, n_obs=n_obs, dim_x=n_vars, return_type='array')
            data.append((x, y, d))

.. tabbed:: R

    .. jupyter-execute::

        library(DoubleML)
        set.seed(1234)
        n_rep = 1000
        n_obs = 500
        n_vars = 20
        alpha = 0.5

        data = list()
        for (i_rep in seq_len(n_rep)) {
            data[[i_rep]] = make_plr_CCDDHNR2018(alpha=alpha, n_obs=n_obs, dim_x=n_vars,
                                                  return_type="data.frame")
        }


OLS estimation
++++++++++++++

A naive OLS regression of :math:`Y` on :math:`D` produces a significant bias.

.. tabbed:: Python

    .. The following block makes sure that the seaborn graphics are rendered appropriately but does not need to be shown

    .. ipython:: python
        :suppress:

        import seaborn as sns
        sns.set()

    .. ipython:: python

        from sklearn.linear_model import LinearRegression
        import matplotlib.pyplot as plt
        import seaborn as sns
        colors = sns.color_palette()

        def est_ols(y, X):
            if X.ndim == 1:
                X = X.reshape(-1, 1)
            ols = LinearRegression(fit_intercept=False)
            results = ols.fit(X, y)
            theta = results.coef_
            return theta

        # to speed up the illustration we hard-code the simulation results
        theta_ols = np.array([0.74327549, 0.71934891, 0.7071162 , 0.66889543, 0.7321444 , 0.69223437, 0.68652905, 0.68488856, 0.72617801, 0.77559064, 0.71563239, 0.70957142, 0.72750812, 0.61424786, 0.71949073, 0.76285484, 0.7496472 , 0.69688757, 0.6478375 , 0.69363074, 0.60957089, 0.69387009, 0.63558263, 0.74582498, 0.68074102, 0.66290947, 0.70199172, 0.67168635, 0.6949646 , 0.67395231, 0.6863304 , 0.72837954, 0.63418985, 0.624109  , 0.74254538, 0.66124323, 0.69945743, 0.74743667, 0.67949935, 0.70447876, 0.68997626, 0.6485608 , 0.6996691 , 0.64571962, 0.689712  , 0.72131247, 0.75407754, 0.70783852, 0.66223883, 0.74018891, 0.71145533, 0.69873155, 0.7445769 , 0.74689479, 0.73542415, 0.67113299, 0.76903052, 0.70375282, 0.70996563, 0.70438228, 0.74164684, 0.74533407, 0.66750142, 0.66591911, 0.68102801, 0.68273323, 0.68804608, 0.65742228, 0.73445098, 0.73037019, 0.70510367, 0.66405038, 0.7135943 , 0.68373932, 0.69066059, 0.72144004, 0.70095231, 0.73540764, 0.65717624, 0.72036667, 0.68831806, 0.68206625, 0.6739611 , 0.6508514 , 0.68228283, 0.70360066, 0.69994817, 0.6896916 , 0.7008032 , 0.65414898, 0.63797163, 0.68304265, 0.719207  , 0.71895005, 0.68102457, 0.72023145, 0.65410707, 0.73580482, 0.758165  , 0.76284332, 0.65921112, 0.78098578, 0.65429805, 0.73015814, 0.66525843, 0.73406423, 0.67064761, 0.67702571, 0.61453065, 0.69567958, 0.66214949, 0.72614386, 0.64724407, 0.68049916, 0.67879612, 0.68264901, 0.67908577, 0.73721147, 0.70790385, 0.66412035, 0.66370082, 0.70412941, 0.63224826, 0.68415579, 0.62283769, 0.74062522, 0.66059795, 0.74803403, 0.70683391, 0.71588062, 0.71335596, 0.66469741, 0.73895398, 0.64462981, 0.73767695, 0.7153053 , 0.6798498 , 0.67976232, 0.67474487, 0.67327029, 0.70457262, 0.64944259, 0.68885062, 0.70302035, 0.77104544, 0.7340215 , 0.60766083, 0.6978024 , 0.63118877, 0.67956038, 0.74487726, 0.69809963, 0.63742437, 0.63204771, 0.70265094, 0.71273853, 0.66776843, 0.66167171, 0.62838624, 0.72428889, 0.68596631, 0.65854284, 0.7185046 , 0.69556817, 0.63636399, 0.64001144, 0.6774715 , 0.71398585, 0.7206766 , 0.71158677, 0.68220638, 0.70811733, 0.7142335 , 0.64883066, 0.70728145, 0.701635  , 0.68152398, 0.75183935, 0.70673431, 0.69499219, 0.67894841, 0.70822604, 0.71424631, 0.69439508, 0.63792728, 0.70779977, 0.65836604, 0.68838003, 0.76057073, 0.70518268, 0.66624295, 0.69771291, 0.70339602, 0.61495143, 0.70285859, 0.67603443, 0.67350996, 0.71083834, 0.70669517, 0.6560908 , 0.7115781 , 0.76633989, 0.67506737, 0.69908479, 0.64724321, 0.72057926, 0.72813169, 0.72147159, 0.76321423, 0.73190132, 0.71900152, 0.83985806, 0.69003517, 0.71106874, 0.68019664, 0.67788391, 0.69556955, 0.72715998, 0.69344462, 0.7361361 , 0.70171533, 0.69514106, 0.70428968, 0.68723961, 0.69519307, 0.7752073 , 0.725045  , 0.71316354, 0.70633665, 0.72327643, 0.7378771 , 0.73544547, 0.76327184, 0.68528505, 0.73389217, 0.71946662, 0.67604625, 0.7301871 , 0.749881  , 0.71642655, 0.72777549, 0.74001467, 0.70727526, 0.72453894, 0.72419681, 0.68750118, 0.66134216, 0.69077829, 0.61894095, 0.65831753, 0.61303561, 0.67040552, 0.70625606, 0.7406828 , 0.69817593, 0.66253564, 0.67347683, 0.66641965, 0.72216603, 0.687488  , 0.69851329, 0.66535231, 0.72674181, 0.63890483, 0.66448343, 0.68513246, 0.71418108, 0.74725317, 0.69184291, 0.70298728, 0.64504616, 0.67366495, 0.66080846, 0.72740611, 0.76593912, 0.72531422, 0.73445034, 0.69357226, 0.72019358, 0.70164815, 0.66416009, 0.62691047, 0.7358819 , 0.64742474, 0.69877579, 0.7301649 , 0.74876575, 0.72219001, 0.74149084, 0.63438795, 0.71421892, 0.67649523, 0.72637419, 0.71195445, 0.66203908, 0.70503894, 0.74214977, 0.67249686, 0.6745924 , 0.64505834, 0.7430257 , 0.76377145, 0.73309393, 0.6955911 , 0.68118147, 0.66220603, 0.6872002 , 0.64224507, 0.71097023, 0.65575011, 0.72530842, 0.70042267, 0.72079657, 0.72049826, 0.64445019, 0.69462224, 0.61749367, 0.72824316, 0.76603465, 0.64882095, 0.77414655, 0.67239775, 0.6913868 , 0.72970133, 0.74398472, 0.66393636, 0.66809563, 0.66559467, 0.65972145, 0.68293813, 0.68885247, 0.6826176 , 0.71199311, 0.68399782, 0.66651665, 0.6430474 , 0.76104959, 0.62501309, 0.69037431, 0.70827025, 0.71243416, 0.64936689, 0.67299405, 0.64401341, 0.6402889 , 0.70964786, 0.75769502, 0.74268972, 0.60605689, 0.67428741, 0.69151102, 0.65351861, 0.73290528, 0.67646306, 0.77124533, 0.75031368, 0.69167897, 0.69591337, 0.67769018, 0.69554608, 0.68826404, 0.74290162, 0.68824777, 0.6788195 , 0.70778066, 0.74477137, 0.74890937, 0.72461889, 0.73463566, 0.73299754, 0.67779193, 0.71025889, 0.72357707, 0.67878529, 0.64187993, 0.69078848, 0.75697607, 0.69658874, 0.72859922, 0.63521489, 0.69522341, 0.69636772, 0.6882388 , 0.72691576, 0.73811265, 0.68586124, 0.76468613, 0.71687043, 0.71766859, 0.70110446, 0.70629848, 0.66439167, 0.7063781 , 0.71500308, 0.72072699, 0.65919732, 0.68267172, 0.76063796, 0.65311553, 0.66823248, 0.69612821, 0.67767157, 0.69615742, 0.73365577, 0.69066563, 0.67824086, 0.66459544, 0.68855269, 0.67483516, 0.70343555, 0.65756028, 0.68679577, 0.63600737, 0.65914566, 0.69127272, 0.66132902, 0.72527193, 0.6561677 , 0.65575471, 0.6771258 , 0.70693135, 0.7068362 , 0.66044513, 0.65750752, 0.69489232, 0.70209298, 0.69030804, 0.65292839, 0.74482234, 0.77210838, 0.76402082, 0.63706175, 0.80246894, 0.71075308, 0.68932578, 0.69838028, 0.71986259, 0.72035574, 0.69014776, 0.61957911, 0.78058917, 0.75061184, 0.68010985, 0.68201939, 0.71087529, 0.65718244, 0.66889886, 0.68441827, 0.68030518, 0.64026   , 0.69940905, 0.68472154, 0.6980611 , 0.6743405 , 0.61627356, 0.73709355, 0.7259686 , 0.67825975, 0.67245584, 0.74060318, 0.68292475, 0.69392214, 0.72233407, 0.65375414, 0.67897431, 0.68195602, 0.69500853, 0.73391607, 0.62957796, 0.70762817, 0.65648516, 0.67576564, 0.6822775 , 0.67919546, 0.73044761, 0.69287171, 0.67688566, 0.68916795, 0.70854278, 0.74128771, 0.68919917, 0.68281587, 0.75671677, 0.69483885, 0.66805291, 0.70802717, 0.68346707, 0.70785511, 0.69121972, 0.77845075, 0.69497408, 0.66787606, 0.68269251, 0.72353937, 0.69121218, 0.71229518, 0.73661   , 0.67379506, 0.62866932, 0.76514717, 0.63096581, 0.69799023, 0.74263167, 0.65315192, 0.69011544, 0.64289252, 0.66248887, 0.75572848, 0.70633491, 0.71980933, 0.70990222, 0.68236809, 0.63144806, 0.76917637, 0.70548978, 0.6872363 , 0.68288922, 0.71330755, 0.68743302, 0.69001899, 0.63304898, 0.6612942 , 0.70889306, 0.65172423, 0.70332827, 0.69544724, 0.73597262, 0.69084301, 0.66360327, 0.63318307, 0.71794487, 0.7296925 , 0.73830294, 0.69018389, 0.68530351, 0.64466351, 0.72795657, 0.74572509, 0.71879458, 0.68817547, 0.68388842, 0.69964242, 0.6707944 , 0.68598015, 0.6911791 , 0.65229477, 0.70051195, 0.73886474, 0.69973603, 0.72145509, 0.67691804, 0.69474291, 0.74927914, 0.6925408 , 0.68009917, 0.73011234, 0.67334211, 0.70379472, 0.69494909, 0.68040205, 0.66378064, 0.68015517, 0.69191074, 0.70576493, 0.68183233, 0.6920525 , 0.80265328, 0.63236205, 0.70254452, 0.74404953, 0.62763892, 0.66471009, 0.63424108, 0.71889551, 0.68724167, 0.73472725, 0.66256348, 0.70113645, 0.67380303, 0.75341579, 0.63601087, 0.77265435, 0.77629498, 0.70519382, 0.71852746, 0.62270543, 0.63435171, 0.66434686, 0.71276531, 0.61200484, 0.69570543, 0.72409771, 0.67989275, 0.76061293, 0.69486415, 0.68264177, 0.76285539, 0.70682067, 0.74412259, 0.76480689, 0.68619273, 0.69662082, 0.71817887, 0.72879108, 0.71854285, 0.69333544, 0.68505412, 0.73232986, 0.69677492, 0.70463502, 0.65319593, 0.71393354, 0.76082275, 0.68634329, 0.72370656, 0.7038216 , 0.73545344, 0.67939289, 0.70396255, 0.72410425, 0.70396681, 0.66982425, 0.73096645, 0.675231  , 0.67290012, 0.74422842, 0.63647005, 0.70865121, 0.72815056, 0.76628858, 0.67138495, 0.8081447 , 0.70802804, 0.62203997, 0.70137234, 0.73102304, 0.66195252, 0.65069946, 0.70561816, 0.66383408, 0.63018904, 0.73449558, 0.7620257 , 0.73296115, 0.766281  , 0.70122614, 0.7073625 , 0.69383866, 0.66024139, 0.6983459 , 0.7089143 , 0.72025392, 0.64611713, 0.72110171, 0.73356897, 0.75618105, 0.68538144, 0.69916272, 0.68158417, 0.7632855 , 0.6773266 , 0.72036536, 0.69281412, 0.70182395, 0.72684361, 0.71467682, 0.73090411, 0.72315133, 0.7126368 , 0.72787178, 0.7381704 , 0.7247259 , 0.73177938, 0.68736389, 0.69211875, 0.62814182, 0.65572817, 0.67721101, 0.63716646, 0.7781467 , 0.72111211, 0.63447689, 0.66970619, 0.68283888, 0.70328369, 0.75061351, 0.66822854, 0.70791141, 0.68640197, 0.67764118, 0.75310358, 0.6887805 , 0.725512  , 0.67909202, 0.71469464, 0.69789628, 0.69839272, 0.69753509, 0.71251512, 0.67821753, 0.75999227, 0.68194335, 0.66168968, 0.72413526, 0.69228247, 0.6290483 , 0.68858301, 0.69165799, 0.70140782, 0.74462382, 0.74248043, 0.72780035, 0.73267364, 0.68103662, 0.67341583, 0.71038551, 0.73089887, 0.73389819, 0.72521307, 0.63585328, 0.66452962, 0.71781253, 0.76575054, 0.76274836, 0.73538776, 0.66935649, 0.678953  , 0.67114448, 0.69354395, 0.71735326, 0.72553022, 0.6702165 , 0.68285097, 0.71845315, 0.67904253, 0.7077958 , 0.66416596, 0.69390533, 0.76992967, 0.69424878, 0.72606027, 0.69411379, 0.74603158, 0.66527451, 0.69020945, 0.66992763, 0.76019975, 0.722434  , 0.69615135, 0.67044271, 0.68773598, 0.71978712, 0.70290068, 0.74776359, 0.73526717, 0.71220166, 0.69774305, 0.73210423, 0.75697046, 0.71565338, 0.67501828, 0.71096965, 0.72063185, 0.71701347, 0.66483651, 0.67006209, 0.72298989, 0.71843874, 0.74013517, 0.67151365, 0.65434834, 0.7043809 , 0.71246714, 0.72110591, 0.67365252, 0.73162591, 0.67534299, 0.67315495, 0.67353862, 0.70187853, 0.71328949, 0.69364518, 0.6725559 , 0.66318501, 0.69946142, 0.6885109 , 0.68913105, 0.67847892, 0.67510952, 0.65235085, 0.72252816, 0.69872274, 0.64822831, 0.76603744, 0.68119107, 0.71548934, 0.6565369 , 0.73006022, 0.71673464, 0.63381933, 0.68381569, 0.62259402, 0.64895141, 0.70696913, 0.69400652, 0.65418197, 0.7408791 , 0.69333385, 0.68162549, 0.68758473, 0.78601115, 0.69854975, 0.70877716, 0.70927824, 0.74223289, 0.67462245, 0.72841165, 0.70648889, 0.74212229, 0.6780401 , 0.71744857, 0.70713474, 0.76756027, 0.70075192, 0.7663556 , 0.73035958, 0.7251279 , 0.70250536, 0.60750864, 0.64722813, 0.68258431, 0.76401857, 0.7301316 , 0.75426456, 0.75686724, 0.72955664, 0.71311446, 0.69683742, 0.67842193, 0.61635675, 0.71321345, 0.74782417, 0.7968747 , 0.74645497, 0.74606223, 0.66032173, 0.7208764 , 0.68504013, 0.7198266 , 0.69807561, 0.61770357, 0.74206728, 0.74122974, 0.70647123, 0.69578346, 0.73532379, 0.67455062, 0.72963957, 0.63620053, 0.70005491, 0.67395195, 0.69040186, 0.7555862 , 0.63111288, 0.7338178 , 0.72674268, 0.69883056, 0.72141827, 0.7248861 , 0.71698368, 0.75032942, 0.7169032 , 0.73334991, 0.68948078, 0.70543862, 0.67887218, 0.67724562, 0.68571986, 0.72683199, 0.69126599, 0.69297811, 0.7155441 , 0.7022518 , 0.68101205, 0.73425718, 0.70616102, 0.70442355, 0.72700315, 0.67334006, 0.66331978, 0.72518054, 0.67873674, 0.66230419, 0.68842285, 0.6955737 , 0.71696978, 0.67991793, 0.68504384, 0.70799728, 0.70816936, 0.64363711, 0.72614627, 0.68620038, 0.68105073, 0.71382614, 0.70531326, 0.70377149, 0.60272405, 0.67365426, 0.73663565, 0.71887456, 0.68629552, 0.66517383, 0.67843139, 0.83380246, 0.71556854, 0.67534963, 0.71346912, 0.67974676, 0.71540587, 0.76652245, 0.72137807, 0.74793308, 0.69230067, 0.72171513, 0.64717882, 0.66817614, 0.75565663, 0.68729597, 0.66712949, 0.67945236, 0.67130341, 0.75787916, 0.74381545, 0.7186033 , 0.70142608, 0.65704122, 0.72724067, 0.75769786, 0.66953558, 0.64257678, 0.72408594, 0.74775009, 0.64302864, 0.67426595, 0.68400988, 0.70802411, 0.68567715, 0.72523497, 0.67610014, 0.73898806, 0.6649236 , 0.68699112, 0.68785269, 0.68595389, 0.70842019, 0.71694299, 0.7175504 , 0.67534593, 0.65634612, 0.67889042, 0.71258743, 0.67982733, 0.63596576, 0.70204131, 0.68938513, 0.74445616, 0.64451886, 0.77808901, 0.59905118, 0.74627647, 0.64311863, 0.68305962, 0.69589329, 0.62183265, 0.62354426, 0.6973124 , 0.64621183, 0.70835832, 0.67838342, 0.65407672, 0.69778855, 0.68802322, 0.71261085, 0.66083634, 0.67370759, 0.70478525, 0.73190933, 0.75251925, 0.71631252, 0.69366042, 0.72112305, 0.65782835, 0.79678457, 0.69339723, 0.69830379, 0.74999046, 0.6928068 , 0.68273726, 0.67683079])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            this_theta = est_ols(y, d)
            # we show that the loaded result matches the just computed
            print(np.abs(theta_ols[i_rep] - this_theta))
            theta_ols[i_rep] = this_theta

        ax = sns.kdeplot(theta_ols, shade=True, color=colors[0])
        @savefig ols.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        library(ggplot2)

        est_ols = function(df) {
            ols = stats::lm(y ~ -1 +., df)
            theta = coef(ols)["d"]
            return(theta)
        }

        # to speed up the illustration we hard-code the simulation results
        theta_ols = c(0.56709602, 0.61401665, 0.48339020, 0.55948163, 0.44635236, 0.54450786, 0.62068931, 0.52396223, 0.52974051, 0.61373999, 0.60005016, 0.51544790, 0.55151594, 0.46931430, 0.53898334, 0.51692529, 0.53449705, 0.63804632, 0.58561427, 0.56902561, 0.51861469, 0.57083949, 0.51037844, 0.54289821, 0.55602031, 0.48071878, 0.59709078, 0.61677860, 0.53868644, 0.52662601, 0.60130563, 0.56021640, 0.66614044, 0.56801606, 0.53262994, 0.57484755, 0.59821419, 0.59640667, 0.54718348, 0.63492289, 0.54267985, 0.63391310, 0.44633232, 0.59208159, 0.67374013, 0.59806591, 0.63155052, 0.58692794, 0.55410994, 0.51374694, 0.62071854, 0.63015750, 0.60985861, 0.55153589, 0.60023144, 0.67978140, 0.59255222, 0.51727085, 0.54013474, 0.55990781, 0.53915802, 0.53637556, 0.65469156, 0.56182368, 0.57774476, 0.48377702, 0.52125336, 0.50508894, 0.66317796, 0.51138154, 0.58239171, 0.61163129, 0.49163172, 0.51180637, 0.56753160, 0.50074969, 0.59423689, 0.57967983, 0.51852945, 0.53176019, 0.46323302, 0.52768308, 0.58691889, 0.56113142, 0.52009343, 0.57841710, 0.55047263, 0.56520815, 0.54922198, 0.64849510, 0.64131469, 0.56116140, 0.51844455, 0.55875361, 0.52995668, 0.63036194, 0.55904326, 0.55815509, 0.63921825, 0.50807846, 0.53737973, 0.51480812, 0.55739343, 0.50236813, 0.52096129, 0.49997510, 0.56365163, 0.55773726, 0.56074925, 0.54948695, 0.57157219, 0.58086299, 0.48914143, 0.52149926, 0.51092045, 0.57193717, 0.58497859, 0.53807878, 0.56131764, 0.51565237, 0.61714161, 0.62981337, 0.55544560, 0.47954054, 0.54859072, 0.60201578, 0.52589360, 0.54192677, 0.57535850, 0.59750818, 0.59282235, 0.57670412, 0.53834520, 0.67124260, 0.51409979, 0.58266923, 0.60087315, 0.57565698, 0.59559518, 0.48186702, 0.53358776, 0.48532259, 0.59887238, 0.49392398, 0.55970077, 0.56786004, 0.54314111, 0.58761003, 0.61288801, 0.56523506, 0.61585242, 0.61964964, 0.61401424, 0.50934817, 0.68601033, 0.59380039, 0.44732872, 0.48133787, 0.51371543, 0.54849685, 0.65826531, 0.56038412, 0.56756454, 0.57253778, 0.62548523, 0.58481198, 0.66113631, 0.52288045, 0.59708477, 0.67349024, 0.51726228, 0.56208474, 0.56111226, 0.51068435, 0.57128848, 0.57669203, 0.52837565, 0.55844831, 0.55684715, 0.49906096, 0.54165793, 0.51923608, 0.52696240, 0.61702800, 0.49234093, 0.48869424, 0.55651430, 0.55215221, 0.53303708, 0.56521207, 0.58966129, 0.62650137, 0.57609639, 0.64281502, 0.61348136, 0.58808509, 0.54674466, 0.54640107, 0.53303524, 0.48892404, 0.52835679, 0.56898125, 0.48487194, 0.64107605, 0.60652512, 0.45178877, 0.51809536, 0.63032027, 0.50049451, 0.57464976, 0.51414822, 0.64804892, 0.56453802, 0.49765435, 0.60500959, 0.65338847, 0.63355694, 0.56365435, 0.49895948, 0.51224804, 0.54815359, 0.59236642, 0.54485648, 0.48607542, 0.54213521, 0.61089532, 0.51974730, 0.51691905, 0.54605879, 0.56704578, 0.57374987, 0.52677352, 0.57241830, 0.49195420, 0.54699829, 0.56826432, 0.61631103, 0.46830329, 0.51118955, 0.49461294, 0.55696083, 0.57587257, 0.61872797, 0.58295725, 0.55089702, 0.52450622, 0.57171674, 0.61505111, 0.56570059, 0.61332769, 0.45273327, 0.64816235, 0.55814250, 0.60052079, 0.54319743, 0.59318102, 0.44913075, 0.50058538, 0.49502973, 0.41757624, 0.57906143, 0.56695270, 0.54429112, 0.52069666, 0.59398054, 0.56769710, 0.61172941, 0.47863028, 0.56453177, 0.52199438, 0.56107308, 0.59394681, 0.63714007, 0.56187704, 0.56392089, 0.54852227, 0.56378178, 0.55642104, 0.60641010, 0.56822239, 0.56292008, 0.50637802, 0.59356627, 0.55148621, 0.58842857, 0.60257062, 0.57166024, 0.53079479, 0.65749783, 0.58033557, 0.57175376, 0.54676761, 0.56284589, 0.61090138, 0.51087759, 0.55744368, 0.46943477, 0.53383258, 0.56275803, 0.56972978, 0.51404321, 0.52487541, 0.60492362, 0.61427718, 0.64136711, 0.50945011, 0.61260999, 0.54790872, 0.51723030, 0.48361452, 0.66192208, 0.59071518, 0.54459618, 0.56095721, 0.55886811, 0.55620770, 0.60248616, 0.53982472, 0.55515312, 0.57779504, 0.58475568, 0.42939125, 0.55711582, 0.54117477, 0.58197512, 0.59424800, 0.53532889, 0.63931872, 0.55784049, 0.53839417, 0.57923446, 0.57475916, 0.58754882, 0.57722391, 0.50985455, 0.54251587, 0.56593576, 0.61002456, 0.58386724, 0.58903334, 0.48007542, 0.56141922, 0.54623062, 0.58113029, 0.61592777, 0.54927746, 0.55517568, 0.56212025, 0.50797447, 0.60136720, 0.59993322, 0.48475620, 0.64956908, 0.62889349, 0.49809591, 0.54491006, 0.59517129, 0.57453122, 0.52731592, 0.57447282, 0.59025547, 0.54770893, 0.60521856, 0.58426911, 0.51606830, 0.56450284, 0.53307280, 0.59015503, 0.61460482, 0.49881199, 0.52199733, 0.51333827, 0.56141260, 0.53120753, 0.60716321, 0.56627211, 0.59690240, 0.56714483, 0.60771958, 0.51575208, 0.61500720, 0.63159777, 0.56797603, 0.51465019, 0.58042204, 0.60559469, 0.50863737, 0.57760276, 0.60392784, 0.46800700, 0.62440952, 0.61136306, 0.59513601, 0.49838718, 0.52792206, 0.60017443, 0.59674727, 0.59239481, 0.52729870, 0.60599102, 0.62818691, 0.68457727, 0.66981427, 0.61193281, 0.53346025, 0.61076900, 0.55114639, 0.55734721, 0.51023571, 0.48142760, 0.54916196, 0.57647678, 0.55175627, 0.57765934, 0.50138297, 0.47330708, 0.58369785, 0.49741776, 0.52105395, 0.58312372, 0.56273043, 0.53840013, 0.59044999, 0.55911068, 0.62229147, 0.57732235, 0.54188864, 0.52577590, 0.51753687, 0.54119764, 0.60608160, 0.58854093, 0.63299777, 0.52946548, 0.48553321, 0.59698442, 0.53889846, 0.55296257, 0.56393044, 0.57221846, 0.63333411, 0.54707716, 0.59105922, 0.55380287, 0.61103065, 0.66578163, 0.52587584, 0.57471016, 0.63092860, 0.61284199, 0.62610170, 0.66895141, 0.60077736, 0.52378551, 0.54859466, 0.59663114, 0.56856078, 0.50501128, 0.60615078, 0.64811592, 0.62449954, 0.56959041, 0.57767444, 0.48839682, 0.53138667, 0.58531007, 0.61193813, 0.52317385, 0.58689810, 0.51548070, 0.53670612, 0.46151372, 0.60988698, 0.57128902, 0.59818368, 0.58557631, 0.49799994, 0.58299872, 0.53790792, 0.46749973, 0.64039300, 0.58412822, 0.52375439, 0.57593987, 0.56465831, 0.57723735, 0.54455305, 0.62696707, 0.59543238, 0.53176994, 0.52934153, 0.57454341, 0.66214960, 0.56130450, 0.60252700, 0.54610154, 0.55342090, 0.59838000, 0.64128569, 0.54734707, 0.51754089, 0.45840245, 0.50231923, 0.59131533, 0.56195040, 0.58334067, 0.61026894, 0.52744308, 0.66826623, 0.61744282, 0.62096710, 0.62201901, 0.57354494, 0.53798024, 0.50247607, 0.66433200, 0.60313356, 0.50763460, 0.59322607, 0.57150019, 0.54427976, 0.48595134, 0.54846757, 0.59958359, 0.52484015, 0.61979781, 0.55965282, 0.56515191, 0.50958261, 0.61774052, 0.55346996, 0.45850162, 0.50555861, 0.55614293, 0.56778896, 0.64095657, 0.49965984, 0.47521904, 0.54035809, 0.56829267, 0.52502495, 0.55628172, 0.54316710, 0.51909846, 0.50096720, 0.61107724, 0.51351764, 0.61004873, 0.41160405, 0.58463582, 0.55947983, 0.56880171, 0.52531149, 0.61203179, 0.49178103, 0.53411386, 0.56901326, 0.56867064, 0.63632541, 0.57786284, 0.60013447, 0.55183244, 0.48575646, 0.58734988, 0.56911644, 0.60241965, 0.53771770, 0.50407711, 0.58527819, 0.51094022, 0.57288010, 0.54592562, 0.48528306, 0.53218942, 0.59415293, 0.53675487, 0.59016499, 0.62474434, 0.65227987, 0.53048988, 0.62915488, 0.50192973, 0.50768872, 0.58220803, 0.53560156, 0.53978802, 0.57415025, 0.54366054, 0.61168932, 0.55296596, 0.53006170, 0.53411519, 0.54883071, 0.60433643, 0.57519576, 0.56191626, 0.56645975, 0.60429858, 0.57289060, 0.56090873, 0.50272245, 0.48805370, 0.58572654, 0.59785880, 0.55634325, 0.53885208, 0.60294969, 0.59086781, 0.54297875, 0.50035129, 0.54766191, 0.53830602, 0.53256888, 0.59359486, 0.66875386, 0.62912801, 0.50990706, 0.51779119, 0.65251351, 0.60961217, 0.55134686, 0.51462637, 0.49128407, 0.57244525, 0.52593421, 0.52398111, 0.61532820, 0.60451914, 0.55578481, 0.47893232, 0.66023918, 0.59426667, 0.59530395, 0.60727999, 0.60217872, 0.55001276, 0.54054381, 0.60751850, 0.58143467, 0.56480134, 0.56273108, 0.46487077, 0.53245376, 0.49096572, 0.55448153, 0.57374039, 0.63882259, 0.64202504, 0.52893576, 0.70529796, 0.62926237, 0.52554171, 0.54153673, 0.61535352, 0.48234669, 0.53140781, 0.58131164, 0.53008981, 0.58096886, 0.58356583, 0.55394385, 0.55666497, 0.53651055, 0.52275665, 0.60188983, 0.56072888, 0.52640753, 0.50992683, 0.48149559, 0.51431164, 0.57421069, 0.56475395, 0.57816175, 0.53483830, 0.57070619, 0.50126740, 0.55373026, 0.60723408, 0.56104976, 0.57378922, 0.58787508, 0.58750244, 0.52245961, 0.50294138, 0.58050457, 0.60601740, 0.61344580, 0.56272122, 0.54098114, 0.57868132, 0.54065869, 0.61550280, 0.45424226, 0.55569931, 0.52920899, 0.57817143, 0.48395595, 0.57616785, 0.49596921, 0.60627956, 0.55894113, 0.52322260, 0.52483786, 0.44754244, 0.54443244, 0.64653406, 0.53551798, 0.58296742, 0.52275529, 0.54709426, 0.49255421, 0.58781654, 0.64224312, 0.57124727, 0.53783008, 0.67062097, 0.58741613, 0.45608488, 0.52866298, 0.62339058, 0.52579453, 0.57771648, 0.60608792, 0.51971489, 0.60764506, 0.46712077, 0.63507586, 0.59685025, 0.46485408, 0.54183122, 0.55251450, 0.53487253, 0.56756954, 0.65517181, 0.55679067, 0.59976388, 0.53608927, 0.54679683, 0.51070564, 0.61528200, 0.53082122, 0.55282395, 0.60091171, 0.54432757, 0.51437215, 0.55228146, 0.58216942, 0.59467575, 0.63539909, 0.46275557, 0.51259313, 0.55907340, 0.56682782, 0.52971652, 0.53163114, 0.62466249, 0.55313359, 0.53655542, 0.59907040, 0.55354590, 0.67119798, 0.55566845, 0.56926957, 0.51840689, 0.62463497, 0.51722201, 0.56719893, 0.61816786, 0.57001340, 0.53930615, 0.55847786, 0.55771890, 0.45730233, 0.60420948, 0.55467367, 0.62915682, 0.59747692, 0.51711421, 0.69484781, 0.56928625, 0.53747887, 0.51819493, 0.52021630, 0.57904673, 0.54916167, 0.45733180, 0.60367416, 0.54497889, 0.61289443, 0.55284260, 0.52196327, 0.65597830, 0.61501275, 0.60829830, 0.58695413, 0.49887965, 0.61444305, 0.51441881, 0.59780774, 0.51621294, 0.56299309, 0.59444157, 0.50828119, 0.52357251, 0.51082059, 0.52128498, 0.51877065, 0.61470780, 0.52519303, 0.63308817, 0.55712170, 0.49580635, 0.46614979, 0.52784907, 0.57750766, 0.54856081, 0.57750633, 0.53589033, 0.62490079, 0.61694477, 0.61957466, 0.56188623, 0.63747566, 0.57511139, 0.49061982, 0.50857930, 0.61581185, 0.57639176, 0.55133008, 0.56446660, 0.56926791, 0.59987963, 0.57813681, 0.62632058, 0.58180974, 0.66426916, 0.52693010, 0.61586346, 0.62938245, 0.55728754, 0.55302606, 0.53752360, 0.51554196, 0.48265361, 0.54737214, 0.64704423, 0.60493328, 0.50742122, 0.54751529, 0.60125685, 0.54531507, 0.60638749, 0.63406583, 0.58904287, 0.54571289, 0.54540087, 0.61663757, 0.52734304, 0.60774219, 0.53281382, 0.58223117, 0.51253400, 0.53751040, 0.58194996, 0.53166086, 0.52557064, 0.62184222, 0.61428711, 0.51517034, 0.51993098, 0.61134092, 0.60521062, 0.49580685, 0.58574768, 0.54880627, 0.49365254, 0.55812943, 0.53865779, 0.54974249, 0.49854083, 0.57339507, 0.53645797, 0.56450689, 0.56888380, 0.64170423, 0.59891157, 0.55401413, 0.55773625, 0.56768093, 0.69833967, 0.59771269, 0.62724013, 0.57583576, 0.65186698, 0.50501544, 0.51308859, 0.60267659, 0.58076644, 0.51363919, 0.64816152, 0.66549739, 0.64708834, 0.53495937, 0.60330316, 0.54525587, 0.49990577, 0.63418079, 0.62849430, 0.44391867, 0.59213019, 0.61988532, 0.48566736, 0.65612208, 0.49013514, 0.61717695, 0.64810300, 0.59673877, 0.52360902, 0.52845439, 0.58077372, 0.58728694, 0.57624461, 0.52028967, 0.52611253, 0.49335366, 0.57329700, 0.51778323, 0.54669985, 0.62327828, 0.52316897, 0.53936627, 0.67881790, 0.59947240, 0.58810317, 0.46339494, 0.53449194, 0.58425717, 0.56870531, 0.53792372, 0.55343830, 0.59906839, 0.55971272, 0.53254689, 0.45624799, 0.58377376, 0.55661346, 0.62974414, 0.59860824, 0.57494058, 0.60951655, 0.52997434, 0.49854576, 0.58743319, 0.64654450, 0.53424073, 0.59589396, 0.63905972, 0.57535583, 0.47887235, 0.57203596, 0.61357314, 0.52906937, 0.55255546, 0.55093424, 0.55403428, 0.52274500, 0.56300228, 0.64538460, 0.61045085, 0.58457316, 0.53947948, 0.56765919, 0.51683953, 0.55195375, 0.53431979, 0.59481024, 0.54526593, 0.65059519, 0.59442346, 0.55677362, 0.58254264, 0.57377937, 0.57604200, 0.50826418, 0.41216119, 0.57183545, 0.51081341, 0.55013175, 0.56935240, 0.46602671, 0.62688918, 0.54943529, 0.59144573, 0.54227535, 0.52741416, 0.62453097, 0.55098703, 0.55635504, 0.49367592, 0.60688614)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
          df = data[[i_rep]]
          this_theta = est_ols(df)
          print(abs(theta_ols[i_rep] - this_theta))
          theta_ols[i_rep] = this_theta
        }

        g_ols = ggplot(data.frame(theta_ols), aes(x = theta_ols)) +
                    geom_density(fill = "dark blue", alpha = 0.3, color = "dark blue") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_ols


Regularization bias in simple ML-approaches
+++++++++++++++++++++++++++++++++++++++++++

A simple ML approach is given by randomly splitting the sample into two parts.
On the auxiliary sample indexed by :math:`i \in I^C` the nuisance function :math:`g_0(X)` is estimated with an ML method.
Given the estimate :math:`\hat{g}_0(X)`, the final estimate of :math:`\theta` is obtained as (:math:`n=N/2`) using the
other half of observations indexed with :math:`i \in I`


.. math::

    \hat{\theta} = \left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i (Y_i - \hat{g}_0(X_i)).

.. tabbed:: Python

    .. ipython:: python

        def non_orth_score(y, d, g_hat, m_hat, smpls):
            u_hat = y - g_hat
            psi_a = -np.multiply(d, d)
            psi_b = np.multiply(d, u_hat)
            return psi_a, psi_b

    .. ipython:: python

        from doubleml import DoubleMLData
        from doubleml import DoubleMLPLR
        from sklearn.ensemble import RandomForestRegressor
        from sklearn.base import clone
        import numpy as np
        np.random.seed(1111)

        learner = RandomForestRegressor(n_estimators=100)
        ml_m = clone(learner)
        ml_g = clone(learner)

        # to speed up the illustration we hard-code the simulation results
        theta_nonorth = np.array([0.29679605, 0.32957512, 0.31068173, 0.21257769, 0.24413364, 0.25345752, 0.33939174, 0.23944182, 0.40112783, 0.42150297, 0.25818522, 0.29091509, 0.33951067, 0.22294108, 0.32159648, 0.35856862, 0.35489736, 0.1855233 , 0.28606168, 0.37240014, 0.24862315, 0.23150758, 0.22605159, 0.21303468, 0.19763983, 0.17279299, 0.37113039, 0.3002475 , 0.28000418, 0.38411398, 0.31207227, 0.36037211, 0.19136636, 0.27485637, 0.26475161, 0.27621594, 0.25443056, 0.25051007, 0.30329624, 0.25785105, 0.19737409, 0.23533523, 0.32915413, 0.23246208, 0.36057373, 0.28680384, 0.20782164, 0.31016947, 0.25050038, 0.2899227 , 0.27924244, 0.24327245, 0.31947001, 0.28466986, 0.34137068, 0.24159617, 0.37041182, 0.21310598, 0.2759387 , 0.26026004, 0.32561161, 0.34263593, 0.31992973, 0.30455507, 0.33327844, 0.25095254, 0.28828866, 0.27407946, 0.28466116, 0.11480655, 0.28317385, 0.35380692, 0.30480729, 0.29668215, 0.468863  , 0.30420297, 0.34482943, 0.21443583, 0.3242687 , 0.35046336, 0.24702789, 0.2349603 , 0.16790631, 0.29415474, 0.1376781 , 0.17774637, 0.28734929, 0.32890948, 0.26458314, 0.22850889, 0.22346573, 0.26701379, 0.25146223, 0.32005597, 0.33020728, 0.27383579, 0.21924728, 0.27265236, 0.30437842, 0.28650595, 0.22775761, 0.40406112, 0.24168389, 0.34408412, 0.29825323, 0.20407617, 0.30838721, 0.3070743 , 0.29832671, 0.37465763, 0.2777784 , 0.24747046, 0.35157628, 0.33699291, 0.27732555, 0.23928981, 0.31883952, 0.25784045, 0.20029927, 0.22408316, 0.40036378, 0.29695996, 0.3197772 , 0.25043462, 0.20087615, 0.37390256, 0.21028026, 0.27264596, 0.36447548, 0.25842762, 0.27328176, 0.2828846 , 0.2830529 , 0.25562532, 0.15946193, 0.39144025, 0.20739178, 0.35810203, 0.24937832, 0.36519893, 0.15781118, 0.27733858, 0.284265  , 0.34339164, 0.23256502, 0.29133951, 0.23686348, 0.36632719, 0.30117009, 0.3170157 , 0.31739035, 0.26371919, 0.23883645, 0.33096716, 0.11829353, 0.34605854, 0.20426494, 0.20888901, 0.34154846, 0.30642106, 0.29702598, 0.24843267, 0.26040456, 0.17571845, 0.33543179, 0.12822694, 0.37334006, 0.30841235, 0.29057858, 0.28409939, 0.30495422, 0.33716629, 0.33699189, 0.26268809, 0.31182871, 0.30544001, 0.37447803, 0.27048427, 0.27861903, 0.37453693, 0.25371825, 0.31993988, 0.29417262, 0.27327934, 0.2356018 , 0.26829812, 0.2107135 , 0.13589261, 0.35871259, 0.29706744, 0.14368303, 0.3271124 , 0.27173275, 0.16528799, 0.25619998, 0.26499333, 0.32555653, 0.25395111, 0.17301322, 0.20045586, 0.2726404 , 0.21387808, 0.28591298, 0.28251268, 0.27982564, 0.20283982, 0.16540732, 0.20980748, 0.27490177, 0.24323069, 0.21709503, 0.34283237, 0.15684596, 0.16634989, 0.18626848, 0.29811731, 0.25023395, 0.2794405 , 0.45194967, 0.28408159, 0.29486078, 0.31015878, 0.33252436, 0.28176203, 0.34624988, 0.32290496, 0.15657211, 0.32339951, 0.26366066, 0.30012215, 0.38162212, 0.31101005, 0.43273083, 0.2648901 , 0.29795227, 0.36185553, 0.168115  , 0.20424897, 0.34867057, 0.26440432, 0.28222637, 0.38942416, 0.33700583, 0.2364373 , 0.38189848, 0.22853011, 0.40484275, 0.26115386, 0.31731642, 0.22582248, 0.30351372, 0.19957617, 0.24117668, 0.36297824, 0.22495632, 0.25327547, 0.27890354, 0.33509105, 0.34045678, 0.20752697, 0.2352852 , 0.31052975, 0.25952168, 0.25763154, 0.24524071, 0.41417296, 0.33331372, 0.35983166, 0.19286173, 0.30365136, 0.11982952, 0.35331187, 0.16813625, 0.44774213, 0.24564107, 0.31762917, 0.24861867, 0.15256724, 0.28019331, 0.29868233, 0.38777607, 0.28408027, 0.32361829, 0.31034472, 0.32675595, 0.29739539, 0.39007811, 0.33230278, 0.39474302, 0.21282175, 0.29043153, 0.24047133, 0.17348579, 0.24082973, 0.26914561, 0.22781109, 0.32047801, 0.23134756, 0.22365539, 0.23478497, 0.22434556, 0.36489232, 0.26568996, 0.2334255 , 0.24267271, 0.31245332, 0.36882274, 0.21711598, 0.32151622, 0.27137295, 0.32011318, 0.17964615, 0.37453214, 0.25836642, 0.12869443, 0.42303041, 0.21269069, 0.34446804, 0.18511917, 0.35824219, 0.31552653, 0.2499332 , 0.31599485, 0.35168467, 0.24912651, 0.35285022, 0.25313049, 0.39630436, 0.23129588, 0.33895786, 0.247044  , 0.39795555, 0.18242405, 0.23112187, 0.21275385, 0.23972371, 0.28195518, 0.23625609, 0.27053391, 0.2366347 , 0.41668158, 0.24153989, 0.31499471, 0.26470919, 0.21034403, 0.33191124, 0.31307725, 0.29627452, 0.312004  , 0.22151743, 0.36624646, 0.28678424, 0.36415371, 0.27073968, 0.35815656, 0.29731216, 0.27753397, 0.2007902 , 0.29068127, 0.21913443, 0.31828602, 0.1884884 , 0.3318458 , 0.25933361, 0.35345206, 0.29469604, 0.1767253 , 0.32844964, 0.26190563, 0.30638805, 0.2163965 , 0.24981114, 0.31341823, 0.28867339, 0.25576252, 0.28703362, 0.2974881 , 0.23887368, 0.3891675 , 0.19134132, 0.32722764, 0.30841591, 0.23955918, 0.32926522, 0.3146866 , 0.24183083, 0.30830199, 0.29970906, 0.21860963, 0.30890365, 0.31368344, 0.29268751, 0.24721539, 0.21324323, 0.26247702, 0.27513594, 0.25858458, 0.30359055, 0.21135042, 0.41252371, 0.20882719, 0.32741503, 0.31152402, 0.28353282, 0.26774892, 0.28646551, 0.26059597, 0.36700196, 0.36050925, 0.24541552, 0.25511596, 0.24936221, 0.22795882, 0.1556826 , 0.21889188, 0.26494178, 0.32447313, 0.18426353, 0.15247604, 0.20402322, 0.1998415 , 0.25099638, 0.3101037 , 0.23232221, 0.34542512, 0.13984517, 0.30171714, 0.2827545 , 0.33478855, 0.38576438, 0.45932686, 0.2798762 , 0.27515592, 0.33180863, 0.24265284, 0.27443945, 0.23089534, 0.17068289, 0.27308349, 0.32719977, 0.42466151, 0.22317795, 0.31157793, 0.26422155, 0.39181507, 0.26310269, 0.16354276, 0.2482511 , 0.20448507, 0.17531259, 0.32001307, 0.16817169, 0.23011699, 0.23154515, 0.23767968, 0.33371856, 0.36688108, 0.14105553, 0.29670389, 0.20989105, 0.25969709, 0.30742557, 0.27059633, 0.38615522, 0.30586652, 0.24036826, 0.28530316, 0.24676037, 0.1934947 , 0.27087168, 0.30008059, 0.31670259, 0.29954058, 0.26807183, 0.31847831, 0.2156835 , 0.23956747, 0.24556076, 0.28964291, 0.32914556, 0.31600496, 0.30605659, 0.38311224, 0.40016883, 0.30643568, 0.35951091, 0.21140275, 0.32993458, 0.33372245, 0.26658281, 0.26626999, 0.17316331, 0.25091592, 0.18913443, 0.23716569, 0.37684718, 0.27228763, 0.32193899, 0.21077201, 0.36309506, 0.22321712, 0.3710447 , 0.33971913, 0.26053509, 0.28817737, 0.19965886, 0.1896735 , 0.40838362, 0.36368254, 0.34556244, 0.19100224, 0.24446888, 0.23231819, 0.405489  , 0.40400974, 0.27095832, 0.25121596, 0.24609318, 0.18155156, 0.21477772, 0.31756558, 0.25673351, 0.27346287, 0.22484023, 0.23770717, 0.30339801, 0.37487601, 0.29421733, 0.35354028, 0.18393565, 0.4893736 , 0.30271432, 0.33373841, 0.33749562, 0.29273051, 0.21965208, 0.3519047 , 0.3782592 , 0.21998575, 0.25360033, 0.37175875, 0.34021636, 0.29779569, 0.2479152 , 0.26941452, 0.31804903, 0.31525528, 0.33192498, 0.31407982, 0.30193385, 0.13699477, 0.22763375, 0.23689478, 0.37331276, 0.28075292, 0.32078398, 0.23287623, 0.24084911, 0.39365387, 0.27238342, 0.26742955, 0.35123857, 0.12716602, 0.26998991, 0.33870836, 0.3594415 , 0.26786502, 0.24911161, 0.37654081, 0.26401827, 0.26426355, 0.26230141, 0.21792683, 0.29919519, 0.32935249, 0.25465608, 0.30577643, 0.20976466, 0.23947566, 0.25082969, 0.25580604, 0.31247366, 0.23026259, 0.3287677 , 0.31377704, 0.22861677, 0.21241008, 0.28502275, 0.26020091, 0.17534777, 0.21332275, 0.31859392, 0.30578838, 0.33008569, 0.22695115, 0.28267711, 0.20995274, 0.30712861, 0.25174358, 0.26293734, 0.39926306, 0.4094122 , 0.23864894, 0.21965822, 0.2746896 , 0.23832186, 0.29818065, 0.25029868, 0.23981032, 0.38641925, 0.32594176, 0.31442879, 0.27557087, 0.22758644, 0.28830315, 0.32035305, 0.27132454, 0.31319748, 0.24586209, 0.22647133, 0.25435754, 0.35364013, 0.23676324, 0.25909375, 0.36416962, 0.33923276, 0.27482175, 0.31527037, 0.29069018, 0.32016767, 0.36199457, 0.36634307, 0.27905185, 0.26591086, 0.34088192, 0.22517353, 0.28695741, 0.48139514, 0.20512337, 0.33352548, 0.24662517, 0.27097216, 0.29196119, 0.22287756, 0.29951944, 0.26349198, 0.38482098, 0.24508414, 0.35575637, 0.19194213, 0.2696152 , 0.3517681 , 0.29562165, 0.33175759, 0.22677601, 0.32152582, 0.27376982, 0.31023537, 0.16808203, 0.38752679, 0.26321878, 0.32430601, 0.41266399, 0.34333301, 0.23084731, 0.30009422, 0.32729981, 0.35304698, 0.21747483, 0.28223348, 0.26573485, 0.2017466 , 0.20549198, 0.27050704, 0.3505072 , 0.26580412, 0.30182548, 0.22009739, 0.23423928, 0.34235092, 0.37531875, 0.28941897, 0.26556007, 0.11324665, 0.34813396, 0.40858105, 0.35478199, 0.1857985 , 0.27030601, 0.3132229 , 0.17625634, 0.35954289, 0.19003642, 0.17460796, 0.26226866, 0.31605287, 0.33954386, 0.36477729, 0.24511494, 0.339712  , 0.27174663, 0.28806664, 0.23451845, 0.22301992, 0.20289772, 0.22189346, 0.26319462, 0.34178308, 0.33258075, 0.28396373, 0.17803691, 0.40887652, 0.32106122, 0.31609469, 0.24033328, 0.31878602, 0.1779888 , 0.31375176, 0.26944556, 0.2282    , 0.24927123, 0.27086278, 0.24145369, 0.28054479, 0.34429956, 0.27980076, 0.3109697 , 0.25763417, 0.34954545, 0.28276579, 0.30552692, 0.25722401, 0.24311547, 0.27603095, 0.35559001, 0.3288998 , 0.39184018, 0.1875853 , 0.30325991, 0.34357666, 0.24415904, 0.28710774, 0.13232982, 0.34500569, 0.3287172 , 0.28138829, 0.39089955, 0.26070544, 0.20554212, 0.29529805, 0.3191856 , 0.38233052, 0.38108764, 0.28093007, 0.25813176, 0.4535886 , 0.26202736, 0.29011877, 0.29534255, 0.27722879, 0.19550926, 0.22662657, 0.33067833, 0.31507375, 0.25421744, 0.29285879, 0.30152957, 0.28930933, 0.35658707, 0.21995133, 0.26171144, 0.18546017, 0.2626822 , 0.21282791, 0.31654949, 0.25989504, 0.37648605, 0.40962144, 0.30483946, 0.27132915, 0.27328356, 0.24119692, 0.2527897 , 0.21964396, 0.27946546, 0.36998692, 0.14368716, 0.27769412, 0.27029076, 0.32919668, 0.29371133, 0.23624589, 0.21061951, 0.33257537, 0.29453733, 0.2900873 , 0.2194386 , 0.2197191 , 0.30061447, 0.19320315, 0.20051296, 0.29877259, 0.14021613, 0.35590796, 0.24364629, 0.26947337, 0.24976757, 0.15913207, 0.31975041, 0.30691886, 0.31121174, 0.23143689, 0.27358734, 0.3548515 , 0.2652643 , 0.27244918, 0.31191098, 0.2545304 , 0.3182436 , 0.25835956, 0.31731542, 0.30574765, 0.32106847, 0.26234575, 0.34586492, 0.28377021, 0.1563255 , 0.31114134, 0.20145578, 0.26203733, 0.28616613, 0.17939201, 0.24943607, 0.2793056 , 0.27715064, 0.35437497, 0.30769958, 0.28468707, 0.27433965, 0.32636791, 0.15582302, 0.25024391, 0.2904759 , 0.15988646, 0.26979871, 0.24119756, 0.34552596, 0.30854059, 0.27772718, 0.36265291, 0.29408408, 0.3246014 , 0.30468724, 0.32229337, 0.26031393, 0.3146074 , 0.21912605, 0.36708532, 0.20678841, 0.39551674, 0.27939865, 0.35820962, 0.35184356, 0.22723562, 0.2378745 , 0.3880068 , 0.38027836, 0.2706534 , 0.19197872, 0.28671985, 0.28327138, 0.25102241, 0.25376087, 0.27468498, 0.19446275, 0.18863406, 0.33332452, 0.34795792, 0.24702422, 0.39747454, 0.24838265, 0.3543367 , 0.38877525, 0.23748692, 0.16216944, 0.37369278, 0.30304297, 0.24579843, 0.17652643, 0.37390149, 0.31909786, 0.32201009, 0.27091736, 0.25141746, 0.24417993, 0.25107227, 0.26077665, 0.09972868, 0.26627454, 0.38050445, 0.30352801, 0.33329665, 0.21256174, 0.2384502 , 0.20230229, 0.17416242, 0.27979653, 0.20512292, 0.21927453, 0.37119061, 0.26152583, 0.14785347, 0.33210893, 0.28398626, 0.28456189, 0.1476003 , 0.26104776, 0.26338231, 0.22404511, 0.34629209, 0.34185823, 0.28127588, 0.24221467, 0.30971946, 0.32472845, 0.2012553 , 0.2320941 , 0.41755168, 0.24276716, 0.2507632 , 0.3156745 , 0.21192168, 0.21057475, 0.29911174, 0.29335453, 0.32286649, 0.2932949 , 0.2751863 , 0.26723268, 0.23281359, 0.22063521, 0.3027866 , 0.26972679, 0.20679624, 0.15792408, 0.22099853, 0.3454382 , 0.32571292, 0.20160838, 0.32055328, 0.2378003 , 0.2142103 , 0.26425829, 0.24741648, 0.22685479, 0.36895567, 0.30211914, 0.23346892, 0.25034601, 0.27684176, 0.22650335, 0.21455088, 0.26977488, 0.29817784, 0.29607516, 0.33678634, 0.30176709, 0.24415958, 0.33129447, 0.33175802, 0.39795847, 0.31680336, 0.26647652, 0.30671846, 0.23667905, 0.31752655, 0.19342789, 0.30054004, 0.26254493, 0.25320432, 0.37415042, 0.19410236, 0.20820447, 0.35653844, 0.2707344 , 0.26369249, 0.29958195, 0.24486328, 0.22229448, 0.38939821, 0.22894142, 0.34607668, 0.22250118, 0.32124781, 0.28692343, 0.31598853, 0.32733083, 0.3214234 , 0.3071906 , 0.24947136])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr_nonorth = DoubleMLPLR(obj_dml_data,
                                              ml_m, ml_g,
                                              n_folds=2,
                                              apply_cross_fitting=False,
                                              score=non_orth_score)
            obj_dml_plr_nonorth.fit()
            this_theta = obj_dml_plr_nonorth.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_nonorth[i_rep] - this_theta))
            theta_nonorth[i_rep] = this_theta

        ax = sns.kdeplot(theta_nonorth, shade=True, color=colors[1])
        @savefig nonorth.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        non_orth_score = function(y, d, g_hat, m_hat, smpls) {
         u_hat = y - g_hat
         psi_a = -1*d*d
         psi_b = d*u_hat
         psis = list(psi_a = psi_a, psi_b = psi_b)
         return(psis)
        }


    .. jupyter-execute::

        library(mlr3)
        library(mlr3learners)
        library(data.table)
        lgr::get_logger("mlr3")$set_threshold("warn")
        set.seed(1111)

        learner = lrn("regr.ranger", num.trees = 100, mtry = 20, min.node.size = 2, max.depth = 5)
        ml_m = learner$clone()
        ml_g = learner$clone()

        # to speed up the illustration we hard-code the simulation results
        theta_nonorth = c(0.334301792, 0.382362163, 0.340523434, 0.212148418, 0.169059365, 0.224893109, 0.357667586, 0.371251163, 0.142404500, 0.246200553, 0.364780326, 0.293014267, 0.279750088, 0.235626760, 0.280999833, 0.215160245, 0.294437118, 0.275316161, 0.348827405, 0.287640556, 0.249338704, 0.242065658, 0.437302344, 0.281592828, 0.293128770, 0.243506797, 0.154210765, 0.324504466, 0.272916482, 0.345503832, 0.254453194, 0.195755735, 0.125554802, 0.357950176, 0.311636323, 0.312313732, 0.218408088, 0.425636268, 0.319245484, 0.346378010, 0.359674392, 0.403772970, 0.138935625, 0.391104862, 0.399896870, 0.300021287, 0.326225585, 0.292143675, 0.343125427, 0.147859165, 0.233518883, 0.340372030, 0.307856641, 0.264522824, 0.220069717, 0.403891425, 0.259313891, 0.139918505, 0.223976971, 0.265842939, 0.301732308, 0.272162252, 0.315115153, 0.255757129, 0.344332487, 0.205830706, 0.236648747, 0.311428437, 0.393278956, 0.305628532, 0.251775132, 0.348330726, 0.221393129, 0.290651507, 0.273723492, 0.263755023, 0.308733574, 0.347732064, 0.189642371, 0.298278714, 0.162688126, 0.239874419, 0.239099636, 0.215164023, 0.360673417, 0.238636152, 0.315653277, 0.309837160, 0.322136037, 0.429401723, 0.459964744, 0.269722380, 0.240195556, 0.300964657, 0.257396151, 0.305723485, 0.256157599, 0.180138433, 0.293305995, 0.197100578, 0.249608643, 0.422464768, 0.277954659, 0.177607701, 0.341700023, 0.247089598, 0.260381244, 0.358048341, 0.318976957, 0.240519690, 0.337325238, 0.247304692, 0.172391931, 0.369875091, 0.176954008, 0.279592677, 0.271277755, 0.334334150, 0.372406351, 0.148380570, 0.285546077, 0.292321140, 0.200225143, 0.290690368, 0.295146769, 0.214979020, 0.277565050, 0.391819410, 0.243356902, 0.307285498, 0.248273483, 0.282436979, 0.208594091, 0.417756312, 0.312062669, 0.271447615, 0.327630684, 0.275611927, 0.275583926, 0.256250070, 0.276858657, 0.328730296, 0.397909953, 0.353153777, 0.393651543, 0.260929610, 0.380140636, 0.325346022, 0.356697000, 0.304936949, 0.412289584, 0.294014694, 0.418201436, 0.330932760, 0.343442331, 0.298549000, 0.206291432, 0.172026103, 0.268614241, 0.217427453, 0.265822249, 0.273075777, 0.258449615, 0.176067164, 0.186662280, 0.328234850, 0.256368307, 0.287770130, 0.316004864, 0.344399707, 0.168420604, 0.275878574, 0.327238453, 0.281274199, 0.466670028, 0.147205538, 0.200275690, 0.363375804, 0.240426340, 0.367571568, 0.278661758, 0.191753306, 0.328167784, 0.296139364, 0.152818799, 0.242250460, 0.388706202, 0.379811666, 0.284894701, 0.234338573, 0.310034875, 0.384566126, 0.329362970, 0.332406782, 0.213706870, 0.298593509, 0.229952321, 0.322005969, 0.202347807, 0.275296740, 0.269969078, 0.330995223, 0.128599638, 0.362322595, 0.438054469, 0.130635855, 0.292133914, 0.460956452, 0.222610357, 0.243229185, 0.285411753, 0.312452578, 0.258244423, 0.277715492, 0.390026282, 0.415628933, 0.317476554, 0.206315002, 0.194905126, 0.234459793, 0.153018054, 0.381291928, 0.203966567, 0.155798112, 0.274697600, 0.321884178, 0.296861425, 0.385939429, 0.322258548, 0.231321528, 0.349196319, 0.306567532, 0.232088462, 0.215487998, 0.308535908, 0.342314069, 0.351021657, 0.249237813, 0.222795535, 0.250168144, 0.171969587, 0.318140651, 0.208965798, 0.274970342, 0.113126498, 0.238707011, 0.242028434, 0.373567406, 0.403137732, 0.217471686, 0.297568796, 0.311908278, 0.314644359, 0.188570063, 0.364854293, 0.298174137, 0.314072989, 0.379010894, 0.258534639, 0.154349553, 0.324568752, 0.265465586, 0.246968690, 0.246052391, 0.281958213, 0.245703190, 0.275896457, 0.293358004, 0.312599116, 0.135706191, 0.275053588, 0.312820710, 0.275599568, 0.305406395, 0.196877920, 0.392168754, 0.261494517, 0.233760080, 0.394906832, 0.371065449, 0.236422010, 0.224814334, 0.300273461, 0.276080614, 0.360642445, 0.389229250, 0.267005725, 0.353213644, 0.441214151, 0.274175810, 0.192970258, 0.296709939, 0.291803154, 0.378031519, 0.276809573, 0.272151186, 0.194732455, 0.319555153, 0.232541632, 0.292453479, 0.128109411, 0.372739180, 0.262036532, 0.244533364, 0.399039118, 0.264928805, 0.324061954, 0.222214422, 0.276506645, 0.271142842, 0.276027702, 0.217835444, 0.234161259, 0.235276499, 0.265231546, 0.250103858, 0.402541916, 0.192869659, 0.361177828, 0.395658873, 0.336718801, 0.258695706, 0.241983920, 0.310012700, 0.211973933, 0.420371977, 0.276299352, 0.327974440, 0.232934584, 0.263915047, 0.317017347, 0.274567232, 0.270652784, 0.333543837, 0.235480605, 0.295085109, 0.257887169, 0.371283176, 0.295465850, 0.304467063, 0.257263596, 0.362942377, 0.265885360, 0.306104497, 0.241019368, 0.264985273, 0.271688086, 0.327406175, 0.267696027, 0.367559088, 0.242176262, 0.295493814, 0.355795055, 0.395146080, 0.183975595, 0.216949911, 0.277741411, 0.409839137, 0.212173995, 0.300621618, 0.288943114, 0.229147433, 0.331416467, 0.201070593, 0.181788407, 0.249558315, 0.296475410, 0.304644403, 0.273344962, 0.236776400, 0.311376919, 0.251741971, 0.296878307, 0.294603118, 0.289437980, 0.235839079, 0.292865460, 0.174820267, 0.258071114, 0.284104049, 0.350472347, 0.357983495, 0.369112919, 0.334453256, 0.319844562, 0.207531124, 0.225488725, 0.217969645, 0.350988864, 0.279467447, 0.357277303, 0.330173427, 0.282731166, 0.319992495, 0.220540458, 0.259680996, 0.257819290, 0.360960866, 0.240552015, 0.353683049, 0.282280933, 0.409342339, 0.376979236, 0.360873146, 0.266613413, 0.298636780, 0.307961158, 0.246633589, 0.254229630, 0.284777321, 0.327387251, 0.279635146, 0.295119458, 0.369189199, 0.310984424, 0.164495140, 0.195154447, 0.281599250, 0.263734639, 0.313052056, 0.310670876, 0.319981266, 0.190110511, 0.331012652, 0.259638582, 0.266820360, 0.248152149, 0.348326167, 0.262590871, 0.238381082, 0.290231785, 0.207790790, 0.289044965, 0.249223667, 0.219726897, 0.315072758, 0.332872664, 0.303423929, 0.238711302, 0.295153117, 0.377949570, 0.233377826, 0.246009986, 0.440981686, 0.283376563, 0.208573436, 0.391032175, 0.284825407, 0.205020573, 0.314542850, 0.272856779, 0.255773415, 0.332062910, 0.251676800, 0.312855045, 0.283450374, 0.349895356, 0.154979926, 0.269876238, 0.378757984, 0.107758197, 0.281380014, 0.134593688, 0.196285965, 0.334723211, 0.255252060, 0.289192809, 0.203472169, 0.302955775, 0.344889548, 0.273906203, 0.259598806, 0.169480151, 0.258838902, 0.224912587, 0.306606996, 0.202941135, 0.403935509, 0.203372510, 0.227395620, 0.223223505, 0.292525993, 0.210511680, 0.212912173, 0.201747068, 0.255659261, 0.359863280, 0.410212482, 0.409300958, 0.265585337, 0.250942643, 0.296897291, 0.318281309, 0.211193205, 0.282612943, 0.349817682, 0.381010739, 0.284773310, 0.462356992, 0.215054607, 0.206572985, 0.305961970, 0.286927990, 0.312650545, 0.244075629, 0.361203502, 0.294160531, 0.256379418, 0.370873102, 0.393930271, 0.428976807, 0.271028686, 0.315242481, 0.276185621, 0.232014369, 0.251069346, 0.307819438, 0.264045535, 0.312971688, 0.330049110, 0.290507345, 0.211461856, 0.260309136, 0.390142430, 0.272803666, 0.380043671, 0.305516025, 0.232668778, 0.353684427, 0.288511477, 0.342557311, 0.222486397, 0.356872737, 0.414216392, 0.253593435, 0.393197781, 0.192485363, 0.285903336, 0.146910148, 0.305425367, 0.271255895, 0.294634189, 0.236294910, 0.290142659, 0.253232940, 0.360206628, 0.177847060, 0.309069007, 0.151355722, 0.274332741, 0.311813829, 0.174356579, 0.330577083, 0.348137105, 0.238628435, 0.209962478, 0.228697672, 0.386339726, 0.311751592, 0.313553716, 0.291499266, 0.245182538, 0.256677905, 0.309404938, 0.217249816, 0.341520600, 0.224221505, 0.273926068, 0.228225428, 0.288307051, 0.270530883, 0.202469190, 0.311971565, 0.253442573, 0.218829934, 0.266405496, 0.205555685, 0.232568736, 0.285162580, 0.209863530, 0.296613323, 0.130193672, 0.250361119, 0.280097734, 0.268494324, 0.326135462, 0.244135606, 0.249481773, 0.394999761, 0.279176297, 0.255553645, 0.317563363, 0.298809906, 0.262105591, 0.238755757, 0.364943696, 0.331377940, 0.308389786, 0.383183019, 0.311639358, 0.249502220, 0.162376681, 0.337663172, 0.417809471, 0.045162205, 0.316232881, 0.389131719, 0.350018017, 0.290424010, 0.162869563, 0.262234438, 0.384159718, 0.308951694, 0.359456767, 0.335467327, 0.323901956, 0.197153403, 0.279974236, 0.228093600, 0.201036916, 0.282469088, 0.294645108, 0.319088557, 0.271445943, 0.198652966, 0.313415163, 0.356264392, 0.354112077, 0.332768332, 0.275298226, 0.348009826, 0.283298709, 0.214014166, 0.393526137, 0.235436787, 0.234381882, 0.346517471, 0.286811069, 0.383992530, 0.386412862, 0.259571544, 0.213006513, 0.238596828, 0.135415238, 0.241271634, 0.323250033, 0.398953002, 0.350120961, 0.317085169, 0.413396078, 0.272775847, 0.316992161, 0.175047119, 0.333776300, 0.365127796, 0.237548833, 0.326150783, 0.280548685, 0.266896126, 0.375264355, 0.261963509, 0.219038271, 0.149897213, 0.288840000, 0.384339151, 0.430297120, 0.266033743, 0.297096262, 0.250344360, 0.264868738, 0.295594448, 0.357291831, 0.232293824, 0.209357550, 0.292363853, 0.329739543, 0.273212442, 0.405016516, 0.303780532, 0.243335806, 0.205819109, 0.275201962, 0.254885110, 0.288140311, 0.319507834, 0.425849854, 0.341629055, 0.223724840, 0.389428181, 0.250912692, 0.355307555, 0.347825281, 0.253746848, 0.247201171, 0.214908697, 0.316318413, 0.292140111, 0.244355444, 0.256271237, 0.253620870, 0.257814150, 0.247363046, 0.230032193, 0.112408621, 0.309018316, 0.371757395, 0.170989447, 0.222380129, 0.262779265, 0.207750325, 0.308320460, 0.379365267, 0.268565266, 0.318906529, 0.403231288, 0.355001791, 0.288528488, 0.209261540, 0.216368635, 0.334152472, 0.257946784, 0.389010641, 0.327427092, 0.228533431, 0.243096024, 0.355593544, 0.358062774, 0.328009075, 0.245097523, 0.239548564, 0.274284144, 0.350463693, 0.265373026, 0.388895428, 0.262005335, 0.298903008, 0.279212912, 0.278086805, 0.307255979, 0.270900845, 0.303988317, 0.298080704, 0.265119499, 0.338198979, 0.298075141, 0.336058657, 0.397777150, 0.313806910, 0.325692046, 0.266236905, 0.197487524, 0.285981023, 0.352137171, 0.246885422, 0.276880001, 0.335376638, 0.279637631, 0.303652382, 0.280478987, 0.245345484, 0.236852646, 0.228880115, 0.287122684, 0.326808506, 0.306767684, 0.192954401, 0.354426471, 0.303976766, 0.381327218, 0.273133742, 0.332577516, 0.215344972, 0.197115398, 0.214766597, 0.220878593, 0.422803278, 0.271224891, 0.227652750, 0.450923760, 0.324513884, 0.150393041, 0.259433800, 0.262154897, 0.282097870, 0.209922423, 0.243506761, 0.312550723, 0.336860901, 0.344019533, 0.248688318, 0.378511172, 0.316763248, 0.298725177, 0.383099925, 0.223117954, 0.190760877, 0.368633242, 0.319218694, 0.272445981, 0.238364406, 0.318344300, 0.333314339, 0.259458961, 0.266251978, 0.236932315, 0.409355158, 0.284622451, 0.269026734, 0.258075006, 0.278670295, 0.302669959, 0.292450804, 0.155925656, 0.268519510, 0.255041291, 0.215063070, 0.315840146, 0.222323552, 0.321359548, 0.300912546, 0.224777936, 0.258493650, 0.319250486, 0.280186704, 0.138223502, 0.307731261, 0.309526153, 0.230466412, 0.278518036, 0.292088067, 0.405313228, 0.304471352, 0.243945819, 0.309362734, 0.311263839, 0.374211605, 0.270831938, 0.288522317, 0.246409285, 0.366063301, 0.280897821, 0.378804464, 0.165137322, 0.229647219, 0.198550886, 0.372354252, 0.300365234, 0.240710105, 0.305827514, 0.259945147, 0.264619702, 0.305696864, 0.296630506, 0.310323330, 0.372956218, 0.285707255, 0.291818858, 0.292737681, 0.334493759, 0.277167094, 0.299670566, 0.249816017, 0.323277775, 0.299707624, 0.368158944, 0.251905133, 0.267467640, 0.355977313, 0.235742785, 0.215979537, 0.362410789, 0.284889483, 0.304003742, 0.228160600, 0.309110829, 0.195882573, 0.210266013, 0.194784568, 0.221014561, 0.262064669, 0.267955368, 0.236187031, 0.393340709, 0.240797373, 0.328563572, 0.235615208, 0.225607749, 0.142020164, 0.379884007, 0.388534603, 0.227268893, 0.380240783, 0.282164832, 0.294764800, 0.278896585, 0.247252354, 0.238135447, 0.270617064, 0.270056949, 0.340700210, 0.224963721, 0.263004653, 0.326323400, 0.295245345, 0.323256386, 0.239582656, 0.282111350, 0.312700550, 0.189800140, 0.313014046, 0.264552307, 0.267596503, 0.268678851, 0.267408693, 0.198380258, 0.254279252, 0.207605652, 0.302686218, 0.303119635, 0.273088864, 0.257363384, 0.436098854, 0.163459785, 0.238679920, 0.289483250, 0.361306937, 0.255716505, 0.310463224, 0.196920359, 0.269636987, 0.264919636, 0.271662030, 0.292553427, 0.324165994, 0.177442502, 0.251462508, 0.345243516, 0.318776630, 0.349767532, 0.256534117, 0.195970611, 0.205189744, 0.263907407, 0.235893571, 0.273636180, 0.281247940, 0.270909860, 0.278667171, 0.321301310, 0.367964768, 0.256736284, 0.248014350, 0.213732007, 0.312677261, 0.221433707, 0.310099824, 0.353680308, 0.231536633, 0.193855989, 0.301574798, 0.383396867, 0.240017944, 0.202400124, 0.232118369, 0.349093243, 0.243387971, 0.293620739, 0.327687985, 0.232137048, 0.161061712, 0.242582209, 0.259307461, 0.363104738, 0.356422220, 0.281962758, 0.300674549, 0.375219212, 0.285321492, 0.173028780, 0.262146246, 0.383091273, 0.346603802, 0.331250721, 0.214696349, 0.283535179, 0.103316754, 0.248462689, 0.283356316, 0.271743441, 0.284659787, 0.358651168, 0.269786280, 0.289981993, 0.250076449, 0.411763321, 0.342744380, 0.192041793, 0.336434646, 0.281313811, 0.283680228)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr_nonorth = DoubleMLPLR$new(obj_dml_data,
                                                  ml_g, ml_m,
                                                  n_folds=2,
                                                  score=non_orth_score,
                                                  apply_cross_fitting=FALSE)
            obj_dml_plr_nonorth$fit()
            this_theta = obj_dml_plr_nonorth$coef
            print(abs(theta_nonorth[i_rep] - this_theta))
            theta_nonorth[i_rep] = this_theta
        }

        g_nonorth = ggplot(data.frame(theta_nonorth), aes(x = theta_nonorth)) +
                        geom_density(fill = "dark orange", alpha = 0.3, color = "dark orange") +
                        geom_vline(aes(xintercept = alpha), col = "black") +
                        xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_nonorth


The regularization bias in the simple ML-approach is caused by the slow convergence of :math:`\hat{\theta}`

.. math::

    |\sqrt{n} (\hat{\theta} - \theta) | \rightarrow_{P} \infty

i.e. slower than :math:`1/\sqrt{n}`.
The driving factor is the bias in learning :math:`g`.
A Heuristic illustration is given by

.. math::

    \sqrt{n}(\hat{\theta} - \theta) = \underbrace{\left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i U_i}_{=:a}
    +  \underbrace{\left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i (g_0(X_i) - \hat{g}_0(X_i))}_{=:b}.

:math:`a` is approximately Gaussian under mild conditions.
However, :math:`b` (the regularization bias) diverges in general.

.. _bias_non_orth:

Overcoming regularization bias by orthogonalization
+++++++++++++++++++++++++++++++++++++++++++++++++++

To overcome the regularization bias we are directly partialling out the effect of :math:`X` from :math:`D` to obtain the
orthogonalized regressor :math:`V = D - m(X)`. We then use the final estimate

.. math::

    \check{\theta} = \left(\frac{1}{n} \sum_{i\in I} \hat{V}_i D_i\right)^{-1} \frac{1}{n} \sum_{i\in I} \hat{V}_i (Y_i - \hat{g}_0(X_i)).

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        np.random.seed(2222)

        # to speed up the illustration we hard-code the simulation results
        theta_orth_nosplit = np.array([0.22023318, 0.19512947, 0.17791766, 0.18959941, 0.18470874, 0.18163931, 0.19246392, 0.18340614, 0.21750892, 0.23529775, 0.2133142 , 0.19480662, 0.21384866, 0.15559891, 0.1856335 , 0.19096774, 0.2022617 , 0.17499436, 0.20591233, 0.20230211, 0.18490285, 0.16555014, 0.175788  , 0.19465384, 0.17809635, 0.18950193, 0.19205119, 0.17582973, 0.17714269, 0.19774612, 0.20631753, 0.22711128, 0.15862832, 0.15994921, 0.17796572, 0.16790858, 0.19467776, 0.20111571, 0.18849586, 0.17934543, 0.17555069, 0.19271825, 0.1799472 , 0.15138443, 0.2062645 , 0.18913462, 0.19260511, 0.18824945, 0.19488347, 0.21906489, 0.17744021, 0.19896701, 0.19953033, 0.19676104, 0.21355724, 0.15552276, 0.206079  , 0.2066243 , 0.17347478, 0.18469337, 0.18944017, 0.20860871, 0.22653301, 0.19252723, 0.21639472, 0.16300175, 0.17078827, 0.18421699, 0.20846191, 0.20496774, 0.1722621 , 0.18316222, 0.1777545 , 0.19923632, 0.18370263, 0.20174617, 0.19134679, 0.2045339 , 0.19697737, 0.20733339, 0.18502416, 0.1938242 , 0.19151547, 0.18358945, 0.15754855, 0.19232516, 0.19578578, 0.20156954, 0.21019933, 0.19680101, 0.16437145, 0.17027056, 0.22656317, 0.18957264, 0.19062884, 0.1897507 , 0.19533413, 0.19545563, 0.22959963, 0.20723617, 0.17227341, 0.22776493, 0.17714511, 0.1989891 , 0.18471743, 0.21712008, 0.19147893, 0.19705429, 0.15898859, 0.1943586 , 0.16504189, 0.17592581, 0.16586717, 0.16128311, 0.19050713, 0.18695406, 0.19213897, 0.18880841, 0.19584573, 0.1691118 , 0.1820177 , 0.22297357, 0.19191938, 0.18523522, 0.15298036, 0.22183248, 0.17350571, 0.18325202, 0.18409054, 0.16373597, 0.20852267, 0.18038393, 0.18664721, 0.18174482, 0.18686294, 0.20715867, 0.20826314, 0.21791028, 0.1661464 , 0.17754664, 0.17355264, 0.16696677, 0.2343109 , 0.17932992, 0.22921436, 0.15378104, 0.16600355, 0.20552058, 0.18863912, 0.21110229, 0.2077549 , 0.18884369, 0.16757927, 0.18292935, 0.18638591, 0.22806168, 0.17575874, 0.17549965, 0.16429435, 0.22163264, 0.1931242 , 0.18711091, 0.21362147, 0.20844054, 0.18577877, 0.18733938, 0.21559446, 0.1883645 , 0.19540601, 0.18869375, 0.19009746, 0.18249261, 0.1926115 , 0.18917507, 0.18748311, 0.19645714, 0.20133933, 0.24070141, 0.18932955, 0.17511183, 0.18669166, 0.20959207, 0.19473115, 0.15332387, 0.15109561, 0.16705573, 0.15660117, 0.17678164, 0.20675164, 0.20980717, 0.17184265, 0.17283674, 0.19030407, 0.13910433, 0.17150246, 0.19199872, 0.19457218, 0.21437114, 0.18203947, 0.19631336, 0.20522589, 0.22396441, 0.18882796, 0.18718076, 0.18535053, 0.17781521, 0.20533799, 0.18084828, 0.21127859, 0.21151627, 0.16472829, 0.23951506, 0.16557223, 0.16473951, 0.15592459, 0.20798738, 0.18347089, 0.22547253, 0.20247204, 0.20130539, 0.19941138, 0.20443386, 0.19872417, 0.21298334, 0.19219722, 0.20732456, 0.20399771, 0.19364624, 0.23754469, 0.16707049, 0.21771448, 0.21986752, 0.23548139, 0.18474442, 0.18712216, 0.21202089, 0.19019743, 0.17234909, 0.21202152, 0.19512846, 0.19158791, 0.19868013, 0.17707585, 0.20255875, 0.18537   , 0.18961168, 0.20176429, 0.18590829, 0.14768421, 0.16513114, 0.17443843, 0.18754145, 0.19695418, 0.19177361, 0.21192942, 0.15347562, 0.18803332, 0.20492468, 0.24465269, 0.19272625, 0.1846391 , 0.15391834, 0.18465271, 0.17805726, 0.16850369, 0.19913787, 0.17752299, 0.20233129, 0.2002238 , 0.16395254, 0.16134861, 0.18487827, 0.14467383, 0.22057089, 0.21495682, 0.21977816, 0.19279219, 0.18230718, 0.1847692 , 0.1992529 , 0.18805664, 0.16928048, 0.22255   , 0.17731991, 0.19353827, 0.20611068, 0.21782673, 0.2136739 , 0.2131556 , 0.15158772, 0.20104455, 0.21284829, 0.19001268, 0.17372406, 0.17883277, 0.20574792, 0.24189015, 0.17593357, 0.21292701, 0.14882285, 0.18889223, 0.23394462, 0.19382145, 0.18651408, 0.17579296, 0.20394512, 0.19285841, 0.15837557, 0.2002351 , 0.19183226, 0.19116907, 0.16287551, 0.17874027, 0.21839561, 0.143358  , 0.17497033, 0.13024579, 0.19952259, 0.19164125, 0.18883956, 0.23325154, 0.16492132, 0.20558259, 0.21199399, 0.2081656 , 0.1748465 , 0.20439352, 0.17156386, 0.17798393, 0.17963783, 0.19418019, 0.2072041 , 0.1786757 , 0.17173397, 0.18023128, 0.17191016, 0.22304757, 0.15097992, 0.19763782, 0.20795476, 0.1890694 , 0.17607498, 0.19691505, 0.17025578, 0.1599239 , 0.21716068, 0.17588922, 0.21173647, 0.19754729, 0.16142291, 0.18931705, 0.17144885, 0.20759078, 0.18329186, 0.21740555, 0.21537968, 0.18088154, 0.17821674, 0.16192567, 0.17604728, 0.20545742, 0.17578522, 0.21079791, 0.19052552, 0.21060308, 0.21365248, 0.18370091, 0.20628469, 0.20018093, 0.19082218, 0.15552427, 0.19169525, 0.17871368, 0.18540108, 0.16874008, 0.18061878, 0.22078169, 0.18900253, 0.17649012, 0.1645352 , 0.22092625, 0.18481638, 0.20824028, 0.18634215, 0.19565354, 0.18869324, 0.1999008 , 0.19104845, 0.16084887, 0.17048191, 0.20971263, 0.19881747, 0.21406935, 0.19062432, 0.17177786, 0.16080784, 0.18947687, 0.18634376, 0.19026466, 0.20108019, 0.18137515, 0.18495644, 0.17662293, 0.20336244, 0.16867037, 0.20292999, 0.18287192, 0.19097258, 0.18604793, 0.17334441, 0.19066905, 0.17003197, 0.17701039, 0.16330203, 0.16795869, 0.19900965, 0.20045173, 0.17478557, 0.16148987, 0.17165582, 0.19920859, 0.18891239, 0.19122702, 0.18164225, 0.22160904, 0.19069739, 0.20757067, 0.17085224, 0.19443249, 0.21910486, 0.22835449, 0.16921655, 0.19793651, 0.17809714, 0.18979853, 0.18902889, 0.20100693, 0.20209368, 0.2009446 , 0.1826252 , 0.22000763, 0.19989699, 0.2060121 , 0.20854013, 0.18925037, 0.17284605, 0.18925773, 0.19512074, 0.20068095, 0.1935246 , 0.18678796, 0.16919167, 0.21062319, 0.18132654, 0.18607032, 0.1959991 , 0.21313032, 0.19015879, 0.17137592, 0.19402307, 0.20209317, 0.17870011, 0.18088106, 0.14436099, 0.18894043, 0.16511244, 0.20702649, 0.19896266, 0.16498048, 0.20141605, 0.17577395, 0.19081329, 0.18817451, 0.16026541, 0.17653754, 0.19764983, 0.19063639, 0.17880321, 0.18237461, 0.18946537, 0.19808166, 0.17455651, 0.21683953, 0.19472651, 0.19074854, 0.17057376, 0.1993284 , 0.21616917, 0.22273247, 0.19938605, 0.18680656, 0.17657334, 0.16366995, 0.16982008, 0.17518827, 0.21491139, 0.22255738, 0.1854054 , 0.15765789, 0.20479984, 0.17132742, 0.20132185, 0.19710629, 0.15932448, 0.2031606 , 0.16496414, 0.14999846, 0.19733176, 0.20663442, 0.18535366, 0.18192639, 0.1726949 , 0.19953683, 0.24144356, 0.21038524, 0.20461771, 0.17339179, 0.19758915, 0.16523628, 0.18202489, 0.19070515, 0.16662021, 0.19786356, 0.19300584, 0.17199753, 0.22128536, 0.19909077, 0.18890577, 0.19223694, 0.15913086, 0.23875514, 0.16673999, 0.20791775, 0.20265535, 0.1695712 , 0.17958909, 0.22781435, 0.2041037 , 0.20178472, 0.17168062, 0.1987143 , 0.19548279, 0.1840655 , 0.16744473, 0.17819275, 0.16839992, 0.20327695, 0.2125252 , 0.18139149, 0.19799585, 0.19645125, 0.20320318, 0.21785071, 0.23461786, 0.18739339, 0.20044315, 0.19160737, 0.19052991, 0.19195866, 0.15964645, 0.1651561 , 0.21351971, 0.17248441, 0.1913779 , 0.18902565, 0.18701248, 0.19858602, 0.19500538, 0.21523021, 0.2046043 , 0.17288628, 0.19275321, 0.15902112, 0.18190459, 0.20029927, 0.19991258, 0.18394674, 0.1764289 , 0.17854042, 0.21998384, 0.16915085, 0.2302083 , 0.20393852, 0.18609787, 0.17945484, 0.15114782, 0.12965807, 0.18598792, 0.18203269, 0.16054434, 0.17772018, 0.18053329, 0.17763461, 0.21171894, 0.17003851, 0.18129124, 0.18856157, 0.17093121, 0.21205479, 0.20530993, 0.19341436, 0.20832818, 0.20176591, 0.18997761, 0.20444822, 0.20119589, 0.17593839, 0.21217746, 0.17093246, 0.18171623, 0.19185379, 0.20502687, 0.19868355, 0.16239599, 0.18394565, 0.17449176, 0.19752306, 0.19787744, 0.19663975, 0.20271801, 0.21399027, 0.20695522, 0.19318898, 0.20280106, 0.16880432, 0.18693755, 0.16095112, 0.1870395 , 0.20145775, 0.22185481, 0.19206798, 0.24962552, 0.18129852, 0.17665864, 0.19396249, 0.21181586, 0.17482881, 0.20123081, 0.18410787, 0.18229119, 0.16357972, 0.23380414, 0.18523145, 0.21183792, 0.20570542, 0.15666542, 0.20592731, 0.17330298, 0.20796562, 0.16588995, 0.20624727, 0.21467659, 0.16729307, 0.17970595, 0.19935217, 0.18486897, 0.18639021, 0.21412599, 0.16553723, 0.19898914, 0.17375742, 0.21914143, 0.21646168, 0.19059514, 0.19213253, 0.20759333, 0.18295785, 0.18882729, 0.17725935, 0.1831487 , 0.22001587, 0.19749684, 0.20523665, 0.18704534, 0.214098  , 0.17646273, 0.16489124, 0.18910848, 0.16820982, 0.19158275, 0.22119254, 0.16916691, 0.215043  , 0.22293664, 0.18962653, 0.23128091, 0.17239903, 0.19374197, 0.19649186, 0.19740333, 0.21080598, 0.19871606, 0.22962133, 0.17047753, 0.2062487 , 0.2004581 , 0.21738737, 0.19290353, 0.16406941, 0.1847257 , 0.1751831 , 0.20074995, 0.16946252, 0.19830211, 0.17365347, 0.18223159, 0.20671269, 0.1955871 , 0.18046802, 0.18954066, 0.16594141, 0.20765298, 0.18909437, 0.19068289, 0.18574651, 0.20251025, 0.16721873, 0.22111741, 0.19562783, 0.15817423, 0.19028746, 0.21414063, 0.19662465, 0.21615034, 0.19657721, 0.17264048, 0.17650502, 0.18293277, 0.204951  , 0.22650671, 0.18935228, 0.2010391 , 0.19420265, 0.2048166 , 0.20861163, 0.18305849, 0.16125443, 0.20863564, 0.20624262, 0.1946297 , 0.20183712, 0.18965161, 0.23805912, 0.19872885, 0.21443539, 0.16258501, 0.19674465, 0.20199527, 0.18072608, 0.17602377, 0.19018066, 0.221052  , 0.19557583, 0.19337215, 0.19849885, 0.23327593, 0.16503508, 0.20151839, 0.21057862, 0.17298892, 0.18970134, 0.22030419, 0.20850478, 0.18123822, 0.19239253, 0.19360668, 0.19134808, 0.20714196, 0.22858395, 0.19398927, 0.17757157, 0.19537908, 0.17079369, 0.1685463 , 0.18405435, 0.15571216, 0.19376211, 0.19587001, 0.21031823, 0.18135929, 0.1738786 , 0.1660487 , 0.16414263, 0.17807318, 0.22732186, 0.1822735 , 0.18648112, 0.19425244, 0.17935347, 0.20374257, 0.22364866, 0.17798437, 0.17053056, 0.20107483, 0.18137161, 0.23286193, 0.17407033, 0.17682684, 0.20076524, 0.17866947, 0.18275877, 0.18023925, 0.18417436, 0.16762061, 0.19848201, 0.18657647, 0.19763079, 0.17994455, 0.20324801, 0.19072701, 0.22501409, 0.21538833, 0.17850311, 0.17740644, 0.22039251, 0.17728976, 0.19233228, 0.17567352, 0.2087703 , 0.20159692, 0.20290721, 0.18234101, 0.22178944, 0.17001382, 0.20952312, 0.2005751 , 0.16683626, 0.19399174, 0.17498718, 0.17181362, 0.17206323, 0.18508181, 0.21264074, 0.21277729, 0.19311987, 0.2466125 , 0.19688212, 0.17346102, 0.16628297, 0.15133592, 0.17584763, 0.19504171, 0.22046734, 0.19967058, 0.23409709, 0.19863157, 0.19865582, 0.18644484, 0.18814594, 0.17254973, 0.13992337, 0.21983511, 0.17747255, 0.1791562 , 0.19018463, 0.21523398, 0.1708404 , 0.20685814, 0.17979606, 0.18126178, 0.2111532 , 0.19703612, 0.22069938, 0.15762052, 0.20602886, 0.21080469, 0.19001883, 0.18834287, 0.19574054, 0.1891792 , 0.17305659, 0.20890682, 0.19029647, 0.15968324, 0.15471731, 0.16401586, 0.18135146, 0.21676885, 0.19711508, 0.22966236, 0.18900793, 0.21099107, 0.22110479, 0.19860767, 0.20262286, 0.17148428, 0.2063882 , 0.18392419, 0.18022922, 0.15644453, 0.22656556, 0.1853546 , 0.174975  , 0.21692504, 0.16125883, 0.19779295, 0.20145803, 0.17129511, 0.18945712, 0.21493509, 0.18774513, 0.1897929 , 0.16594197, 0.17765549, 0.19588387, 0.17285071, 0.21168904, 0.15126781, 0.18820209, 0.21366577, 0.19101887, 0.19504106, 0.16840189, 0.16419594, 0.22069655, 0.1978049 , 0.20253226, 0.17379447, 0.1674624 , 0.21172747, 0.22724823, 0.20148898, 0.19173772, 0.17139303, 0.20845439, 0.18314765, 0.19100359, 0.20882275, 0.15991878, 0.21027222, 0.18237364, 0.16760238, 0.22710899, 0.21448352, 0.19566259, 0.21915133, 0.20266546, 0.20018785, 0.16938479, 0.18459863, 0.18691521, 0.22913151, 0.20486861, 0.1636095 , 0.19257733, 0.16272024, 0.17523217, 0.16901566, 0.17973766, 0.2002513 , 0.23660653, 0.20935584, 0.19226546, 0.21189747, 0.1595699 , 0.1856006 , 0.19650712, 0.17178052, 0.19333426, 0.19140831, 0.19500076, 0.185842  , 0.19076128, 0.16111911, 0.21455889, 0.20775016, 0.18641569, 0.19047277, 0.20613416, 0.15962345, 0.1909415 , 0.17810634, 0.16688278, 0.19259555, 0.15773323, 0.18663911, 0.19319638, 0.18448125, 0.1774126 , 0.17772109, 0.18857577, 0.21919318, 0.19529415, 0.18337115, 0.16338293, 0.18205506, 0.22012551, 0.21613048, 0.21994392, 0.21164255, 0.20031291, 0.1932621 , 0.15258561, 0.20530465, 0.20254799, 0.17949254, 0.21155171, 0.19149969, 0.18007717, 0.19826431])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr_orth_nosplit = DoubleMLPLR(obj_dml_data,
                                                   ml_g, ml_m,
                                                   n_folds=1,
                                                   score='IV-type',
                                                   apply_cross_fitting=False)
            obj_dml_plr_orth_nosplit.fit()
            this_theta = obj_dml_plr_orth_nosplit.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_orth_nosplit[i_rep] - this_theta))
            theta_orth_nosplit[i_rep] = this_theta

        ax = sns.kdeplot(theta_orth_nosplit, shade=True, color=colors[2])
        @savefig orth_nosplit.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        library(data.table)
        lgr::get_logger("mlr3")$set_threshold("warn")
        set.seed(2222)

        # to speed up the illustration we hard-code the simulation results
        theta_orth_nosplit = c(0.39049321, 0.38623322, 0.32039999, 0.35366961, 0.31736777, 0.33277060, 0.43781769, 0.34531791, 0.33283542, 0.42722848, 0.40507855, 0.33148730, 0.35394538, 0.31330780, 0.35502543, 0.31074485, 0.34968750, 0.40803653, 0.39187114, 0.37547230, 0.32921808, 0.34830244, 0.37227546, 0.34347407, 0.38704686, 0.35095282, 0.38702848, 0.44676621, 0.40231157, 0.35722360, 0.38757110, 0.36663528, 0.45927558, 0.40780656, 0.35138709, 0.35119543, 0.40143418, 0.40858348, 0.34764508, 0.38908864, 0.37347419, 0.43576972, 0.27314928, 0.43321026, 0.44573586, 0.43063553, 0.42601212, 0.35902515, 0.38708416, 0.35491437, 0.37668742, 0.42241278, 0.43406890, 0.33166148, 0.38246320, 0.48264989, 0.37431527, 0.32168353, 0.36081761, 0.34969437, 0.37374976, 0.32161613, 0.39480342, 0.36530728, 0.41290537, 0.34844447, 0.34532761, 0.35764003, 0.42205157, 0.33998713, 0.41100083, 0.41516516, 0.34469729, 0.34586140, 0.37695302, 0.38685907, 0.38947661, 0.38637460, 0.36360061, 0.37004994, 0.35369789, 0.38198984, 0.39024056, 0.35629661, 0.38734531, 0.38157211, 0.37207524, 0.38908484, 0.35574587, 0.44481773, 0.42375632, 0.36618387, 0.34411684, 0.38156491, 0.31665591, 0.42389144, 0.36617182, 0.37959079, 0.42847245, 0.36305699, 0.35155391, 0.32876317, 0.34892126, 0.36493144, 0.36792632, 0.31759919, 0.38716813, 0.38514959, 0.37417318, 0.39442611, 0.37368982, 0.38548267, 0.35089008, 0.39418820, 0.32498503, 0.37934508, 0.38255187, 0.38351468, 0.38783505, 0.35710339, 0.41360396, 0.42524172, 0.40838513, 0.34811064, 0.37045911, 0.38477071, 0.32797188, 0.39907332, 0.38036559, 0.36982395, 0.39292964, 0.34644329, 0.30418789, 0.42685645, 0.36047085, 0.37912392, 0.42025438, 0.34740863, 0.35587695, 0.36719599, 0.36589131, 0.34272689, 0.41743034, 0.33766206, 0.38670145, 0.34530436, 0.34978684, 0.42026599, 0.40382610, 0.40825545, 0.44099494, 0.38804948, 0.45389669, 0.34705564, 0.47294370, 0.37862341, 0.31855724, 0.33688705, 0.41276919, 0.34553736, 0.45423311, 0.37964429, 0.38751826, 0.36150448, 0.42768606, 0.38790227, 0.42537798, 0.39370888, 0.39135713, 0.45338337, 0.39138018, 0.38624857, 0.35654923, 0.34246302, 0.39578757, 0.38244909, 0.33327480, 0.38431839, 0.34739509, 0.35298783, 0.35385368, 0.34746322, 0.40414291, 0.40493647, 0.33571477, 0.31135444, 0.37234268, 0.39679210, 0.32775288, 0.36733360, 0.38105588, 0.41414294, 0.37319050, 0.45386794, 0.37119935, 0.41778163, 0.37068323, 0.38692416, 0.32360910, 0.33824963, 0.37431996, 0.38469141, 0.30263371, 0.44107479, 0.41883865, 0.31564318, 0.34173561, 0.43564242, 0.40036688, 0.38976090, 0.34861851, 0.39234854, 0.39049207, 0.33688679, 0.39394909, 0.40148437, 0.42220312, 0.38146976, 0.31022507, 0.34239552, 0.38804406, 0.40617535, 0.35289024, 0.31617303, 0.38155783, 0.42749702, 0.36465385, 0.35726313, 0.35499749, 0.39678911, 0.37634900, 0.37470684, 0.36724464, 0.29626162, 0.37195005, 0.38466128, 0.40131629, 0.32010977, 0.35896510, 0.33290952, 0.33445889, 0.41083150, 0.39835619, 0.38460634, 0.36266596, 0.35002288, 0.33762366, 0.43995288, 0.37930989, 0.39129927, 0.32156116, 0.41928763, 0.38137263, 0.39111599, 0.34263364, 0.37663252, 0.30874349, 0.32936234, 0.35975523, 0.29155957, 0.40502383, 0.37452386, 0.35875942, 0.35152081, 0.40148681, 0.36007586, 0.36391794, 0.31399413, 0.41198829, 0.35998570, 0.37380211, 0.40121628, 0.41631442, 0.38537924, 0.38531920, 0.39934841, 0.34998189, 0.35877463, 0.41467150, 0.38189391, 0.35350061, 0.35321985, 0.40422698, 0.36522258, 0.39346168, 0.39555643, 0.37247852, 0.33854620, 0.45097727, 0.39711792, 0.40975534, 0.38707289, 0.38953390, 0.42750094, 0.35140684, 0.37222427, 0.33802539, 0.38071437, 0.35058867, 0.37607757, 0.34673095, 0.36697579, 0.36482319, 0.37482430, 0.41076420, 0.38059279, 0.43989005, 0.35068132, 0.36046811, 0.37699394, 0.44740559, 0.38410523, 0.33640580, 0.35426940, 0.37497980, 0.37802039, 0.41227596, 0.34331348, 0.36850168, 0.38076361, 0.42292516, 0.28776147, 0.34948857, 0.38432855, 0.38539992, 0.40783806, 0.33701899, 0.41785799, 0.36882731, 0.41234460, 0.39478028, 0.39558266, 0.37642618, 0.39587948, 0.36001151, 0.35384212, 0.38981850, 0.39543032, 0.40271817, 0.39845660, 0.27313414, 0.37912280, 0.36894265, 0.38764453, 0.42301678, 0.38477651, 0.34724049, 0.35871211, 0.34721739, 0.41770212, 0.38811339, 0.31750760, 0.42862995, 0.43292570, 0.33736744, 0.33701444, 0.36239214, 0.37757843, 0.37947704, 0.37915179, 0.38296507, 0.38675467, 0.42459012, 0.37665917, 0.34508817, 0.39481167, 0.36904614, 0.39536985, 0.38168527, 0.31205592, 0.33532134, 0.33188604, 0.42238628, 0.37552872, 0.39884642, 0.40002111, 0.37064889, 0.37353344, 0.40052303, 0.36382528, 0.39918582, 0.42899545, 0.38814057, 0.37357666, 0.38857725, 0.40312452, 0.33098416, 0.37161389, 0.36169096, 0.31223609, 0.42233792, 0.41143570, 0.40195566, 0.32860795, 0.33705429, 0.36618287, 0.38330103, 0.40222025, 0.38014870, 0.37127554, 0.40664068, 0.45846327, 0.41796096, 0.40267337, 0.33490381, 0.39172123, 0.39149881, 0.38334707, 0.40158049, 0.33275482, 0.37285153, 0.38257421, 0.38995875, 0.42749008, 0.37175633, 0.28156365, 0.37312772, 0.32595360, 0.32795049, 0.40215033, 0.38707170, 0.37432329, 0.37354574, 0.40070092, 0.42047878, 0.38556941, 0.38254452, 0.36364867, 0.35026076, 0.34686864, 0.40314823, 0.37537432, 0.41019516, 0.33362454, 0.32966030, 0.38369051, 0.34315170, 0.40644113, 0.38857200, 0.43107204, 0.42998399, 0.36909986, 0.42169929, 0.33946987, 0.39125429, 0.43033718, 0.33821569, 0.38464566, 0.39953481, 0.43296544, 0.42913508, 0.43827183, 0.38984285, 0.32903827, 0.38690801, 0.39385016, 0.37191800, 0.33995035, 0.38900599, 0.42775130, 0.37982975, 0.36371489, 0.34515812, 0.29430837, 0.34725014, 0.38469682, 0.37662320, 0.35379308, 0.38229426, 0.35770848, 0.35119266, 0.34281327, 0.36698297, 0.37997368, 0.42971682, 0.39330591, 0.31642156, 0.38694958, 0.33477434, 0.32308630, 0.44186699, 0.34772030, 0.37598331, 0.38798447, 0.38757607, 0.37923948, 0.34904313, 0.40157379, 0.41897737, 0.33960373, 0.36959868, 0.39568743, 0.42631811, 0.36956263, 0.39759134, 0.36983688, 0.37082963, 0.41454849, 0.41720935, 0.35160923, 0.31830039, 0.28636821, 0.33746717, 0.37930366, 0.40176895, 0.39764966, 0.43106410, 0.35208149, 0.47307955, 0.39256578, 0.41434685, 0.40600527, 0.41896853, 0.38610347, 0.30105950, 0.43178711, 0.42073616, 0.36360048, 0.41300677, 0.39271881, 0.35738764, 0.33139601, 0.35917627, 0.38043080, 0.36582944, 0.41596955, 0.32036057, 0.36525026, 0.32796366, 0.39142993, 0.36526417, 0.35137902, 0.37680791, 0.38572126, 0.37308977, 0.42228946, 0.33558927, 0.31891409, 0.36548876, 0.38715169, 0.36703391, 0.37476888, 0.33369762, 0.35536534, 0.33086917, 0.43562175, 0.33057738, 0.39276025, 0.28141347, 0.40582468, 0.36383699, 0.32838905, 0.37466181, 0.43388335, 0.34520098, 0.35912438, 0.34539768, 0.39261511, 0.41143139, 0.38610009, 0.43228399, 0.37498365, 0.34194814, 0.38942662, 0.40427155, 0.42058329, 0.35936179, 0.32974031, 0.36816755, 0.33193179, 0.40539959, 0.35566560, 0.31007850, 0.38091446, 0.38445540, 0.39694140, 0.40505025, 0.43123028, 0.43790728, 0.37955198, 0.42687388, 0.33636456, 0.30923701, 0.38727879, 0.34633314, 0.36915789, 0.34923956, 0.35078096, 0.41870087, 0.35979959, 0.36157385, 0.36931715, 0.37007185, 0.41169273, 0.37537760, 0.38444021, 0.40016928, 0.41307944, 0.40820169, 0.34132658, 0.35187495, 0.29957315, 0.40098646, 0.39850926, 0.35258290, 0.39307980, 0.41902389, 0.39034348, 0.35777477, 0.31316893, 0.38222600, 0.36756746, 0.36312506, 0.42006334, 0.45632363, 0.40248631, 0.33951418, 0.34635155, 0.38778134, 0.40133199, 0.37260563, 0.32567782, 0.30924518, 0.39043846, 0.34491735, 0.37701158, 0.37023754, 0.39958350, 0.40338892, 0.34375094, 0.41716017, 0.39553697, 0.38771269, 0.39967060, 0.38840850, 0.36402858, 0.36911248, 0.40052280, 0.37845439, 0.41482476, 0.33872475, 0.32267007, 0.35599048, 0.29664949, 0.37189301, 0.37528183, 0.40841438, 0.43697700, 0.32851468, 0.49948760, 0.38906437, 0.39556396, 0.35679557, 0.38592858, 0.35651584, 0.38613866, 0.38771473, 0.33795989, 0.40356307, 0.39044545, 0.35251968, 0.35048952, 0.34705581, 0.35430905, 0.40861974, 0.38379638, 0.35371569, 0.32028550, 0.34073942, 0.34246909, 0.39014975, 0.40712878, 0.35094540, 0.36561404, 0.37301917, 0.36954535, 0.38541706, 0.44132248, 0.36051211, 0.38930364, 0.36602703, 0.38789440, 0.37321055, 0.33602730, 0.39829899, 0.41467980, 0.41808960, 0.34570933, 0.35476443, 0.40419503, 0.35159869, 0.40980852, 0.30384932, 0.34547129, 0.35882370, 0.37697048, 0.30285211, 0.37519791, 0.35409260, 0.39088348, 0.38269365, 0.38811505, 0.31491056, 0.27545082, 0.37653419, 0.39443877, 0.34979512, 0.41299558, 0.34509510, 0.37478061, 0.34914035, 0.38143941, 0.43454938, 0.37735497, 0.36853649, 0.43799378, 0.41086518, 0.31796562, 0.34909281, 0.35312500, 0.35961474, 0.38267981, 0.42463239, 0.35557373, 0.39225430, 0.35096924, 0.40207886, 0.37826856, 0.33351414, 0.35428997, 0.36470536, 0.36591732, 0.37880361, 0.43032446, 0.36870803, 0.37193902, 0.38206158, 0.36082883, 0.36603027, 0.40108015, 0.35796562, 0.37223186, 0.37555592, 0.34918905, 0.37928217, 0.36280338, 0.40838449, 0.38278183, 0.45815442, 0.30734983, 0.34016458, 0.38453083, 0.39883628, 0.38670426, 0.34657232, 0.41089378, 0.34467102, 0.35802987, 0.39237721, 0.35985812, 0.43840643, 0.35183006, 0.36705566, 0.36180920, 0.40139499, 0.35340685, 0.39069474, 0.40671741, 0.38029988, 0.38503578, 0.38870444, 0.37181842, 0.30302286, 0.40441286, 0.37720655, 0.42643489, 0.40838772, 0.33436060, 0.43267964, 0.36080556, 0.34661043, 0.37884496, 0.35743337, 0.38631566, 0.38275644, 0.31901801, 0.40273082, 0.37680675, 0.40503828, 0.34702401, 0.36577024, 0.41118310, 0.40746128, 0.42744368, 0.36006236, 0.34037916, 0.45408709, 0.33627613, 0.41443604, 0.35085963, 0.38540938, 0.34845399, 0.33004802, 0.37764755, 0.34026971, 0.37501160, 0.38540639, 0.42262431, 0.31969346, 0.41093245, 0.38592503, 0.31423033, 0.33408191, 0.34642653, 0.36023519, 0.39949760, 0.40076267, 0.39600668, 0.42189771, 0.41615746, 0.40765201, 0.38315156, 0.41112277, 0.38673571, 0.27860583, 0.35181222, 0.41240773, 0.35233530, 0.34925827, 0.39687910, 0.37850778, 0.40325664, 0.37093167, 0.41090133, 0.39867629, 0.45226702, 0.36965486, 0.36984475, 0.42561742, 0.38226515, 0.32027813, 0.34804785, 0.35391736, 0.30301071, 0.36023501, 0.44010227, 0.41551136, 0.34761721, 0.37638072, 0.41475094, 0.34413413, 0.40956694, 0.37026594, 0.36743059, 0.36710269, 0.35498793, 0.40293639, 0.35075277, 0.39296474, 0.37002612, 0.38289412, 0.37288841, 0.37662928, 0.38639646, 0.38084114, 0.33262801, 0.40324329, 0.39548604, 0.29963864, 0.33540291, 0.37898764, 0.41192466, 0.33619434, 0.39011219, 0.38966803, 0.32438129, 0.37606118, 0.34666850, 0.34178282, 0.32923941, 0.37171107, 0.33136672, 0.38171394, 0.36805410, 0.40638170, 0.39946428, 0.37920325, 0.37752372, 0.37740911, 0.45528417, 0.39508487, 0.44625092, 0.39211050, 0.38963354, 0.32095404, 0.33827295, 0.41193861, 0.38295449, 0.36012456, 0.43471780, 0.41426493, 0.42116707, 0.35046428, 0.39239468, 0.37883463, 0.33591603, 0.45880292, 0.38463052, 0.28281594, 0.42418029, 0.41057366, 0.34876232, 0.43838530, 0.33406321, 0.39679409, 0.41684471, 0.39526670, 0.35772346, 0.39330715, 0.38215367, 0.35761130, 0.35942927, 0.33737534, 0.34782715, 0.34427716, 0.39088607, 0.32862263, 0.38036965, 0.46431538, 0.36781862, 0.37046263, 0.43556806, 0.39395677, 0.39785567, 0.30531366, 0.35900116, 0.41336494, 0.39578712, 0.40391840, 0.35005779, 0.35867356, 0.38971486, 0.35618854, 0.27722263, 0.36605436, 0.36926065, 0.41414760, 0.39145495, 0.39483095, 0.39864155, 0.34120646, 0.33324393, 0.40088027, 0.40899790, 0.37936413, 0.40172518, 0.38112545, 0.40381700, 0.36169050, 0.42454280, 0.40890698, 0.32622500, 0.32951677, 0.33770347, 0.35378556, 0.35432291, 0.36451275, 0.40109421, 0.40114241, 0.37222841, 0.36313350, 0.37971901, 0.37431455, 0.39102354, 0.38273885, 0.39992868, 0.37100929, 0.42897760, 0.39977531, 0.37887685, 0.40347785, 0.37756153, 0.39151490, 0.33720432, 0.28692127, 0.39102979, 0.34006289, 0.36206740, 0.38467964, 0.35091427, 0.42481238, 0.36482863, 0.40828241, 0.34610274, 0.35600550, 0.44524777, 0.40440560, 0.39808257, 0.31116652, 0.41218200)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr_orth_nosplit = DoubleMLPLR$new(obj_dml_data,
                                                   ml_g, ml_m,
                                                   n_folds=1,
                                                   score='IV-type',
                                                   apply_cross_fitting=FALSE)
            obj_dml_plr_orth_nosplit$fit()
            this_theta = obj_dml_plr_orth_nosplit$coef
            print(abs(theta_orth_nosplit[i_rep] - this_theta))
            theta_orth_nosplit[i_rep] = this_theta
        }

        g_nosplit = ggplot(data.frame(theta_orth_nosplit), aes(x = theta_orth_nosplit)) +
                    geom_density(fill = "dark green", alpha = 0.3, color = "dark green") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_nosplit


If the nuisance models :math:`\hat{g}_0()` and :math:`\hat{m}()` are estimate on the whole dataset which is also used for obtaining
the final estimate :math:`\check{\theta}` another bias can be observed.

.. _bias_overfitting:

Sample splitting to remove bias induced by overfitting
++++++++++++++++++++++++++++++++++++++++++++++++++++++

Using sample splitting, i.e., estimate the nuisance models :math:`\hat{g}_0()` and :math:`\hat{m}()` on one part of the
data (training data) and estimate :math:`\check{\theta}` on the other part of the data (test data) overcomes the bias
induced by overfitting. Cross-fitting performs well empirically.

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        np.random.seed(3333)

        # to speed up the illustration we hard-code the simulation results
        theta_dml = np.array([0.53783864, 0.56137482, 0.47098531, 0.49583251, 0.49344941, 0.49895219, 0.59308632, 0.49283658, 0.60049746, 0.68809848, 0.55178072, 0.52951073, 0.59111311, 0.45678428, 0.51044539, 0.47135222, 0.54800861, 0.43937261, 0.52557027, 0.5137966 , 0.46957348, 0.44770654, 0.50473021, 0.54379035, 0.43121509, 0.47568429, 0.54724643, 0.54346354, 0.45580967, 0.53456083, 0.5506845 , 0.6108647 , 0.42431298, 0.40483012, 0.49364032, 0.45364977, 0.53312033, 0.5822299 , 0.53350867, 0.58569661, 0.46171462, 0.50171163, 0.51947323, 0.41757247, 0.56090534, 0.52062507, 0.50679924, 0.49267434, 0.54011667, 0.58221526, 0.50753144, 0.52731262, 0.53813272, 0.49114307, 0.58793752, 0.45668958, 0.55160055, 0.5751591 , 0.46923846, 0.44591062, 0.5486273 , 0.62260706, 0.59466655, 0.47626302, 0.59448847, 0.453359  , 0.4527237 , 0.51919837, 0.55042676, 0.56295342, 0.51004551, 0.48335437, 0.44326301, 0.48753803, 0.54122424, 0.53122786, 0.53423165, 0.50733556, 0.46729663, 0.56826126, 0.46596646, 0.52360725, 0.49694176, 0.49133648, 0.45807535, 0.49282829, 0.57311644, 0.51322115, 0.55192333, 0.51333404, 0.45745403, 0.49211851, 0.61072219, 0.54286275, 0.60291552, 0.53964174, 0.60676176, 0.56218827, 0.60814281, 0.57304886, 0.4879059 , 0.61748175, 0.46240249, 0.50534639, 0.57236123, 0.56905693, 0.53564901, 0.51521593, 0.43209209, 0.52602676, 0.47579394, 0.47174784, 0.51041103, 0.49552937, 0.52775505, 0.48832121, 0.4748268 , 0.49898515, 0.50592215, 0.45786484, 0.51855131, 0.59166107, 0.52192837, 0.48969862, 0.42411325, 0.60393144, 0.45346591, 0.54748658, 0.4924075 , 0.41504931, 0.55400544, 0.48546277, 0.58499325, 0.48842204, 0.50875017, 0.57020554, 0.58097763, 0.57046144, 0.4721674 , 0.52090667, 0.4789362 , 0.4656156 , 0.67534548, 0.52526612, 0.55625508, 0.48143598, 0.43691466, 0.54010898, 0.49104853, 0.57336697, 0.57293363, 0.56018508, 0.47114175, 0.59002851, 0.51535431, 0.64295986, 0.49876754, 0.53738643, 0.4788897 , 0.59140102, 0.50571022, 0.50257281, 0.55169142, 0.55682985, 0.51841162, 0.45346847, 0.61532575, 0.5908174 , 0.54058647, 0.45978968, 0.56057182, 0.52271005, 0.48266003, 0.49253787, 0.52613578, 0.54883372, 0.51763886, 0.57393782, 0.54278759, 0.49736676, 0.50131867, 0.58952557, 0.5342031 , 0.46800654, 0.45173334, 0.50603531, 0.43723407, 0.50612435, 0.58456323, 0.53379164, 0.46220983, 0.49744829, 0.50716769, 0.39656082, 0.53222344, 0.52947978, 0.49065975, 0.61459832, 0.48314906, 0.48721612, 0.5383895 , 0.55096836, 0.50869886, 0.53079304, 0.47664465, 0.46266691, 0.52397272, 0.54812042, 0.49213521, 0.61310809, 0.50693975, 0.61626284, 0.42822354, 0.41691684, 0.45419581, 0.53081374, 0.45103733, 0.56594786, 0.54613219, 0.55702516, 0.56589101, 0.52632096, 0.499588  , 0.54011465, 0.50038198, 0.61861759, 0.51576021, 0.51326794, 0.62130466, 0.43719905, 0.5702503 , 0.63380428, 0.6745056 , 0.5277932 , 0.4886822 , 0.60888513, 0.49923686, 0.4650197 , 0.59211297, 0.52402717, 0.47964695, 0.54351952, 0.46982823, 0.53680776, 0.51078557, 0.48201543, 0.56909583, 0.47705104, 0.47022787, 0.41796317, 0.49473413, 0.50239883, 0.51455828, 0.48244305, 0.5010798 , 0.40653606, 0.49722635, 0.55655504, 0.62895192, 0.5098877 , 0.52575782, 0.45184377, 0.52420825, 0.51028974, 0.46979654, 0.5494409 , 0.49375063, 0.5225844 , 0.53718251, 0.44433291, 0.46569306, 0.4903771 , 0.43253232, 0.62010203, 0.5907308 , 0.56746028, 0.58400136, 0.4219075 , 0.52738482, 0.57229111, 0.52196608, 0.51977276, 0.57218664, 0.47052068, 0.5000791 , 0.52605601, 0.59120425, 0.49359383, 0.6372248 , 0.42938816, 0.55762068, 0.5605121 , 0.51110379, 0.54904524, 0.49530218, 0.54216341, 0.67644095, 0.42432689, 0.61932783, 0.40027802, 0.56448883, 0.62864412, 0.52028095, 0.48152184, 0.4271319 , 0.49763376, 0.54424632, 0.40973258, 0.52205883, 0.56236831, 0.52791313, 0.45010052, 0.49155512, 0.55435332, 0.43473213, 0.5063737 , 0.38896185, 0.55079684, 0.53157471, 0.57150794, 0.67658817, 0.45364663, 0.59036917, 0.54294199, 0.51997323, 0.51307474, 0.50070894, 0.50381579, 0.4485085 , 0.52440677, 0.50383492, 0.53235392, 0.41900542, 0.46309485, 0.52603559, 0.47674276, 0.66231738, 0.37511717, 0.52994597, 0.51854592, 0.48202892, 0.47709318, 0.51738195, 0.45161972, 0.487567  , 0.53582165, 0.50720532, 0.5500362 , 0.56175473, 0.50082023, 0.49412586, 0.46680239, 0.58990189, 0.5318778 , 0.64129666, 0.59045578, 0.56477998, 0.50145889, 0.48628756, 0.47166047, 0.57444274, 0.4578859 , 0.56623253, 0.55335073, 0.6201215 , 0.56670752, 0.51953877, 0.5540502 , 0.53570066, 0.52590807, 0.46212934, 0.50525156, 0.48013077, 0.48556497, 0.4752577 , 0.4795085 , 0.58036601, 0.45524343, 0.49405297, 0.41217327, 0.55901695, 0.50399344, 0.53088332, 0.52597253, 0.58600767, 0.47286067, 0.56161112, 0.53638216, 0.44462506, 0.48146452, 0.5265833 , 0.52839864, 0.50680572, 0.49266965, 0.44332455, 0.40332254, 0.49575569, 0.50411128, 0.52410718, 0.5497688 , 0.4774744 , 0.44092695, 0.51728623, 0.6041784 , 0.49641213, 0.54189158, 0.49458719, 0.48607875, 0.55122463, 0.51809319, 0.52011965, 0.46054722, 0.45394522, 0.41521196, 0.51738559, 0.49988601, 0.53337213, 0.49423041, 0.42673903, 0.47901704, 0.54214711, 0.50957695, 0.51722563, 0.52386319, 0.57832324, 0.52252369, 0.55606565, 0.46069737, 0.52490504, 0.57741978, 0.55777247, 0.45551497, 0.5749121 , 0.49609472, 0.48538087, 0.51338672, 0.57588884, 0.53816269, 0.53777377, 0.48846157, 0.55188654, 0.57904603, 0.58504476, 0.51192921, 0.50026496, 0.43590759, 0.56251263, 0.51319351, 0.55528963, 0.56718055, 0.53306159, 0.43738128, 0.61425381, 0.51150941, 0.51669332, 0.5646931 , 0.58360615, 0.48069954, 0.4665604 , 0.54664655, 0.54690096, 0.49301759, 0.54557584, 0.4292182 , 0.48301877, 0.48203858, 0.57210624, 0.53160168, 0.49398141, 0.53784935, 0.47779268, 0.47118828, 0.57117059, 0.4548582 , 0.46588955, 0.56799648, 0.52322551, 0.47456259, 0.53707786, 0.53377565, 0.49041699, 0.48958131, 0.62189998, 0.49823658, 0.51165907, 0.48409694, 0.57515668, 0.59989535, 0.61976348, 0.60235948, 0.4690357 , 0.46508223, 0.49308399, 0.51928699, 0.47982849, 0.56608963, 0.61378612, 0.55421424, 0.44635864, 0.54105439, 0.51260485, 0.57873274, 0.57683763, 0.41098466, 0.59900594, 0.45420134, 0.39094282, 0.5655048 , 0.64522171, 0.51589183, 0.49218891, 0.50137452, 0.56158437, 0.61541693, 0.58805207, 0.50266515, 0.45237094, 0.59677007, 0.45677508, 0.49295391, 0.51138004, 0.48193596, 0.55124699, 0.45493534, 0.49872723, 0.55582753, 0.54187217, 0.57020516, 0.46115721, 0.44835767, 0.62792296, 0.49962322, 0.54602109, 0.52722248, 0.46447756, 0.49522768, 0.58777485, 0.58059375, 0.52843226, 0.53019653, 0.5714872 , 0.52769883, 0.47997665, 0.47973062, 0.47124428, 0.42977003, 0.48095953, 0.5847105 , 0.50597991, 0.5636729 , 0.56772219, 0.55368796, 0.5617357 , 0.61296842, 0.50996196, 0.52993336, 0.52038135, 0.50125543, 0.52867737, 0.42446777, 0.43934888, 0.60959647, 0.44282601, 0.56127397, 0.51472516, 0.47446762, 0.69091138, 0.51502744, 0.6216372 , 0.5863867 , 0.45324573, 0.49668718, 0.50104202, 0.49810959, 0.549392  , 0.53922011, 0.4530355 , 0.4976699 , 0.52811134, 0.61601329, 0.41994026, 0.64506017, 0.71263969, 0.47040142, 0.49523336, 0.4402073 , 0.36396297, 0.57115148, 0.56282331, 0.45683168, 0.48580597, 0.46309659, 0.46615961, 0.57418296, 0.4309641 , 0.49972961, 0.52094906, 0.53125201, 0.5604556 , 0.55116597, 0.5341042 , 0.56019292, 0.59179924, 0.43450196, 0.55261048, 0.54148967, 0.47287168, 0.54150009, 0.45895701, 0.50766087, 0.5263654 , 0.59082588, 0.52071728, 0.4874937 , 0.55259655, 0.46049653, 0.53583496, 0.59864876, 0.52618606, 0.53722681, 0.56953011, 0.53676736, 0.51315883, 0.55460677, 0.45968795, 0.48017007, 0.47058584, 0.56320797, 0.52812586, 0.66661584, 0.53660856, 0.70240011, 0.51814088, 0.524043  , 0.52694454, 0.61047065, 0.50814414, 0.54501657, 0.44872854, 0.50416308, 0.43018453, 0.66554748, 0.5211602 , 0.59225135, 0.59509462, 0.456472  , 0.59225571, 0.46450262, 0.57526165, 0.46700273, 0.51515545, 0.59518514, 0.39676771, 0.51218183, 0.47505981, 0.51579065, 0.52228275, 0.54300831, 0.5019425 , 0.55334156, 0.50742764, 0.59900983, 0.58471484, 0.50405506, 0.51458833, 0.55821454, 0.44936211, 0.50132957, 0.45732065, 0.49443947, 0.58455275, 0.5170793 , 0.56840335, 0.49852024, 0.60609395, 0.44366099, 0.49347636, 0.45303381, 0.3974909 , 0.52448547, 0.58537187, 0.50496709, 0.52191665, 0.59363332, 0.48565432, 0.63967538, 0.49710098, 0.52125984, 0.52179559, 0.5527036 , 0.48390453, 0.5787376 , 0.57727166, 0.484088  , 0.53759055, 0.5692601 , 0.57670839, 0.55962101, 0.46002444, 0.50408734, 0.4610186 , 0.58003577, 0.51085109, 0.56330371, 0.43109838, 0.4580175 , 0.58447869, 0.54104849, 0.5035158 , 0.49287041, 0.47004253, 0.55605003, 0.50613606, 0.57855655, 0.5578599 , 0.50757853, 0.39955081, 0.57951418, 0.62354414, 0.45110401, 0.50203751, 0.56310319, 0.52059582, 0.53604864, 0.53743264, 0.48397148, 0.46995635, 0.47836336, 0.531217  , 0.56927627, 0.52425042, 0.52800469, 0.53449662, 0.5645122 , 0.5119682 , 0.49317557, 0.45827623, 0.5526725 , 0.60602678, 0.53288901, 0.53736054, 0.51138198, 0.61827937, 0.53617608, 0.55274069, 0.45284639, 0.46472503, 0.54193365, 0.4851703 , 0.43225581, 0.5444395 , 0.59045296, 0.48085181, 0.51828633, 0.51205135, 0.60656996, 0.44446555, 0.62690607, 0.57983329, 0.49593785, 0.47520081, 0.58017501, 0.5613651 , 0.49202955, 0.5214653 , 0.53878626, 0.47661513, 0.58502639, 0.57968053, 0.47226381, 0.43963272, 0.56584683, 0.46582098, 0.45640722, 0.52283275, 0.44621995, 0.51338618, 0.57445119, 0.5104929 , 0.52061042, 0.5049428 , 0.40711325, 0.38988766, 0.44429344, 0.62910149, 0.48950861, 0.45951028, 0.529202  , 0.48176574, 0.52931396, 0.64590277, 0.48030023, 0.46244716, 0.55967127, 0.54278287, 0.67998974, 0.45601417, 0.51238465, 0.63161161, 0.46862991, 0.46845512, 0.50217724, 0.56177649, 0.47600552, 0.5188323 , 0.51346826, 0.54360147, 0.44537397, 0.6183776 , 0.54267589, 0.60649996, 0.54124449, 0.50293502, 0.51624682, 0.58722172, 0.54482994, 0.5878722 , 0.54012617, 0.50871376, 0.51753372, 0.5680869 , 0.43320441, 0.61867887, 0.42575284, 0.61943966, 0.58176853, 0.39926806, 0.51854904, 0.46140728, 0.45413191, 0.52016952, 0.51244476, 0.51720474, 0.50823928, 0.46394043, 0.69474163, 0.49935577, 0.52588693, 0.53418591, 0.4307186 , 0.47307765, 0.55869235, 0.61977205, 0.60009163, 0.64754364, 0.50528855, 0.54532167, 0.46891828, 0.4557624 , 0.46623088, 0.39501437, 0.6286615 , 0.50279653, 0.51607761, 0.51536467, 0.62228505, 0.51592972, 0.619399  , 0.4573063 , 0.53164744, 0.50520217, 0.49024949, 0.56236976, 0.41696365, 0.53456962, 0.52101607, 0.45300581, 0.48299018, 0.48580939, 0.53761413, 0.43021178, 0.56500283, 0.49741986, 0.51121487, 0.42715391, 0.47867598, 0.53194906, 0.60440529, 0.47091405, 0.62390853, 0.52293441, 0.56656492, 0.52947739, 0.53341967, 0.56143506, 0.45308852, 0.61482144, 0.52937071, 0.4776877 , 0.43929754, 0.60419573, 0.46478678, 0.46467048, 0.57706104, 0.39894393, 0.53328485, 0.55841651, 0.45252677, 0.56276416, 0.61961996, 0.50960217, 0.47807724, 0.45216205, 0.4562606 , 0.53334145, 0.4550416 , 0.56730075, 0.39089593, 0.57686124, 0.59943034, 0.47183457, 0.52394739, 0.50456928, 0.45361112, 0.55709398, 0.54569701, 0.54102148, 0.52455363, 0.46059473, 0.53242988, 0.67460852, 0.53637109, 0.59734389, 0.41928379, 0.53440489, 0.48623947, 0.48110893, 0.56832337, 0.48293222, 0.52213927, 0.51863761, 0.44929188, 0.59223093, 0.603576  , 0.56249045, 0.53562286, 0.53695044, 0.52036059, 0.4860525 , 0.50513244, 0.53629578, 0.5736218 , 0.5571627 , 0.44197165, 0.5434403 , 0.48091898, 0.54246856, 0.43174217, 0.47787912, 0.55646815, 0.6488853 , 0.5098719 , 0.49638191, 0.58373093, 0.42913302, 0.47934893, 0.52763207, 0.48518677, 0.58592606, 0.51241616, 0.51119172, 0.52429989, 0.49164947, 0.43754339, 0.56197387, 0.58027946, 0.48953938, 0.51422463, 0.562054  , 0.44069727, 0.57170695, 0.48507785, 0.44667846, 0.5199057 , 0.44761977, 0.49092208, 0.51495295, 0.50203644, 0.48059648, 0.5462675 , 0.56652299, 0.51049805, 0.45324566, 0.5035162 , 0.49955657, 0.50152408, 0.58141641, 0.5568171 , 0.56061661, 0.52258334, 0.53405183, 0.49562861, 0.46399661, 0.59327525, 0.52509286, 0.48194342, 0.60035599, 0.52735904, 0.48059072, 0.61032448])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr = DoubleMLPLR(obj_dml_data,
                                      ml_g, ml_m,
                                      n_folds=2,
                                      score='IV-type')
            obj_dml_plr.fit()
            this_theta = obj_dml_plr.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_dml[i_rep] - this_theta))
            theta_dml[i_rep] = this_theta

        ax = sns.kdeplot(theta_dml, shade=True, color=colors[3])
        @savefig orth.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        set.seed(3333)

        # to speed up the illustration we hard-code the simulation results
        theta_dml = c(0.55583732, 0.59698061, 0.42622692, 0.57065897, 0.48076443, 0.47931293, 0.59837758, 0.47891549, 0.48596322, 0.58327156, 0.53802261, 0.47206318, 0.45801241, 0.43231203, 0.47001012, 0.48481500, 0.48263437, 0.59349709, 0.52467033, 0.52830123, 0.41483774, 0.50628558, 0.52034034, 0.49914977, 0.50953827, 0.46820569, 0.52980768, 0.58837655, 0.49120595, 0.51303767, 0.50991896, 0.50083001, 0.64199346, 0.54936795, 0.46308708, 0.50596192, 0.56077607, 0.51854599, 0.48781402, 0.52134717, 0.47608740, 0.55138921, 0.37212477, 0.58111242, 0.61916441, 0.60602517, 0.50456468, 0.48721512, 0.48368484, 0.42155143, 0.54455051, 0.55881304, 0.54840944, 0.43424054, 0.47211491, 0.64801896, 0.49051298, 0.43143410, 0.53237162, 0.46918541, 0.52538786, 0.50164477, 0.54512740, 0.53047707, 0.51859518, 0.50067174, 0.39757765, 0.53209970, 0.54750446, 0.47642472, 0.59104664, 0.53766442, 0.49963847, 0.46426719, 0.55287076, 0.53878614, 0.49714491, 0.54013264, 0.47250459, 0.49099921, 0.46230582, 0.51530281, 0.51639658, 0.47369180, 0.55638282, 0.51593168, 0.50403993, 0.53329479, 0.42355099, 0.55743232, 0.59265814, 0.48518068, 0.51059997, 0.49545290, 0.42056735, 0.57978408, 0.55576884, 0.54570888, 0.59493606, 0.46959370, 0.44253228, 0.41914419, 0.48238310, 0.53303363, 0.51818116, 0.48013390, 0.50718647, 0.47332719, 0.54101409, 0.53692933, 0.49952018, 0.54070246, 0.46891445, 0.53981923, 0.43885296, 0.51101688, 0.54015143, 0.51296869, 0.51091924, 0.47024580, 0.56669854, 0.54531183, 0.56403189, 0.49522854, 0.48070524, 0.51732264, 0.45580103, 0.51430360, 0.54591780, 0.53914312, 0.50275083, 0.50606970, 0.46483789, 0.57490782, 0.48191155, 0.55369407, 0.56048006, 0.42297254, 0.49583320, 0.47453816, 0.51513324, 0.46132979, 0.54677686, 0.47818015, 0.53360231, 0.50376588, 0.45703947, 0.55057917, 0.54770757, 0.54757223, 0.57308760, 0.51391298, 0.61439485, 0.50875917, 0.70403211, 0.50875252, 0.41111138, 0.47451172, 0.58802962, 0.52970459, 0.59256050, 0.50199198, 0.50699239, 0.52428032, 0.59897681, 0.52520567, 0.56290362, 0.48928598, 0.54685003, 0.64721479, 0.51561889, 0.54318092, 0.51628961, 0.52677629, 0.58309250, 0.49394105, 0.48711406, 0.53599916, 0.53307739, 0.40677386, 0.45959648, 0.51832526, 0.53258196, 0.60142854, 0.48552138, 0.44699271, 0.56465176, 0.52229536, 0.48604204, 0.50545872, 0.49311693, 0.56637447, 0.50548532, 0.62009408, 0.50981827, 0.62321750, 0.49175814, 0.52866625, 0.44100123, 0.47865539, 0.44334858, 0.59916906, 0.40514201, 0.52774540, 0.57532501, 0.44390625, 0.49528758, 0.54490714, 0.60209832, 0.53517064, 0.48053099, 0.58738378, 0.48695724, 0.50575559, 0.55887670, 0.58374868, 0.56117377, 0.53031438, 0.48567162, 0.48428183, 0.51615139, 0.56692701, 0.48611381, 0.42132089, 0.53912562, 0.55344851, 0.49696208, 0.48491336, 0.51443770, 0.52746420, 0.53042663, 0.47383807, 0.47187560, 0.40105944, 0.53858998, 0.51811049, 0.57915313, 0.43791771, 0.51727274, 0.47290672, 0.46229752, 0.59240623, 0.55398200, 0.51357018, 0.50081897, 0.46798846, 0.46528736, 0.62267142, 0.52925744, 0.61424193, 0.46252655, 0.58179473, 0.50441771, 0.55515935, 0.44989467, 0.54785942, 0.49050917, 0.45488618, 0.48479409, 0.41403688, 0.57332341, 0.50119835, 0.48919354, 0.51081006, 0.54734920, 0.44162714, 0.45535464, 0.48007584, 0.56519286, 0.53150777, 0.54065862, 0.50021804, 0.58379719, 0.50196678, 0.52574156, 0.54998549, 0.49933023, 0.44793615, 0.51367421, 0.54004840, 0.50777223, 0.43799466, 0.54657671, 0.44637736, 0.47766162, 0.55388206, 0.54374992, 0.46015686, 0.58857584, 0.53920776, 0.60849844, 0.53342063, 0.49155683, 0.55616403, 0.48530385, 0.44166337, 0.52236730, 0.51121452, 0.53134275, 0.47810577, 0.45996934, 0.49390341, 0.56199085, 0.54996818, 0.60556792, 0.48328732, 0.61336962, 0.47890606, 0.51203562, 0.48265657, 0.61026242, 0.50829119, 0.43824490, 0.49232506, 0.56773914, 0.50197690, 0.55489255, 0.47483008, 0.51528794, 0.48538011, 0.58165383, 0.39166197, 0.49413358, 0.51745194, 0.52667036, 0.52635654, 0.46206208, 0.56614861, 0.47831617, 0.53860594, 0.46215618, 0.50174888, 0.55161213, 0.60742944, 0.50252908, 0.45355615, 0.55079611, 0.61570614, 0.56660124, 0.51692477, 0.38452609, 0.54735027, 0.53498745, 0.59120731, 0.60218639, 0.51141323, 0.47859404, 0.48509576, 0.47623062, 0.50882684, 0.63552047, 0.42572104, 0.51946201, 0.53319696, 0.47988342, 0.44682223, 0.51022792, 0.50050934, 0.53898949, 0.53369417, 0.51644768, 0.49458503, 0.56520487, 0.54721149, 0.49027225, 0.51414278, 0.50906311, 0.52045737, 0.51151249, 0.40936258, 0.47154563, 0.54835201, 0.57263195, 0.52245099, 0.53287902, 0.53877890, 0.45651737, 0.52514231, 0.50289327, 0.49080946, 0.56107553, 0.55427665, 0.51008150, 0.46182057, 0.50590581, 0.57680893, 0.40487345, 0.52026958, 0.55477735, 0.38852405, 0.57588319, 0.61633208, 0.54966584, 0.47648244, 0.42548949, 0.49427528, 0.53146583, 0.53138626, 0.53139079, 0.46290840, 0.52252523, 0.62883404, 0.56823307, 0.54751224, 0.44360764, 0.55634206, 0.53005894, 0.49152948, 0.51302322, 0.46741707, 0.51100589, 0.56659282, 0.50328633, 0.55339695, 0.47619604, 0.43103361, 0.49612390, 0.45921111, 0.46568427, 0.48276599, 0.49145050, 0.51168127, 0.62033664, 0.49682594, 0.54194524, 0.54038912, 0.52608304, 0.51588104, 0.45983880, 0.51760230, 0.52287124, 0.47865420, 0.63357364, 0.50212785, 0.43505472, 0.52260665, 0.47595492, 0.54254050, 0.52250018, 0.52648502, 0.54307470, 0.45585020, 0.51356424, 0.46182126, 0.52009972, 0.60117743, 0.46140143, 0.54785857, 0.53151469, 0.62270309, 0.56880362, 0.62963174, 0.55264665, 0.39882702, 0.47345449, 0.53038010, 0.55170956, 0.40680161, 0.53403167, 0.54759877, 0.54693676, 0.51442236, 0.47235483, 0.40136462, 0.45305321, 0.53463126, 0.52245865, 0.50325651, 0.50720501, 0.44295015, 0.46475243, 0.47285817, 0.52922962, 0.52992543, 0.60603229, 0.50905406, 0.44667528, 0.50046205, 0.49227277, 0.42854932, 0.58060576, 0.50368143, 0.48707358, 0.51809518, 0.51129882, 0.47855748, 0.52827766, 0.52243675, 0.53964224, 0.52570183, 0.52779796, 0.49357111, 0.55047205, 0.49710152, 0.53886327, 0.52759373, 0.46855763, 0.51548228, 0.56376555, 0.45016728, 0.51168836, 0.43971892, 0.45401274, 0.55227497, 0.54219699, 0.54809525, 0.57993513, 0.51115609, 0.65079618, 0.55225574, 0.62347466, 0.52693238, 0.58545076, 0.51951317, 0.39164656, 0.60227716, 0.62297043, 0.50673451, 0.51791753, 0.54901343, 0.53628121, 0.47573811, 0.48857039, 0.50455716, 0.52055881, 0.60630166, 0.40288140, 0.52757320, 0.39000885, 0.51555835, 0.50889457, 0.50348007, 0.50743545, 0.54049814, 0.49263964, 0.57632904, 0.46685772, 0.44952156, 0.49394724, 0.50355199, 0.50550197, 0.51534155, 0.46705229, 0.49305559, 0.42177477, 0.58615433, 0.49958495, 0.53243770, 0.37780172, 0.55131253, 0.47481085, 0.41210336, 0.51367425, 0.57637529, 0.45151096, 0.46504370, 0.48241223, 0.52100077, 0.58139290, 0.56208122, 0.60335538, 0.52929944, 0.42344000, 0.50067257, 0.57684497, 0.64478451, 0.43886235, 0.44666630, 0.51560435, 0.46258175, 0.54541132, 0.47979215, 0.43655740, 0.50703049, 0.53495727, 0.56162800, 0.55143527, 0.56284327, 0.60164181, 0.49749983, 0.58094130, 0.43562956, 0.42500995, 0.54948680, 0.47369505, 0.48414826, 0.51676280, 0.43266514, 0.57155003, 0.49200885, 0.47127192, 0.51761501, 0.50773766, 0.55882211, 0.48162295, 0.54465651, 0.53899152, 0.55328930, 0.55015769, 0.46811310, 0.53175613, 0.41530338, 0.55883316, 0.47936568, 0.45146579, 0.54243048, 0.54052303, 0.54204609, 0.50101337, 0.45019570, 0.52847647, 0.48879457, 0.50841671, 0.56159485, 0.62666809, 0.55974125, 0.45787448, 0.48001082, 0.54468903, 0.62293597, 0.49151523, 0.46646523, 0.40776337, 0.53172854, 0.44128392, 0.49630940, 0.55516482, 0.55068695, 0.51504028, 0.44182408, 0.54421632, 0.54990182, 0.50641548, 0.54543312, 0.53841544, 0.53191428, 0.51565128, 0.56393382, 0.48140364, 0.53908984, 0.48513175, 0.44577571, 0.47026617, 0.42197892, 0.52318967, 0.54342911, 0.54052999, 0.61999630, 0.46727823, 0.66016799, 0.57814695, 0.54674643, 0.50318362, 0.53845020, 0.52966896, 0.51541901, 0.54180353, 0.43743811, 0.55299857, 0.57370417, 0.50517927, 0.50456898, 0.48205677, 0.50698245, 0.56958667, 0.56685099, 0.48241890, 0.43353350, 0.41908357, 0.43555085, 0.57974968, 0.53628091, 0.47439816, 0.51052830, 0.55555215, 0.44878309, 0.51539657, 0.58610238, 0.50991064, 0.53597739, 0.49093576, 0.49093476, 0.47967627, 0.46857646, 0.53849319, 0.56773075, 0.54969753, 0.50844446, 0.52763823, 0.54726307, 0.50235737, 0.60404935, 0.43504425, 0.50201734, 0.48319084, 0.53910765, 0.42227222, 0.47998739, 0.46162446, 0.48761478, 0.48853964, 0.51629025, 0.42741104, 0.41795278, 0.54420407, 0.54785448, 0.40615081, 0.54039178, 0.51765489, 0.52341567, 0.47482172, 0.46685349, 0.61864869, 0.50262483, 0.50948196, 0.59471341, 0.53282638, 0.42811554, 0.48789967, 0.55367278, 0.50757846, 0.48020808, 0.52584696, 0.47088057, 0.52005290, 0.44185704, 0.55161742, 0.53255008, 0.44998637, 0.48313476, 0.43334243, 0.44554022, 0.53576187, 0.54492438, 0.48227448, 0.52801078, 0.50838284, 0.48309134, 0.45828664, 0.53132600, 0.48834343, 0.60701284, 0.59000358, 0.47613136, 0.51698062, 0.49712326, 0.55273677, 0.46149663, 0.58391862, 0.40974148, 0.45456859, 0.50089030, 0.55969422, 0.49266572, 0.47709065, 0.54791680, 0.51307235, 0.52119356, 0.55454918, 0.46666936, 0.61361510, 0.48641678, 0.47867774, 0.58019697, 0.56769460, 0.49174912, 0.50356454, 0.57852110, 0.53772411, 0.56122263, 0.54703591, 0.56860270, 0.41152652, 0.53957253, 0.52546442, 0.57052431, 0.53406606, 0.45686732, 0.55124644, 0.48893879, 0.53660613, 0.51914010, 0.44545112, 0.50660139, 0.49113147, 0.45092217, 0.57928446, 0.52660127, 0.56665130, 0.48263917, 0.49084172, 0.56727025, 0.54994978, 0.58531253, 0.50437095, 0.46171615, 0.58375147, 0.51039881, 0.57484893, 0.46438886, 0.55382972, 0.45084632, 0.46849081, 0.46886473, 0.45499292, 0.49458783, 0.50834733, 0.59688976, 0.41906880, 0.59625017, 0.53019544, 0.44742767, 0.55455162, 0.43433874, 0.44533193, 0.55742158, 0.50963407, 0.51425096, 0.52970878, 0.59189062, 0.56228480, 0.50486220, 0.52634779, 0.55703601, 0.38906191, 0.47603658, 0.55300897, 0.45863744, 0.51654066, 0.53278863, 0.49120572, 0.52456829, 0.44569890, 0.54669166, 0.56017754, 0.56400660, 0.52404763, 0.51298370, 0.53612826, 0.52174999, 0.42552476, 0.49746254, 0.45250956, 0.39378770, 0.54453382, 0.60952767, 0.52205440, 0.50570404, 0.51837963, 0.54014112, 0.44208068, 0.55926638, 0.51638118, 0.46378629, 0.50025689, 0.49762845, 0.50956321, 0.43939502, 0.50407863, 0.54828682, 0.51535576, 0.48851664, 0.53025087, 0.54736660, 0.51293225, 0.45526085, 0.57814547, 0.54479804, 0.42535363, 0.49529198, 0.50218650, 0.62596580, 0.48555410, 0.52228404, 0.55603706, 0.42253387, 0.53281790, 0.45407777, 0.44129944, 0.45021231, 0.47504333, 0.48811395, 0.53932262, 0.58055372, 0.60344592, 0.55648339, 0.51546235, 0.58388643, 0.48293573, 0.61379203, 0.51708565, 0.57059163, 0.51606676, 0.55990129, 0.43549615, 0.39840913, 0.52185373, 0.52121201, 0.45661105, 0.60325708, 0.57525503, 0.55669995, 0.49533380, 0.51018932, 0.50169564, 0.45984316, 0.58217376, 0.58840961, 0.41740572, 0.52688995, 0.55576371, 0.46426704, 0.62785564, 0.45034220, 0.51272584, 0.51744499, 0.50555755, 0.50902172, 0.50298285, 0.50808057, 0.48263061, 0.42331573, 0.46381084, 0.50413707, 0.45408342, 0.55593124, 0.45045401, 0.53053876, 0.57808014, 0.50363774, 0.51299529, 0.62999350, 0.55551994, 0.53528685, 0.42093831, 0.52287392, 0.53134561, 0.55699982, 0.46861129, 0.50071062, 0.50876032, 0.47905073, 0.50054900, 0.37331814, 0.57767768, 0.47989398, 0.51534253, 0.51899355, 0.55741241, 0.56310904, 0.44019481, 0.46015830, 0.54287129, 0.55381284, 0.57240940, 0.57739614, 0.52546551, 0.50803944, 0.44706023, 0.57462768, 0.57476655, 0.42375039, 0.44488583, 0.46758864, 0.53032452, 0.45780910, 0.51460371, 0.53655617, 0.52008064, 0.55084256, 0.47492127, 0.47056189, 0.49387306, 0.48341067, 0.49558922, 0.50035820, 0.49617795, 0.58039029, 0.55346729, 0.50355772, 0.53971306, 0.56498287, 0.55701710, 0.46391340, 0.38992070, 0.41396972, 0.45471663, 0.49631098, 0.56012856, 0.50680061, 0.59138775, 0.50149269, 0.55410782, 0.45675793, 0.50697618, 0.60137306, 0.53737509, 0.54048152, 0.40617918, 0.63143569)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr = DoubleMLPLR$new(obj_dml_data,
                                      ml_g, ml_m,
                                      n_folds=2,
                                      score='IV-type')
            obj_dml_plr$fit()
            this_theta = obj_dml_plr$coef
            print(abs(theta_dml[i_rep] - this_theta))
            theta_dml[i_rep] = this_theta
        }

        g_dml = ggplot(data.frame(theta_dml), aes(x = theta_dml)) +
                    geom_density(fill = "dark red", alpha = 0.3, color = "dark red") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_dml


Double/debiased machine learning
++++++++++++++++++++++++++++++++

To illustrate the benefits of the auxiliary prediction step (the DML) we write the error as

.. math::

    \sqrt{n}(\check{\theta} - \theta) = a^* + b^* + c^*

Chernozhukov et al. (2018) argues that:

The first term

.. math::

    a^* := (EV^2)^{-1} \frac{1}{\sqrt{n}} \sum_{i\in I} V_i U_i

will be asymptotically normally distributed.

The second term

.. math::

    b^* := (EV^2)^{-1} \frac{1}{\sqrt{n}} \sum_{i\in I} (\hat{m}(X_i) - m(X_i)) (\hat{g}_0(X_i) - g_0(X_i))

vanishes asymptotically for many data generating processes.

The third term :math:`c^*` vanishes in probability if sample splitting is applied.

.. tabbed:: Python

    .. ipython:: python

        ax = sns.kdeplot(theta_ols, shade=True)
        sns.kdeplot(theta_nonorth, shade=True, ax=ax);
        sns.kdeplot(theta_orth_nosplit, shade=True);
        sns.kdeplot(theta_dml, shade=True);
        labels = ['True Theta', 'OLS', 'Non-Orthogonal ML', 'Double ML (no Cross-Fitting)', 'Double ML with Cross-Fitting']
        ax.axvline(0.5, color='k', label='True theta');
        @savefig comparison.png width=5in
        ax.legend(labels);

.. tabbed:: R

    .. jupyter-execute::

        g_all = ggplot(data.frame(theta_ols, theta_nonorth, theta_orth_nosplit, theta_dml)) +
                    geom_density(aes(x = theta_ols), fill = "dark blue", alpha = 0.3, color = "dark blue") +
                    geom_density(aes(x = theta_nonorth), fill = "dark orange", alpha = 0.3, color = "dark orange") +
                    geom_density(aes(x = theta_orth_nosplit), fill = "dark green", alpha = 0.3, color = "dark green") +
                    geom_density(aes(x = theta_dml), fill = "dark red", alpha = 0.3, color = "dark red") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_all


References
++++++++++

Chernozhukov, V., Chetverikov, D., Demirer, M., Duflo, E., Hansen, C., Newey, W. and Robins, J. (2018), Double/debiased machine learning for treatment and structural parameters. The Econometrics Journal, 21: C1-C68. doi:`10.1111/ectj.12097 <https://doi.org/10.1111/ectj.12097>`_.