.. _basics:

The basics of double/debiased machine learning
----------------------------------------------

In the following we provide a brief summary of and motivation to double machine learning methods and show how the
corresponding methods provided by the :ref:`DoubleML <doubleml_package>` package can be applied.
For details we refer to Chernozhukov et al. (2018).

.. Add references to the vignette here when it is ready.

Data generating process
+++++++++++++++++++++++

We consider the following partially linear model

.. math::

        d_i = m_0(x_i) + v_i, & &v_i \sim \mathcal{N}(0,1),

        y_i = \theta d_i + g_0(x_i) + \zeta_i, & &\zeta_i \sim \mathcal{N}(0,1),


with covariates :math:`x_i \sim \mathcal{N}(0, \Sigma)`, where  :math:`\Sigma` is a matrix with entries
:math:`\Sigma_{kj} = 0.7^{|j-k|}`.
The true parameter :math:`\theta` is set to :math:`0.5`.

The nuisance functions are given by

.. math::

    m_0(x_i) &= \frac{1}{4} x_{i,1} + \frac{\exp(x_{i,3})}{1+\exp(x_{i,3})},

    g_0(X) &= \frac{\exp(x_{i,1})}{1+\exp(x_{i,1})} + \frac{1}{4} x_{i,3}.


.. note::
    - In Python the data can be generated with :py:func:`doubleml.datasets.make_plr_CCDDHNR2018`.
    - In R the data can be generated with `DoubleML::make_plr_CCDDHNR2018()`.

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        from doubleml.datasets import make_plr_CCDDHNR2018

        np.random.seed(1234)
        n_rep = 1000
        n_obs = 500
        n_vars = 20
        alpha = 0.5

        data = list()

        for i_rep in range(n_rep):
            (x, y, d) = make_plr_CCDDHNR2018(alpha=alpha, n_obs=n_obs, dim_x=n_vars, return_type='array')
            data.append((x, y, d))

.. tabbed:: R

    .. jupyter-execute::

        library(DoubleML)
        set.seed(1234)
        n_rep = 1000
        n_obs = 500
        n_vars = 20
        alpha = 0.5

        data = list()
        for (i_rep in seq_len(n_rep)) {
            data[[i_rep]] = make_plr_CCDDHNR2018(alpha=alpha, n_obs=n_obs, dim_x=n_vars,
                                                  return_type="data.frame")
        }


OLS estimation
++++++++++++++

A naive OLS regression of :math:`Y` on :math:`D` produces a significant bias.

.. tabbed:: Python

    .. The following block makes sure that the seaborn graphics are rendered appropriately but does not need to be shown

    .. ipython:: python
        :suppress:

        import seaborn as sns
        sns.set()

    .. ipython:: python

        from sklearn.linear_model import LinearRegression
        import matplotlib.pyplot as plt
        import seaborn as sns
        colors = sns.color_palette()

        def est_ols(y, X):
            ols = LinearRegression(fit_intercept=True)
            results = ols.fit(X, y)
            theta = results.coef_[0]
            return theta

        # to speed up the illustration we hard-code the simulation results
        theta_ols = np.array([0.53474489, 0.49321301, 0.48938474, 0.49113348, 0.47249586, 0.5002854 , 0.54329356, 0.49102594, 0.5122862 , 0.60483322, 0.50529179, 0.53756289, 0.53973136, 0.39572044, 0.48551521, 0.49308509, 0.52267272, 0.4739062 , 0.52061361, 0.49173419, 0.46886516, 0.44620177, 0.48511717, 0.52962376, 0.48755895, 0.43818864, 0.52179583, 0.46562877, 0.4800013 , 0.52071133, 0.49715162, 0.584374  , 0.41527432, 0.42062481, 0.49689983, 0.47557549, 0.47519286, 0.55330276, 0.50076464, 0.50110138, 0.44096759, 0.46251581, 0.49484472, 0.41750748, 0.51593157, 0.50057749, 0.51954889, 0.509907  , 0.50827057, 0.55922668, 0.47165547, 0.46419179, 0.53983825, 0.54715187, 0.56191988, 0.42893567, 0.52380663, 0.53270167, 0.4479071 , 0.48105327, 0.53353764, 0.54124996, 0.54548295, 0.51094094, 0.56332714, 0.43157765, 0.46556516, 0.48167184, 0.56591972, 0.5402868 , 0.45071603, 0.480492  , 0.4832924 , 0.51180645, 0.50391732, 0.55593077, 0.52081439, 0.49764327, 0.49323343, 0.50710186, 0.48558193, 0.49369803, 0.49289557, 0.45678834, 0.44466524, 0.5276184 , 0.50574872, 0.50873315, 0.5093345 , 0.5358176 , 0.41679893, 0.47270082, 0.54418933, 0.49517824, 0.52979261, 0.48433163, 0.48359337, 0.51812487, 0.59181156, 0.53699232, 0.46552581, 0.55333476, 0.48623123, 0.51144752, 0.46236854, 0.57886483, 0.51789811, 0.50735307, 0.4211589 , 0.48855078, 0.4243681 , 0.47640944, 0.45491436, 0.43403199, 0.48560822, 0.47612736, 0.48238253, 0.47310284, 0.4687885 , 0.47317536, 0.49469609, 0.56567542, 0.51730801, 0.49993896, 0.43936152, 0.56527377, 0.46761745, 0.47789828, 0.46624183, 0.43593246, 0.53883015, 0.4434861 , 0.52922966, 0.46343688, 0.48016923, 0.54198326, 0.53640534, 0.5486066 , 0.42170194, 0.47966118, 0.46205922, 0.44124758, 0.55045419, 0.53159584, 0.59094911, 0.42068926, 0.40552518, 0.53774806, 0.45015142, 0.52390304, 0.55731778, 0.49946863, 0.4673236 , 0.43911031, 0.5290068 , 0.62502696, 0.45862903, 0.49461714, 0.46826537, 0.6051445 , 0.49431491, 0.47420313, 0.51407318, 0.54771606, 0.49161362, 0.44876688, 0.55423873, 0.52165142, 0.54497392, 0.50958543, 0.52191335, 0.46170832, 0.48759109, 0.4665105 , 0.51398279, 0.49982105, 0.53468427, 0.57252245, 0.50871602, 0.49004664, 0.44862674, 0.54257961, 0.51952797, 0.43977019, 0.42614987, 0.4720368 , 0.4259677 , 0.46686015, 0.55086186, 0.51424663, 0.45194414, 0.46101624, 0.48000879, 0.40106034, 0.48569319, 0.49920413, 0.46055315, 0.53534816, 0.47341027, 0.44843531, 0.50454913, 0.57366355, 0.4925387 , 0.49228086, 0.4716174 , 0.45750129, 0.49507212, 0.4917077 , 0.56592525, 0.54639371, 0.4567486 , 0.60379587, 0.43035842, 0.38947502, 0.44171603, 0.54995707, 0.46330771, 0.54304814, 0.53987895, 0.53023513, 0.54072239, 0.50089411, 0.50459866, 0.53817506, 0.47298026, 0.55963564, 0.50326527, 0.50355272, 0.60127213, 0.49417754, 0.54759414, 0.56598608, 0.63706283, 0.49713338, 0.52999039, 0.60079361, 0.51643385, 0.44295755, 0.5963949 , 0.54125622, 0.50391499, 0.55067411, 0.47376548, 0.53941362, 0.46516167, 0.46151392, 0.53755663, 0.45469142, 0.43863601, 0.41087728, 0.47003843, 0.51079895, 0.52527368, 0.52637816, 0.50092493, 0.44371885, 0.49035799, 0.48642697, 0.58636112, 0.45844304, 0.46310898, 0.42365187, 0.49340386, 0.49373416, 0.47127632, 0.52443002, 0.48453076, 0.53557534, 0.54587319, 0.44557909, 0.44707145, 0.4539416 , 0.39477708, 0.57836687, 0.54884059, 0.55032192, 0.53475578, 0.50112881, 0.48718628, 0.50788462, 0.54118569, 0.48301988, 0.5794996 , 0.46683584, 0.50240451, 0.51780353, 0.59311556, 0.48079214, 0.56902342, 0.41570907, 0.51884787, 0.52249686, 0.50962174, 0.47330233, 0.4726149 , 0.48647001, 0.61941465, 0.43823152, 0.53603477, 0.44087591, 0.52902047, 0.58196358, 0.52784005, 0.5011582 , 0.45911991, 0.49441593, 0.53494157, 0.44535554, 0.5414655 , 0.49733792, 0.49475779, 0.43915872, 0.49568767, 0.56616213, 0.41704942, 0.48640589, 0.38543642, 0.50647226, 0.51371925, 0.52275473, 0.61616474, 0.4457942 , 0.53518279, 0.54067626, 0.53808711, 0.46492893, 0.50588601, 0.47287885, 0.45846615, 0.47665859, 0.47544855, 0.57764142, 0.4591314 , 0.45698   , 0.49991277, 0.45565277, 0.61295733, 0.39221989, 0.56562479, 0.49472817, 0.50932473, 0.42825645, 0.55559475, 0.43789049, 0.44167833, 0.57057639, 0.51820855, 0.52564698, 0.50620186, 0.43815581, 0.4810203 , 0.51335185, 0.5406191 , 0.48605583, 0.56855526, 0.54627503, 0.54415214, 0.43370327, 0.45239461, 0.46801712, 0.51715154, 0.47194603, 0.53931567, 0.5177749 , 0.53794166, 0.55616002, 0.51282155, 0.53608601, 0.55132172, 0.4980859 , 0.45259939, 0.47296707, 0.45061339, 0.4656037 , 0.43601839, 0.47838829, 0.56652835, 0.47912519, 0.47854479, 0.42877945, 0.54045897, 0.50203415, 0.51853431, 0.48332299, 0.51886349, 0.4922721 , 0.51415983, 0.50206898, 0.45802994, 0.48818453, 0.49376163, 0.49887163, 0.52478963, 0.52212671, 0.43240737, 0.41568593, 0.47251163, 0.51264271, 0.466146  , 0.48933761, 0.48328596, 0.47176266, 0.46670011, 0.53623029, 0.46025685, 0.47451923, 0.46879133, 0.50285378, 0.51401867, 0.47154368, 0.48150155, 0.42599135, 0.42931466, 0.38318738, 0.48729486, 0.50933095, 0.55217102, 0.46280048, 0.43381374, 0.50524411, 0.46498898, 0.49124544, 0.50201223, 0.46115799, 0.56409345, 0.49510631, 0.54108662, 0.44732406, 0.55340783, 0.53348839, 0.58847206, 0.42240913, 0.53597536, 0.45452201, 0.46062658, 0.509018  , 0.56280922, 0.54645935, 0.49926289, 0.47578281, 0.57868343, 0.53177585, 0.52901166, 0.49277313, 0.48939172, 0.43784499, 0.51884934, 0.50864266, 0.47256198, 0.50127337, 0.4865633 , 0.43823874, 0.50186063, 0.45279471, 0.45886552, 0.52525697, 0.53479534, 0.49155475, 0.41529628, 0.51256312, 0.51154064, 0.47848512, 0.53132404, 0.40414784, 0.48513958, 0.46941835, 0.506359  , 0.51026723, 0.42966184, 0.49305197, 0.46517452, 0.47567673, 0.53031564, 0.45419569, 0.48672741, 0.49795157, 0.48743661, 0.45806165, 0.49365887, 0.49653507, 0.48774482, 0.46732982, 0.58459275, 0.49083937, 0.48334247, 0.39941987, 0.5403948 , 0.53823986, 0.57201352, 0.52602583, 0.50339863, 0.4615549 , 0.44344451, 0.49285971, 0.45480388, 0.56558225, 0.60131966, 0.5053107 , 0.43050647, 0.50708966, 0.46837389, 0.54209162, 0.51197757, 0.44571481, 0.53555083, 0.42096495, 0.41615568, 0.53194506, 0.53527908, 0.51869224, 0.48849469, 0.4618124 , 0.5028268 , 0.56673464, 0.55341871, 0.5145758 , 0.45543321, 0.53295514, 0.4848744 , 0.44652998, 0.49586723, 0.46408788, 0.52653831, 0.45675493, 0.48064854, 0.54894375, 0.51060434, 0.53444835, 0.52246305, 0.43932644, 0.58277465, 0.49863121, 0.55056164, 0.49953239, 0.46288279, 0.46965027, 0.5697236 , 0.53503966, 0.4965715 , 0.4674949 , 0.5263088 , 0.50678119, 0.46258979, 0.4384881 , 0.46117142, 0.44299651, 0.54077493, 0.53312685, 0.48808191, 0.51242034, 0.50558988, 0.51457369, 0.56547915, 0.56384583, 0.48725927, 0.57817448, 0.50696463, 0.51031497, 0.48304431, 0.43884653, 0.41845616, 0.55504791, 0.46636769, 0.54222221, 0.47889168, 0.48675801, 0.5656616 , 0.49355164, 0.59875287, 0.54860168, 0.41522733, 0.48733809, 0.45435601, 0.48421146, 0.53625036, 0.52039774, 0.46557329, 0.44124397, 0.45918866, 0.59905709, 0.45946443, 0.58272019, 0.56888478, 0.51512697, 0.49093757, 0.42787907, 0.36219117, 0.45381723, 0.52093829, 0.40546958, 0.4660952 , 0.48313102, 0.44781083, 0.57084453, 0.46142245, 0.47217102, 0.52012389, 0.48153086, 0.53011145, 0.51914472, 0.50200375, 0.53883905, 0.54166622, 0.48516097, 0.51547332, 0.52541931, 0.47094642, 0.53695563, 0.49049476, 0.52160056, 0.51067811, 0.54168207, 0.54234601, 0.44459535, 0.48857404, 0.47027832, 0.50366589, 0.57688593, 0.47950764, 0.53180427, 0.53870999, 0.53445408, 0.5105142 , 0.51371376, 0.42762207, 0.51726115, 0.45286408, 0.5109974 , 0.49780359, 0.54788922, 0.50479127, 0.64452317, 0.48756741, 0.47778028, 0.50247063, 0.5683386 , 0.47424521, 0.52908729, 0.48216914, 0.4775991 , 0.45400233, 0.60397105, 0.49374285, 0.52471122, 0.57952876, 0.43364184, 0.53986198, 0.4539684 , 0.52752411, 0.47134024, 0.51161519, 0.54641137, 0.41413646, 0.48030456, 0.50183466, 0.50047268, 0.47452658, 0.55366858, 0.43086586, 0.56226793, 0.48369335, 0.53388527, 0.52281165, 0.47390147, 0.44183718, 0.53477263, 0.48494785, 0.51406698, 0.4364245 , 0.4743458 , 0.53747715, 0.52402966, 0.5517987 , 0.462502  , 0.53312726, 0.45864507, 0.4963592 , 0.45126227, 0.3865317 , 0.52282475, 0.5811465 , 0.48913972, 0.47794925, 0.53048497, 0.47688648, 0.59828497, 0.47491287, 0.48384638, 0.50358656, 0.47974641, 0.52118523, 0.52047044, 0.57841763, 0.44414197, 0.49448264, 0.48941372, 0.56717217, 0.49568387, 0.46514785, 0.48829665, 0.48496805, 0.53573793, 0.44725976, 0.52156074, 0.48637891, 0.47565922, 0.52188966, 0.52385771, 0.48305139, 0.50539809, 0.42186232, 0.5310401 , 0.5259056 , 0.49774519, 0.52779038, 0.50357969, 0.44497218, 0.55608139, 0.5305365 , 0.44169658, 0.46459225, 0.49803248, 0.50077158, 0.51459487, 0.5578276 , 0.44990819, 0.47057602, 0.4935438 , 0.50186926, 0.55992217, 0.49552788, 0.56180316, 0.50581783, 0.55138616, 0.53310174, 0.51467114, 0.46727048, 0.49602158, 0.54968695, 0.49183205, 0.53702454, 0.48045015, 0.60745461, 0.47877859, 0.52268702, 0.44059445, 0.52658321, 0.51342425, 0.48777418, 0.45409294, 0.50199068, 0.58796237, 0.51459613, 0.52727472, 0.51778247, 0.58508896, 0.42353076, 0.5589943 , 0.5452906 , 0.46497285, 0.4721525 , 0.51872793, 0.50737646, 0.53598476, 0.51487334, 0.51025047, 0.45997346, 0.52569714, 0.59271492, 0.47565387, 0.4253818 , 0.51048574, 0.45883372, 0.46833953, 0.49072685, 0.40760359, 0.50887312, 0.51979943, 0.4819792 , 0.5011791 , 0.48768716, 0.42263539, 0.42955879, 0.43264743, 0.56108565, 0.46934004, 0.49473812, 0.49870407, 0.50209089, 0.5257926 , 0.58951831, 0.47646809, 0.44359847, 0.51646926, 0.48335204, 0.6095419 , 0.43684926, 0.46532125, 0.57085336, 0.45246229, 0.45500884, 0.43820721, 0.48883694, 0.49923171, 0.49454512, 0.46757216, 0.50392497, 0.45690719, 0.52115087, 0.49426604, 0.5682218 , 0.56663046, 0.48588061, 0.50559017, 0.55418244, 0.46094655, 0.4875857 , 0.49152018, 0.51592583, 0.45254013, 0.52578698, 0.48037731, 0.5888076 , 0.41591601, 0.57084497, 0.54238712, 0.46058968, 0.49596231, 0.44058778, 0.46605588, 0.43884962, 0.50133128, 0.56691439, 0.51067353, 0.50922709, 0.59197217, 0.51544076, 0.46496894, 0.44652142, 0.38269509, 0.48060243, 0.57067647, 0.52669513, 0.54722451, 0.59266688, 0.5027297 , 0.52517902, 0.50655131, 0.48671682, 0.46502047, 0.36989293, 0.57694682, 0.47269473, 0.49795472, 0.45216404, 0.58739343, 0.46508828, 0.55824265, 0.47456072, 0.51541848, 0.55838359, 0.51605357, 0.54614737, 0.41025221, 0.51133316, 0.5643638 , 0.47493961, 0.50785406, 0.53192483, 0.52820181, 0.45081073, 0.5402259 , 0.52844925, 0.48895705, 0.45544954, 0.46532192, 0.46329957, 0.53848375, 0.49837064, 0.56305592, 0.52683051, 0.48461581, 0.53912628, 0.47429614, 0.55116519, 0.41253095, 0.55496383, 0.49483699, 0.48079289, 0.40545022, 0.55754818, 0.49453036, 0.45718172, 0.54040348, 0.44332797, 0.53741497, 0.52103591, 0.40783533, 0.53037164, 0.56506329, 0.42884113, 0.4905965 , 0.46556432, 0.46612422, 0.49108396, 0.43627095, 0.53392408, 0.40424801, 0.53241135, 0.54615187, 0.48652899, 0.526703  , 0.47725838, 0.44261845, 0.57641265, 0.51916159, 0.51944697, 0.4668915 , 0.46111359, 0.55932904, 0.59413201, 0.50788586, 0.48124233, 0.44335864, 0.54505944, 0.47534189, 0.48856266, 0.54285278, 0.46202711, 0.53536273, 0.46786836, 0.46270178, 0.59477902, 0.54031046, 0.53264006, 0.56325303, 0.54716242, 0.50410641, 0.45729931, 0.49915554, 0.49975055, 0.56362584, 0.55207975, 0.43898493, 0.47108249, 0.43693969, 0.49183465, 0.42706892, 0.47105807, 0.48851287, 0.6038248 , 0.47808143, 0.47665868, 0.52669046, 0.42548465, 0.51011812, 0.48982998, 0.46345572, 0.50397137, 0.485495  , 0.50939626, 0.4710299 , 0.50338374, 0.42873138, 0.5485134 , 0.53108115, 0.49835547, 0.47022046, 0.53646885, 0.4645972 , 0.52719066, 0.47153956, 0.43017155, 0.49774166, 0.4094798 , 0.47422792, 0.5230961 , 0.47733581, 0.45446963, 0.49697803, 0.48056422, 0.54790097, 0.48669133, 0.51637556, 0.46626523, 0.48151959, 0.62070997, 0.56278102, 0.5733016 , 0.50237631, 0.49459564, 0.48035173, 0.40878425, 0.5860298 , 0.53697496, 0.50528379, 0.54038233, 0.50800976, 0.45271877, 0.5263313 ])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            this_theta = est_ols(y, np.column_stack((d, x)))
            # we show that the loaded result matches the just computed
            print(np.abs(theta_ols[i_rep] - this_theta))
            theta_ols[i_rep] = this_theta

        ax = sns.kdeplot(theta_ols, shade=True, color=colors[0])
        @savefig ols.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        library(ggplot2)

        est_ols = function(df) {
            ols = stats::lm(y ~ 1 +., df)
            theta = coef(ols)["d"]
            return(theta)
        }

        # to speed up the illustration we hard-code the simulation results
        theta_ols = c(0.50066732, 0.50427573, 0.42586006, 0.49819607, 0.43031137, 0.45943417, 0.58053661, 0.47083882, 0.43765156, 0.57232581, 0.52764176, 0.46623794, 0.48053142, 0.41475097, 0.47480772, 0.43668051, 0.47197283, 0.53890654, 0.50196409, 0.50654331, 0.45220941, 0.49118202, 0.49802683, 0.48933184, 0.49425810, 0.44290158, 0.51163123, 0.54398421, 0.51612200, 0.46093349, 0.52834483, 0.47945559, 0.58077183, 0.51163208, 0.47799363, 0.48152794, 0.53218330, 0.51947047, 0.48144133, 0.55552300, 0.51077567, 0.58100498, 0.37198745, 0.54752476, 0.60814248, 0.56207911, 0.55344214, 0.50372917, 0.50739677, 0.46361648, 0.50692998, 0.55508325, 0.55892586, 0.43038581, 0.51166642, 0.61206564, 0.50688059, 0.42821179, 0.47149354, 0.47552530, 0.47896573, 0.46797847, 0.55834902, 0.48738283, 0.53997247, 0.44397148, 0.45532671, 0.47293800, 0.58190473, 0.47794627, 0.53893031, 0.51362988, 0.43821108, 0.46977411, 0.50410572, 0.48325857, 0.52050605, 0.51664075, 0.46123328, 0.46715418, 0.44163853, 0.48416978, 0.49581100, 0.47833080, 0.48142249, 0.52478285, 0.49932350, 0.49147930, 0.48815788, 0.58174769, 0.56855142, 0.47738046, 0.46158105, 0.48742835, 0.43133935, 0.56936694, 0.49875521, 0.50901641, 0.55269304, 0.48506152, 0.46457400, 0.45481627, 0.47627805, 0.47414423, 0.48196350, 0.42755058, 0.51613766, 0.47567344, 0.48975577, 0.50049529, 0.49204048, 0.52329820, 0.44268564, 0.51801296, 0.43913696, 0.49644820, 0.50139236, 0.49644952, 0.52550191, 0.47850645, 0.55325750, 0.52430925, 0.50466736, 0.46351904, 0.49209642, 0.51685043, 0.46718974, 0.49139770, 0.50837053, 0.51968789, 0.52344953, 0.49260919, 0.47580028, 0.58971410, 0.49733412, 0.50672821, 0.56237838, 0.47049485, 0.51617218, 0.46809280, 0.47582432, 0.44200286, 0.55167234, 0.46612616, 0.50666745, 0.47140522, 0.48292014, 0.56455593, 0.54159118, 0.53088114, 0.57274027, 0.53980120, 0.56837368, 0.45500889, 0.63798844, 0.51442580, 0.42549014, 0.45924884, 0.51324280, 0.47627181, 0.60017483, 0.51546453, 0.52304766, 0.46410910, 0.58651139, 0.49439696, 0.58396640, 0.48096527, 0.52773000, 0.59013907, 0.49578304, 0.50348918, 0.50298010, 0.49689960, 0.51464746, 0.52846405, 0.47918644, 0.50869185, 0.46972237, 0.45297674, 0.46837834, 0.43481788, 0.52461321, 0.53965683, 0.45925218, 0.43081423, 0.51475927, 0.50997223, 0.42726448, 0.48823491, 0.50486063, 0.55700563, 0.51522359, 0.56801983, 0.51385100, 0.53670447, 0.46106079, 0.48107204, 0.41265459, 0.44161506, 0.46647676, 0.54613775, 0.42464200, 0.56838213, 0.54659934, 0.41424573, 0.46727458, 0.55746128, 0.51260987, 0.50694646, 0.44708596, 0.53175532, 0.49325278, 0.44394346, 0.51713778, 0.56126763, 0.57216441, 0.51596040, 0.43622536, 0.43111436, 0.49674821, 0.52884593, 0.48694542, 0.42135831, 0.51909331, 0.55535898, 0.46648137, 0.47995408, 0.48833233, 0.52878151, 0.50462174, 0.45630503, 0.46892560, 0.41599179, 0.49166181, 0.53167068, 0.53673555, 0.42790862, 0.47008032, 0.43330117, 0.45683119, 0.51774241, 0.52444128, 0.51948450, 0.49377847, 0.45829671, 0.48400733, 0.57788194, 0.48952230, 0.54090109, 0.42886823, 0.56458851, 0.51313559, 0.52304774, 0.45337603, 0.51534409, 0.39260348, 0.45853171, 0.47418236, 0.39527165, 0.53637804, 0.51474281, 0.43700814, 0.50304246, 0.52493683, 0.50029998, 0.51684017, 0.42955499, 0.53866880, 0.48894866, 0.50102238, 0.52924921, 0.53624992, 0.50367799, 0.51398849, 0.50154105, 0.48148108, 0.49054661, 0.52251363, 0.50976342, 0.50717556, 0.46837895, 0.53687619, 0.46165277, 0.50487022, 0.53911377, 0.51456417, 0.44196227, 0.57267812, 0.51085391, 0.54015592, 0.50785953, 0.48043897, 0.57627249, 0.44143149, 0.46175117, 0.44487475, 0.50517121, 0.48287961, 0.47092681, 0.44510506, 0.46883448, 0.51430465, 0.51790550, 0.55082436, 0.46959873, 0.58445074, 0.47939905, 0.47263398, 0.48326625, 0.59438456, 0.53247209, 0.45142072, 0.46531072, 0.49950719, 0.48435991, 0.52953789, 0.46718510, 0.49799995, 0.51424938, 0.53891853, 0.38005517, 0.47792351, 0.50969866, 0.51278719, 0.53905647, 0.44169991, 0.59948661, 0.50398729, 0.53108183, 0.50853684, 0.52368196, 0.51326702, 0.52847604, 0.46198463, 0.44293624, 0.50875253, 0.52797189, 0.54258196, 0.51504251, 0.37597742, 0.50157708, 0.48532716, 0.51168507, 0.57366041, 0.51998065, 0.47464574, 0.49555359, 0.49944543, 0.52839810, 0.52797065, 0.40116794, 0.57753658, 0.55853553, 0.44981621, 0.47386518, 0.46899545, 0.48728839, 0.48284544, 0.49794629, 0.51563955, 0.49469190, 0.55860459, 0.48822793, 0.44772398, 0.51000459, 0.46140997, 0.52418422, 0.51989802, 0.43492256, 0.45682348, 0.47517416, 0.54180906, 0.48531315, 0.51620542, 0.49163140, 0.51688825, 0.50852671, 0.53056111, 0.45057403, 0.54350287, 0.57187755, 0.50768851, 0.47366729, 0.53265882, 0.51421110, 0.40531573, 0.48227807, 0.50272070, 0.42190323, 0.58135957, 0.52609920, 0.52536233, 0.45551939, 0.43403804, 0.48740693, 0.52222253, 0.53188772, 0.50488552, 0.52231654, 0.55462697, 0.58243939, 0.58445392, 0.52865802, 0.46018330, 0.49966192, 0.52242397, 0.50602332, 0.49169944, 0.43186131, 0.48198022, 0.52017519, 0.49604544, 0.51000725, 0.44123490, 0.42791577, 0.51853182, 0.45287910, 0.45936798, 0.53304653, 0.49496500, 0.46945827, 0.52583917, 0.52271836, 0.54750460, 0.49858299, 0.52754817, 0.46439323, 0.47181330, 0.48490582, 0.51909177, 0.48794387, 0.55412407, 0.46064043, 0.44831203, 0.51052375, 0.44488789, 0.48549908, 0.50226314, 0.53529690, 0.57369121, 0.46987655, 0.51643945, 0.48300412, 0.53951605, 0.58048405, 0.46253797, 0.49901964, 0.51932941, 0.54465400, 0.54980292, 0.61111919, 0.51365195, 0.42782642, 0.49144821, 0.51886718, 0.49278062, 0.41265323, 0.55309826, 0.58174079, 0.53723735, 0.47632763, 0.46500712, 0.41986973, 0.45877825, 0.52432225, 0.51758261, 0.46315391, 0.50989348, 0.44460749, 0.47844637, 0.43345987, 0.52954886, 0.50796129, 0.55473962, 0.52574352, 0.46183288, 0.51862844, 0.44850163, 0.42841580, 0.57861017, 0.49553444, 0.49939855, 0.50796643, 0.51020383, 0.53477602, 0.48603068, 0.55077541, 0.54743400, 0.45969149, 0.46888128, 0.49905443, 0.57924707, 0.48855463, 0.52001682, 0.47532081, 0.49935747, 0.51361875, 0.57092815, 0.49096426, 0.46132399, 0.41117314, 0.45536761, 0.50615464, 0.51712814, 0.52371634, 0.57748296, 0.48763315, 0.58766210, 0.51628119, 0.55078021, 0.54955141, 0.54640512, 0.50254850, 0.40519524, 0.58765706, 0.52822568, 0.48818884, 0.53213139, 0.52538154, 0.47456800, 0.45719406, 0.45870730, 0.51707942, 0.50039608, 0.57150347, 0.46992585, 0.50127675, 0.43245089, 0.55161370, 0.45372696, 0.42976500, 0.47153581, 0.50046689, 0.50060313, 0.55714472, 0.45761909, 0.43710657, 0.47303297, 0.51778267, 0.48606986, 0.50817795, 0.44934873, 0.47804326, 0.43660275, 0.57189433, 0.43676580, 0.52591845, 0.35141071, 0.51967233, 0.50948236, 0.45643821, 0.49293429, 0.56674796, 0.45721977, 0.45712430, 0.46882489, 0.49820733, 0.56485509, 0.49917315, 0.52774244, 0.50117347, 0.45566039, 0.51779057, 0.51582060, 0.56366401, 0.47700195, 0.43682703, 0.52369677, 0.44850616, 0.51151042, 0.47795083, 0.41914872, 0.50798470, 0.52942301, 0.48002965, 0.52012958, 0.55702419, 0.57382353, 0.50366329, 0.58428843, 0.44234497, 0.42210186, 0.53703926, 0.47066823, 0.50139878, 0.48802580, 0.45242935, 0.56559196, 0.48257810, 0.46505862, 0.46454286, 0.47926939, 0.55268475, 0.50684342, 0.51265553, 0.52003636, 0.55005241, 0.54553139, 0.48302109, 0.47986321, 0.40734049, 0.51080886, 0.49912839, 0.47363408, 0.48204256, 0.53672747, 0.51572541, 0.50504645, 0.43894774, 0.52552170, 0.48763376, 0.48934983, 0.54572683, 0.59432946, 0.53552204, 0.45852263, 0.45259567, 0.54027496, 0.53835142, 0.48784839, 0.47851290, 0.43686367, 0.49563022, 0.45977060, 0.46939544, 0.53828310, 0.55549073, 0.51091299, 0.43419404, 0.57218403, 0.52202352, 0.51162030, 0.55635525, 0.52896556, 0.51162328, 0.48953297, 0.54853567, 0.50314214, 0.51410353, 0.48588511, 0.40336329, 0.48574450, 0.41733040, 0.49095700, 0.50629231, 0.56312436, 0.57294264, 0.45393382, 0.65467453, 0.54424278, 0.50932487, 0.47439085, 0.50312400, 0.46687313, 0.50245625, 0.51114339, 0.46222222, 0.53607829, 0.50782433, 0.48330653, 0.48176420, 0.46678653, 0.47681682, 0.53370349, 0.51158140, 0.46794453, 0.43858061, 0.42663446, 0.44833478, 0.50422689, 0.53391347, 0.49713339, 0.50413157, 0.48207044, 0.45082284, 0.48985484, 0.54392159, 0.49028608, 0.50663257, 0.49082248, 0.49434110, 0.49565974, 0.45277153, 0.52266025, 0.54276780, 0.55768740, 0.46217194, 0.49364866, 0.49908343, 0.47664710, 0.53770342, 0.38188183, 0.47052588, 0.47777865, 0.50427585, 0.42621112, 0.49261972, 0.46104674, 0.50778382, 0.51194839, 0.48133845, 0.43745951, 0.36609416, 0.50267033, 0.54301787, 0.44500215, 0.52150278, 0.45691559, 0.48907908, 0.43864666, 0.51924207, 0.57012142, 0.54818041, 0.47250224, 0.57675402, 0.50139561, 0.40137978, 0.49091005, 0.54405777, 0.48331665, 0.52750134, 0.55059885, 0.47181193, 0.52773111, 0.45910612, 0.56181917, 0.52360854, 0.43638797, 0.46081990, 0.47452563, 0.48570708, 0.53004725, 0.58193750, 0.49657087, 0.50109363, 0.47918939, 0.46777521, 0.46405517, 0.53780641, 0.46672310, 0.47316826, 0.53038721, 0.46306136, 0.50808909, 0.48721938, 0.53455955, 0.52049822, 0.58531183, 0.39919635, 0.47861225, 0.48789088, 0.52743843, 0.49631607, 0.47634820, 0.55881738, 0.47889382, 0.47573653, 0.51353116, 0.45954166, 0.57306211, 0.45348439, 0.46522012, 0.45405720, 0.53492427, 0.44948520, 0.52282164, 0.55284135, 0.50753579, 0.50828959, 0.50878314, 0.48484081, 0.39129183, 0.54452492, 0.50383061, 0.55487855, 0.53269304, 0.46162257, 0.59135921, 0.48747589, 0.47270425, 0.47711855, 0.46921169, 0.50961172, 0.51093603, 0.41499467, 0.55718243, 0.48393349, 0.55093147, 0.47110871, 0.47731253, 0.56227032, 0.53666606, 0.56525763, 0.48420795, 0.43241152, 0.56620680, 0.46293670, 0.54681509, 0.46311275, 0.51836299, 0.47644570, 0.45330370, 0.48118085, 0.43365082, 0.47719110, 0.48576523, 0.55231477, 0.41639812, 0.55794435, 0.48878937, 0.44333507, 0.45989541, 0.47074514, 0.49226709, 0.52616744, 0.51772110, 0.51015827, 0.54569087, 0.55700773, 0.52833013, 0.49386971, 0.51387381, 0.48342709, 0.39036925, 0.46803622, 0.53218625, 0.47678805, 0.47998107, 0.51539311, 0.50510222, 0.53440923, 0.48805375, 0.55869142, 0.52542717, 0.58525335, 0.47429851, 0.51637824, 0.54808150, 0.51381418, 0.44767744, 0.49424921, 0.45051008, 0.41970534, 0.48882750, 0.54564194, 0.55195744, 0.46230872, 0.49830445, 0.51466583, 0.46390509, 0.52575909, 0.55925511, 0.48846725, 0.51922050, 0.48222224, 0.52774161, 0.46774800, 0.54290394, 0.49725398, 0.49684339, 0.47807697, 0.49662279, 0.49997424, 0.49148366, 0.46333822, 0.54731926, 0.51107001, 0.42790305, 0.44115950, 0.53315275, 0.55838288, 0.45456911, 0.51452523, 0.51385439, 0.45275635, 0.49693898, 0.47593131, 0.45505981, 0.41278897, 0.50987286, 0.47279156, 0.48471865, 0.52113990, 0.57897176, 0.53151761, 0.51298751, 0.49745084, 0.50989722, 0.58393070, 0.54017336, 0.56205868, 0.53433385, 0.55035803, 0.40630827, 0.43679964, 0.54156204, 0.49980253, 0.45944577, 0.58178368, 0.59587454, 0.54699896, 0.49107440, 0.52755051, 0.49130843, 0.44265640, 0.57737293, 0.54923130, 0.36738210, 0.52160136, 0.53884056, 0.45552436, 0.58932667, 0.44327171, 0.54486112, 0.57444526, 0.54074632, 0.45366687, 0.47830339, 0.51022401, 0.50674658, 0.52723529, 0.43752528, 0.46713395, 0.44706357, 0.52050046, 0.43476177, 0.52395257, 0.56811545, 0.50024244, 0.49691311, 0.56225763, 0.52449949, 0.53427641, 0.41689839, 0.49431404, 0.54314393, 0.52507149, 0.50050957, 0.46552783, 0.51820802, 0.51003490, 0.49198762, 0.39227933, 0.53075889, 0.50267675, 0.54573284, 0.52044565, 0.53641566, 0.53300891, 0.46860332, 0.44188533, 0.54736360, 0.55480168, 0.48455964, 0.53462980, 0.53762875, 0.49579148, 0.43991177, 0.53916040, 0.55265393, 0.43102330, 0.46606470, 0.44239634, 0.50628504, 0.47511074, 0.49463827, 0.55632449, 0.51860881, 0.50461636, 0.47601946, 0.49539076, 0.48239028, 0.50884845, 0.47452176, 0.53284504, 0.48798765, 0.56748601, 0.51233059, 0.50515004, 0.53735938, 0.51657253, 0.53292288, 0.45154775, 0.39663526, 0.50293754, 0.45005974, 0.51335252, 0.50333869, 0.44186876, 0.53579483, 0.46438079, 0.53491798, 0.45302889, 0.47677119, 0.57622394, 0.52933019, 0.49324093, 0.41279485, 0.53838295)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
          df = data[[i_rep]]
          this_theta = est_ols(df)
          print(abs(theta_ols[i_rep] - this_theta))
          theta_ols[i_rep] = this_theta
        }

        g_ols = ggplot(data.frame(theta_ols), aes(x = theta_ols)) +
                    geom_density(fill = "dark blue", alpha = 0.3, color = "dark blue") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_ols


Regularization bias in simple ML-approaches
+++++++++++++++++++++++++++++++++++++++++++

A simple ML approach is given by randomly splitting the sample into two parts.
On the auxiliary sample indexed by :math:`i \in I^C` the nuisance function :math:`g_0(X)` is estimated with an ML method.
Given the estimate :math:`\hat{g}_0(X)`, the final estimate of :math:`\theta` is obtained as (:math:`n=N/2`) using the
other half of observations indexed with :math:`i \in I`


.. math::

    \hat{\theta} = \left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i (Y_i - \hat{g}_0(X_i)).

.. tabbed:: Python

    .. ipython:: python

        def non_orth_score(y, d, g_hat, m_hat, smpls):
            u_hat = y - g_hat
            psi_a = -np.multiply(d, d)
            psi_b = np.multiply(d, u_hat)
            return psi_a, psi_b

    .. ipython:: python

        from doubleml import DoubleMLData
        from doubleml import DoubleMLPLR
        from sklearn.ensemble import RandomForestRegressor
        from sklearn.base import clone
        import numpy as np
        np.random.seed(1111)

        learner = RandomForestRegressor(n_estimators=100, max_features=20, max_depth=5, min_samples_leaf=2)
        ml_m = clone(learner)
        ml_g = clone(learner)

        # to speed up the illustration we hard-code the simulation results
        theta_nonorth = np.array([0.29319684, 0.31840615, 0.31223144, 0.21330107, 0.25659459, 0.24835001, 0.34180878, 0.2434044 , 0.39574817, 0.41771943, 0.26560856, 0.28342785, 0.3251033 , 0.21955147, 0.326546  , 0.3666444 , 0.35565926, 0.20386695, 0.27908492, 0.3676557 , 0.23653232, 0.24380573, 0.24229452, 0.21983314, 0.20134483, 0.17584869, 0.35675313, 0.31079762, 0.29343276, 0.39521953, 0.31544726, 0.35182732, 0.19266858, 0.27993025, 0.2625552 , 0.28292512, 0.2504227 , 0.25184899, 0.32404356, 0.25360991, 0.20085518, 0.24903073, 0.32223034, 0.22999957, 0.36521065, 0.29230698, 0.21207339, 0.3155053 , 0.2565405 , 0.28042589, 0.27927371, 0.24020442, 0.31689617, 0.30543755, 0.33658461, 0.24789342, 0.35596227, 0.21703709, 0.28244194, 0.25493631, 0.33369396, 0.33491105, 0.31333223, 0.30679768, 0.33111346, 0.25416343, 0.28499504, 0.27214359, 0.28477609, 0.11725465, 0.30035971, 0.36260626, 0.30574892, 0.29619337, 0.47072922, 0.32151207, 0.35074774, 0.21117695, 0.33625854, 0.35161057, 0.25353144, 0.24231556, 0.17925759, 0.29530721, 0.14742435, 0.17959333, 0.28699551, 0.32394097, 0.27759004, 0.24004821, 0.22557524, 0.27228742, 0.26156933, 0.3225659 , 0.31609126, 0.28303064, 0.22460877, 0.26487577, 0.31546301, 0.29192795, 0.23488023, 0.40330001, 0.25796419, 0.35024425, 0.29272965, 0.20371538, 0.31188784, 0.30727171, 0.30207012, 0.37011565, 0.27569244, 0.24342733, 0.35242927, 0.33346499, 0.2835006 , 0.23589216, 0.32692853, 0.25555251, 0.21043037, 0.23278246, 0.40567014, 0.29273458, 0.32095532, 0.25429688, 0.20978686, 0.37868848, 0.22678583, 0.27186399, 0.37387355, 0.24947016, 0.26737071, 0.29613413, 0.29554816, 0.25821904, 0.17825272, 0.37491785, 0.19583833, 0.36591379, 0.2549919 , 0.36753639, 0.15887216, 0.27815385, 0.2855657 , 0.34708299, 0.23808476, 0.29864112, 0.23332502, 0.37003327, 0.29792418, 0.32318961, 0.3207421 , 0.26794835, 0.2547224 , 0.33712819, 0.12832034, 0.33788336, 0.20525795, 0.21347059, 0.34635817, 0.29988315, 0.30323361, 0.23957384, 0.26197808, 0.17971546, 0.34330474, 0.13339347, 0.37059148, 0.31371407, 0.28624461, 0.27985534, 0.30185459, 0.35130287, 0.33901941, 0.25795781, 0.31584885, 0.30775679, 0.36706445, 0.27068611, 0.2891883 , 0.38371762, 0.25517989, 0.33023073, 0.29958366, 0.28026265, 0.2503629 , 0.26475935, 0.21049856, 0.1423197 , 0.35287324, 0.30344198, 0.15053151, 0.324559  , 0.27280448, 0.16433175, 0.25466775, 0.2745836 , 0.32328078, 0.25970638, 0.17766038, 0.2098045 , 0.28357777, 0.21605416, 0.27122119, 0.27571804, 0.2936043 , 0.19794982, 0.17866909, 0.21235336, 0.29199468, 0.23830312, 0.23033383, 0.35933588, 0.1620826 , 0.17186896, 0.18416139, 0.30637393, 0.26472774, 0.27727687, 0.44740879, 0.28375374, 0.3066991 , 0.29732014, 0.33021236, 0.27559895, 0.34884626, 0.32356646, 0.16272322, 0.33545231, 0.25534704, 0.29852845, 0.37720084, 0.30664904, 0.44687089, 0.26946585, 0.31865206, 0.35660557, 0.17476756, 0.20519534, 0.35203209, 0.27581518, 0.27925961, 0.39696984, 0.34167771, 0.24138579, 0.37792603, 0.2308852 , 0.41492775, 0.26002311, 0.32188474, 0.22756602, 0.30044557, 0.2143263 , 0.24005907, 0.35667131, 0.22619088, 0.25794655, 0.27608715, 0.32097895, 0.33727697, 0.20818261, 0.24644071, 0.30466575, 0.26298512, 0.25662702, 0.24483208, 0.43047575, 0.33397762, 0.35399593, 0.18956857, 0.31086464, 0.14275596, 0.35707408, 0.17847349, 0.45623743, 0.25790341, 0.32341659, 0.26190591, 0.14788621, 0.28693403, 0.29365714, 0.39700133, 0.27012914, 0.3252729 , 0.32146871, 0.3345289 , 0.29520698, 0.38879868, 0.33701645, 0.38698306, 0.21135743, 0.28989781, 0.23002162, 0.18095605, 0.24977852, 0.27216133, 0.22074684, 0.32612241, 0.23451498, 0.23155274, 0.25115124, 0.22946209, 0.37080465, 0.26271139, 0.2331574 , 0.24477204, 0.31580129, 0.37118545, 0.21998636, 0.32829081, 0.28601368, 0.31922825, 0.17514537, 0.37554706, 0.26155049, 0.12972149, 0.41703229, 0.20742184, 0.35163323, 0.17901207, 0.37205129, 0.31401936, 0.25664183, 0.32165039, 0.34636682, 0.26836103, 0.35899911, 0.25426319, 0.40731718, 0.24251142, 0.33523925, 0.24649361, 0.38725382, 0.19132417, 0.2338103 , 0.20397743, 0.24174912, 0.27969103, 0.24087839, 0.28480819, 0.2392837 , 0.42328871, 0.2405941 , 0.316421  , 0.26945591, 0.21905906, 0.3393181 , 0.31728025, 0.29444184, 0.31527138, 0.2289431 , 0.3771293 , 0.28432793, 0.36679193, 0.26713554, 0.36532493, 0.30502709, 0.27736823, 0.20196746, 0.29207574, 0.21556587, 0.32772197, 0.20262584, 0.32476781, 0.25873466, 0.34620529, 0.29935617, 0.16642763, 0.34663595, 0.27357198, 0.2982772 , 0.2314988 , 0.25063713, 0.31574765, 0.28674426, 0.25510278, 0.29910046, 0.3013401 , 0.24221426, 0.3978542 , 0.19700109, 0.33796558, 0.31580919, 0.23913296, 0.32639272, 0.31939073, 0.24759191, 0.30181017, 0.30404123, 0.2199586 , 0.31506155, 0.32422915, 0.29305382, 0.25247297, 0.21021239, 0.26032998, 0.27315551, 0.25212632, 0.31220125, 0.21501468, 0.42037517, 0.21377253, 0.32713257, 0.31418021, 0.2795437 , 0.27236052, 0.28665366, 0.27599028, 0.36403201, 0.37400683, 0.24246052, 0.25156382, 0.25034515, 0.22781666, 0.16727949, 0.20829453, 0.26574614, 0.32446194, 0.18586769, 0.15760543, 0.19925664, 0.19235239, 0.26086358, 0.30401212, 0.22782145, 0.34334088, 0.14627948, 0.3062442 , 0.29297942, 0.33304006, 0.38315349, 0.46590377, 0.2961071 , 0.27611792, 0.33925651, 0.23486769, 0.27318809, 0.23299323, 0.18690162, 0.26601188, 0.33316654, 0.41506294, 0.23462502, 0.31792679, 0.25699156, 0.3876131 , 0.26230957, 0.16928191, 0.25158579, 0.2070323 , 0.18600558, 0.32185997, 0.17230405, 0.23305841, 0.22027967, 0.23728688, 0.34456774, 0.36797653, 0.15093248, 0.29702243, 0.20975122, 0.26149668, 0.31582985, 0.27934859, 0.39253709, 0.30071506, 0.24750077, 0.28515173, 0.25959705, 0.18610014, 0.27691788, 0.30597765, 0.30857929, 0.29784484, 0.27233281, 0.31245188, 0.21266821, 0.24001271, 0.25243079, 0.28468564, 0.32814629, 0.32008091, 0.30770589, 0.4007951 , 0.38673759, 0.29577242, 0.36105942, 0.22222496, 0.32465443, 0.34077791, 0.27961799, 0.26581298, 0.17582005, 0.25421134, 0.20055969, 0.23679547, 0.37920991, 0.27687498, 0.33009316, 0.21521212, 0.37229198, 0.24640521, 0.37133471, 0.33087701, 0.25700688, 0.28865486, 0.20395873, 0.20134789, 0.41165877, 0.36403856, 0.34082548, 0.1911489 , 0.2458969 , 0.24399398, 0.40612449, 0.40687366, 0.28284873, 0.25900919, 0.26050391, 0.19316106, 0.21614061, 0.31498673, 0.26115004, 0.28625721, 0.23141924, 0.23526172, 0.29346302, 0.37407703, 0.29807147, 0.36158063, 0.18973578, 0.4925426 , 0.31404028, 0.34714361, 0.34828088, 0.29817134, 0.22289707, 0.3507302 , 0.37813269, 0.23393946, 0.25365312, 0.37061011, 0.34198828, 0.30826333, 0.25759974, 0.27215007, 0.31859742, 0.30971266, 0.33893234, 0.32067849, 0.31533274, 0.14171065, 0.22870236, 0.24468148, 0.37954881, 0.28879696, 0.32565767, 0.24073966, 0.24477197, 0.38713123, 0.28208479, 0.28028966, 0.35180517, 0.13896571, 0.27460199, 0.34498357, 0.35840354, 0.26501797, 0.24719994, 0.38345119, 0.26542125, 0.26892174, 0.25980829, 0.21219918, 0.29915366, 0.33709222, 0.26477143, 0.30082016, 0.22205185, 0.24135321, 0.25896329, 0.27433097, 0.31751965, 0.23741986, 0.34162057, 0.31637418, 0.24616973, 0.20866684, 0.29308645, 0.26946817, 0.18029697, 0.23213092, 0.3272268 , 0.30925319, 0.34352314, 0.24100002, 0.2935282 , 0.21217536, 0.30401715, 0.26930965, 0.26283796, 0.41262901, 0.41025537, 0.22624398, 0.22155853, 0.27518809, 0.22958604, 0.30585373, 0.24801936, 0.23922312, 0.38973797, 0.32953543, 0.31376603, 0.28214616, 0.22996967, 0.29459341, 0.32026782, 0.28212886, 0.3141234 , 0.25450605, 0.2281625 , 0.25325933, 0.35504011, 0.23994727, 0.26219842, 0.35210459, 0.34979984, 0.27873991, 0.31598357, 0.28785034, 0.32573893, 0.36294896, 0.35413158, 0.27939219, 0.27436846, 0.34141719, 0.2510968 , 0.28478198, 0.48027739, 0.21290708, 0.3448923 , 0.24738578, 0.26994387, 0.29477065, 0.22314961, 0.30959474, 0.26492522, 0.38316418, 0.25156742, 0.34927883, 0.20908885, 0.26999617, 0.35343235, 0.30228772, 0.33787966, 0.22634276, 0.33010634, 0.26729395, 0.32410384, 0.16898097, 0.39029219, 0.27314103, 0.32954321, 0.40718884, 0.34020381, 0.23845998, 0.30376588, 0.32920799, 0.36046021, 0.2139594 , 0.27729576, 0.2627463 , 0.21606684, 0.21692553, 0.27241316, 0.35847809, 0.27756088, 0.3112457 , 0.22817825, 0.24076747, 0.3485126 , 0.38160213, 0.29835211, 0.26714476, 0.12172368, 0.34813552, 0.40019165, 0.35481774, 0.18447926, 0.26753618, 0.31162233, 0.18207261, 0.36366675, 0.18792699, 0.17845665, 0.26822811, 0.32174025, 0.33915387, 0.36974784, 0.25623063, 0.3505247 , 0.29268366, 0.29502533, 0.23791722, 0.22480179, 0.20797668, 0.22843705, 0.26060172, 0.34559641, 0.33075109, 0.29154998, 0.17506779, 0.40922365, 0.32391234, 0.31525306, 0.24737843, 0.31168529, 0.18289927, 0.32788822, 0.27563492, 0.23207472, 0.25275258, 0.26766764, 0.24839109, 0.27624132, 0.34317465, 0.28597101, 0.31796601, 0.26668254, 0.34324541, 0.28340665, 0.31155751, 0.26450331, 0.23816392, 0.27773972, 0.36095836, 0.33361369, 0.38941858, 0.1934152 , 0.31910934, 0.35391103, 0.24717574, 0.29170106, 0.13608657, 0.34946051, 0.32978011, 0.28974828, 0.40412635, 0.25718237, 0.20917514, 0.29336392, 0.31834754, 0.39534384, 0.377525  , 0.27984207, 0.2611942 , 0.45504852, 0.26819527, 0.29593522, 0.30072384, 0.27772612, 0.20591858, 0.24460663, 0.33253005, 0.31414112, 0.25752077, 0.30515717, 0.2958151 , 0.29908035, 0.34519822, 0.21390263, 0.255619  , 0.19645229, 0.26358932, 0.21695193, 0.32616397, 0.26568104, 0.37924359, 0.40788188, 0.30958615, 0.27918601, 0.28233053, 0.24696353, 0.25926154, 0.22315697, 0.29290969, 0.37519665, 0.13700712, 0.28288805, 0.27115335, 0.34500685, 0.30067907, 0.22967867, 0.20945214, 0.33677418, 0.29349561, 0.27971383, 0.21687752, 0.21439806, 0.3040365 , 0.19724053, 0.19431075, 0.29937213, 0.13991248, 0.35703645, 0.25022749, 0.27888559, 0.25257467, 0.15812217, 0.32429678, 0.31307669, 0.31110078, 0.23503492, 0.27567851, 0.34933315, 0.26637685, 0.27437971, 0.29887281, 0.25437893, 0.32804333, 0.25517129, 0.32624261, 0.30818378, 0.33665691, 0.25485245, 0.34054008, 0.28722171, 0.16125703, 0.31100509, 0.20788044, 0.26865956, 0.28267972, 0.17606888, 0.2464257 , 0.29432742, 0.29093306, 0.34917428, 0.3131915 , 0.28269665, 0.27450994, 0.34060333, 0.1611629 , 0.2583948 , 0.29976931, 0.1690698 , 0.27318073, 0.23783928, 0.3472381 , 0.30807657, 0.27193936, 0.36001817, 0.29930924, 0.32817252, 0.31023429, 0.32385623, 0.26935814, 0.32371182, 0.23675695, 0.36532003, 0.21114686, 0.40356034, 0.27415229, 0.34925102, 0.34139483, 0.22968727, 0.22189511, 0.38603935, 0.38341789, 0.27129872, 0.2050083 , 0.29786157, 0.28388557, 0.25213282, 0.24934106, 0.28368466, 0.19737474, 0.17556709, 0.34283217, 0.34575408, 0.25779986, 0.39944258, 0.25762786, 0.35609135, 0.39902364, 0.24469687, 0.16505124, 0.37074506, 0.29948662, 0.25388669, 0.18420502, 0.36455915, 0.31538916, 0.32632153, 0.26363196, 0.26300757, 0.24221963, 0.2455832 , 0.26117476, 0.11555666, 0.27081887, 0.39253464, 0.31743827, 0.33979268, 0.20979431, 0.22644027, 0.1944916 , 0.17493588, 0.27738256, 0.20720776, 0.22320087, 0.37081578, 0.25118571, 0.15345798, 0.32626107, 0.28168503, 0.27939485, 0.14938423, 0.26394828, 0.2635838 , 0.2313757 , 0.3523135 , 0.3599672 , 0.29293004, 0.25985955, 0.31377221, 0.34501481, 0.20813081, 0.22527715, 0.40425807, 0.23440039, 0.260185  , 0.31564136, 0.21534504, 0.20893064, 0.30806966, 0.29505211, 0.31448366, 0.29072767, 0.28258194, 0.28801394, 0.23111009, 0.22035274, 0.29706831, 0.27670521, 0.20682787, 0.15758223, 0.23297569, 0.33843577, 0.33158128, 0.19926417, 0.32296074, 0.24813818, 0.21652956, 0.24979186, 0.24950038, 0.22569088, 0.37113768, 0.30798443, 0.23541823, 0.25514065, 0.27408747, 0.23496553, 0.21193389, 0.27317648, 0.30666689, 0.30886513, 0.33145074, 0.30266963, 0.25960121, 0.33044062, 0.33390467, 0.39959554, 0.3063657 , 0.27558343, 0.31338648, 0.22957856, 0.32061607, 0.20468418, 0.30246092, 0.26548053, 0.25675625, 0.38064923, 0.19447888, 0.20874608, 0.35848563, 0.27297357, 0.26689161, 0.29202662, 0.2490595 , 0.23875537, 0.39059001, 0.2318199 , 0.34861821, 0.21427262, 0.32231824, 0.2935788 , 0.3069678 , 0.32836187, 0.32886618, 0.31457978, 0.25469999])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr_nonorth = DoubleMLPLR(obj_dml_data,
                                              ml_m, ml_g,
                                              n_folds=2,
                                              apply_cross_fitting=False,
                                              score=non_orth_score)
            obj_dml_plr_nonorth.fit()
            this_theta = obj_dml_plr_nonorth.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_nonorth[i_rep] - this_theta))
            theta_nonorth[i_rep] = this_theta

        ax = sns.kdeplot(theta_nonorth, shade=True, color=colors[1])
        @savefig nonorth.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        non_orth_score = function(y, d, g_hat, m_hat, smpls) {
         u_hat = y - g_hat
         psi_a = -1*d*d
         psi_b = d*u_hat
         psis = list(psi_a = psi_a, psi_b = psi_b)
         return(psis)
        }


    .. jupyter-execute::

        library(mlr3)
        library(mlr3learners)
        library(data.table)
        lgr::get_logger("mlr3")$set_threshold("warn")
        set.seed(1111)

        learner = lrn("regr.ranger", num.trees = 100, mtry = 20, min.node.size = 2, max.depth = 5)
        ml_m = learner$clone()
        ml_g = learner$clone()

        # to speed up the illustration we hard-code the simulation results
        theta_nonorth = c(0.334301792, 0.382362163, 0.340523434, 0.212148418, 0.169059365, 0.224893109, 0.357667586, 0.371251163, 0.142404500, 0.246200553, 0.364780326, 0.293014267, 0.279750088, 0.235626760, 0.280999833, 0.215160245, 0.294437118, 0.275316161, 0.348827405, 0.287640556, 0.249338704, 0.242065658, 0.437302344, 0.281592828, 0.293128770, 0.243506797, 0.154210765, 0.324504466, 0.272916482, 0.345503832, 0.254453194, 0.195755735, 0.125554802, 0.357950176, 0.311636323, 0.312313732, 0.218408088, 0.425636268, 0.319245484, 0.346378010, 0.359674392, 0.403772970, 0.138935625, 0.391104862, 0.399896870, 0.300021287, 0.326225585, 0.292143675, 0.343125427, 0.147859165, 0.233518883, 0.340372030, 0.307856641, 0.264522824, 0.220069717, 0.403891425, 0.259313891, 0.139918505, 0.223976971, 0.265842939, 0.301732308, 0.272162252, 0.315115153, 0.255757129, 0.344332487, 0.205830706, 0.236648747, 0.311428437, 0.393278956, 0.305628532, 0.251775132, 0.348330726, 0.221393129, 0.290651507, 0.273723492, 0.263755023, 0.308733574, 0.347732064, 0.189642371, 0.298278714, 0.162688126, 0.239874419, 0.239099636, 0.215164023, 0.360673417, 0.238636152, 0.315653277, 0.309837160, 0.322136037, 0.429401723, 0.459964744, 0.269722380, 0.240195556, 0.300964657, 0.257396151, 0.305723485, 0.256157599, 0.180138433, 0.293305995, 0.197100578, 0.249608643, 0.422464768, 0.277954659, 0.177607701, 0.341700023, 0.247089598, 0.260381244, 0.358048341, 0.318976957, 0.240519690, 0.337325238, 0.247304692, 0.172391931, 0.369875091, 0.176954008, 0.279592677, 0.271277755, 0.334334150, 0.372406351, 0.148380570, 0.285546077, 0.292321140, 0.200225143, 0.290690368, 0.295146769, 0.214979020, 0.277565050, 0.391819410, 0.243356902, 0.307285498, 0.248273483, 0.282436979, 0.208594091, 0.417756312, 0.312062669, 0.271447615, 0.327630684, 0.275611927, 0.275583926, 0.256250070, 0.276858657, 0.328730296, 0.397909953, 0.353153777, 0.393651543, 0.260929610, 0.380140636, 0.325346022, 0.356697000, 0.304936949, 0.412289584, 0.294014694, 0.418201436, 0.330932760, 0.343442331, 0.298549000, 0.206291432, 0.172026103, 0.268614241, 0.217427453, 0.265822249, 0.273075777, 0.258449615, 0.176067164, 0.186662280, 0.328234850, 0.256368307, 0.287770130, 0.316004864, 0.344399707, 0.168420604, 0.275878574, 0.327238453, 0.281274199, 0.466670028, 0.147205538, 0.200275690, 0.363375804, 0.240426340, 0.367571568, 0.278661758, 0.191753306, 0.328167784, 0.296139364, 0.152818799, 0.242250460, 0.388706202, 0.379811666, 0.284894701, 0.234338573, 0.310034875, 0.384566126, 0.329362970, 0.332406782, 0.213706870, 0.298593509, 0.229952321, 0.322005969, 0.202347807, 0.275296740, 0.269969078, 0.330995223, 0.128599638, 0.362322595, 0.438054469, 0.130635855, 0.292133914, 0.460956452, 0.222610357, 0.243229185, 0.285411753, 0.312452578, 0.258244423, 0.277715492, 0.390026282, 0.415628933, 0.317476554, 0.206315002, 0.194905126, 0.234459793, 0.153018054, 0.381291928, 0.203966567, 0.155798112, 0.274697600, 0.321884178, 0.296861425, 0.385939429, 0.322258548, 0.231321528, 0.349196319, 0.306567532, 0.232088462, 0.215487998, 0.308535908, 0.342314069, 0.351021657, 0.249237813, 0.222795535, 0.250168144, 0.171969587, 0.318140651, 0.208965798, 0.274970342, 0.113126498, 0.238707011, 0.242028434, 0.373567406, 0.403137732, 0.217471686, 0.297568796, 0.311908278, 0.314644359, 0.188570063, 0.364854293, 0.298174137, 0.314072989, 0.379010894, 0.258534639, 0.154349553, 0.324568752, 0.265465586, 0.246968690, 0.246052391, 0.281958213, 0.245703190, 0.275896457, 0.293358004, 0.312599116, 0.135706191, 0.275053588, 0.312820710, 0.275599568, 0.305406395, 0.196877920, 0.392168754, 0.261494517, 0.233760080, 0.394906832, 0.371065449, 0.236422010, 0.224814334, 0.300273461, 0.276080614, 0.360642445, 0.389229250, 0.267005725, 0.353213644, 0.441214151, 0.274175810, 0.192970258, 0.296709939, 0.291803154, 0.378031519, 0.276809573, 0.272151186, 0.194732455, 0.319555153, 0.232541632, 0.292453479, 0.128109411, 0.372739180, 0.262036532, 0.244533364, 0.399039118, 0.264928805, 0.324061954, 0.222214422, 0.276506645, 0.271142842, 0.276027702, 0.217835444, 0.234161259, 0.235276499, 0.265231546, 0.250103858, 0.402541916, 0.192869659, 0.361177828, 0.395658873, 0.336718801, 0.258695706, 0.241983920, 0.310012700, 0.211973933, 0.420371977, 0.276299352, 0.327974440, 0.232934584, 0.263915047, 0.317017347, 0.274567232, 0.270652784, 0.333543837, 0.235480605, 0.295085109, 0.257887169, 0.371283176, 0.295465850, 0.304467063, 0.257263596, 0.362942377, 0.265885360, 0.306104497, 0.241019368, 0.264985273, 0.271688086, 0.327406175, 0.267696027, 0.367559088, 0.242176262, 0.295493814, 0.355795055, 0.395146080, 0.183975595, 0.216949911, 0.277741411, 0.409839137, 0.212173995, 0.300621618, 0.288943114, 0.229147433, 0.331416467, 0.201070593, 0.181788407, 0.249558315, 0.296475410, 0.304644403, 0.273344962, 0.236776400, 0.311376919, 0.251741971, 0.296878307, 0.294603118, 0.289437980, 0.235839079, 0.292865460, 0.174820267, 0.258071114, 0.284104049, 0.350472347, 0.357983495, 0.369112919, 0.334453256, 0.319844562, 0.207531124, 0.225488725, 0.217969645, 0.350988864, 0.279467447, 0.357277303, 0.330173427, 0.282731166, 0.319992495, 0.220540458, 0.259680996, 0.257819290, 0.360960866, 0.240552015, 0.353683049, 0.282280933, 0.409342339, 0.376979236, 0.360873146, 0.266613413, 0.298636780, 0.307961158, 0.246633589, 0.254229630, 0.284777321, 0.327387251, 0.279635146, 0.295119458, 0.369189199, 0.310984424, 0.164495140, 0.195154447, 0.281599250, 0.263734639, 0.313052056, 0.310670876, 0.319981266, 0.190110511, 0.331012652, 0.259638582, 0.266820360, 0.248152149, 0.348326167, 0.262590871, 0.238381082, 0.290231785, 0.207790790, 0.289044965, 0.249223667, 0.219726897, 0.315072758, 0.332872664, 0.303423929, 0.238711302, 0.295153117, 0.377949570, 0.233377826, 0.246009986, 0.440981686, 0.283376563, 0.208573436, 0.391032175, 0.284825407, 0.205020573, 0.314542850, 0.272856779, 0.255773415, 0.332062910, 0.251676800, 0.312855045, 0.283450374, 0.349895356, 0.154979926, 0.269876238, 0.378757984, 0.107758197, 0.281380014, 0.134593688, 0.196285965, 0.334723211, 0.255252060, 0.289192809, 0.203472169, 0.302955775, 0.344889548, 0.273906203, 0.259598806, 0.169480151, 0.258838902, 0.224912587, 0.306606996, 0.202941135, 0.403935509, 0.203372510, 0.227395620, 0.223223505, 0.292525993, 0.210511680, 0.212912173, 0.201747068, 0.255659261, 0.359863280, 0.410212482, 0.409300958, 0.265585337, 0.250942643, 0.296897291, 0.318281309, 0.211193205, 0.282612943, 0.349817682, 0.381010739, 0.284773310, 0.462356992, 0.215054607, 0.206572985, 0.305961970, 0.286927990, 0.312650545, 0.244075629, 0.361203502, 0.294160531, 0.256379418, 0.370873102, 0.393930271, 0.428976807, 0.271028686, 0.315242481, 0.276185621, 0.232014369, 0.251069346, 0.307819438, 0.264045535, 0.312971688, 0.330049110, 0.290507345, 0.211461856, 0.260309136, 0.390142430, 0.272803666, 0.380043671, 0.305516025, 0.232668778, 0.353684427, 0.288511477, 0.342557311, 0.222486397, 0.356872737, 0.414216392, 0.253593435, 0.393197781, 0.192485363, 0.285903336, 0.146910148, 0.305425367, 0.271255895, 0.294634189, 0.236294910, 0.290142659, 0.253232940, 0.360206628, 0.177847060, 0.309069007, 0.151355722, 0.274332741, 0.311813829, 0.174356579, 0.330577083, 0.348137105, 0.238628435, 0.209962478, 0.228697672, 0.386339726, 0.311751592, 0.313553716, 0.291499266, 0.245182538, 0.256677905, 0.309404938, 0.217249816, 0.341520600, 0.224221505, 0.273926068, 0.228225428, 0.288307051, 0.270530883, 0.202469190, 0.311971565, 0.253442573, 0.218829934, 0.266405496, 0.205555685, 0.232568736, 0.285162580, 0.209863530, 0.296613323, 0.130193672, 0.250361119, 0.280097734, 0.268494324, 0.326135462, 0.244135606, 0.249481773, 0.394999761, 0.279176297, 0.255553645, 0.317563363, 0.298809906, 0.262105591, 0.238755757, 0.364943696, 0.331377940, 0.308389786, 0.383183019, 0.311639358, 0.249502220, 0.162376681, 0.337663172, 0.417809471, 0.045162205, 0.316232881, 0.389131719, 0.350018017, 0.290424010, 0.162869563, 0.262234438, 0.384159718, 0.308951694, 0.359456767, 0.335467327, 0.323901956, 0.197153403, 0.279974236, 0.228093600, 0.201036916, 0.282469088, 0.294645108, 0.319088557, 0.271445943, 0.198652966, 0.313415163, 0.356264392, 0.354112077, 0.332768332, 0.275298226, 0.348009826, 0.283298709, 0.214014166, 0.393526137, 0.235436787, 0.234381882, 0.346517471, 0.286811069, 0.383992530, 0.386412862, 0.259571544, 0.213006513, 0.238596828, 0.135415238, 0.241271634, 0.323250033, 0.398953002, 0.350120961, 0.317085169, 0.413396078, 0.272775847, 0.316992161, 0.175047119, 0.333776300, 0.365127796, 0.237548833, 0.326150783, 0.280548685, 0.266896126, 0.375264355, 0.261963509, 0.219038271, 0.149897213, 0.288840000, 0.384339151, 0.430297120, 0.266033743, 0.297096262, 0.250344360, 0.264868738, 0.295594448, 0.357291831, 0.232293824, 0.209357550, 0.292363853, 0.329739543, 0.273212442, 0.405016516, 0.303780532, 0.243335806, 0.205819109, 0.275201962, 0.254885110, 0.288140311, 0.319507834, 0.425849854, 0.341629055, 0.223724840, 0.389428181, 0.250912692, 0.355307555, 0.347825281, 0.253746848, 0.247201171, 0.214908697, 0.316318413, 0.292140111, 0.244355444, 0.256271237, 0.253620870, 0.257814150, 0.247363046, 0.230032193, 0.112408621, 0.309018316, 0.371757395, 0.170989447, 0.222380129, 0.262779265, 0.207750325, 0.308320460, 0.379365267, 0.268565266, 0.318906529, 0.403231288, 0.355001791, 0.288528488, 0.209261540, 0.216368635, 0.334152472, 0.257946784, 0.389010641, 0.327427092, 0.228533431, 0.243096024, 0.355593544, 0.358062774, 0.328009075, 0.245097523, 0.239548564, 0.274284144, 0.350463693, 0.265373026, 0.388895428, 0.262005335, 0.298903008, 0.279212912, 0.278086805, 0.307255979, 0.270900845, 0.303988317, 0.298080704, 0.265119499, 0.338198979, 0.298075141, 0.336058657, 0.397777150, 0.313806910, 0.325692046, 0.266236905, 0.197487524, 0.285981023, 0.352137171, 0.246885422, 0.276880001, 0.335376638, 0.279637631, 0.303652382, 0.280478987, 0.245345484, 0.236852646, 0.228880115, 0.287122684, 0.326808506, 0.306767684, 0.192954401, 0.354426471, 0.303976766, 0.381327218, 0.273133742, 0.332577516, 0.215344972, 0.197115398, 0.214766597, 0.220878593, 0.422803278, 0.271224891, 0.227652750, 0.450923760, 0.324513884, 0.150393041, 0.259433800, 0.262154897, 0.282097870, 0.209922423, 0.243506761, 0.312550723, 0.336860901, 0.344019533, 0.248688318, 0.378511172, 0.316763248, 0.298725177, 0.383099925, 0.223117954, 0.190760877, 0.368633242, 0.319218694, 0.272445981, 0.238364406, 0.318344300, 0.333314339, 0.259458961, 0.266251978, 0.236932315, 0.409355158, 0.284622451, 0.269026734, 0.258075006, 0.278670295, 0.302669959, 0.292450804, 0.155925656, 0.268519510, 0.255041291, 0.215063070, 0.315840146, 0.222323552, 0.321359548, 0.300912546, 0.224777936, 0.258493650, 0.319250486, 0.280186704, 0.138223502, 0.307731261, 0.309526153, 0.230466412, 0.278518036, 0.292088067, 0.405313228, 0.304471352, 0.243945819, 0.309362734, 0.311263839, 0.374211605, 0.270831938, 0.288522317, 0.246409285, 0.366063301, 0.280897821, 0.378804464, 0.165137322, 0.229647219, 0.198550886, 0.372354252, 0.300365234, 0.240710105, 0.305827514, 0.259945147, 0.264619702, 0.305696864, 0.296630506, 0.310323330, 0.372956218, 0.285707255, 0.291818858, 0.292737681, 0.334493759, 0.277167094, 0.299670566, 0.249816017, 0.323277775, 0.299707624, 0.368158944, 0.251905133, 0.267467640, 0.355977313, 0.235742785, 0.215979537, 0.362410789, 0.284889483, 0.304003742, 0.228160600, 0.309110829, 0.195882573, 0.210266013, 0.194784568, 0.221014561, 0.262064669, 0.267955368, 0.236187031, 0.393340709, 0.240797373, 0.328563572, 0.235615208, 0.225607749, 0.142020164, 0.379884007, 0.388534603, 0.227268893, 0.380240783, 0.282164832, 0.294764800, 0.278896585, 0.247252354, 0.238135447, 0.270617064, 0.270056949, 0.340700210, 0.224963721, 0.263004653, 0.326323400, 0.295245345, 0.323256386, 0.239582656, 0.282111350, 0.312700550, 0.189800140, 0.313014046, 0.264552307, 0.267596503, 0.268678851, 0.267408693, 0.198380258, 0.254279252, 0.207605652, 0.302686218, 0.303119635, 0.273088864, 0.257363384, 0.436098854, 0.163459785, 0.238679920, 0.289483250, 0.361306937, 0.255716505, 0.310463224, 0.196920359, 0.269636987, 0.264919636, 0.271662030, 0.292553427, 0.324165994, 0.177442502, 0.251462508, 0.345243516, 0.318776630, 0.349767532, 0.256534117, 0.195970611, 0.205189744, 0.263907407, 0.235893571, 0.273636180, 0.281247940, 0.270909860, 0.278667171, 0.321301310, 0.367964768, 0.256736284, 0.248014350, 0.213732007, 0.312677261, 0.221433707, 0.310099824, 0.353680308, 0.231536633, 0.193855989, 0.301574798, 0.383396867, 0.240017944, 0.202400124, 0.232118369, 0.349093243, 0.243387971, 0.293620739, 0.327687985, 0.232137048, 0.161061712, 0.242582209, 0.259307461, 0.363104738, 0.356422220, 0.281962758, 0.300674549, 0.375219212, 0.285321492, 0.173028780, 0.262146246, 0.383091273, 0.346603802, 0.331250721, 0.214696349, 0.283535179, 0.103316754, 0.248462689, 0.283356316, 0.271743441, 0.284659787, 0.358651168, 0.269786280, 0.289981993, 0.250076449, 0.411763321, 0.342744380, 0.192041793, 0.336434646, 0.281313811, 0.283680228)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr_nonorth = DoubleMLPLR$new(obj_dml_data,
                                                  ml_g, ml_m,
                                                  n_folds=2,
                                                  score=non_orth_score,
                                                  apply_cross_fitting=FALSE)
            obj_dml_plr_nonorth$fit()
            this_theta = obj_dml_plr_nonorth$coef
            print(abs(theta_nonorth[i_rep] - this_theta))
            theta_nonorth[i_rep] = this_theta
        }

        g_nonorth = ggplot(data.frame(theta_nonorth), aes(x = theta_nonorth)) +
                        geom_density(fill = "dark orange", alpha = 0.3, color = "dark orange") +
                        geom_vline(aes(xintercept = alpha), col = "black") +
                        xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_nonorth


The regularization bias in the simple ML-approach is caused by the slow convergence of :math:`\hat{\theta}`

.. math::

    |\sqrt{n} (\hat{\theta} - \theta) | \rightarrow_{P} \infty

i.e. slower than :math:`1/\sqrt{n}`.
The driving factor is the bias in learning :math:`g`.
A Heuristic illustration is given by

.. math::

    \sqrt{n}(\hat{\theta} - \theta) = \underbrace{\left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i U_i}_{=:a}
    +  \underbrace{\left(\frac{1}{n} \sum_{i\in I} D_i^2\right)^{-1} \frac{1}{n} \sum_{i\in I} D_i (g_0(X_i) - \hat{g}_0(X_i))}_{=:b}.

:math:`a` is approximately Gaussian under mild conditions.
However, :math:`b` (the regularization bias) diverges in general.

.. _bias_non_orth:

Overcoming regularization bias by orthogonalization
+++++++++++++++++++++++++++++++++++++++++++++++++++

To overcome the regularization bias we are directly partialling out the effect of :math:`X` from :math:`D` to obtain the
orthogonalized regressor :math:`V = D - m(X)`. We then use the final estimate

.. math::

    \check{\theta} = \left(\frac{1}{n} \sum_{i\in I} \hat{V}_i D_i\right)^{-1} \frac{1}{n} \sum_{i\in I} \hat{V}_i (Y_i - \hat{g}_0(X_i)).

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        np.random.seed(2222)

        # to speed up the illustration we hard-code the simulation results
        theta_orth_nosplit = np.array([0.40001928, 0.37391323, 0.36308174, 0.36397944, 0.38541354, 0.3647171 , 0.40384992, 0.35925774, 0.40405829, 0.45272764, 0.40589423, 0.39377149, 0.41607069, 0.30492928, 0.36393528, 0.35385938, 0.38820243, 0.32989575, 0.3950756 , 0.37300714, 0.36545957, 0.33376852, 0.35256856, 0.36745957, 0.37102312, 0.34407758, 0.38984721, 0.36315858, 0.34772464, 0.39907514, 0.39374186, 0.43632286, 0.30719141, 0.32357411, 0.36874534, 0.34185308, 0.3631246 , 0.42268676, 0.38962016, 0.36641865, 0.34184314, 0.35062047, 0.36312652, 0.29401635, 0.40708813, 0.37791416, 0.3791789 , 0.37336375, 0.38507954, 0.44364113, 0.37275674, 0.37871017, 0.40828118, 0.39711773, 0.42601953, 0.33105222, 0.39585972, 0.43057969, 0.34452166, 0.36048483, 0.37794291, 0.40790173, 0.42418859, 0.38581412, 0.43188922, 0.33496595, 0.34463871, 0.3740169 , 0.42040489, 0.4057572 , 0.35336546, 0.36826517, 0.35224745, 0.39656492, 0.38819845, 0.39556661, 0.39492787, 0.39160303, 0.37582737, 0.40836546, 0.37592515, 0.36888467, 0.36023196, 0.35917169, 0.31524108, 0.39645808, 0.38930541, 0.37679351, 0.42913451, 0.39257438, 0.31370033, 0.33008828, 0.4284092 , 0.37201739, 0.38960731, 0.36442073, 0.38552077, 0.37666163, 0.48631475, 0.4088208 , 0.34498681, 0.43395948, 0.35941184, 0.40336225, 0.35556994, 0.43595662, 0.37842213, 0.40400933, 0.32198722, 0.36822364, 0.31142137, 0.35557807, 0.31839808, 0.33508737, 0.35310067, 0.38252933, 0.37534813, 0.37612325, 0.36934383, 0.35994186, 0.35715418, 0.44296029, 0.36743584, 0.36233167, 0.3015209 , 0.43576511, 0.33934909, 0.35533359, 0.35842759, 0.32351336, 0.41555779, 0.33858524, 0.37568617, 0.35843984, 0.36415919, 0.42145838, 0.41801671, 0.41663198, 0.31566444, 0.36326722, 0.35382034, 0.33178367, 0.44348583, 0.37095711, 0.42932865, 0.32469571, 0.32093132, 0.40160851, 0.35380148, 0.40504826, 0.3974217 , 0.38126728, 0.34374086, 0.36263591, 0.37124129, 0.46183988, 0.34940501, 0.37324977, 0.3188404 , 0.45117178, 0.3625096 , 0.36526825, 0.40936905, 0.41393585, 0.37869091, 0.35503858, 0.42627007, 0.36684799, 0.37608838, 0.3889056 , 0.40241684, 0.36906768, 0.37472092, 0.3531769 , 0.37551279, 0.37727005, 0.38937792, 0.46217379, 0.37782073, 0.35427822, 0.35297377, 0.40282625, 0.38365911, 0.3128854 , 0.30541763, 0.33503233, 0.3131235 , 0.3570351 , 0.40264212, 0.39558471, 0.33638786, 0.34186089, 0.3706435 , 0.29921387, 0.34671158, 0.37515507, 0.35998719, 0.40269215, 0.36606708, 0.34727916, 0.3964172 , 0.4308127 , 0.37397258, 0.37908462, 0.35550212, 0.33847138, 0.37118469, 0.35680909, 0.41848221, 0.40910494, 0.32729232, 0.46065445, 0.34459009, 0.29925887, 0.3227665 , 0.40430184, 0.35947231, 0.42583399, 0.39264917, 0.38338045, 0.43812287, 0.38281252, 0.37412672, 0.41700389, 0.38997648, 0.41027076, 0.39887435, 0.39220661, 0.44667408, 0.35197091, 0.40839143, 0.45209609, 0.4854438 , 0.35984437, 0.39423685, 0.43863703, 0.39093657, 0.35288801, 0.4397813 , 0.3871005 , 0.37778353, 0.40302877, 0.36125463, 0.41313949, 0.36067965, 0.33348316, 0.39962313, 0.36046663, 0.30451561, 0.31436114, 0.35565845, 0.37132819, 0.40666967, 0.39291165, 0.40295233, 0.30137892, 0.37572141, 0.38910604, 0.45560371, 0.36628338, 0.34611358, 0.31946706, 0.36373672, 0.36290657, 0.32529586, 0.39611899, 0.35310936, 0.42265876, 0.39885886, 0.32070258, 0.33339491, 0.34807571, 0.3008017 , 0.43347475, 0.40705414, 0.41674307, 0.40116894, 0.34334819, 0.3652796 , 0.38690629, 0.39948237, 0.35624796, 0.44379513, 0.36134902, 0.39043792, 0.40062084, 0.42713632, 0.38826038, 0.4267711 , 0.32855835, 0.3934872 , 0.40711174, 0.36893045, 0.34430599, 0.35327016, 0.38025061, 0.4990183 , 0.32497223, 0.42042386, 0.31622936, 0.3845819 , 0.44199202, 0.40472012, 0.35178447, 0.34843387, 0.38243416, 0.37708262, 0.32599582, 0.41200995, 0.37592255, 0.37834844, 0.32644963, 0.36207232, 0.42825537, 0.31530526, 0.35193491, 0.25959322, 0.39757105, 0.37261522, 0.38220709, 0.45142696, 0.33491789, 0.40776485, 0.39904373, 0.40776978, 0.35872097, 0.38864564, 0.36338925, 0.36164464, 0.34967735, 0.36396066, 0.43237291, 0.34351456, 0.35134618, 0.36176665, 0.3578046 , 0.45026987, 0.29329639, 0.41276502, 0.37373708, 0.37778935, 0.33909472, 0.3825095 , 0.34375536, 0.32434162, 0.43193363, 0.38970205, 0.40210207, 0.38724759, 0.34272059, 0.37373754, 0.35249926, 0.41151054, 0.35227197, 0.44718949, 0.42365257, 0.3739113 , 0.34358956, 0.33013519, 0.35346691, 0.38489312, 0.35225214, 0.41610397, 0.38223922, 0.39665339, 0.41339714, 0.36907582, 0.42374678, 0.38524038, 0.36085989, 0.31655061, 0.37696926, 0.36065944, 0.36892628, 0.32763272, 0.34931115, 0.4260696 , 0.36570993, 0.35202871, 0.33243539, 0.41358266, 0.36117919, 0.40821946, 0.35451097, 0.39068749, 0.34932853, 0.40351363, 0.37338521, 0.33198775, 0.34546106, 0.38870774, 0.37487984, 0.41485181, 0.37819235, 0.3444466 , 0.31210797, 0.36536734, 0.3585581 , 0.37276796, 0.39038369, 0.35372052, 0.35770557, 0.34884474, 0.41060923, 0.35855565, 0.3754773 , 0.37705445, 0.36425304, 0.36813507, 0.35759128, 0.39519617, 0.31883331, 0.33481559, 0.30294863, 0.3417548 , 0.36674413, 0.42152389, 0.36753216, 0.32171057, 0.34289769, 0.3560997 , 0.38603148, 0.37512908, 0.36306193, 0.41412217, 0.39053237, 0.40267606, 0.36691473, 0.38739647, 0.4171407 , 0.44489486, 0.31748   , 0.41482869, 0.35578538, 0.34258253, 0.37325434, 0.39639158, 0.38074552, 0.38273402, 0.35443547, 0.43075305, 0.4041138 , 0.40898089, 0.38242225, 0.3691925 , 0.34541086, 0.385363  , 0.37520769, 0.39151627, 0.38908748, 0.37646241, 0.34469022, 0.40290612, 0.36785716, 0.34992955, 0.36480184, 0.42123525, 0.36785073, 0.33123989, 0.40012545, 0.40659565, 0.36670067, 0.36191338, 0.29588814, 0.37312647, 0.34450584, 0.41318293, 0.36830677, 0.33650682, 0.39740905, 0.34176039, 0.36255794, 0.39656271, 0.34226146, 0.33676304, 0.39863481, 0.37353873, 0.35562713, 0.34678962, 0.35397938, 0.37667251, 0.34768794, 0.44232947, 0.37778086, 0.36194223, 0.31841387, 0.41601059, 0.45841643, 0.41726768, 0.38971096, 0.3615244 , 0.34464587, 0.32016425, 0.35866142, 0.34102194, 0.43715451, 0.42918335, 0.40681994, 0.31614225, 0.38457513, 0.32693288, 0.39855689, 0.39965807, 0.33575816, 0.40958387, 0.31303368, 0.30116879, 0.40875235, 0.42010187, 0.3670462 , 0.37005269, 0.34600724, 0.38423086, 0.45565091, 0.4075572 , 0.38656348, 0.34823337, 0.40672543, 0.34702377, 0.33763111, 0.36848661, 0.34351093, 0.40765753, 0.35455126, 0.36658001, 0.43232251, 0.38002381, 0.39626922, 0.37470471, 0.33188491, 0.45238551, 0.35766247, 0.40136229, 0.40085299, 0.34099208, 0.35867416, 0.44196904, 0.39799583, 0.39557137, 0.33924171, 0.40664603, 0.38649806, 0.33890776, 0.33571103, 0.36178626, 0.32561263, 0.38989618, 0.41930585, 0.35879548, 0.38260298, 0.37959771, 0.38320536, 0.40644429, 0.46036703, 0.35928164, 0.40456807, 0.3703464 , 0.36396502, 0.36222125, 0.32160536, 0.32060248, 0.41835681, 0.36036523, 0.37223746, 0.37364487, 0.38060943, 0.4087947 , 0.38203536, 0.44316304, 0.40369167, 0.31823117, 0.37607956, 0.30894414, 0.36593423, 0.39484666, 0.38495636, 0.37091047, 0.344995  , 0.34522012, 0.45476102, 0.32879695, 0.46335482, 0.41390145, 0.38299544, 0.3478091 , 0.30508563, 0.25788365, 0.34417653, 0.37548332, 0.31559959, 0.35250302, 0.37518343, 0.34191062, 0.41173967, 0.33789068, 0.36083339, 0.37212116, 0.34153455, 0.39955205, 0.38214725, 0.37826086, 0.40799408, 0.40414415, 0.35654331, 0.38867323, 0.39627225, 0.37085042, 0.41217105, 0.35672309, 0.39028068, 0.39691158, 0.41215798, 0.41185912, 0.31927866, 0.33923031, 0.34686718, 0.39160909, 0.39914311, 0.37219483, 0.38711755, 0.41833532, 0.4075456 , 0.37910866, 0.39925244, 0.31736814, 0.35622151, 0.30780188, 0.38266598, 0.39246002, 0.42789418, 0.37768803, 0.49802608, 0.37222247, 0.36255244, 0.37235673, 0.441084  , 0.34552991, 0.41865159, 0.35272684, 0.36665575, 0.34459399, 0.45355361, 0.36238447, 0.3940214 , 0.41563089, 0.30784041, 0.40532945, 0.35047921, 0.40777292, 0.33807763, 0.41170668, 0.41847632, 0.3229755 , 0.34919152, 0.37602639, 0.35764439, 0.37919626, 0.42789052, 0.32479458, 0.40656109, 0.35942197, 0.42795907, 0.42178479, 0.37430742, 0.3594821 , 0.41440698, 0.35120302, 0.37670767, 0.34015444, 0.35686015, 0.42889141, 0.36608222, 0.40993091, 0.34429054, 0.3950648 , 0.34619943, 0.3602255 , 0.35568094, 0.31484337, 0.40194631, 0.43142201, 0.35767893, 0.3838824 , 0.4071251 , 0.37998851, 0.46975559, 0.3423469 , 0.36946962, 0.38608829, 0.38124941, 0.4012503 , 0.39802026, 0.46122726, 0.33159043, 0.39760405, 0.36865209, 0.42865276, 0.39717176, 0.33976851, 0.35605032, 0.33303654, 0.41360348, 0.32096278, 0.38594815, 0.34268407, 0.35379911, 0.4281709 , 0.38618201, 0.36661045, 0.38085064, 0.31483165, 0.40219091, 0.38286771, 0.37351899, 0.36708458, 0.38886385, 0.31246683, 0.43668857, 0.39498873, 0.31789358, 0.35644839, 0.39724234, 0.39324696, 0.40169982, 0.39143351, 0.32184708, 0.35742505, 0.3553842 , 0.38381159, 0.4252446 , 0.36776472, 0.39457504, 0.39134822, 0.41879626, 0.39985936, 0.3598499 , 0.33797701, 0.39034027, 0.41110237, 0.38722897, 0.39546593, 0.35475288, 0.46662869, 0.38648158, 0.41740426, 0.35272521, 0.41189599, 0.39212775, 0.37394017, 0.34465552, 0.37506786, 0.45274256, 0.39040896, 0.38499868, 0.41025248, 0.45289013, 0.33040533, 0.4206823 , 0.41810672, 0.34234731, 0.36635969, 0.39868398, 0.40740216, 0.3487334 , 0.3684021 , 0.39842957, 0.33778305, 0.40680549, 0.44988675, 0.38084697, 0.32520345, 0.37972098, 0.34855965, 0.3335882 , 0.35493294, 0.30038498, 0.37995591, 0.38329241, 0.3713927 , 0.37405192, 0.36780832, 0.31504347, 0.33406286, 0.33658461, 0.43945234, 0.34716015, 0.36633356, 0.36133551, 0.35967686, 0.41488804, 0.43615878, 0.36982913, 0.35167351, 0.40145525, 0.37297699, 0.45283849, 0.33275454, 0.37397552, 0.41599255, 0.36625249, 0.34064723, 0.35701413, 0.36229925, 0.35441231, 0.37409266, 0.36191122, 0.37258104, 0.36389199, 0.40936828, 0.35942624, 0.42557527, 0.44162361, 0.35905005, 0.35521254, 0.43260028, 0.34506343, 0.37593818, 0.36634496, 0.3791138 , 0.37239845, 0.39537278, 0.37742375, 0.42449894, 0.34116406, 0.42180961, 0.3930474 , 0.33319946, 0.37302795, 0.33566649, 0.33855726, 0.35796936, 0.38957767, 0.422651  , 0.39985559, 0.37471674, 0.46037463, 0.37215373, 0.3568127 , 0.35044192, 0.30720257, 0.34597545, 0.37958671, 0.40859707, 0.40356913, 0.4519151 , 0.35556564, 0.39574165, 0.37859138, 0.3677757 , 0.34430123, 0.27408725, 0.42790453, 0.35137221, 0.36628569, 0.34516025, 0.42150124, 0.34079594, 0.41236038, 0.36351485, 0.37356844, 0.40794707, 0.40046451, 0.42245609, 0.30739235, 0.40548092, 0.40480409, 0.37983063, 0.38360541, 0.40449139, 0.40043292, 0.33300848, 0.40949876, 0.38578454, 0.34847574, 0.31840413, 0.31554551, 0.37761179, 0.40156503, 0.3814114 , 0.43932064, 0.37264881, 0.38376388, 0.39972841, 0.37333311, 0.42005324, 0.32283845, 0.40612175, 0.3738961 , 0.35382731, 0.31703621, 0.419838  , 0.36337648, 0.35585304, 0.43294994, 0.33380524, 0.40448412, 0.38686772, 0.32781478, 0.3883739 , 0.42930206, 0.33721595, 0.36460544, 0.35110877, 0.35457233, 0.38980433, 0.32714994, 0.40629809, 0.3001643 , 0.4005793 , 0.42266842, 0.37730864, 0.36729098, 0.33792152, 0.32971545, 0.43005192, 0.36994985, 0.40517234, 0.36060753, 0.34352767, 0.39749167, 0.44900376, 0.39123799, 0.3707553 , 0.34466515, 0.41541919, 0.37094542, 0.36066029, 0.4030567 , 0.33306289, 0.4251346 , 0.35943752, 0.33270913, 0.44412164, 0.417759  , 0.3887691 , 0.42244357, 0.40871404, 0.38964918, 0.35687496, 0.37631172, 0.36547202, 0.4326922 , 0.38354621, 0.34163407, 0.36605822, 0.32700064, 0.36247681, 0.32461241, 0.357158  , 0.38543326, 0.46429449, 0.38894153, 0.36282777, 0.41773433, 0.31510457, 0.38434146, 0.37526389, 0.33252803, 0.3815958 , 0.3566598 , 0.41237545, 0.37128323, 0.37616103, 0.30245403, 0.42499999, 0.39983854, 0.3680776 , 0.35406263, 0.40911188, 0.32070078, 0.38785558, 0.36099076, 0.32987217, 0.36092565, 0.30339202, 0.36388319, 0.39233829, 0.353423  , 0.35282661, 0.38403738, 0.36623352, 0.40644562, 0.3726407 , 0.39589529, 0.35380977, 0.37687277, 0.43741286, 0.424962  , 0.44086745, 0.40033519, 0.3743433 , 0.37034677, 0.2780654 , 0.41968544, 0.40875204, 0.36862512, 0.39604901, 0.38384861, 0.37429416, 0.42576152])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr_orth_nosplit = DoubleMLPLR(obj_dml_data,
                                                   ml_g, ml_m,
                                                   n_folds=1,
                                                   score='IV-type',
                                                   apply_cross_fitting=False)
            obj_dml_plr_orth_nosplit.fit()
            this_theta = obj_dml_plr_orth_nosplit.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_orth_nosplit[i_rep] - this_theta))
            theta_orth_nosplit[i_rep] = this_theta

        ax = sns.kdeplot(theta_orth_nosplit, shade=True, color=colors[2])
        @savefig orth_nosplit.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        library(data.table)
        lgr::get_logger("mlr3")$set_threshold("warn")
        set.seed(2222)

        # to speed up the illustration we hard-code the simulation results
        theta_orth_nosplit = c(0.39049321, 0.38623322, 0.32039999, 0.35366961, 0.31736777, 0.33277060, 0.43781769, 0.34531791, 0.33283542, 0.42722848, 0.40507855, 0.33148730, 0.35394538, 0.31330780, 0.35502543, 0.31074485, 0.34968750, 0.40803653, 0.39187114, 0.37547230, 0.32921808, 0.34830244, 0.37227546, 0.34347407, 0.38704686, 0.35095282, 0.38702848, 0.44676621, 0.40231157, 0.35722360, 0.38757110, 0.36663528, 0.45927558, 0.40780656, 0.35138709, 0.35119543, 0.40143418, 0.40858348, 0.34764508, 0.38908864, 0.37347419, 0.43576972, 0.27314928, 0.43321026, 0.44573586, 0.43063553, 0.42601212, 0.35902515, 0.38708416, 0.35491437, 0.37668742, 0.42241278, 0.43406890, 0.33166148, 0.38246320, 0.48264989, 0.37431527, 0.32168353, 0.36081761, 0.34969437, 0.37374976, 0.32161613, 0.39480342, 0.36530728, 0.41290537, 0.34844447, 0.34532761, 0.35764003, 0.42205157, 0.33998713, 0.41100083, 0.41516516, 0.34469729, 0.34586140, 0.37695302, 0.38685907, 0.38947661, 0.38637460, 0.36360061, 0.37004994, 0.35369789, 0.38198984, 0.39024056, 0.35629661, 0.38734531, 0.38157211, 0.37207524, 0.38908484, 0.35574587, 0.44481773, 0.42375632, 0.36618387, 0.34411684, 0.38156491, 0.31665591, 0.42389144, 0.36617182, 0.37959079, 0.42847245, 0.36305699, 0.35155391, 0.32876317, 0.34892126, 0.36493144, 0.36792632, 0.31759919, 0.38716813, 0.38514959, 0.37417318, 0.39442611, 0.37368982, 0.38548267, 0.35089008, 0.39418820, 0.32498503, 0.37934508, 0.38255187, 0.38351468, 0.38783505, 0.35710339, 0.41360396, 0.42524172, 0.40838513, 0.34811064, 0.37045911, 0.38477071, 0.32797188, 0.39907332, 0.38036559, 0.36982395, 0.39292964, 0.34644329, 0.30418789, 0.42685645, 0.36047085, 0.37912392, 0.42025438, 0.34740863, 0.35587695, 0.36719599, 0.36589131, 0.34272689, 0.41743034, 0.33766206, 0.38670145, 0.34530436, 0.34978684, 0.42026599, 0.40382610, 0.40825545, 0.44099494, 0.38804948, 0.45389669, 0.34705564, 0.47294370, 0.37862341, 0.31855724, 0.33688705, 0.41276919, 0.34553736, 0.45423311, 0.37964429, 0.38751826, 0.36150448, 0.42768606, 0.38790227, 0.42537798, 0.39370888, 0.39135713, 0.45338337, 0.39138018, 0.38624857, 0.35654923, 0.34246302, 0.39578757, 0.38244909, 0.33327480, 0.38431839, 0.34739509, 0.35298783, 0.35385368, 0.34746322, 0.40414291, 0.40493647, 0.33571477, 0.31135444, 0.37234268, 0.39679210, 0.32775288, 0.36733360, 0.38105588, 0.41414294, 0.37319050, 0.45386794, 0.37119935, 0.41778163, 0.37068323, 0.38692416, 0.32360910, 0.33824963, 0.37431996, 0.38469141, 0.30263371, 0.44107479, 0.41883865, 0.31564318, 0.34173561, 0.43564242, 0.40036688, 0.38976090, 0.34861851, 0.39234854, 0.39049207, 0.33688679, 0.39394909, 0.40148437, 0.42220312, 0.38146976, 0.31022507, 0.34239552, 0.38804406, 0.40617535, 0.35289024, 0.31617303, 0.38155783, 0.42749702, 0.36465385, 0.35726313, 0.35499749, 0.39678911, 0.37634900, 0.37470684, 0.36724464, 0.29626162, 0.37195005, 0.38466128, 0.40131629, 0.32010977, 0.35896510, 0.33290952, 0.33445889, 0.41083150, 0.39835619, 0.38460634, 0.36266596, 0.35002288, 0.33762366, 0.43995288, 0.37930989, 0.39129927, 0.32156116, 0.41928763, 0.38137263, 0.39111599, 0.34263364, 0.37663252, 0.30874349, 0.32936234, 0.35975523, 0.29155957, 0.40502383, 0.37452386, 0.35875942, 0.35152081, 0.40148681, 0.36007586, 0.36391794, 0.31399413, 0.41198829, 0.35998570, 0.37380211, 0.40121628, 0.41631442, 0.38537924, 0.38531920, 0.39934841, 0.34998189, 0.35877463, 0.41467150, 0.38189391, 0.35350061, 0.35321985, 0.40422698, 0.36522258, 0.39346168, 0.39555643, 0.37247852, 0.33854620, 0.45097727, 0.39711792, 0.40975534, 0.38707289, 0.38953390, 0.42750094, 0.35140684, 0.37222427, 0.33802539, 0.38071437, 0.35058867, 0.37607757, 0.34673095, 0.36697579, 0.36482319, 0.37482430, 0.41076420, 0.38059279, 0.43989005, 0.35068132, 0.36046811, 0.37699394, 0.44740559, 0.38410523, 0.33640580, 0.35426940, 0.37497980, 0.37802039, 0.41227596, 0.34331348, 0.36850168, 0.38076361, 0.42292516, 0.28776147, 0.34948857, 0.38432855, 0.38539992, 0.40783806, 0.33701899, 0.41785799, 0.36882731, 0.41234460, 0.39478028, 0.39558266, 0.37642618, 0.39587948, 0.36001151, 0.35384212, 0.38981850, 0.39543032, 0.40271817, 0.39845660, 0.27313414, 0.37912280, 0.36894265, 0.38764453, 0.42301678, 0.38477651, 0.34724049, 0.35871211, 0.34721739, 0.41770212, 0.38811339, 0.31750760, 0.42862995, 0.43292570, 0.33736744, 0.33701444, 0.36239214, 0.37757843, 0.37947704, 0.37915179, 0.38296507, 0.38675467, 0.42459012, 0.37665917, 0.34508817, 0.39481167, 0.36904614, 0.39536985, 0.38168527, 0.31205592, 0.33532134, 0.33188604, 0.42238628, 0.37552872, 0.39884642, 0.40002111, 0.37064889, 0.37353344, 0.40052303, 0.36382528, 0.39918582, 0.42899545, 0.38814057, 0.37357666, 0.38857725, 0.40312452, 0.33098416, 0.37161389, 0.36169096, 0.31223609, 0.42233792, 0.41143570, 0.40195566, 0.32860795, 0.33705429, 0.36618287, 0.38330103, 0.40222025, 0.38014870, 0.37127554, 0.40664068, 0.45846327, 0.41796096, 0.40267337, 0.33490381, 0.39172123, 0.39149881, 0.38334707, 0.40158049, 0.33275482, 0.37285153, 0.38257421, 0.38995875, 0.42749008, 0.37175633, 0.28156365, 0.37312772, 0.32595360, 0.32795049, 0.40215033, 0.38707170, 0.37432329, 0.37354574, 0.40070092, 0.42047878, 0.38556941, 0.38254452, 0.36364867, 0.35026076, 0.34686864, 0.40314823, 0.37537432, 0.41019516, 0.33362454, 0.32966030, 0.38369051, 0.34315170, 0.40644113, 0.38857200, 0.43107204, 0.42998399, 0.36909986, 0.42169929, 0.33946987, 0.39125429, 0.43033718, 0.33821569, 0.38464566, 0.39953481, 0.43296544, 0.42913508, 0.43827183, 0.38984285, 0.32903827, 0.38690801, 0.39385016, 0.37191800, 0.33995035, 0.38900599, 0.42775130, 0.37982975, 0.36371489, 0.34515812, 0.29430837, 0.34725014, 0.38469682, 0.37662320, 0.35379308, 0.38229426, 0.35770848, 0.35119266, 0.34281327, 0.36698297, 0.37997368, 0.42971682, 0.39330591, 0.31642156, 0.38694958, 0.33477434, 0.32308630, 0.44186699, 0.34772030, 0.37598331, 0.38798447, 0.38757607, 0.37923948, 0.34904313, 0.40157379, 0.41897737, 0.33960373, 0.36959868, 0.39568743, 0.42631811, 0.36956263, 0.39759134, 0.36983688, 0.37082963, 0.41454849, 0.41720935, 0.35160923, 0.31830039, 0.28636821, 0.33746717, 0.37930366, 0.40176895, 0.39764966, 0.43106410, 0.35208149, 0.47307955, 0.39256578, 0.41434685, 0.40600527, 0.41896853, 0.38610347, 0.30105950, 0.43178711, 0.42073616, 0.36360048, 0.41300677, 0.39271881, 0.35738764, 0.33139601, 0.35917627, 0.38043080, 0.36582944, 0.41596955, 0.32036057, 0.36525026, 0.32796366, 0.39142993, 0.36526417, 0.35137902, 0.37680791, 0.38572126, 0.37308977, 0.42228946, 0.33558927, 0.31891409, 0.36548876, 0.38715169, 0.36703391, 0.37476888, 0.33369762, 0.35536534, 0.33086917, 0.43562175, 0.33057738, 0.39276025, 0.28141347, 0.40582468, 0.36383699, 0.32838905, 0.37466181, 0.43388335, 0.34520098, 0.35912438, 0.34539768, 0.39261511, 0.41143139, 0.38610009, 0.43228399, 0.37498365, 0.34194814, 0.38942662, 0.40427155, 0.42058329, 0.35936179, 0.32974031, 0.36816755, 0.33193179, 0.40539959, 0.35566560, 0.31007850, 0.38091446, 0.38445540, 0.39694140, 0.40505025, 0.43123028, 0.43790728, 0.37955198, 0.42687388, 0.33636456, 0.30923701, 0.38727879, 0.34633314, 0.36915789, 0.34923956, 0.35078096, 0.41870087, 0.35979959, 0.36157385, 0.36931715, 0.37007185, 0.41169273, 0.37537760, 0.38444021, 0.40016928, 0.41307944, 0.40820169, 0.34132658, 0.35187495, 0.29957315, 0.40098646, 0.39850926, 0.35258290, 0.39307980, 0.41902389, 0.39034348, 0.35777477, 0.31316893, 0.38222600, 0.36756746, 0.36312506, 0.42006334, 0.45632363, 0.40248631, 0.33951418, 0.34635155, 0.38778134, 0.40133199, 0.37260563, 0.32567782, 0.30924518, 0.39043846, 0.34491735, 0.37701158, 0.37023754, 0.39958350, 0.40338892, 0.34375094, 0.41716017, 0.39553697, 0.38771269, 0.39967060, 0.38840850, 0.36402858, 0.36911248, 0.40052280, 0.37845439, 0.41482476, 0.33872475, 0.32267007, 0.35599048, 0.29664949, 0.37189301, 0.37528183, 0.40841438, 0.43697700, 0.32851468, 0.49948760, 0.38906437, 0.39556396, 0.35679557, 0.38592858, 0.35651584, 0.38613866, 0.38771473, 0.33795989, 0.40356307, 0.39044545, 0.35251968, 0.35048952, 0.34705581, 0.35430905, 0.40861974, 0.38379638, 0.35371569, 0.32028550, 0.34073942, 0.34246909, 0.39014975, 0.40712878, 0.35094540, 0.36561404, 0.37301917, 0.36954535, 0.38541706, 0.44132248, 0.36051211, 0.38930364, 0.36602703, 0.38789440, 0.37321055, 0.33602730, 0.39829899, 0.41467980, 0.41808960, 0.34570933, 0.35476443, 0.40419503, 0.35159869, 0.40980852, 0.30384932, 0.34547129, 0.35882370, 0.37697048, 0.30285211, 0.37519791, 0.35409260, 0.39088348, 0.38269365, 0.38811505, 0.31491056, 0.27545082, 0.37653419, 0.39443877, 0.34979512, 0.41299558, 0.34509510, 0.37478061, 0.34914035, 0.38143941, 0.43454938, 0.37735497, 0.36853649, 0.43799378, 0.41086518, 0.31796562, 0.34909281, 0.35312500, 0.35961474, 0.38267981, 0.42463239, 0.35557373, 0.39225430, 0.35096924, 0.40207886, 0.37826856, 0.33351414, 0.35428997, 0.36470536, 0.36591732, 0.37880361, 0.43032446, 0.36870803, 0.37193902, 0.38206158, 0.36082883, 0.36603027, 0.40108015, 0.35796562, 0.37223186, 0.37555592, 0.34918905, 0.37928217, 0.36280338, 0.40838449, 0.38278183, 0.45815442, 0.30734983, 0.34016458, 0.38453083, 0.39883628, 0.38670426, 0.34657232, 0.41089378, 0.34467102, 0.35802987, 0.39237721, 0.35985812, 0.43840643, 0.35183006, 0.36705566, 0.36180920, 0.40139499, 0.35340685, 0.39069474, 0.40671741, 0.38029988, 0.38503578, 0.38870444, 0.37181842, 0.30302286, 0.40441286, 0.37720655, 0.42643489, 0.40838772, 0.33436060, 0.43267964, 0.36080556, 0.34661043, 0.37884496, 0.35743337, 0.38631566, 0.38275644, 0.31901801, 0.40273082, 0.37680675, 0.40503828, 0.34702401, 0.36577024, 0.41118310, 0.40746128, 0.42744368, 0.36006236, 0.34037916, 0.45408709, 0.33627613, 0.41443604, 0.35085963, 0.38540938, 0.34845399, 0.33004802, 0.37764755, 0.34026971, 0.37501160, 0.38540639, 0.42262431, 0.31969346, 0.41093245, 0.38592503, 0.31423033, 0.33408191, 0.34642653, 0.36023519, 0.39949760, 0.40076267, 0.39600668, 0.42189771, 0.41615746, 0.40765201, 0.38315156, 0.41112277, 0.38673571, 0.27860583, 0.35181222, 0.41240773, 0.35233530, 0.34925827, 0.39687910, 0.37850778, 0.40325664, 0.37093167, 0.41090133, 0.39867629, 0.45226702, 0.36965486, 0.36984475, 0.42561742, 0.38226515, 0.32027813, 0.34804785, 0.35391736, 0.30301071, 0.36023501, 0.44010227, 0.41551136, 0.34761721, 0.37638072, 0.41475094, 0.34413413, 0.40956694, 0.37026594, 0.36743059, 0.36710269, 0.35498793, 0.40293639, 0.35075277, 0.39296474, 0.37002612, 0.38289412, 0.37288841, 0.37662928, 0.38639646, 0.38084114, 0.33262801, 0.40324329, 0.39548604, 0.29963864, 0.33540291, 0.37898764, 0.41192466, 0.33619434, 0.39011219, 0.38966803, 0.32438129, 0.37606118, 0.34666850, 0.34178282, 0.32923941, 0.37171107, 0.33136672, 0.38171394, 0.36805410, 0.40638170, 0.39946428, 0.37920325, 0.37752372, 0.37740911, 0.45528417, 0.39508487, 0.44625092, 0.39211050, 0.38963354, 0.32095404, 0.33827295, 0.41193861, 0.38295449, 0.36012456, 0.43471780, 0.41426493, 0.42116707, 0.35046428, 0.39239468, 0.37883463, 0.33591603, 0.45880292, 0.38463052, 0.28281594, 0.42418029, 0.41057366, 0.34876232, 0.43838530, 0.33406321, 0.39679409, 0.41684471, 0.39526670, 0.35772346, 0.39330715, 0.38215367, 0.35761130, 0.35942927, 0.33737534, 0.34782715, 0.34427716, 0.39088607, 0.32862263, 0.38036965, 0.46431538, 0.36781862, 0.37046263, 0.43556806, 0.39395677, 0.39785567, 0.30531366, 0.35900116, 0.41336494, 0.39578712, 0.40391840, 0.35005779, 0.35867356, 0.38971486, 0.35618854, 0.27722263, 0.36605436, 0.36926065, 0.41414760, 0.39145495, 0.39483095, 0.39864155, 0.34120646, 0.33324393, 0.40088027, 0.40899790, 0.37936413, 0.40172518, 0.38112545, 0.40381700, 0.36169050, 0.42454280, 0.40890698, 0.32622500, 0.32951677, 0.33770347, 0.35378556, 0.35432291, 0.36451275, 0.40109421, 0.40114241, 0.37222841, 0.36313350, 0.37971901, 0.37431455, 0.39102354, 0.38273885, 0.39992868, 0.37100929, 0.42897760, 0.39977531, 0.37887685, 0.40347785, 0.37756153, 0.39151490, 0.33720432, 0.28692127, 0.39102979, 0.34006289, 0.36206740, 0.38467964, 0.35091427, 0.42481238, 0.36482863, 0.40828241, 0.34610274, 0.35600550, 0.44524777, 0.40440560, 0.39808257, 0.31116652, 0.41218200)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr_orth_nosplit = DoubleMLPLR$new(obj_dml_data,
                                                   ml_g, ml_m,
                                                   n_folds=1,
                                                   score='IV-type',
                                                   apply_cross_fitting=FALSE)
            obj_dml_plr_orth_nosplit$fit()
            this_theta = obj_dml_plr_orth_nosplit$coef
            print(abs(theta_orth_nosplit[i_rep] - this_theta))
            theta_orth_nosplit[i_rep] = this_theta
        }

        g_nosplit = ggplot(data.frame(theta_orth_nosplit), aes(x = theta_orth_nosplit)) +
                    geom_density(fill = "dark green", alpha = 0.3, color = "dark green") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_nosplit


If the nuisance models :math:`\hat{g}_0()` and :math:`\hat{m}()` are estimate on the whole dataset which is also used for obtaining
the final estimate :math:`\check{\theta}` another bias can be observed.

.. _bias_overfitting:

Sample splitting to remove bias induced by overfitting
++++++++++++++++++++++++++++++++++++++++++++++++++++++

Using sample splitting, i.e., estimate the nuisance models :math:`\hat{g}_0()` and :math:`\hat{m}()` on one part of the
data (training data) and estimate :math:`\check{\theta}` on the other part of the data (test data) overcomes the bias
induced by overfitting. Cross-fitting performs well empirically.

.. tabbed:: Python

    .. ipython:: python

        import numpy as np
        np.random.seed(3333)

        # to speed up the illustration we hard-code the simulation results
        theta_dml = np.array([0.54288123, 0.55371181, 0.46339388, 0.49385475, 0.49213487, 0.5050111 , 0.58988897, 0.48236908, 0.59217066, 0.68522203, 0.54380239, 0.52029499, 0.57284115, 0.4452564 , 0.50441597, 0.47650409, 0.54015765, 0.4494413 , 0.51149339, 0.50135583, 0.45471109, 0.43816486, 0.49635474, 0.53906716, 0.44338049, 0.47216099, 0.53343896, 0.53398806, 0.45514509, 0.53182394, 0.5303002 , 0.59774184, 0.42232608, 0.41028   , 0.48106874, 0.45175907, 0.51987224, 0.5646365 , 0.52328251, 0.60129572, 0.45353462, 0.50068965, 0.51352137, 0.40257158, 0.56185356, 0.51313695, 0.47868459, 0.48287266, 0.53839614, 0.56937954, 0.48854769, 0.52246533, 0.53382   , 0.49055279, 0.57694377, 0.45368641, 0.54769772, 0.57136253, 0.48699937, 0.44713082, 0.53278924, 0.61622837, 0.58404215, 0.47695354, 0.57401785, 0.45826163, 0.45183085, 0.50876734, 0.55230931, 0.5525642 , 0.51221464, 0.47471202, 0.43182669, 0.48680894, 0.52992376, 0.51947981, 0.53100123, 0.50903748, 0.47147659, 0.55365849, 0.46354071, 0.49771178, 0.49184555, 0.49907314, 0.45997543, 0.48476604, 0.57464762, 0.51354284, 0.54057693, 0.51580169, 0.44953565, 0.49137078, 0.59612721, 0.52669037, 0.58384796, 0.5223915 , 0.5890493 , 0.54512917, 0.59141874, 0.56064394, 0.47962013, 0.59676291, 0.47192364, 0.49610932, 0.55024611, 0.56388654, 0.53474486, 0.50483367, 0.42511813, 0.51894994, 0.46555202, 0.47976104, 0.49473788, 0.48674666, 0.51802349, 0.49883541, 0.48041863, 0.48991678, 0.50315856, 0.45638511, 0.50304149, 0.57999991, 0.50017858, 0.48184566, 0.41348744, 0.59922079, 0.46788614, 0.53816671, 0.47716643, 0.41114365, 0.54517718, 0.46920287, 0.5513536 , 0.4812061 , 0.49303468, 0.56928813, 0.56281834, 0.56134251, 0.47101611, 0.51214381, 0.4449861 , 0.46967615, 0.66494507, 0.52411009, 0.5627987 , 0.46889612, 0.43322021, 0.54225098, 0.47493747, 0.55515923, 0.59001373, 0.55045017, 0.46257442, 0.57645122, 0.5125088 , 0.64325479, 0.49696001, 0.52841445, 0.48363358, 0.57992595, 0.50376609, 0.49412297, 0.53749749, 0.55120499, 0.49548393, 0.44926652, 0.61120697, 0.57560467, 0.5326141 , 0.45642576, 0.55800428, 0.51337626, 0.47870204, 0.47898159, 0.49427373, 0.54115408, 0.50890063, 0.57227194, 0.54011276, 0.48522659, 0.48264631, 0.59157632, 0.52172118, 0.46068703, 0.44879916, 0.49233865, 0.44551616, 0.48969064, 0.58951441, 0.53296876, 0.46373658, 0.49411278, 0.49759449, 0.38396783, 0.52089373, 0.52621081, 0.4838764 , 0.60379733, 0.47195369, 0.47158175, 0.51786732, 0.54475883, 0.50852276, 0.53318138, 0.47926804, 0.45619227, 0.50260623, 0.54202818, 0.4985257 , 0.58083738, 0.49965165, 0.61791868, 0.41490793, 0.40957736, 0.45771652, 0.5276147 , 0.44166667, 0.56142333, 0.5396268 , 0.54399625, 0.5603477 , 0.50688066, 0.47792653, 0.54546745, 0.49763558, 0.60469747, 0.50601012, 0.50086284, 0.61122109, 0.43873687, 0.56353642, 0.63164213, 0.6655241 , 0.52014402, 0.49188033, 0.59537227, 0.51097082, 0.45484618, 0.59893759, 0.51668152, 0.48513793, 0.53441438, 0.46361776, 0.52071106, 0.49173985, 0.46711264, 0.56188561, 0.47680123, 0.46876735, 0.41519849, 0.48184913, 0.49327555, 0.50168819, 0.50622028, 0.49621954, 0.40299829, 0.48457349, 0.54311977, 0.61214234, 0.49524956, 0.51907762, 0.45570902, 0.5141557 , 0.4907405 , 0.46856077, 0.54663006, 0.50657429, 0.50710349, 0.52861611, 0.45056299, 0.46437207, 0.48729905, 0.41781897, 0.60918909, 0.57086807, 0.55678849, 0.57762845, 0.42506485, 0.52038609, 0.55889078, 0.52330059, 0.51058693, 0.55722153, 0.47343708, 0.49456868, 0.52850052, 0.60359548, 0.48583537, 0.60985179, 0.42306727, 0.55830886, 0.56450183, 0.5023707 , 0.53918371, 0.48830692, 0.52639965, 0.65310452, 0.41605668, 0.60650297, 0.40384292, 0.5540774 , 0.60327977, 0.50982093, 0.46057863, 0.42980553, 0.48275956, 0.54745587, 0.42612266, 0.51881336, 0.55630213, 0.52818715, 0.448852  , 0.49142825, 0.5408009 , 0.43427999, 0.48774935, 0.37876327, 0.54186573, 0.5349062 , 0.54993939, 0.67252298, 0.45452935, 0.58202535, 0.54358087, 0.51920907, 0.52043039, 0.48373032, 0.50878891, 0.4403581 , 0.51515119, 0.4804859 , 0.55334542, 0.43517394, 0.44945722, 0.52748988, 0.48059059, 0.63433224, 0.38657828, 0.54196978, 0.50538468, 0.47964171, 0.46324595, 0.51417836, 0.44501977, 0.48243664, 0.541168  , 0.51142664, 0.54107284, 0.55089771, 0.4889118 , 0.47989282, 0.47446686, 0.58407023, 0.50681244, 0.62763976, 0.59114501, 0.54602667, 0.49708495, 0.47690188, 0.47033221, 0.55975611, 0.46505781, 0.55328171, 0.54508166, 0.6053623 , 0.53304524, 0.51387898, 0.55728172, 0.5309572 , 0.50511962, 0.45684557, 0.49275603, 0.47789289, 0.48390916, 0.46768712, 0.4680081 , 0.55672889, 0.45635084, 0.4895981 , 0.40400326, 0.55612157, 0.50309062, 0.53872531, 0.52818503, 0.56509319, 0.45802902, 0.55746355, 0.53745026, 0.43922291, 0.47271576, 0.50979356, 0.51405123, 0.50596611, 0.48391823, 0.42509758, 0.41495324, 0.49400391, 0.50834419, 0.50270474, 0.53361532, 0.47550126, 0.4379097 , 0.49619306, 0.59187293, 0.49083569, 0.53105003, 0.46823576, 0.48224406, 0.53703992, 0.51623097, 0.50182542, 0.44415112, 0.42868143, 0.40507765, 0.50786408, 0.47974999, 0.53334098, 0.48899422, 0.41220893, 0.48448626, 0.52558846, 0.50606804, 0.49527948, 0.51170001, 0.55484841, 0.5080514 , 0.54684739, 0.4672308 , 0.52501485, 0.57952153, 0.55416348, 0.44838364, 0.55772562, 0.47629212, 0.47861361, 0.51545903, 0.59180565, 0.52759925, 0.52150478, 0.48280741, 0.54607199, 0.56641874, 0.57572268, 0.50245113, 0.48998946, 0.43407436, 0.55008705, 0.50068967, 0.54284476, 0.55825218, 0.5301717 , 0.43552436, 0.57160797, 0.49540104, 0.50659788, 0.54352645, 0.56329468, 0.48614516, 0.45815761, 0.54469478, 0.53058589, 0.48369298, 0.54072482, 0.43254562, 0.47888438, 0.46790166, 0.56443991, 0.52367178, 0.4860834 , 0.53665246, 0.47242828, 0.48634781, 0.56650099, 0.45879876, 0.45823984, 0.56632343, 0.51110318, 0.48258134, 0.51983996, 0.52339937, 0.48171847, 0.48478394, 0.62268801, 0.4756197 , 0.5022304 , 0.45939683, 0.55872411, 0.59955496, 0.61981263, 0.58407476, 0.45784569, 0.45454045, 0.48236482, 0.50875611, 0.47021639, 0.56335066, 0.58578129, 0.54189485, 0.43979271, 0.53246033, 0.49300375, 0.55107142, 0.55327048, 0.41151374, 0.5782344 , 0.4559725 , 0.39182657, 0.55674415, 0.62358707, 0.5140278 , 0.48536104, 0.48678686, 0.54773984, 0.60755871, 0.57080837, 0.47628834, 0.45078021, 0.5824967 , 0.46131088, 0.4891095 , 0.51689449, 0.46752986, 0.55227843, 0.44353426, 0.5017675 , 0.54559348, 0.52851101, 0.55026317, 0.45830156, 0.45772046, 0.6086443 , 0.49685519, 0.52751136, 0.51693728, 0.4484294 , 0.47660812, 0.58280905, 0.56772909, 0.52309964, 0.52428475, 0.57452075, 0.50973168, 0.47994609, 0.47923962, 0.45873824, 0.42570426, 0.48709328, 0.57413965, 0.5010925 , 0.55390541, 0.5593062 , 0.53844322, 0.55278223, 0.58870101, 0.51296611, 0.53402263, 0.52677827, 0.48695852, 0.5189925 , 0.42698966, 0.43450457, 0.60177386, 0.43788479, 0.55378877, 0.50138574, 0.45779969, 0.65772781, 0.49861358, 0.62596601, 0.57850869, 0.43050011, 0.49863034, 0.50523083, 0.49873493, 0.54422498, 0.54082604, 0.45050052, 0.47435829, 0.51097711, 0.60423771, 0.42562366, 0.63754131, 0.68396765, 0.46219551, 0.48702357, 0.43979438, 0.3685082 , 0.54834188, 0.55257998, 0.4443959 , 0.47900246, 0.45853638, 0.47023051, 0.57502053, 0.42216264, 0.48205311, 0.51736319, 0.52870329, 0.55425165, 0.54517921, 0.53670905, 0.55902853, 0.55993381, 0.43934017, 0.5430404 , 0.52401268, 0.45896712, 0.51809886, 0.45799006, 0.50187884, 0.5282877 , 0.58286187, 0.54218412, 0.4740787 , 0.54697446, 0.46129549, 0.53013919, 0.58395247, 0.51412211, 0.54379608, 0.57321777, 0.52975203, 0.51495748, 0.5467124 , 0.45404561, 0.48794829, 0.48734902, 0.567259  , 0.52374715, 0.639907  , 0.51235897, 0.69537551, 0.50771561, 0.52800241, 0.52819641, 0.60988158, 0.50655609, 0.54311974, 0.43545178, 0.48855101, 0.42757789, 0.64668596, 0.5135953 , 0.58217787, 0.58968197, 0.45775186, 0.58696989, 0.46007659, 0.57055176, 0.47679118, 0.50239227, 0.58181557, 0.40036324, 0.50038656, 0.48532153, 0.50611492, 0.51150958, 0.5366197 , 0.49252948, 0.55489687, 0.49758722, 0.58760888, 0.5632469 , 0.49489314, 0.49340345, 0.53955843, 0.44620908, 0.50076492, 0.45903207, 0.48582541, 0.57206606, 0.52236893, 0.56820001, 0.488824  , 0.59306406, 0.43605472, 0.48696051, 0.45298925, 0.39318081, 0.52131276, 0.5762088 , 0.48928729, 0.51129619, 0.56414142, 0.47669731, 0.63322221, 0.48599872, 0.50768554, 0.51273497, 0.53815394, 0.48362047, 0.56871147, 0.57371601, 0.46781439, 0.51894111, 0.55982441, 0.56836997, 0.55620777, 0.44896588, 0.49390795, 0.46122141, 0.5816414 , 0.50393289, 0.54457592, 0.44544417, 0.45760621, 0.5619857 , 0.5452888 , 0.50945522, 0.49124629, 0.47099338, 0.55211594, 0.50838207, 0.56501643, 0.55517873, 0.49045651, 0.40052446, 0.54423852, 0.6128542 , 0.44779434, 0.48657489, 0.5345633 , 0.51695592, 0.53434974, 0.52631928, 0.47704191, 0.46972198, 0.49172569, 0.54121094, 0.57445396, 0.51172669, 0.52637434, 0.52231926, 0.55580816, 0.51005062, 0.49158488, 0.46784938, 0.55121887, 0.61267839, 0.52871497, 0.53510678, 0.50852953, 0.61108235, 0.51697885, 0.53838749, 0.43386249, 0.48953085, 0.52407627, 0.46122995, 0.43647296, 0.52533791, 0.59640842, 0.48702877, 0.51564086, 0.50747108, 0.60527912, 0.42804851, 0.61809225, 0.57765345, 0.48651207, 0.4719782 , 0.56534957, 0.54008846, 0.48257632, 0.51142981, 0.54265858, 0.47225596, 0.56737839, 0.57305763, 0.46305606, 0.44839578, 0.5630844 , 0.47854302, 0.45146904, 0.50651709, 0.43292156, 0.50190796, 0.55304236, 0.5048284 , 0.50935487, 0.49152674, 0.41626669, 0.3969901 , 0.43283057, 0.60609904, 0.49024351, 0.47260228, 0.52034277, 0.47434266, 0.52362985, 0.63715217, 0.4649629 , 0.45748183, 0.54876253, 0.54048754, 0.66209149, 0.46648912, 0.50648451, 0.62963293, 0.46002751, 0.45168543, 0.48558652, 0.5388721 , 0.48292948, 0.49692646, 0.50144901, 0.5311668 , 0.4433951 , 0.5994168 , 0.53507823, 0.5897199 , 0.55392028, 0.4898946 , 0.52498239, 0.57091353, 0.52483223, 0.57629511, 0.52226816, 0.50367003, 0.50431973, 0.55528828, 0.45148067, 0.61352869, 0.4192982 , 0.61325168, 0.56546158, 0.41165108, 0.51160897, 0.45947673, 0.45603623, 0.50188999, 0.50650618, 0.50802022, 0.50795509, 0.47430019, 0.66732014, 0.49536729, 0.51603985, 0.5356992 , 0.42138356, 0.47243618, 0.56172251, 0.60485133, 0.57270442, 0.61730567, 0.50098006, 0.53091275, 0.4667603 , 0.47463872, 0.46995092, 0.39080554, 0.61192293, 0.50051007, 0.51423798, 0.52463494, 0.61575622, 0.52122775, 0.61039663, 0.45444551, 0.5401122 , 0.51205537, 0.49522669, 0.54929165, 0.41392431, 0.51435354, 0.5102911 , 0.44584664, 0.49165231, 0.48092642, 0.53309011, 0.4464865 , 0.56956229, 0.49715136, 0.50024868, 0.4309782 , 0.4688883 , 0.52904395, 0.59702491, 0.48048275, 0.61836839, 0.52187141, 0.53837696, 0.53425391, 0.52303295, 0.56348063, 0.44350304, 0.61558571, 0.53451139, 0.47780918, 0.42430238, 0.59087015, 0.47117401, 0.46995392, 0.56108674, 0.39646194, 0.53758368, 0.54887843, 0.44117517, 0.55502218, 0.63049554, 0.50074495, 0.47175411, 0.44655077, 0.4659113 , 0.52578297, 0.44756423, 0.55430589, 0.38678048, 0.55950509, 0.5903938 , 0.46580053, 0.50412846, 0.50256973, 0.44921474, 0.54562771, 0.5283449 , 0.53478664, 0.51393261, 0.45211007, 0.53410651, 0.67965399, 0.52733183, 0.59288505, 0.42833549, 0.53187216, 0.48986914, 0.47154567, 0.560534  , 0.47802934, 0.5169961 , 0.51271924, 0.44755838, 0.57637584, 0.59043142, 0.551828  , 0.52766878, 0.53500404, 0.50245993, 0.48553613, 0.49231206, 0.52748163, 0.57156535, 0.55340669, 0.4464268 , 0.53106926, 0.46675916, 0.5288402 , 0.42895956, 0.47848931, 0.55288537, 0.62971468, 0.49971099, 0.48699172, 0.57282032, 0.42364484, 0.4919252 , 0.51970401, 0.48053561, 0.58069438, 0.49787367, 0.5132585 , 0.50927198, 0.48982636, 0.43971438, 0.5531551 , 0.55420679, 0.48878611, 0.50664052, 0.54780657, 0.43992251, 0.55003118, 0.47555086, 0.44184514, 0.51220845, 0.44591446, 0.49200604, 0.51930475, 0.49684299, 0.47302858, 0.53907741, 0.5597189 , 0.50058171, 0.45030896, 0.47991928, 0.49398814, 0.48686849, 0.58547764, 0.5431777 , 0.55883729, 0.51228697, 0.52702564, 0.48845903, 0.45192874, 0.5939419 , 0.51038814, 0.46999408, 0.60098515, 0.51694077, 0.47429053, 0.61261457])

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for i_rep in range(n_rep):
        for i_rep in range(1):
            (x, y, d) = data[i_rep]
            obj_dml_data = DoubleMLData.from_arrays(x, y, d)
            obj_dml_plr = DoubleMLPLR(obj_dml_data,
                                      ml_g, ml_m,
                                      n_folds=2,
                                      score='IV-type')
            obj_dml_plr.fit()
            this_theta = obj_dml_plr.coef[0]
            # we show that the loaded result matches the just computed
            print(np.abs(theta_dml[i_rep] - this_theta))
            theta_dml[i_rep] = this_theta

        ax = sns.kdeplot(theta_dml, shade=True, color=colors[3])
        @savefig orth.png width=5in
        ax.axvline(0.5, color='k', label='True theta');

.. tabbed:: R

    .. jupyter-execute::

        set.seed(3333)

        # to speed up the illustration we hard-code the simulation results
        theta_dml = c(0.55583732, 0.59698061, 0.42622692, 0.57065897, 0.48076443, 0.47931293, 0.59837758, 0.47891549, 0.48596322, 0.58327156, 0.53802261, 0.47206318, 0.45801241, 0.43231203, 0.47001012, 0.48481500, 0.48263437, 0.59349709, 0.52467033, 0.52830123, 0.41483774, 0.50628558, 0.52034034, 0.49914977, 0.50953827, 0.46820569, 0.52980768, 0.58837655, 0.49120595, 0.51303767, 0.50991896, 0.50083001, 0.64199346, 0.54936795, 0.46308708, 0.50596192, 0.56077607, 0.51854599, 0.48781402, 0.52134717, 0.47608740, 0.55138921, 0.37212477, 0.58111242, 0.61916441, 0.60602517, 0.50456468, 0.48721512, 0.48368484, 0.42155143, 0.54455051, 0.55881304, 0.54840944, 0.43424054, 0.47211491, 0.64801896, 0.49051298, 0.43143410, 0.53237162, 0.46918541, 0.52538786, 0.50164477, 0.54512740, 0.53047707, 0.51859518, 0.50067174, 0.39757765, 0.53209970, 0.54750446, 0.47642472, 0.59104664, 0.53766442, 0.49963847, 0.46426719, 0.55287076, 0.53878614, 0.49714491, 0.54013264, 0.47250459, 0.49099921, 0.46230582, 0.51530281, 0.51639658, 0.47369180, 0.55638282, 0.51593168, 0.50403993, 0.53329479, 0.42355099, 0.55743232, 0.59265814, 0.48518068, 0.51059997, 0.49545290, 0.42056735, 0.57978408, 0.55576884, 0.54570888, 0.59493606, 0.46959370, 0.44253228, 0.41914419, 0.48238310, 0.53303363, 0.51818116, 0.48013390, 0.50718647, 0.47332719, 0.54101409, 0.53692933, 0.49952018, 0.54070246, 0.46891445, 0.53981923, 0.43885296, 0.51101688, 0.54015143, 0.51296869, 0.51091924, 0.47024580, 0.56669854, 0.54531183, 0.56403189, 0.49522854, 0.48070524, 0.51732264, 0.45580103, 0.51430360, 0.54591780, 0.53914312, 0.50275083, 0.50606970, 0.46483789, 0.57490782, 0.48191155, 0.55369407, 0.56048006, 0.42297254, 0.49583320, 0.47453816, 0.51513324, 0.46132979, 0.54677686, 0.47818015, 0.53360231, 0.50376588, 0.45703947, 0.55057917, 0.54770757, 0.54757223, 0.57308760, 0.51391298, 0.61439485, 0.50875917, 0.70403211, 0.50875252, 0.41111138, 0.47451172, 0.58802962, 0.52970459, 0.59256050, 0.50199198, 0.50699239, 0.52428032, 0.59897681, 0.52520567, 0.56290362, 0.48928598, 0.54685003, 0.64721479, 0.51561889, 0.54318092, 0.51628961, 0.52677629, 0.58309250, 0.49394105, 0.48711406, 0.53599916, 0.53307739, 0.40677386, 0.45959648, 0.51832526, 0.53258196, 0.60142854, 0.48552138, 0.44699271, 0.56465176, 0.52229536, 0.48604204, 0.50545872, 0.49311693, 0.56637447, 0.50548532, 0.62009408, 0.50981827, 0.62321750, 0.49175814, 0.52866625, 0.44100123, 0.47865539, 0.44334858, 0.59916906, 0.40514201, 0.52774540, 0.57532501, 0.44390625, 0.49528758, 0.54490714, 0.60209832, 0.53517064, 0.48053099, 0.58738378, 0.48695724, 0.50575559, 0.55887670, 0.58374868, 0.56117377, 0.53031438, 0.48567162, 0.48428183, 0.51615139, 0.56692701, 0.48611381, 0.42132089, 0.53912562, 0.55344851, 0.49696208, 0.48491336, 0.51443770, 0.52746420, 0.53042663, 0.47383807, 0.47187560, 0.40105944, 0.53858998, 0.51811049, 0.57915313, 0.43791771, 0.51727274, 0.47290672, 0.46229752, 0.59240623, 0.55398200, 0.51357018, 0.50081897, 0.46798846, 0.46528736, 0.62267142, 0.52925744, 0.61424193, 0.46252655, 0.58179473, 0.50441771, 0.55515935, 0.44989467, 0.54785942, 0.49050917, 0.45488618, 0.48479409, 0.41403688, 0.57332341, 0.50119835, 0.48919354, 0.51081006, 0.54734920, 0.44162714, 0.45535464, 0.48007584, 0.56519286, 0.53150777, 0.54065862, 0.50021804, 0.58379719, 0.50196678, 0.52574156, 0.54998549, 0.49933023, 0.44793615, 0.51367421, 0.54004840, 0.50777223, 0.43799466, 0.54657671, 0.44637736, 0.47766162, 0.55388206, 0.54374992, 0.46015686, 0.58857584, 0.53920776, 0.60849844, 0.53342063, 0.49155683, 0.55616403, 0.48530385, 0.44166337, 0.52236730, 0.51121452, 0.53134275, 0.47810577, 0.45996934, 0.49390341, 0.56199085, 0.54996818, 0.60556792, 0.48328732, 0.61336962, 0.47890606, 0.51203562, 0.48265657, 0.61026242, 0.50829119, 0.43824490, 0.49232506, 0.56773914, 0.50197690, 0.55489255, 0.47483008, 0.51528794, 0.48538011, 0.58165383, 0.39166197, 0.49413358, 0.51745194, 0.52667036, 0.52635654, 0.46206208, 0.56614861, 0.47831617, 0.53860594, 0.46215618, 0.50174888, 0.55161213, 0.60742944, 0.50252908, 0.45355615, 0.55079611, 0.61570614, 0.56660124, 0.51692477, 0.38452609, 0.54735027, 0.53498745, 0.59120731, 0.60218639, 0.51141323, 0.47859404, 0.48509576, 0.47623062, 0.50882684, 0.63552047, 0.42572104, 0.51946201, 0.53319696, 0.47988342, 0.44682223, 0.51022792, 0.50050934, 0.53898949, 0.53369417, 0.51644768, 0.49458503, 0.56520487, 0.54721149, 0.49027225, 0.51414278, 0.50906311, 0.52045737, 0.51151249, 0.40936258, 0.47154563, 0.54835201, 0.57263195, 0.52245099, 0.53287902, 0.53877890, 0.45651737, 0.52514231, 0.50289327, 0.49080946, 0.56107553, 0.55427665, 0.51008150, 0.46182057, 0.50590581, 0.57680893, 0.40487345, 0.52026958, 0.55477735, 0.38852405, 0.57588319, 0.61633208, 0.54966584, 0.47648244, 0.42548949, 0.49427528, 0.53146583, 0.53138626, 0.53139079, 0.46290840, 0.52252523, 0.62883404, 0.56823307, 0.54751224, 0.44360764, 0.55634206, 0.53005894, 0.49152948, 0.51302322, 0.46741707, 0.51100589, 0.56659282, 0.50328633, 0.55339695, 0.47619604, 0.43103361, 0.49612390, 0.45921111, 0.46568427, 0.48276599, 0.49145050, 0.51168127, 0.62033664, 0.49682594, 0.54194524, 0.54038912, 0.52608304, 0.51588104, 0.45983880, 0.51760230, 0.52287124, 0.47865420, 0.63357364, 0.50212785, 0.43505472, 0.52260665, 0.47595492, 0.54254050, 0.52250018, 0.52648502, 0.54307470, 0.45585020, 0.51356424, 0.46182126, 0.52009972, 0.60117743, 0.46140143, 0.54785857, 0.53151469, 0.62270309, 0.56880362, 0.62963174, 0.55264665, 0.39882702, 0.47345449, 0.53038010, 0.55170956, 0.40680161, 0.53403167, 0.54759877, 0.54693676, 0.51442236, 0.47235483, 0.40136462, 0.45305321, 0.53463126, 0.52245865, 0.50325651, 0.50720501, 0.44295015, 0.46475243, 0.47285817, 0.52922962, 0.52992543, 0.60603229, 0.50905406, 0.44667528, 0.50046205, 0.49227277, 0.42854932, 0.58060576, 0.50368143, 0.48707358, 0.51809518, 0.51129882, 0.47855748, 0.52827766, 0.52243675, 0.53964224, 0.52570183, 0.52779796, 0.49357111, 0.55047205, 0.49710152, 0.53886327, 0.52759373, 0.46855763, 0.51548228, 0.56376555, 0.45016728, 0.51168836, 0.43971892, 0.45401274, 0.55227497, 0.54219699, 0.54809525, 0.57993513, 0.51115609, 0.65079618, 0.55225574, 0.62347466, 0.52693238, 0.58545076, 0.51951317, 0.39164656, 0.60227716, 0.62297043, 0.50673451, 0.51791753, 0.54901343, 0.53628121, 0.47573811, 0.48857039, 0.50455716, 0.52055881, 0.60630166, 0.40288140, 0.52757320, 0.39000885, 0.51555835, 0.50889457, 0.50348007, 0.50743545, 0.54049814, 0.49263964, 0.57632904, 0.46685772, 0.44952156, 0.49394724, 0.50355199, 0.50550197, 0.51534155, 0.46705229, 0.49305559, 0.42177477, 0.58615433, 0.49958495, 0.53243770, 0.37780172, 0.55131253, 0.47481085, 0.41210336, 0.51367425, 0.57637529, 0.45151096, 0.46504370, 0.48241223, 0.52100077, 0.58139290, 0.56208122, 0.60335538, 0.52929944, 0.42344000, 0.50067257, 0.57684497, 0.64478451, 0.43886235, 0.44666630, 0.51560435, 0.46258175, 0.54541132, 0.47979215, 0.43655740, 0.50703049, 0.53495727, 0.56162800, 0.55143527, 0.56284327, 0.60164181, 0.49749983, 0.58094130, 0.43562956, 0.42500995, 0.54948680, 0.47369505, 0.48414826, 0.51676280, 0.43266514, 0.57155003, 0.49200885, 0.47127192, 0.51761501, 0.50773766, 0.55882211, 0.48162295, 0.54465651, 0.53899152, 0.55328930, 0.55015769, 0.46811310, 0.53175613, 0.41530338, 0.55883316, 0.47936568, 0.45146579, 0.54243048, 0.54052303, 0.54204609, 0.50101337, 0.45019570, 0.52847647, 0.48879457, 0.50841671, 0.56159485, 0.62666809, 0.55974125, 0.45787448, 0.48001082, 0.54468903, 0.62293597, 0.49151523, 0.46646523, 0.40776337, 0.53172854, 0.44128392, 0.49630940, 0.55516482, 0.55068695, 0.51504028, 0.44182408, 0.54421632, 0.54990182, 0.50641548, 0.54543312, 0.53841544, 0.53191428, 0.51565128, 0.56393382, 0.48140364, 0.53908984, 0.48513175, 0.44577571, 0.47026617, 0.42197892, 0.52318967, 0.54342911, 0.54052999, 0.61999630, 0.46727823, 0.66016799, 0.57814695, 0.54674643, 0.50318362, 0.53845020, 0.52966896, 0.51541901, 0.54180353, 0.43743811, 0.55299857, 0.57370417, 0.50517927, 0.50456898, 0.48205677, 0.50698245, 0.56958667, 0.56685099, 0.48241890, 0.43353350, 0.41908357, 0.43555085, 0.57974968, 0.53628091, 0.47439816, 0.51052830, 0.55555215, 0.44878309, 0.51539657, 0.58610238, 0.50991064, 0.53597739, 0.49093576, 0.49093476, 0.47967627, 0.46857646, 0.53849319, 0.56773075, 0.54969753, 0.50844446, 0.52763823, 0.54726307, 0.50235737, 0.60404935, 0.43504425, 0.50201734, 0.48319084, 0.53910765, 0.42227222, 0.47998739, 0.46162446, 0.48761478, 0.48853964, 0.51629025, 0.42741104, 0.41795278, 0.54420407, 0.54785448, 0.40615081, 0.54039178, 0.51765489, 0.52341567, 0.47482172, 0.46685349, 0.61864869, 0.50262483, 0.50948196, 0.59471341, 0.53282638, 0.42811554, 0.48789967, 0.55367278, 0.50757846, 0.48020808, 0.52584696, 0.47088057, 0.52005290, 0.44185704, 0.55161742, 0.53255008, 0.44998637, 0.48313476, 0.43334243, 0.44554022, 0.53576187, 0.54492438, 0.48227448, 0.52801078, 0.50838284, 0.48309134, 0.45828664, 0.53132600, 0.48834343, 0.60701284, 0.59000358, 0.47613136, 0.51698062, 0.49712326, 0.55273677, 0.46149663, 0.58391862, 0.40974148, 0.45456859, 0.50089030, 0.55969422, 0.49266572, 0.47709065, 0.54791680, 0.51307235, 0.52119356, 0.55454918, 0.46666936, 0.61361510, 0.48641678, 0.47867774, 0.58019697, 0.56769460, 0.49174912, 0.50356454, 0.57852110, 0.53772411, 0.56122263, 0.54703591, 0.56860270, 0.41152652, 0.53957253, 0.52546442, 0.57052431, 0.53406606, 0.45686732, 0.55124644, 0.48893879, 0.53660613, 0.51914010, 0.44545112, 0.50660139, 0.49113147, 0.45092217, 0.57928446, 0.52660127, 0.56665130, 0.48263917, 0.49084172, 0.56727025, 0.54994978, 0.58531253, 0.50437095, 0.46171615, 0.58375147, 0.51039881, 0.57484893, 0.46438886, 0.55382972, 0.45084632, 0.46849081, 0.46886473, 0.45499292, 0.49458783, 0.50834733, 0.59688976, 0.41906880, 0.59625017, 0.53019544, 0.44742767, 0.55455162, 0.43433874, 0.44533193, 0.55742158, 0.50963407, 0.51425096, 0.52970878, 0.59189062, 0.56228480, 0.50486220, 0.52634779, 0.55703601, 0.38906191, 0.47603658, 0.55300897, 0.45863744, 0.51654066, 0.53278863, 0.49120572, 0.52456829, 0.44569890, 0.54669166, 0.56017754, 0.56400660, 0.52404763, 0.51298370, 0.53612826, 0.52174999, 0.42552476, 0.49746254, 0.45250956, 0.39378770, 0.54453382, 0.60952767, 0.52205440, 0.50570404, 0.51837963, 0.54014112, 0.44208068, 0.55926638, 0.51638118, 0.46378629, 0.50025689, 0.49762845, 0.50956321, 0.43939502, 0.50407863, 0.54828682, 0.51535576, 0.48851664, 0.53025087, 0.54736660, 0.51293225, 0.45526085, 0.57814547, 0.54479804, 0.42535363, 0.49529198, 0.50218650, 0.62596580, 0.48555410, 0.52228404, 0.55603706, 0.42253387, 0.53281790, 0.45407777, 0.44129944, 0.45021231, 0.47504333, 0.48811395, 0.53932262, 0.58055372, 0.60344592, 0.55648339, 0.51546235, 0.58388643, 0.48293573, 0.61379203, 0.51708565, 0.57059163, 0.51606676, 0.55990129, 0.43549615, 0.39840913, 0.52185373, 0.52121201, 0.45661105, 0.60325708, 0.57525503, 0.55669995, 0.49533380, 0.51018932, 0.50169564, 0.45984316, 0.58217376, 0.58840961, 0.41740572, 0.52688995, 0.55576371, 0.46426704, 0.62785564, 0.45034220, 0.51272584, 0.51744499, 0.50555755, 0.50902172, 0.50298285, 0.50808057, 0.48263061, 0.42331573, 0.46381084, 0.50413707, 0.45408342, 0.55593124, 0.45045401, 0.53053876, 0.57808014, 0.50363774, 0.51299529, 0.62999350, 0.55551994, 0.53528685, 0.42093831, 0.52287392, 0.53134561, 0.55699982, 0.46861129, 0.50071062, 0.50876032, 0.47905073, 0.50054900, 0.37331814, 0.57767768, 0.47989398, 0.51534253, 0.51899355, 0.55741241, 0.56310904, 0.44019481, 0.46015830, 0.54287129, 0.55381284, 0.57240940, 0.57739614, 0.52546551, 0.50803944, 0.44706023, 0.57462768, 0.57476655, 0.42375039, 0.44488583, 0.46758864, 0.53032452, 0.45780910, 0.51460371, 0.53655617, 0.52008064, 0.55084256, 0.47492127, 0.47056189, 0.49387306, 0.48341067, 0.49558922, 0.50035820, 0.49617795, 0.58039029, 0.55346729, 0.50355772, 0.53971306, 0.56498287, 0.55701710, 0.46391340, 0.38992070, 0.41396972, 0.45471663, 0.49631098, 0.56012856, 0.50680061, 0.59138775, 0.50149269, 0.55410782, 0.45675793, 0.50697618, 0.60137306, 0.53737509, 0.54048152, 0.40617918, 0.63143569)

        # to run the full simulation uncomment the following line to fit the model for every dataset and not just for the first dataset
        #for (i_rep in seq_len(n_rep)) {
        for (i_rep in seq_len(1)) {
            df = data[[i_rep]]
            obj_dml_data = double_ml_data_from_data_frame(df, y_col = "y", d_cols = "d")
            obj_dml_plr = DoubleMLPLR$new(obj_dml_data,
                                      ml_g, ml_m,
                                      n_folds=2,
                                      score='IV-type')
            obj_dml_plr$fit()
            this_theta = obj_dml_plr$coef
            print(abs(theta_dml[i_rep] - this_theta))
            theta_dml[i_rep] = this_theta
        }

        g_dml = ggplot(data.frame(theta_dml), aes(x = theta_dml)) +
                    geom_density(fill = "dark red", alpha = 0.3, color = "dark red") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_dml


Double/debiased machine learning
++++++++++++++++++++++++++++++++

To illustrate the benefits of the auxiliary prediction step (the DML) we write the error as

.. math::

    \sqrt{n}(\check{\theta} - \theta) = a^* + b^* + c^*

Chernozhukov et al. (2018) argues that:

The first term

.. math::

    a^* := (EV^2)^{-1} \frac{1}{\sqrt{n}} \sum_{i\in I} V_i U_i

will be asymptotically normally distributed.

The second term

.. math::

    b^* := (EV^2)^{-1} \frac{1}{\sqrt{n}} \sum_{i\in I} (\hat{m}(X_i) - m(X_i)) (\hat{g}_0(X_i) - g_0(X_i))

vanishes asymptotically for many data generating processes.

The third term :math:`c^*` vanishes in probability if sample splitting is applied.

.. tabbed:: Python

    .. ipython:: python

        ax = sns.kdeplot(theta_ols, shade=True)
        sns.kdeplot(theta_nonorth, shade=True, ax=ax);
        sns.kdeplot(theta_orth_nosplit, shade=True);
        sns.kdeplot(theta_dml, shade=True);
        labels = ['True $\\theta$', 'OLS', 'Non-orthogonal ML', 'Double ML (no sample splitting)', 'Double ML with cross-fitting']
        ax.axvline(0.5, color='k', label='True theta');
        @savefig comparison.png width=5in
        ax.legend(labels);

.. tabbed:: R

    .. jupyter-execute::

        g_all = ggplot(data.frame(theta_ols, theta_nonorth, theta_orth_nosplit, theta_dml)) +
                    geom_density(aes(x = theta_ols), fill = "dark blue", alpha = 0.3, color = "dark blue") +
                    geom_density(aes(x = theta_nonorth), fill = "dark orange", alpha = 0.3, color = "dark orange") +
                    geom_density(aes(x = theta_orth_nosplit), fill = "dark green", alpha = 0.3, color = "dark green") +
                    geom_density(aes(x = theta_dml), fill = "dark red", alpha = 0.3, color = "dark red") +
                    geom_vline(aes(xintercept = alpha), col = "black") +
                    xlim(c(0.08, 0.75)) + xlab("") + ylab("") + theme_minimal()
        g_all


References
++++++++++

Chernozhukov, V., Chetverikov, D., Demirer, M., Duflo, E., Hansen, C., Newey, W. and Robins, J. (2018), Double/debiased machine learning for treatment and structural parameters. The Econometrics Journal, 21: C1-C68. doi:`10.1111/ectj.12097 <https://doi.org/10.1111/ectj.12097>`_.